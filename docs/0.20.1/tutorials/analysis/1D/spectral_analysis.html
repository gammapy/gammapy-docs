
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Spectral analysis &#8212; gammapy v0.20.1</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gammapy.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="shortcut icon" href="../../../_static/gammapy_logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Ring background" href="../../../user-guide/makers/ring.html" />
    <link rel="prev" title="Reflected regions background" href="../../../user-guide/makers/reflected.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../../index.html">
  <img src="../../../_static/gammapy_logo_nav.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../getting-started/index.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../../../user-guide/index.html">
  User guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../api-reference/index.html">
  API reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../development/index.html">
  Developer guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../release-notes/index.html">
  Release notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-primary btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        0.20.1  <!-- this text may get changed later by javascript -->
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
</div>

<!-- NOTE: this JS must live here (not in our global JS file) because it relies
     on being processed by Jinja before it is run (specifically for replacing
     variables tutorials/analysis/1D/spectral_analysis and {'json_url': 'https://docs.gammapy.org/stable/switcher.json', 'version_match': '0.20.1'}.
-->

<script type="text/javascript">
// Check if corresponding page path exists in other version of docs
// and, if so, go there instead of the homepage of the other docs version
function checkPageExistsAndRedirect(event) {
    const currentFilePath = "tutorials/analysis/1D/spectral_analysis.html",
          tryUrl = event.target.getAttribute("href");
    let otherDocsHomepage = tryUrl.replace(currentFilePath, "");
    $.ajax({
        type: 'HEAD',
        url: tryUrl,
        // if the page exists, go there
        success: function() {
            location.href = tryUrl;
        }
    }).fail(function() {
        location.href = otherDocsHomepage;
    });
    // this prevents the browser from following the href of the clicked node
    // (which is fine because this function takes care of redirecting)
    return false;
}

// Populate the version switcher from the JSON config file
(function () {
    $.getJSON("https://docs.gammapy.org/stable/switcher.json", function(data, textStatus, jqXHR) {
        const currentFilePath = "tutorials/analysis/1D/spectral_analysis.html";
        // create links to the corresponding page in the other docs versions
        $.each(data, function(index, entry) {
            // if no custom name specified (e.g., "latest"), use version string
            if (!("name" in entry)) {
                entry.name = entry.version;
            }
            // create the node
            const node = document.createElement("a");
            node.setAttribute("class", "list-group-item list-group-item-action py-1");
            node.textContent = `${entry.name}`;
            node.setAttribute("href", `${entry.url}${currentFilePath}`);
            // on click, AJAX calls will check if the linked page exists before
            // trying to redirect, and if not, will redirect to the homepage
            // for that version of the docs.
            node.onclick = checkPageExistsAndRedirect;
            // Add dataset values for the version and name in case people want
            // to apply CSS styling based on this information.
            node.dataset["versionName"] = entry.name;
            node.dataset["version"] = entry.version;

            $("#version_switcher_menu").append(node);
            // replace dropdown button text with the preferred display name of
            // this version, rather than using sphinx's 0.20.1 variable.
            // also highlight the dropdown entry for the currently-viewed
            // version's entry
            if (entry.version == "0.20.1") {
                node.classList.add("active");
                let btn = document.getElementById("version_switcher_button");
                btn.innerText = btn.dataset["activeVersionName"] = entry.name;
                btn.dataset["activeVersion"] = entry.version;
            }
        });
    });
})();
</script>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/gammapy/gammapy" rel="noopener" target="_blank" title="Github"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">Github</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/gammapyST" rel="noopener" target="_blank" title="Twitter"><span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://gammapy.slack.com/" rel="noopener" target="_blank" title="Slack"><span><i class="fab fa-slack"></i></span>
            <label class="sr-only">Slack</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../../../user-guide/package.html">
   Gammapy analysis workflow and package structure
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/dl3.html">
     Data access and selection (DL3)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/irf/index.html">
     Instrument Response Functions (DL3)
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="reference internal" href="../../../user-guide/makers/index.html">
     Data reduction (DL3 to DL4)
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="reference internal" href="../../../user-guide/maps/index.html">
     Sky maps (DL4)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/datasets/index.html">
     Datasets (DL4)
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="reference internal" href="../../../user-guide/modeling.html">
     Modeling and Fitting (DL4 to DL5)
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="reference internal" href="../../../user-guide/estimators.html">
     Estimators (DL4 to DL5, and DL6)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/hli.html">
     High Level Analysis Interface
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/scripts/index.html">
     Command line tools
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/catalog.html">
     Source catalogs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/astro/index.html">
     Astrophysics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/stats/index.html">
     Statistical utility functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/visualization/index.html">
     Visualization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/utils.html">
     Utility functions
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../user-guide/howto.html">
   How To
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../user-guide/model-gallery/index.html">
   Model gallery
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spatial/plot_constant.html">
     Constant spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spatial/plot_disk.html">
     Disk spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spatial/plot_gauss.html">
     Gaussian spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spatial/plot_gen_gauss.html">
     Generalized gaussian spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spatial/plot_point.html">
     Point spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spatial/plot_shell.html">
     Shell spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spatial/plot_shell2.html">
     Shell2 spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spatial/plot_template.html">
     Template spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spectral/plot_absorbed.html">
     EBL absorbption spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spectral/plot_broken_powerlaw.html">
     Broken power law spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spectral/plot_compound.html">
     Compound spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spectral/plot_constant_spectral.html">
     Constant spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spectral/plot_exp_cutoff_powerlaw.html">
     Exponential cutoff power law spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spectral/plot_exp_cutoff_powerlaw_3fgl.html">
     Exponential cutoff power law spectral model used for 3FGL
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spectral/plot_gauss_spectral.html">
     Gaussian spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spectral/plot_logparabola.html">
     Log parabola spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spectral/plot_naima.html">
     Naima spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spectral/plot_piecewise_norm_spectral.html">
     Piecewise  norm spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spectral/plot_powerlaw.html">
     Power law spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spectral/plot_powerlaw2.html">
     Power law 2 spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spectral/plot_smooth_broken_powerlaw.html">
     Smooth broken power law spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spectral/plot_super_exp_cutoff_powerlaw_3fgl.html">
     Super exponential cutoff power law model used for 3FGL
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spectral/plot_super_exp_cutoff_powerlaw_4fgl.html">
     Super Exponential Cutoff Power Law Model used for 4FGL-DR3
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spectral/plot_super_exp_cutoff_powerlaw_4fgl_dr1.html">
     Super Exponential Cutoff Power Law Model used for 4FGL-DR1 (and DR2)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/spectral/plot_template_spectral.html">
     Template spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/temporal/plot_constant_temporal.html">
     Constant temporal model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/temporal/plot_expdecay_temporal.html">
     ExpDecay temporal model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/temporal/plot_gaussian_temporal.html">
     Gaussian temporal model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/temporal/plot_generalized_gaussian_temporal.html">
     Generalized Gaussian temporal model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/temporal/plot_linear_temporal.html">
     Linear temporal model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/temporal/plot_powerlaw_temporal.html">
     PowerLaw temporal model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/temporal/plot_sine_temporal.html">
     Sine temporal model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../user-guide/model-gallery/temporal/plot_template_temporal.html">
     Light curve temporal model
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://gammapy.github.io/gammapy-recipes">
   Gammapy recipes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../user-guide/references.html">
   Glossary and references
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Prerequisites">
   Prerequisites
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Context">
   Context
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Setup">
   Setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Load-Data">
   Load Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Define-Target-Region">
   Define Target Region
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Create-exclusion-mask">
   Create exclusion mask
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Run-data-reduction-chain">
   Run data reduction chain
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Plot-off-regions">
   Plot off regions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Source-statistic">
   Source statistic
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Fit-spectrum">
   Fit spectrum
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Fit-quality-and-model-residuals">
   Fit quality and model residuals
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Compute-Flux-Points">
   Compute Flux Points
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Stack-observations">
   Stack observations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Exercises">
   Exercises
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#What-next?">
   What next?
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<div class="admonition note">
<p class="admonition-title"><strong>This is a fixed-text formatted version of a Jupyter notebook</strong></p>
<ul class="simple">
<li><p>Try online<a class="reference external" href="https://mybinder.org/v2/gh/gammapy/gammapy-webpage/v0.20.1?urlpath=lab/tree/tutorials/analysis/1D/spectral_analysis.ipynb"><img alt="Binder" src="https://static.mybinder.org/badge.svg" /></a></p></li>
<li><p>You may download all the notebooks as a <a class="reference external" href="../../../_downloads/notebooks-0.20.1.tar">tar file</a>.</p></li>
<li><p><strong>Source files:</strong> <a class="reference external" href="../../../_static/notebooks/spectral_analysis.ipynb">spectral_analysis.ipynb</a> | <a class="reference external" href="../../../_static/notebooks/spectral_analysis.py">spectral_analysis.py</a></p></li>
</ul>
</div>
<section id="Spectral-analysis">
<h1>Spectral analysis<a class="headerlink" href="#Spectral-analysis" title="Permalink to this headline">#</a></h1>
<section id="Prerequisites">
<h2>Prerequisites<a class="headerlink" href="#Prerequisites" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Understanding how spectral extraction is performed in Cherenkov astronomy, in particular regarding OFF background measurements.</p></li>
<li><p>Understanding the basics data reduction and modeling/fitting process with the gammapy library API as shown in the <a class="reference internal" href="../../starting/analysis_2.html"><span class="doc">first gammapy analysis with the gammapy library API tutorial</span></a></p></li>
</ul>
</section>
<section id="Context">
<h2>Context<a class="headerlink" href="#Context" title="Permalink to this headline">#</a></h2>
<p>While 3D analyses allow in principle to consider complex field of views containing overlapping gamma-ray sources, in many cases we might have an observation with a single, strong, point-like source in the field of view. A spectral analysis, in that case, might consider all the events inside a source (or ON) region and bin them in energy only, obtaining 1D datasets.</p>
<p>In classical Cherenkov astronomy, the background estimation technique associated with this method measures the number of events in OFF regions taken in regions of the field-of-view devoid of gamma-ray emitters, where the background rate is assumed to be equal to the one in the ON region.</p>
<p>This allows to use a specific fit statistics for ON-OFF measurements, the wstat (see <code class="docutils literal notranslate"><a href='../../../api/gammapy.stats.wstat.html#gammapy.stats.wstat'>gammapy.stats.wstat</a></code>), where no background model is assumed. Background is treated as a set of nuisance parameters. This removes some systematic effects connected to the choice or the quality of the background model. But this comes at the expense of larger statistical uncertainties on the fitted model parameters.</p>
<p><strong>Objective: perform a full region based spectral analysis of 4 Crab observations of H.E.S.S. data release 1 and fit the resulting datasets.</strong></p>
</section>
<section id="Introduction">
<h2>Introduction<a class="headerlink" href="#Introduction" title="Permalink to this headline">#</a></h2>
<p>Here, as usual, we use the <code class="docutils literal notranslate"><a href='../../../api/gammapy.data.DataStore.html#gammapy.data.DataStore'>gammapy.data.DataStore</a></code> to retrieve a list of selected observations (<code class="docutils literal notranslate"><a href='../../../api/gammapy.data.Observations.html#gammapy.data.Observations'>gammapy.data.Observations</a></code>). Then, we define the ON region containing the source and the geometry of the <code class="docutils literal notranslate"><a href='../../../api/gammapy.datasets.SpectrumDataset.html#gammapy.datasets.SpectrumDataset'>gammapy.datasets.SpectrumDataset</a></code> object we want to produce. We then create the corresponding dataset Maker.</p>
<p>We have to define the Maker object that will extract the OFF counts from reflected regions in the field-of-view. To ensure we use data in an energy range where the quality of the IRFs is good enough we also create a safe range Maker.</p>
<p>We can then proceed with data reduction with a loop over all selected observations to produce datasets in the relevant geometry.</p>
<p>We can then explore the resulting datasets and look at the cumulative signal and significance of our source. We finally proceed with model fitting.</p>
<p>In practice, we have to: - Create a <code class="docutils literal notranslate"><a href='../../../api/gammapy.data.DataStore.html#gammapy.data.DataStore'>gammapy.data.DataStore</a></code> poiting to the relevant data - Apply an observation selection to produce a list of observations, a <code class="docutils literal notranslate"><a href='../../../api/gammapy.data.Observations.html#gammapy.data.Observations'>gammapy.data.Observations</a></code> object. - Define a geometry of the spectrum we want to produce: - Create a <code class="docutils literal notranslate"><span class="pre">~regions.CircleSkyRegion</span></code> for the ON extraction region - Create a <code class="docutils literal notranslate"><a href='../../../api/gammapy.maps.MapAxis.html#gammapy.maps.MapAxis'>gammapy.maps.MapAxis</a></code> for the energy binnings: one for the reconstructed (i.e. measured) energy, the other for the true energy (i.e. the one used by IRFs and
models) - Create the necessary makers : - the spectrum dataset maker : <code class="docutils literal notranslate"><a href='../../../api/gammapy.makers.SpectrumDatasetMaker.html#gammapy.makers.SpectrumDatasetMaker'>gammapy.makers.SpectrumDatasetMaker</a></code> - the OFF background maker, here a <code class="docutils literal notranslate"><a href='../../../api/gammapy.makers.ReflectedRegionsBackgroundMaker.html#gammapy.makers.ReflectedRegionsBackgroundMaker'>gammapy.makers.ReflectedRegionsBackgroundMaker</a></code> - and the safe range maker : <code class="docutils literal notranslate"><a href='../../../api/gammapy.makers.SafeMaskMaker.html#gammapy.makers.SafeMaskMaker'>gammapy.makers.SafeMaskMaker</a></code> - Perform the data reduction loop. And for every observation: - Apply the makers sequentially to produce a <code class="docutils literal notranslate"><a href='../../../api/gammapy.datasets.SpectrumDatasetOnOff.html#gammapy.datasets.SpectrumDatasetOnOff'>gammapy.datasets.SpectrumDatasetOnOff</a></code> - Append it to list of datasets - Define the <code class="docutils literal notranslate"><a href='../../../api/gammapy.modeling.models.SkyModel.html#gammapy.modeling.models.SkyModel'>gammapy.modeling.models.SkyModel</a></code> to
apply to the dataset. - Create a <code class="docutils literal notranslate"><a href='../../../api/gammapy.modeling.Fit.html#gammapy.modeling.Fit'>gammapy.modeling.Fit</a></code> object and run it to fit the model parameters - Apply a <code class="docutils literal notranslate"><a href='../../../api/gammapy.estimators.FluxPointsEstimator.html#gammapy.estimators.FluxPointsEstimator'>gammapy.estimators.FluxPointsEstimator</a></code> to compute flux points for the spectral part of the fit.</p>
</section>
<section id="Setup">
<h2>Setup<a class="headerlink" href="#Setup" title="Permalink to this headline">#</a></h2>
<p>As usual, we’ll start with some setup …</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check package versions</span>
<span class="kn">import</span> <span class="nn">gammapy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy</span>
<span class="kn">import</span> <span class="nn">regions</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;gammapy:&quot;</span><span class="p">,</span> <span class="n">gammapy</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;numpy:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;astropy&quot;</span><span class="p">,</span> <span class="n">astropy</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;regions&quot;</span><span class="p">,</span> <span class="n">regions</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
gammapy: 0.20.1
numpy: 1.22.3
astropy 5.0.4
regions 0.6
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">Angle</span>
<span class="kn">from</span> <span class="nn">regions</span> <span class="kn">import</span> <span class="n">CircleSkyRegion</span>
<span class="kn">from</span> <span class="nn">gammapy.maps</span> <span class="kn">import</span> <span class="n">MapAxis</span><span class="p">,</span> <span class="n">RegionGeom</span><span class="p">,</span> <span class="n">WcsGeom</span>
<span class="kn">from</span> <span class="nn">gammapy.modeling</span> <span class="kn">import</span> <span class="n">Fit</span>
<span class="kn">from</span> <span class="nn">gammapy.data</span> <span class="kn">import</span> <span class="n">DataStore</span>
<span class="kn">from</span> <span class="nn">gammapy.datasets</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Datasets</span><span class="p">,</span>
    <span class="n">SpectrumDataset</span><span class="p">,</span>
    <span class="n">SpectrumDatasetOnOff</span><span class="p">,</span>
    <span class="n">FluxPointsDataset</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">gammapy.modeling.models</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ExpCutoffPowerLawSpectralModel</span><span class="p">,</span>
    <span class="n">create_crab_spectral_model</span><span class="p">,</span>
    <span class="n">SkyModel</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">gammapy.makers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SafeMaskMaker</span><span class="p">,</span>
    <span class="n">SpectrumDatasetMaker</span><span class="p">,</span>
    <span class="n">ReflectedRegionsBackgroundMaker</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">gammapy.estimators</span> <span class="kn">import</span> <span class="n">FluxPointsEstimator</span>
<span class="kn">from</span> <span class="nn">gammapy.visualization</span> <span class="kn">import</span> <span class="n">plot_spectrum_datasets_off_regions</span>
</pre></div>
</div>
</div>
</section>
<section id="Load-Data">
<h2>Load Data<a class="headerlink" href="#Load-Data" title="Permalink to this headline">#</a></h2>
<p>First, we select and load some H.E.S.S. observations of the Crab nebula (simulated events for now).</p>
<p>We will access the events, effective area, energy dispersion, livetime and PSF for containement correction.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datastore</span> <span class="o">=</span> <span class="n">DataStore</span><span class="o">.</span><span class="n">from_dir</span><span class="p">(</span><span class="s2">&quot;$GAMMAPY_DATA/hess-dl3-dr1/&quot;</span><span class="p">)</span>
<span class="n">obs_ids</span> <span class="o">=</span> <span class="p">[</span><span class="mi">23523</span><span class="p">,</span> <span class="mi">23526</span><span class="p">,</span> <span class="mi">23559</span><span class="p">,</span> <span class="mi">23592</span><span class="p">]</span>
<span class="n">observations</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">get_observations</span><span class="p">(</span><span class="n">obs_ids</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Define-Target-Region">
<h2>Define Target Region<a class="headerlink" href="#Define-Target-Region" title="Permalink to this headline">#</a></h2>
<p>The next step is to define a signal extraction region, also known as on region. In the simplest case this is just a <a class="reference external" href="http://astropy-regions.readthedocs.io/en/latest/api/regions.CircleSkyRegion.html">CircleSkyRegion</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target_position</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="mf">83.63</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="mf">22.01</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;icrs&quot;</span><span class="p">)</span>
<span class="n">on_region_radius</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="s2">&quot;0.11 deg&quot;</span><span class="p">)</span>
<span class="n">on_region</span> <span class="o">=</span> <span class="n">CircleSkyRegion</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">target_position</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">on_region_radius</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Create-exclusion-mask">
<h2>Create exclusion mask<a class="headerlink" href="#Create-exclusion-mask" title="Permalink to this headline">#</a></h2>
<p>We will use the reflected regions method to place off regions to estimate the background level in the on region. To make sure the off regions don’t contain gamma-ray emission, we create an exclusion mask.</p>
<p>Using <a class="reference external" href="http://gamma-sky.net/">http://gamma-sky.net/</a> we find that there’s only one known gamma-ray source near the Crab nebula: the AGN called <a class="reference external" href="http://gamma-sky.net/#/cat/tev/23">RGB J0521+212</a> at GLON = 183.604 deg and GLAT = -8.708 deg.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exclusion_region</span> <span class="o">=</span> <span class="n">CircleSkyRegion</span><span class="p">(</span>
    <span class="n">center</span><span class="o">=</span><span class="n">SkyCoord</span><span class="p">(</span><span class="mf">183.604</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.708</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;galactic&quot;</span><span class="p">),</span>
    <span class="n">radius</span><span class="o">=</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">skydir</span> <span class="o">=</span> <span class="n">target_position</span><span class="o">.</span><span class="n">galactic</span>
<span class="n">geom</span> <span class="o">=</span> <span class="n">WcsGeom</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">npix</span><span class="o">=</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span> <span class="n">binsz</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">skydir</span><span class="o">=</span><span class="n">skydir</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="s2">&quot;TAN&quot;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;icrs&quot;</span>
<span class="p">)</span>

<span class="n">exclusion_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">geom</span><span class="o">.</span><span class="n">region_mask</span><span class="p">([</span><span class="n">exclusion_region</span><span class="p">])</span>
<span class="n">exclusion_mask</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/tutorials_analysis_1D_spectral_analysis_12_0.png" src="../../../_images/tutorials_analysis_1D_spectral_analysis_12_0.png" />
</div>
</div>
</section>
<section id="Run-data-reduction-chain">
<h2>Run data reduction chain<a class="headerlink" href="#Run-data-reduction-chain" title="Permalink to this headline">#</a></h2>
<p>We begin with the configuration of the maker classes:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">energy_axis</span> <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_energy_bounds</span><span class="p">(</span>
    <span class="mf">0.1</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">per_decade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TeV&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy&quot;</span>
<span class="p">)</span>
<span class="n">energy_axis_true</span> <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_energy_bounds</span><span class="p">(</span>
    <span class="mf">0.05</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">per_decade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TeV&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy_true&quot;</span>
<span class="p">)</span>

<span class="n">geom</span> <span class="o">=</span> <span class="n">RegionGeom</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">on_region</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">energy_axis</span><span class="p">])</span>
<span class="n">dataset_empty</span> <span class="o">=</span> <span class="n">SpectrumDataset</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">geom</span><span class="o">=</span><span class="n">geom</span><span class="p">,</span> <span class="n">energy_axis_true</span><span class="o">=</span><span class="n">energy_axis_true</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset_maker</span> <span class="o">=</span> <span class="n">SpectrumDatasetMaker</span><span class="p">(</span>
    <span class="n">containment_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="s2">&quot;exposure&quot;</span><span class="p">,</span> <span class="s2">&quot;edisp&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">bkg_maker</span> <span class="o">=</span> <span class="n">ReflectedRegionsBackgroundMaker</span><span class="p">(</span><span class="n">exclusion_mask</span><span class="o">=</span><span class="n">exclusion_mask</span><span class="p">)</span>
<span class="n">safe_mask_masker</span> <span class="o">=</span> <span class="n">SafeMaskMaker</span><span class="p">(</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;aeff-max&quot;</span><span class="p">],</span> <span class="n">aeff_percent</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">datasets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">()</span>

<span class="k">for</span> <span class="n">obs_id</span><span class="p">,</span> <span class="n">observation</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obs_ids</span><span class="p">,</span> <span class="n">observations</span><span class="p">):</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="n">dataset_empty</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">obs_id</span><span class="p">)),</span> <span class="n">observation</span>
    <span class="p">)</span>
    <span class="n">dataset_on_off</span> <span class="o">=</span> <span class="n">bkg_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">observation</span><span class="p">)</span>
    <span class="n">dataset_on_off</span> <span class="o">=</span> <span class="n">safe_mask_masker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset_on_off</span><span class="p">,</span> <span class="n">observation</span><span class="p">)</span>
    <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset_on_off</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 6.68 s, sys: 202 ms, total: 6.88 s
Wall time: 7.38 s
</pre></div></div>
</div>
</section>
<section id="Plot-off-regions">
<h2>Plot off regions<a class="headerlink" href="#Plot-off-regions" title="Permalink to this headline">#</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">exclusion_mask</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">on_region</span><span class="o">.</span><span class="n">to_pixel</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plot_spectrum_datasets_off_regions</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">datasets</span><span class="o">=</span><span class="n">datasets</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;WCSAxesSubplot:xlabel=&#39;Right Ascension&#39;, ylabel=&#39;Declination&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/tutorials_analysis_1D_spectral_analysis_18_1.png" src="../../../_images/tutorials_analysis_1D_spectral_analysis_18_1.png" />
</div>
</div>
</section>
<section id="Source-statistic">
<h2>Source statistic<a class="headerlink" href="#Source-statistic" title="Permalink to this headline">#</a></h2>
<p>Next we’re going to look at the overall source statistics in our signal region.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">info_table</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">info_table</span><span class="p">(</span><span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">info_table</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div><i>Table length=4</i>
<table id="table5430737696" class="table-striped table-bordered table-condensed">
<thead><tr><th>name</th><th>counts</th><th>excess</th><th>sqrt_ts</th><th>background</th><th>npred</th><th>npred_background</th><th>npred_signal</th><th>exposure_min</th><th>exposure_max</th><th>livetime</th><th>ontime</th><th>counts_rate</th><th>background_rate</th><th>excess_rate</th><th>n_bins</th><th>n_fit_bins</th><th>stat_type</th><th>stat_sum</th><th>counts_off</th><th>acceptance</th><th>acceptance_off</th><th>alpha</th></tr></thead>
<thead><tr><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th>m2 s</th><th>m2 s</th><th>s</th><th>s</th><th>1 / s</th><th>1 / s</th><th>1 / s</th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead>
<thead><tr><th>str7</th><th>int64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>int64</th><th>int64</th><th>str5</th><th>float64</th><th>int64</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>stacked</td><td>149</td><td>139.25</td><td>20.449683569684254</td><td>9.75</td><td>20.461539024432028</td><td>20.461539024432028</td><td>nan</td><td>2892003.25</td><td>841726208.0</td><td>1581.7367646954954</td><td>1687.0</td><td>0.09420025084179189</td><td>0.006164110373875643</td><td>0.08803614046791623</td><td>27</td><td>18</td><td>wstat</td><td>433.5372460592368</td><td>117</td><td>18.0</td><td>216.0</td><td>0.0833333358168602</td></tr>
<tr><td>stacked</td><td>303</td><td>280.75</td><td>28.446255766130005</td><td>22.250001907348633</td><td>43.84615575068094</td><td>43.84615575068094</td><td>nan</td><td>13397219.0</td><td>1572412928.0</td><td>3154.4235137812793</td><td>3370.0</td><td>0.09605558628263806</td><td>0.007053587386139234</td><td>0.08900199950115721</td><td>27</td><td>19</td><td>wstat</td><td>823.6909484036685</td><td>267</td><td>19.0</td><td>227.99996948242188</td><td>0.0833333432674408</td></tr>
<tr><td>stacked</td><td>439</td><td>408.7743835449219</td><td>36.17588855633591</td><td>30.225610733032227</td><td>50.88364346926001</td><td>50.88364346926001</td><td>nan</td><td>19239702.0</td><td>2077411712.0</td><td>4732.546993609518</td><td>5056.0</td><td>0.09276188923063906</td><td>0.006386753427667313</td><td>0.08637513459388795</td><td>27</td><td>19</td><td>wstat</td><td>1325.2637060766638</td><td>594</td><td>19.0</td><td>373.3919677734375</td><td>0.05088486522436142</td></tr>
<tr><td>stacked</td><td>550</td><td>512.135498046875</td><td>40.90086300803346</td><td>37.864498138427734</td><td>59.674911682627844</td><td>59.674911682627844</td><td>nan</td><td>21017612.0</td><td>2635248128.0</td><td>6313.811659421773</td><td>6742.0</td><td>0.08711061236349418</td><td>0.0059970902175905914</td><td>0.08111352154172066</td><td>27</td><td>19</td><td>wstat</td><td>1701.2360965968023</td><td>869</td><td>19.0</td><td>436.05487060546875</td><td>0.04357249662280083</td></tr>
</table></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">info_table</span><span class="p">[</span><span class="s2">&quot;livetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;h&quot;</span><span class="p">),</span> <span class="n">info_table</span><span class="p">[</span><span class="s2">&quot;excess&quot;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;none&quot;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Livetime [h]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Excess&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/tutorials_analysis_1D_spectral_analysis_22_0.png" src="../../../_images/tutorials_analysis_1D_spectral_analysis_22_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">info_table</span><span class="p">[</span><span class="s2">&quot;livetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;h&quot;</span><span class="p">),</span>
    <span class="n">info_table</span><span class="p">[</span><span class="s2">&quot;sqrt_ts&quot;</span><span class="p">],</span>
    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
    <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Livetime [h]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Sqrt(TS)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/tutorials_analysis_1D_spectral_analysis_23_0.png" src="../../../_images/tutorials_analysis_1D_spectral_analysis_23_0.png" />
</div>
</div>
<p>Finally you can write the extracted datasets to disk using the OGIP format (PHA, ARF, RMF, BKG, see <a class="reference external" href="https://gamma-astro-data-formats.readthedocs.io/en/latest/spectra/ogip/index.html">here</a> for details):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;spectrum_analysis&quot;</span><span class="p">)</span>
<span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;obs_</span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.fits.gz&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<p>If you want to read back the datasets from disk you can use:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datasets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">()</span>

<span class="k">for</span> <span class="n">obs_id</span> <span class="ow">in</span> <span class="n">obs_ids</span><span class="p">:</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;obs_</span><span class="si">{</span><span class="n">obs_id</span><span class="si">}</span><span class="s2">.fits.gz&quot;</span>
    <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SpectrumDatasetOnOff</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
</pre></div>
</div>
</div>
</section>
<section id="Fit-spectrum">
<h2>Fit spectrum<a class="headerlink" href="#Fit-spectrum" title="Permalink to this headline">#</a></h2>
<p>Now we’ll fit a global model to the spectrum. First we do a joint likelihood fit to all observations. If you want to stack the observations see below. We will also produce a debug plot in order to show how the global fit matches one of the individual observations.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spectral_model</span> <span class="o">=</span> <span class="n">ExpCutoffPowerLawSpectralModel</span><span class="p">(</span>
    <span class="n">amplitude</span><span class="o">=</span><span class="mf">1e-12</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;cm-2 s-1 TeV-1&quot;</span><span class="p">),</span>
    <span class="n">index</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">lambda_</span><span class="o">=</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;TeV-1&quot;</span><span class="p">),</span>
    <span class="n">reference</span><span class="o">=</span><span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">SkyModel</span><span class="p">(</span><span class="n">spectral_model</span><span class="o">=</span><span class="n">spectral_model</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;crab&quot;</span><span class="p">)</span>

<span class="n">datasets</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="p">]</span>

<span class="n">fit_joint</span> <span class="o">=</span> <span class="n">Fit</span><span class="p">()</span>
<span class="n">result_joint</span> <span class="o">=</span> <span class="n">fit_joint</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">datasets</span><span class="o">=</span><span class="n">datasets</span><span class="p">)</span>

<span class="c1"># we make a copy here to compare it later</span>
<span class="n">model_best_joint</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="Fit-quality-and-model-residuals">
<h2>Fit quality and model residuals<a class="headerlink" href="#Fit-quality-and-model-residuals" title="Permalink to this headline">#</a></h2>
<p>We can access the results dictionary to see if the fit converged:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">result_joint</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
OptimizeResult

        backend    : minuit
        method     : migrad
        success    : True
        message    : Optimization terminated successfully.
        nfev       : 244
        total stat : 86.12

CovarianceResult

        backend    : minuit
        method     : hesse
        success    : True
        message    : Hesse terminated successfully.

</pre></div></div>
</div>
<p>and check the best-fit parameters</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datasets</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">to_parameters_table</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div><i>Table length=5</i>
<table id="table5462079568" class="table-striped table-bordered table-condensed">
<thead><tr><th>model</th><th>type</th><th>name</th><th>value</th><th>unit</th><th>error</th><th>min</th><th>max</th><th>frozen</th><th>is_norm</th><th>link</th></tr></thead>
<thead><tr><th>str4</th><th>str8</th><th>str9</th><th>float64</th><th>str14</th><th>float64</th><th>float64</th><th>float64</th><th>bool</th><th>bool</th><th>str1</th></tr></thead>
<tr><td>crab</td><td>spectral</td><td>index</td><td>2.2727e+00</td><td></td><td>1.566e-01</td><td>nan</td><td>nan</td><td>False</td><td>False</td><td></td></tr>
<tr><td>crab</td><td>spectral</td><td>amplitude</td><td>4.7913e-11</td><td>cm-2 s-1 TeV-1</td><td>3.600e-12</td><td>nan</td><td>nan</td><td>False</td><td>True</td><td></td></tr>
<tr><td>crab</td><td>spectral</td><td>reference</td><td>1.0000e+00</td><td>TeV</td><td>0.000e+00</td><td>nan</td><td>nan</td><td>True</td><td>False</td><td></td></tr>
<tr><td>crab</td><td>spectral</td><td>lambda_</td><td>1.2097e-01</td><td>TeV-1</td><td>5.382e-02</td><td>nan</td><td>nan</td><td>False</td><td>False</td><td></td></tr>
<tr><td>crab</td><td>spectral</td><td>alpha</td><td>1.0000e+00</td><td></td><td>0.000e+00</td><td>nan</td><td>nan</td><td>True</td><td>False</td><td></td></tr>
</table></div></div>
</div>
<p>A simple way to inspect the model residuals is using the function <code class="docutils literal notranslate"><span class="pre">~SpectrumDataset.plot_fit()</span></code></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax_spectrum</span><span class="p">,</span> <span class="n">ax_residuals</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_fit</span><span class="p">()</span>
<span class="n">ax_spectrum</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
<span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_masks</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax_spectrum</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/tutorials_analysis_1D_spectral_analysis_37_0.png" src="../../../_images/tutorials_analysis_1D_spectral_analysis_37_0.png" />
</div>
</div>
<p>For more ways of assessing fit quality, please refer to the dedicated <a class="reference internal" href="../2D/modeling_2D.html"><span class="doc">modeling and fitting tutorial</span></a>.</p>
</section>
<section id="Compute-Flux-Points">
<h2>Compute Flux Points<a class="headerlink" href="#Compute-Flux-Points" title="Permalink to this headline">#</a></h2>
<p>To round up our analysis we can compute flux points by fitting the norm of the global model in energy bands. We’ll use a fixed energy binning for now:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">e_min</span><span class="p">,</span> <span class="n">e_max</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mi">30</span>
<span class="n">energy_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">geomspace</span><span class="p">(</span><span class="n">e_min</span><span class="p">,</span> <span class="n">e_max</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span>
</pre></div>
</div>
</div>
<p>Now we create an instance of the <code class="docutils literal notranslate"><a href='../../../api/gammapy.estimators.FluxPointsEstimator.html#gammapy.estimators.FluxPointsEstimator'>gammapy.estimators.FluxPointsEstimator</a></code>, by passing the dataset and the energy binning:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpe</span> <span class="o">=</span> <span class="n">FluxPointsEstimator</span><span class="p">(</span>
    <span class="n">energy_edges</span><span class="o">=</span><span class="n">energy_edges</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s2">&quot;crab&quot;</span><span class="p">,</span> <span class="n">selection_optional</span><span class="o">=</span><span class="s2">&quot;all&quot;</span>
<span class="p">)</span>
<span class="n">flux_points</span> <span class="o">=</span> <span class="n">fpe</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">datasets</span><span class="o">=</span><span class="n">datasets</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Here is a the table of the resulting flux points:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flux_points</span><span class="o">.</span><span class="n">to_table</span><span class="p">(</span><span class="n">sed_type</span><span class="o">=</span><span class="s2">&quot;dnde&quot;</span><span class="p">,</span> <span class="n">formatted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div><i>Table length=10</i>
<table id="table5461364896" class="table-striped table-bordered table-condensed">
<thead><tr><th>e_ref</th><th>e_min</th><th>e_max</th><th>dnde</th><th>dnde_err</th><th>dnde_errp</th><th>dnde_errn</th><th>dnde_ul</th><th>ts</th><th>sqrt_ts</th><th>npred [4]</th><th>npred_excess [4]</th><th>stat</th><th>is_ul</th><th>counts [4]</th><th>success</th><th>norm_scan [11]</th><th>stat_scan [11]</th></tr></thead>
<thead><tr><th>TeV</th><th>TeV</th><th>TeV</th><th>1 / (cm2 s TeV)</th><th>1 / (cm2 s TeV)</th><th>1 / (cm2 s TeV)</th><th>1 / (cm2 s TeV)</th><th>1 / (cm2 s TeV)</th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead>
<thead><tr><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float32</th><th>float64</th><th>bool</th><th>float64</th><th>bool</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>0.823</td><td>0.737</td><td>0.920</td><td>6.950e-11</td><td>7.224e-12</td><td>7.462e-12</td><td>7.000e-12</td><td>8.496e-11</td><td>318.308</td><td>17.841</td><td>31.36646258047154 .. 23.889729207163217</td><td>28.875505 .. 21.720263</td><td>8.252</td><td>False</td><td>30.0 .. 25.0</td><td>True</td><td>0.200 .. 5.000</td><td>140.739 .. 451.124</td></tr>
<tr><td>1.148</td><td>0.920</td><td>1.434</td><td>2.884e-11</td><td>2.581e-12</td><td>2.654e-12</td><td>2.510e-12</td><td>3.430e-11</td><td>449.770</td><td>21.208</td><td>40.721594294634784 .. 29.627449286871947</td><td>38.467556 .. 27.449282</td><td>12.649</td><td>False</td><td>43.0 .. 35.0</td><td>True</td><td>0.200 .. 5.000</td><td>182.603 .. 693.653</td></tr>
<tr><td>1.790</td><td>1.434</td><td>2.235</td><td>1.104e-11</td><td>1.132e-12</td><td>1.168e-12</td><td>1.096e-12</td><td>1.345e-11</td><td>350.109</td><td>18.711</td><td>31.973739526878333 .. 21.124620512912387</td><td>29.863094 .. 19.905582</td><td>6.105</td><td>False</td><td>37.0 .. 21.0</td><td>True</td><td>0.200 .. 5.000</td><td>150.799 .. 424.855</td></tr>
<tr><td>2.790</td><td>2.235</td><td>3.483</td><td>3.462e-12</td><td>4.450e-13</td><td>4.631e-13</td><td>4.273e-13</td><td>4.426e-12</td><td>219.114</td><td>14.802</td><td>20.86827471761865 .. 13.385553096466168</td><td>19.729824 .. 12.434938</td><td>12.915</td><td>False</td><td>13.0 .. 17.0</td><td>True</td><td>0.200 .. 5.000</td><td>102.546 .. 293.446</td></tr>
<tr><td>3.892</td><td>3.483</td><td>4.348</td><td>8.756e-13</td><td>2.576e-13</td><td>2.800e-13</td><td>2.362e-13</td><td>1.482e-12</td><td>36.235</td><td>6.020</td><td>4.959042980000916 .. 2.702481330476382</td><td>4.168653 .. 2.5370095</td><td>4.035</td><td>False</td><td>8.0 .. 2.0</td><td>True</td><td>0.200 .. 5.000</td><td>13.594 .. 125.092</td></tr>
<tr><td>5.429</td><td>4.348</td><td>6.778</td><td>5.335e-13</td><td>1.079e-13</td><td>1.149e-13</td><td>1.011e-13</td><td>7.776e-13</td><td>86.926</td><td>9.323</td><td>8.52067876691984 .. 5.173151592973639</td><td>8.258547 .. 4.9781284</td><td>11.815</td><td>False</td><td>12.0 .. 6.0</td><td>True</td><td>0.200 .. 5.000</td><td>47.101 .. 132.109</td></tr>
<tr><td>8.462</td><td>6.778</td><td>10.564</td><td>1.623e-13</td><td>4.547e-14</td><td>4.941e-14</td><td>4.186e-14</td><td>2.695e-13</td><td>38.108</td><td>6.173</td><td>5.121380116204808 .. 3.1055485072447895</td><td>4.620307 .. 2.731345</td><td>8.980</td><td>False</td><td>5.0 .. 5.0</td><td>True</td><td>0.200 .. 5.000</td><td>28.474 .. 55.783</td></tr>
<tr><td>11.803</td><td>10.564</td><td>13.189</td><td>5.214e-14</td><td>3.008e-14</td><td>3.529e-14</td><td>2.546e-14</td><td>1.339e-13</td><td>7.911</td><td>2.813</td><td>1.2131436603915728 .. 0.7323859566564407</td><td>1.1362206 .. 0.6783319</td><td>7.934</td><td>False</td><td>0.0 .. 0.0</td><td>True</td><td>0.200 .. 5.000</td><td>12.285 .. 18.679</td></tr>
<tr><td>16.465</td><td>13.189</td><td>20.556</td><td>1.177e-14</td><td>7.816e-15</td><td>9.399e-15</td><td>6.393e-15</td><td>3.395e-14</td><td>5.269</td><td>2.295</td><td>0.9432263496672387 .. 0.6987575077748854</td><td>0.84752977 .. 0.50956833</td><td>6.611</td><td>False</td><td>1.0 .. 0.0</td><td>True</td><td>0.200 .. 5.000</td><td>9.622 .. 17.557</td></tr>
<tr><td>25.663</td><td>20.556</td><td>32.040</td><td>nan</td><td>nan</td><td>1.094e-15</td><td>nan</td><td>4.378e-15</td><td>-0.012</td><td>-0.000</td><td>0.07895530597715192 .. 0.10937377988399984</td><td>0.002032229 .. 0.0012656718</td><td>0.633</td><td>True</td><td>0.0 .. 0.0</td><td>False</td><td>0.200 .. 5.000</td><td>0.866 .. 6.774</td></tr>
</table></div></div>
</div>
<p>Now we plot the flux points and their likelihood profiles. For the plotting of upper limits we choose a threshold of TS &lt; 4.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">flux_points</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sed_type</span><span class="o">=</span><span class="s2">&quot;e2dnde&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;darkorange&quot;</span><span class="p">)</span>
<span class="n">flux_points</span><span class="o">.</span><span class="n">plot_ts_profiles</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">sed_type</span><span class="o">=</span><span class="s2">&quot;e2dnde&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/tutorials_analysis_1D_spectral_analysis_46_0.png" src="../../../_images/tutorials_analysis_1D_spectral_analysis_46_0.png" />
</div>
</div>
<p>The final plot with the best fit model, flux points and residuals can be quickly made like this:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flux_points_dataset</span> <span class="o">=</span> <span class="n">FluxPointsDataset</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">flux_points</span><span class="p">,</span> <span class="n">models</span><span class="o">=</span><span class="n">model_best_joint</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flux_points_dataset</span><span class="o">.</span><span class="n">plot_fit</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/tutorials_analysis_1D_spectral_analysis_49_0.png" src="../../../_images/tutorials_analysis_1D_spectral_analysis_49_0.png" />
</div>
</div>
</section>
<section id="Stack-observations">
<h2>Stack observations<a class="headerlink" href="#Stack-observations" title="Permalink to this headline">#</a></h2>
<p>And alternative approach to fitting the spectrum is stacking all observations first and the fitting a model. For this we first stack the individual datasets:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset_stacked</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span><span class="o">.</span><span class="n">stack_reduce</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Again we set the model on the dataset we would like to fit (in this case it’s only a single one) and pass it to the <code class="docutils literal notranslate"><a href='../../../api/gammapy.modeling.Fit.html#gammapy.modeling.Fit'>gammapy.modeling.Fit</a></code> object:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset_stacked</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">model</span>
<span class="n">stacked_fit</span> <span class="o">=</span> <span class="n">Fit</span><span class="p">()</span>
<span class="n">result_stacked</span> <span class="o">=</span> <span class="n">stacked_fit</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">dataset_stacked</span><span class="p">])</span>

<span class="c1"># make a copy to compare later</span>
<span class="n">model_best_stacked</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">result_stacked</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
OptimizeResult

        backend    : minuit
        method     : migrad
        success    : True
        message    : Optimization terminated successfully.
        nfev       : 54
        total stat : 8.16

CovarianceResult

        backend    : minuit
        method     : hesse
        success    : True
        message    : Hesse terminated successfully.

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_best_joint</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">to_table</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div><i>Table length=5</i>
<table id="table5468754272" class="table-striped table-bordered table-condensed">
<thead><tr><th>type</th><th>name</th><th>value</th><th>unit</th><th>error</th><th>min</th><th>max</th><th>frozen</th><th>is_norm</th><th>link</th></tr></thead>
<thead><tr><th>str8</th><th>str9</th><th>float64</th><th>str14</th><th>float64</th><th>float64</th><th>float64</th><th>bool</th><th>bool</th><th>str1</th></tr></thead>
<tr><td>spectral</td><td>index</td><td>2.2727e+00</td><td></td><td>1.566e-01</td><td>nan</td><td>nan</td><td>False</td><td>False</td><td></td></tr>
<tr><td>spectral</td><td>amplitude</td><td>4.7913e-11</td><td>cm-2 s-1 TeV-1</td><td>3.600e-12</td><td>nan</td><td>nan</td><td>False</td><td>True</td><td></td></tr>
<tr><td>spectral</td><td>reference</td><td>1.0000e+00</td><td>TeV</td><td>0.000e+00</td><td>nan</td><td>nan</td><td>True</td><td>False</td><td></td></tr>
<tr><td>spectral</td><td>lambda_</td><td>1.2097e-01</td><td>TeV-1</td><td>5.382e-02</td><td>nan</td><td>nan</td><td>False</td><td>False</td><td></td></tr>
<tr><td>spectral</td><td>alpha</td><td>1.0000e+00</td><td></td><td>0.000e+00</td><td>nan</td><td>nan</td><td>True</td><td>False</td><td></td></tr>
</table></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_best_stacked</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">to_table</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div><i>Table length=5</i>
<table id="table5486032640" class="table-striped table-bordered table-condensed">
<thead><tr><th>type</th><th>name</th><th>value</th><th>unit</th><th>error</th><th>min</th><th>max</th><th>frozen</th><th>is_norm</th><th>link</th></tr></thead>
<thead><tr><th>str8</th><th>str9</th><th>float64</th><th>str14</th><th>float64</th><th>float64</th><th>float64</th><th>bool</th><th>bool</th><th>str1</th></tr></thead>
<tr><td>spectral</td><td>index</td><td>2.2785e+00</td><td></td><td>1.563e-01</td><td>nan</td><td>nan</td><td>False</td><td>False</td><td></td></tr>
<tr><td>spectral</td><td>amplitude</td><td>4.7800e-11</td><td>cm-2 s-1 TeV-1</td><td>3.566e-12</td><td>nan</td><td>nan</td><td>False</td><td>True</td><td></td></tr>
<tr><td>spectral</td><td>reference</td><td>1.0000e+00</td><td>TeV</td><td>0.000e+00</td><td>nan</td><td>nan</td><td>True</td><td>False</td><td></td></tr>
<tr><td>spectral</td><td>lambda_</td><td>1.1830e-01</td><td>TeV-1</td><td>5.329e-02</td><td>nan</td><td>nan</td><td>False</td><td>False</td><td></td></tr>
<tr><td>spectral</td><td>alpha</td><td>1.0000e+00</td><td></td><td>0.000e+00</td><td>nan</td><td>nan</td><td>True</td><td>False</td><td></td></tr>
</table></div></div>
</div>
<p>Finally, we compare the results of our stacked analysis to a previously published Crab Nebula Spectrum for reference. This is available in <code class="docutils literal notranslate"><a href='../../../api/gammapy.modeling.models.create_crab_spectral_model.html#gammapy.modeling.models.create_crab_spectral_model'>gammapy.modeling.models.create_crab_spectral_model</a></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_kwargs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;energy_bounds&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">,</span>
    <span class="s2">&quot;sed_type&quot;</span><span class="p">:</span> <span class="s2">&quot;e2dnde&quot;</span><span class="p">,</span>
    <span class="s2">&quot;yunits&quot;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;erg cm-2 s-1&quot;</span><span class="p">),</span>
<span class="p">}</span>

<span class="c1"># plot stacked model</span>
<span class="n">model_best_stacked</span><span class="o">.</span><span class="n">spectral_model</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Stacked analysis result&quot;</span>
<span class="p">)</span>
<span class="n">model_best_stacked</span><span class="o">.</span><span class="n">spectral_model</span><span class="o">.</span><span class="n">plot_error</span><span class="p">(</span>
    <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span>
<span class="p">)</span>

<span class="c1"># plot joint model</span>
<span class="n">model_best_joint</span><span class="o">.</span><span class="n">spectral_model</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Joint analysis result&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span>
<span class="p">)</span>
<span class="n">model_best_joint</span><span class="o">.</span><span class="n">spectral_model</span><span class="o">.</span><span class="n">plot_error</span><span class="p">(</span>
    <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span>
<span class="p">)</span>

<span class="n">create_crab_spectral_model</span><span class="p">(</span><span class="s2">&quot;hess_ecpl&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Crab reference&quot;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x146fe3af0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/tutorials_analysis_1D_spectral_analysis_58_1.png" src="../../../_images/tutorials_analysis_1D_spectral_analysis_58_1.png" />
</div>
</div>
</section>
<section id="Exercises">
<h2>Exercises<a class="headerlink" href="#Exercises" title="Permalink to this headline">#</a></h2>
<p>Now you have learned the basics of a spectral analysis with Gammapy. To practice you can continue with the following exercises:</p>
<ul class="simple">
<li><p>Fit a different spectral model to the data. You could try <code class="docutils literal notranslate"><a href='../../../api/gammapy.modeling.models.ExpCutoffPowerLawSpectralModel.html#gammapy.modeling.models.ExpCutoffPowerLawSpectralModel'>gammapy.modeling.models.ExpCutoffPowerLawSpectralModel</a></code> or <code class="docutils literal notranslate"><a href='../../../api/gammapy.modeling.models.LogParabolaSpectralModel.html#gammapy.modeling.models.LogParabolaSpectralModel'>gammapy.modeling.models.LogParabolaSpectralModel</a></code>.</p></li>
<li><p>Compute flux points for the stacked dataset.</p></li>
<li><p>Create a <code class="docutils literal notranslate"><a href='../../../api/gammapy.datasets.FluxPointsDataset.html#gammapy.datasets.FluxPointsDataset'>gammapy.datasets.FluxPointsDataset</a></code> with the flux points you have computed for the stacked dataset and fit the flux points again with obe of the spectral models. How does the result compare to the best fit model, that was directly fitted to the counts data?</p></li>
</ul>
</section>
<section id="What-next?">
<h2>What next?<a class="headerlink" href="#What-next?" title="Permalink to this headline">#</a></h2>
<p>The methods shown in this tutorial is valid for point-like or midly extended sources where we can assume that the IRF taken at the region center is valid over the whole region. If one wants to extract the 1D spectrum of a large source and properly average the response over the extraction region, one has to use a different approach explained in <a class="reference internal" href="extended_source_spectral_analysis.html"><span class="doc">the extended source spectral analysis tutorial</span></a>.</p>
</section>
</section>


              </div>
              
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, The Gammapy developers.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>