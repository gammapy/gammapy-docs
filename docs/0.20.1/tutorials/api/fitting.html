
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Fitting &#8212; gammapy v0.20.1</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gammapy.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="shortcut icon" href="../../_static/gammapy_logo.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Estimators (DL4 to DL5, and DL6)" href="../../user-guide/estimators.html" />
    <link rel="prev" title="Models" href="models.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../index.html">
  <img src="../../_static/gammapy_logo_nav.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../getting-started/index.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../user-guide/index.html">
  User guide
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../api-reference/index.html">
  API reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../development/index.html">
  Developer guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../release-notes/index.html">
  Release notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-primary btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        0.20.1  <!-- this text may get changed later by javascript -->
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
</div>

<!-- NOTE: this JS must live here (not in our global JS file) because it relies
     on being processed by Jinja before it is run (specifically for replacing
     variables tutorials/api/fitting and {'json_url': 'https://docs.gammapy.org/stable/switcher.json', 'version_match': '0.20.1'}.
-->

<script type="text/javascript">
// Check if corresponding page path exists in other version of docs
// and, if so, go there instead of the homepage of the other docs version
function checkPageExistsAndRedirect(event) {
    const currentFilePath = "tutorials/api/fitting.html",
          tryUrl = event.target.getAttribute("href");
    let otherDocsHomepage = tryUrl.replace(currentFilePath, "");
    $.ajax({
        type: 'HEAD',
        url: tryUrl,
        // if the page exists, go there
        success: function() {
            location.href = tryUrl;
        }
    }).fail(function() {
        location.href = otherDocsHomepage;
    });
    // this prevents the browser from following the href of the clicked node
    // (which is fine because this function takes care of redirecting)
    return false;
}

// Populate the version switcher from the JSON config file
(function () {
    $.getJSON("https://docs.gammapy.org/stable/switcher.json", function(data, textStatus, jqXHR) {
        const currentFilePath = "tutorials/api/fitting.html";
        // create links to the corresponding page in the other docs versions
        $.each(data, function(index, entry) {
            // if no custom name specified (e.g., "latest"), use version string
            if (!("name" in entry)) {
                entry.name = entry.version;
            }
            // create the node
            const node = document.createElement("a");
            node.setAttribute("class", "list-group-item list-group-item-action py-1");
            node.textContent = `${entry.name}`;
            node.setAttribute("href", `${entry.url}${currentFilePath}`);
            // on click, AJAX calls will check if the linked page exists before
            // trying to redirect, and if not, will redirect to the homepage
            // for that version of the docs.
            node.onclick = checkPageExistsAndRedirect;
            // Add dataset values for the version and name in case people want
            // to apply CSS styling based on this information.
            node.dataset["versionName"] = entry.name;
            node.dataset["version"] = entry.version;

            $("#version_switcher_menu").append(node);
            // replace dropdown button text with the preferred display name of
            // this version, rather than using sphinx's 0.20.1 variable.
            // also highlight the dropdown entry for the currently-viewed
            // version's entry
            if (entry.version == "0.20.1") {
                node.classList.add("active");
                let btn = document.getElementById("version_switcher_button");
                btn.innerText = btn.dataset["activeVersionName"] = entry.name;
                btn.dataset["activeVersion"] = entry.version;
            }
        });
    });
})();
</script>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/gammapy/gammapy" rel="noopener" target="_blank" title="Github"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">Github</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/gammapyST" rel="noopener" target="_blank" title="Twitter"><span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://gammapy.slack.com/" rel="noopener" target="_blank" title="Slack"><span><i class="fab fa-slack"></i></span>
            <label class="sr-only">Slack</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../starting/analysis_1.html">
   High level interface
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../starting/analysis_2.html">
   Low level API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../starting/overview.html">
   Data structures
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../data/cta.html">
   CTA with Gammapy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data/hess.html">
   H.E.S.S. with Gammapy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data/fermi_lat.html">
   Fermi-LAT with Gammapy
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/1D/spectral_analysis.html">
   Spectral analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/1D/spectral_analysis_rad_max.html">
   Spectral analysis with energy-dependent directional cuts
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/1D/sed_fitting.html">
   Flux point fitting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/1D/extended_source_spectral_analysis.html">
   Spectral analysis of extended sources
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/1D/spectrum_simulation.html">
   1D spectrum simulation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/1D/cta_sensitivity.html">
   Point source sensitivity
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/2D/ring_background.html">
   Ring background map
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/2D/modeling_2D.html">
   2D map fitting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/2D/detect.html">
   Source detection and significance maps
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/3D/cta_data_analysis.html">
   Basic image exploration and fitting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/3D/analysis_3d.html">
   3D detailed analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/3D/simulate_3d.html">
   3D map simulation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/3D/analysis_mwl.html">
   Multi instrument joint 3D and 1D analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/3D/event_sampling.html">
   Event sampling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/3D/flux_profiles.html">
   Flux Profile Estimation
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/time/light_curve_simulation.html">
   Simulating and fitting a time varying source
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/time/light_curve.html">
   Light curves
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/time/light_curve_flare.html">
   Light curves for flares
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/time/pulsar_analysis.html">
   Pulsar analysis
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="makers.html">
   Makers - Data reduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="catalog.html">
   Source catalogs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="models.html">
   Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="model_management.html">
   Modelling
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Fitting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="maps.html">
   Maps
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mask_maps.html">
   Mask maps
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="astro_dark_matter.html">
   Dark matter spatial and spectral models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="datasets.html">
   Datasets - Reduced data, IRFs, models
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../survey_map.html">
   Survey map
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Prerequisites">
   Prerequisites
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Proposed-approach">
   Proposed approach
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#The-setup">
   The setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Model-and-dataset">
   Model and dataset
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Fitting-options">
   Fitting options
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Fit-quality-assessment">
   Fit quality assessment
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Covariance-and-parameters-errors">
   Covariance and parameters errors
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Confidence-contours">
   Confidence contours
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Computing-contours-using-Fit.stat_contour()">
     Computing contours using
     <code class="docutils literal notranslate">
      <span class="pre">
       Fit.stat_contour()
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Computing-contours-using-Fit.stat_surface()">
     Computing contours using
     <code class="docutils literal notranslate">
      <span class="pre">
       Fit.stat_surface()
      </span>
     </code>
    </a>
   </li>
  </ul>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<div class="admonition note">
<p class="admonition-title"><strong>This is a fixed-text formatted version of a Jupyter notebook</strong></p>
<ul class="simple">
<li><p>Try online<a class="reference external" href="https://mybinder.org/v2/gh/gammapy/gammapy-webpage/v0.20.1?urlpath=lab/tree/tutorials/api/fitting.ipynb"><img alt="Binder" src="https://static.mybinder.org/badge.svg" /></a></p></li>
<li><p>You may download all the notebooks as a <a class="reference external" href="../../_downloads/notebooks-0.20.1.tar">tar file</a>.</p></li>
<li><p><strong>Source files:</strong> <a class="reference external" href="../../_static/notebooks/fitting.ipynb">fitting.ipynb</a> | <a class="reference external" href="../../_static/notebooks/fitting.py">fitting.py</a></p></li>
</ul>
</div>
<section id="Fitting">
<h1>Fitting<a class="headerlink" href="#Fitting" title="Permalink to this headline">#</a></h1>
<section id="Prerequisites">
<h2>Prerequisites<a class="headerlink" href="#Prerequisites" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Knowledge of spectral analysis to produce 1D On-Off datasets, <a class="reference internal" href="../analysis/1D/spectral_analysis.html"><span class="doc">see the following tutorial</span></a></p></li>
<li><p>Reading of pre-computed datasets <a class="reference internal" href="../analysis/3D/analysis_mwl.html"><span class="doc">see the MWL tutorial</span></a></p></li>
<li><p>General knowledge on statistics and optimization methods</p></li>
</ul>
</section>
<section id="Proposed-approach">
<h2>Proposed approach<a class="headerlink" href="#Proposed-approach" title="Permalink to this headline">#</a></h2>
<p>This is a hands-on tutorial to <code class="docutils literal notranslate"><span class="pre">~gammapy.modeling</span></code>, showing how to do perform a Fit in gammapy. The emphasis here is on interfacing the <code class="docutils literal notranslate"><span class="pre">Fit</span></code> class and inspecting the errors. To see an analysis example of how datasets and models interact, see the <a class="reference internal" href="model_management.html"><span class="doc">model management notebook</span></a>. As an example, in this notebook, we are going to work with HESS data of the Crab Nebula and show in particular how to : - perform a spectral analysis - use different fitting backends - access
covariance matrix information and parameter errors - compute likelihood profile - compute confidence contours</p>
<p>See also: <a class="reference internal" href="models.html"><span class="doc">Models gallery tutorial</span></a> and <code class="docutils literal notranslate"><span class="pre">docs/modeling/index.rst</span></code>.</p>
</section>
<section id="The-setup">
<h2>The setup<a class="headerlink" href="#The-setup" title="Permalink to this headline">#</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">StrMethodFormatter</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">st</span>
<span class="kn">from</span> <span class="nn">gammapy.modeling</span> <span class="kn">import</span> <span class="n">Fit</span>
<span class="kn">from</span> <span class="nn">gammapy.datasets</span> <span class="kn">import</span> <span class="n">Datasets</span><span class="p">,</span> <span class="n">SpectrumDatasetOnOff</span>
<span class="kn">from</span> <span class="nn">gammapy.modeling.models</span> <span class="kn">import</span> <span class="n">LogParabolaSpectralModel</span><span class="p">,</span> <span class="n">SkyModel</span>
<span class="kn">from</span> <span class="nn">gammapy.visualization.utils</span> <span class="kn">import</span> <span class="n">plot_contour_line</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>
</pre></div>
</div>
</div>
</section>
<section id="Model-and-dataset">
<h2>Model and dataset<a class="headerlink" href="#Model-and-dataset" title="Permalink to this headline">#</a></h2>
<p>First we define the source model, here we need only a spectral model for which we choose a log-parabola</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crab_spectrum</span> <span class="o">=</span> <span class="n">LogParabolaSpectralModel</span><span class="p">(</span>
    <span class="n">amplitude</span><span class="o">=</span><span class="mf">1e-11</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">,</span>
    <span class="n">reference</span><span class="o">=</span><span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">2.3</span><span class="p">,</span>
    <span class="n">beta</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">crab_spectrum</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">crab_spectrum</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">crab_model</span> <span class="o">=</span> <span class="n">SkyModel</span><span class="p">(</span><span class="n">spectral_model</span><span class="o">=</span><span class="n">crab_spectrum</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;crab&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The data and background are read from pre-computed ON/OFF datasets of HESS observations, for simplicity we stack them together. Then we set the model and fit range to the resulting dataset.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">obs_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">23523</span><span class="p">,</span> <span class="mi">23526</span><span class="p">]:</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">SpectrumDatasetOnOff</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;$GAMMAPY_DATA/joint-crab/spectra/hess/pha_obs</span><span class="si">{</span><span class="n">obs_id</span><span class="si">}</span><span class="s2">.fits&quot;</span>
    <span class="p">)</span>
    <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

<span class="n">dataset_hess</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span><span class="o">.</span><span class="n">stack_reduce</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;HESS&quot;</span><span class="p">)</span>
<span class="n">datasets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">datasets</span><span class="o">=</span><span class="p">[</span><span class="n">dataset_hess</span><span class="p">])</span>

<span class="c1"># Set model and fit range</span>
<span class="n">dataset_hess</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">crab_model</span>
<span class="n">e_min</span> <span class="o">=</span> <span class="mf">0.66</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span>
<span class="n">e_max</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span>
<span class="n">dataset_hess</span><span class="o">.</span><span class="n">mask_fit</span> <span class="o">=</span> <span class="n">dataset_hess</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">energy_mask</span><span class="p">(</span><span class="n">e_min</span><span class="p">,</span> <span class="n">e_max</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Fitting-options">
<h2>Fitting options<a class="headerlink" href="#Fitting-options" title="Permalink to this headline">#</a></h2>
<p>First let’s create a <code class="docutils literal notranslate"><span class="pre">Fit</span></code> instance:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scipy_opts</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span>
    <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ftol&quot;</span><span class="p">:</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="s2">&quot;gtol&quot;</span><span class="p">:</span> <span class="mf">1e-05</span><span class="p">},</span>
    <span class="s2">&quot;backend&quot;</span><span class="p">:</span> <span class="s2">&quot;scipy&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">fit_scipy</span> <span class="o">=</span> <span class="n">Fit</span><span class="p">(</span><span class="n">store_trace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optimize_opts</span><span class="o">=</span><span class="n">scipy_opts</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>By default the fit is performed using MINUIT, you can select alternative optimizers and set their option using the <code class="docutils literal notranslate"><span class="pre">optimize_opts</span></code> argument of the <code class="docutils literal notranslate"><span class="pre">Fit.run()</span></code> method. In addition we have specified to store the trace of parameter values of the fit.</p>
<p>Note that, for now, covaraince matrix and errors are computed only for the fitting with MINUIT. However depending on the problem other optimizers can better perform, so sometimes it can be useful to run a pre-fit with alternative optimization methods.</p>
<div class="line-block">
<div class="line">For the “scipy” backend the available options are described in detail here:</div>
<div class="line"><a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html">https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html</a></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">result_scipy</span> <span class="o">=</span> <span class="n">fit_scipy</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 891 ms, sys: 6.08 ms, total: 897 ms
Wall time: 949 ms
</pre></div></div>
</div>
<div class="line-block">
<div class="line">For the “sherpa” backend you can choose the optimization algorithm between method = {“simplex”, “levmar”, “moncar”, “gridsearch”}.</div>
<div class="line">Those methods are described and compared in detail on <a class="reference external" href="http://cxc.cfa.harvard.edu/sherpa/methods/index.html">http://cxc.cfa.harvard.edu/sherpa/methods/index.html</a> The available options of the optimization methods are described on the following page <a class="reference external" href="https://cxc.cfa.harvard.edu/sherpa/methods/opt_methods.html">https://cxc.cfa.harvard.edu/sherpa/methods/opt_methods.html</a></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">sherpa_opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;simplex&quot;</span><span class="p">,</span> <span class="s2">&quot;ftol&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="s2">&quot;maxfev&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e4</span><span class="p">)}</span>
<span class="n">fit_sherpa</span> <span class="o">=</span> <span class="n">Fit</span><span class="p">(</span><span class="n">store_trace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;sherpa&quot;</span><span class="p">,</span> <span class="n">optimize_opts</span><span class="o">=</span><span class="n">sherpa_opts</span><span class="p">)</span>
<span class="n">results_simplex</span> <span class="o">=</span> <span class="n">fit_sherpa</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
No covariance estimate - not supported by this backend.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 1.16 s, sys: 12.6 ms, total: 1.17 s
Wall time: 1.34 s
</pre></div></div>
</div>
<p>For the “minuit” backend see <a class="reference external" href="https://iminuit.readthedocs.io/en/latest/reference.html">https://iminuit.readthedocs.io/en/latest/reference.html</a> for a detailed description of the available options. If there is an entry ‘migrad_opts’, those options will be passed to <a class="reference external" href="https://iminuit.readthedocs.io/en/latest/reference.html#iminuit.Minuit.migrad">iminuit.Minuit.migrad</a>. Additionally you can set the fit tolerance using the <a class="reference external" href="https://iminuit.readthedocs.io/en/latest/reference.html#iminuit.Minuit.tol">tol</a> option. The minimization will stop when the
estimated distance to the minimum is less than 0.001*tol (by default tol=0.1). The <a class="reference external" href="https://iminuit.readthedocs.io/en/latest/reference.html#iminuit.Minuit.strategy">strategy</a> option change the speed and accuracy of the optimizer: 0 fast, 1 default, 2 slow but accurate. If you want more reliable error estimates, you should run the final fit with strategy 2.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">fit</span> <span class="o">=</span> <span class="n">Fit</span><span class="p">(</span><span class="n">store_trace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">minuit_opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tol&quot;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span> <span class="s2">&quot;strategy&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="n">fit</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="s2">&quot;minuit&quot;</span>
<span class="n">fit</span><span class="o">.</span><span class="n">optimize_opts</span> <span class="o">=</span> <span class="n">minuit_opts</span>
<span class="n">result_minuit</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 334 ms, sys: 1.67 ms, total: 335 ms
Wall time: 364 ms
</pre></div></div>
</div>
</section>
<section id="Fit-quality-assessment">
<h2>Fit quality assessment<a class="headerlink" href="#Fit-quality-assessment" title="Permalink to this headline">#</a></h2>
<p>There are various ways to check the convergence and quality of a fit. Among them:</p>
<p>Refer to the automatically-generated results dictionary:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">result_scipy</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
OptimizeResult

        backend    : scipy
        method     : L-BFGS-B
        success    : True
        message    : CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH
        nfev       : 60
        total stat : 30.35

CovarianceResult

        backend    : minuit
        method     : hesse
        success    : True
        message    : Hesse terminated successfully.

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">results_simplex</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
OptimizeResult

        backend    : sherpa
        method     : simplex
        success    : True
        message    : Optimization terminated successfully
        nfev       : 135
        total stat : 30.35


</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">result_minuit</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
OptimizeResult

        backend    : minuit
        method     : migrad
        success    : True
        message    : Optimization terminated successfully.
        nfev       : 37
        total stat : 30.35

CovarianceResult

        backend    : minuit
        method     : hesse
        success    : True
        message    : Hesse terminated successfully.

</pre></div></div>
</div>
<p>If the fit is performed with minuit you can print detailed informations to check the convergence</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">fit</span><span class="o">.</span><span class="n">minuit</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
┌─────────────────────────────────────────────────────────────────────────┐
│                                Migrad                                   │
├──────────────────────────────────┬──────────────────────────────────────┤
│ FCN = 30.35                      │              Nfcn = 37               │
│ EDM = 3.42e-08 (Goal: 2e-06)     │            time = 0.3 sec            │
├──────────────────────────────────┼──────────────────────────────────────┤
│          Valid Minimum           │        No Parameters at limit        │
├──────────────────────────────────┼──────────────────────────────────────┤
│ Below EDM threshold (goal x 10)  │           Below call limit           │
├───────────────┬──────────────────┼───────────┬─────────────┬────────────┤
│  Covariance   │     Hesse ok     │ Accurate  │  Pos. def.  │ Not forced │
└───────────────┴──────────────────┴───────────┴─────────────┴────────────┘
┌───┬───────────────────┬───────────┬───────────┬────────────┬────────────┬─────────┬─────────┬───────┐
│   │ Name              │   Value   │ Hesse Err │ Minos Err- │ Minos Err+ │ Limit-  │ Limit+  │ Fixed │
├───┼───────────────────┼───────────┼───────────┼────────────┼────────────┼─────────┼─────────┼───────┤
│ 0 │ par_000_amplitude │    3.8    │    0.4    │            │            │         │         │       │
│ 1 │ par_001_alpha     │   2.20    │   0.26    │            │            │    1    │    3    │       │
│ 2 │ par_002_beta      │    2.3    │    1.4    │            │            │         │         │       │
└───┴───────────────────┴───────────┴───────────┴────────────┴────────────┴─────────┴─────────┴───────┘
┌───────────────────┬───────────────────────────────────────────────────────┐
│                   │ par_000_amplitude     par_001_alpha      par_002_beta │
├───────────────────┼───────────────────────────────────────────────────────┤
│ par_000_amplitude │             0.126            0.0455            -0.117 │
│     par_001_alpha │            0.0455            0.0689            -0.331 │
│      par_002_beta │            -0.117            -0.331              1.95 │
└───────────────────┴───────────────────────────────────────────────────────┘
</pre></div></div>
</div>
<p>Check the trace of the fit e.g. in case the fit did not converge properly</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result_minuit</span><span class="o">.</span><span class="n">trace</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div><i>Table length=37</i>
<table id="table5380318112" class="table-striped table-bordered table-condensed">
<thead><tr><th>total_stat</th><th>crab.spectral.amplitude</th><th>crab.spectral.alpha</th><th>crab.spectral.beta</th></tr></thead>
<thead><tr><th>float64</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>30.349530550325255</td><td>3.8122425674284106e-11</td><td>2.1957469091805755</td><td>0.22648273578364578</td></tr>
<tr><td>30.349724600978675</td><td>3.815794007969182e-11</td><td>2.1957469091805755</td><td>0.22648273578364578</td></tr>
<tr><td>30.34971176151139</td><td>3.808691126887639e-11</td><td>2.1957469091805755</td><td>0.22648273578364578</td></tr>
<tr><td>30.349539326519338</td><td>3.812951390605948e-11</td><td>2.1957469091805755</td><td>0.22648273578364578</td></tr>
<tr><td>30.34953672274676</td><td>3.811533744250873e-11</td><td>2.1957469091805755</td><td>0.22648273578364578</td></tr>
<tr><td>30.3505104228728</td><td>3.8122425674284106e-11</td><td>2.198426705199531</td><td>0.22648273578364578</td></tr>
<tr><td>30.35054551385892</td><td>3.8122425674284106e-11</td><td>2.193065650633642</td><td>0.22648273578364578</td></tr>
<tr><td>30.349539006651455</td><td>3.8122425674284106e-11</td><td>2.196014954926682</td><td>0.22648273578364578</td></tr>
<tr><td>30.349542042334622</td><td>3.8122425674284106e-11</td><td>2.1954788488091803</td><td>0.22648273578364578</td></tr>
<tr><td>30.350296409242155</td><td>3.8122425674284106e-11</td><td>2.1957469091805755</td><td>0.2278906654195459</td></tr>
<tr><td>30.35033408445651</td><td>3.8122425674284106e-11</td><td>2.1957469091805755</td><td>0.22507480614774567</td></tr>
<tr><td>30.349536755895077</td><td>3.8122425674284106e-11</td><td>2.1957469091805755</td><td>0.2266235287472358</td></tr>
<tr><td>30.349540038577654</td><td>3.8122425674284106e-11</td><td>2.1957469091805755</td><td>0.22634194282005576</td></tr>
<tr><td>30.349530632842416</td><td>3.8121808354793116e-11</td><td>2.1957673049293085</td><td>0.2264974606416853</td></tr>
<tr><td>30.34953046738743</td><td>3.812216974144315e-11</td><td>2.1957553650099086</td><td>0.22648884052325902</td></tr>
<tr><td>...</td><td>...</td><td>...</td><td>...</td></tr>
<tr><td>30.349537982422092</td><td>3.812925797449946e-11</td><td>2.1957553650099086</td><td>0.22648884052325902</td></tr>
<tr><td>30.34953790113525</td><td>3.811508150838685e-11</td><td>2.1957553650099086</td><td>0.22648884052325902</td></tr>
<tr><td>30.34953814541436</td><td>3.812216974144315e-11</td><td>2.195987401879436</td><td>0.22648884052325902</td></tr>
<tr><td>30.349537737104967</td><td>3.812216974144315e-11</td><td>2.195523317180202</td><td>0.22648884052325902</td></tr>
<tr><td>30.349537804498436</td><td>3.812216974144315e-11</td><td>2.1957553650099086</td><td>0.22662625014703108</td></tr>
<tr><td>30.349538077786526</td><td>3.812216974144315e-11</td><td>2.1957553650099086</td><td>0.22635143089948695</td></tr>
<tr><td>30.34953077465572</td><td>3.8123587388054416e-11</td><td>2.1957553650099086</td><td>0.22648884052325902</td></tr>
<tr><td>30.349530758070323</td><td>3.8120752094831896e-11</td><td>2.1957553650099086</td><td>0.22648884052325902</td></tr>
<tr><td>30.34953080747104</td><td>3.812216974144315e-11</td><td>2.1958017732610444</td><td>0.22648884052325902</td></tr>
<tr><td>30.349530725213548</td><td>3.812216974144315e-11</td><td>2.1957089563203662</td><td>0.22648884052325902</td></tr>
<tr><td>30.3495307394458</td><td>3.812216974144315e-11</td><td>2.1957553650099086</td><td>0.22651632244801345</td></tr>
<tr><td>30.34953079322938</td><td>3.812216974144315e-11</td><td>2.1957553650099086</td><td>0.2264613585985046</td></tr>
<tr><td>30.349535814961794</td><td>3.812925797449946e-11</td><td>2.195987401879436</td><td>0.22648884052325902</td></tr>
<tr><td>30.34953715891958</td><td>3.812925797449946e-11</td><td>2.1957553650099086</td><td>0.22662625014703108</td></tr>
<tr><td>30.349559366919607</td><td>3.812216974144315e-11</td><td>2.195987401879436</td><td>0.22662625014703108</td></tr>
</table></div></div>
</div>
<p>Check that the fitted values and errors for all parameters are reasonable, and no fitted parameter value is “too close” - or even outside - its allowed min-max range</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result_minuit</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">to_table</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div><i>Table length=4</i>
<table id="table5381999776" class="table-striped table-bordered table-condensed">
<thead><tr><th>type</th><th>name</th><th>value</th><th>unit</th><th>error</th><th>min</th><th>max</th><th>frozen</th><th>is_norm</th><th>link</th></tr></thead>
<thead><tr><th>str8</th><th>str9</th><th>float64</th><th>str14</th><th>float64</th><th>float64</th><th>float64</th><th>bool</th><th>bool</th><th>str1</th></tr></thead>
<tr><td>spectral</td><td>amplitude</td><td>3.8122e-11</td><td>cm-2 s-1 TeV-1</td><td>3.546e-12</td><td>nan</td><td>nan</td><td>False</td><td>True</td><td></td></tr>
<tr><td>spectral</td><td>reference</td><td>1.0000e+00</td><td>TeV</td><td>0.000e+00</td><td>nan</td><td>nan</td><td>True</td><td>False</td><td></td></tr>
<tr><td>spectral</td><td>alpha</td><td>2.1958e+00</td><td></td><td>2.626e-01</td><td>1.000e+00</td><td>3.000e+00</td><td>False</td><td>False</td><td></td></tr>
<tr><td>spectral</td><td>beta</td><td>2.2649e-01</td><td></td><td>1.397e-01</td><td>nan</td><td>nan</td><td>False</td><td>False</td><td></td></tr>
</table></div></div>
</div>
<p>Plot fit statistic profiles for all fitted parameters, using <code class="docutils literal notranslate"><a href='../../api/gammapy.modeling.Fit.html#gammapy.modeling.Fit.stat_profile'>gammapy.modeling.Fit.stat_profile()</a></code>. For a good fit and error estimate each profile should be parabolic. The specification for each fit statistic profile can be changed on the <code class="docutils literal notranslate"><a href='../../api/gammapy.modeling.Parameter.html#gammapy.modeling.Parameter'>gammapy.modeling.Parameter</a></code> object, which has <code class="docutils literal notranslate"><span class="pre">.scan_min</span></code>, <code class="docutils literal notranslate"><span class="pre">.scan_max</span></code>, <code class="docutils literal notranslate"><span class="pre">.scan_n_values</span></code> and <code class="docutils literal notranslate"><span class="pre">.scan_n_sigma</span></code> attributes.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total_stat</span> <span class="o">=</span> <span class="n">result_minuit</span><span class="o">.</span><span class="n">total_stat</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">par</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">crab_model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">free_parameters</span><span class="p">):</span>
    <span class="n">par</span><span class="o">.</span><span class="n">scan_n_values</span> <span class="o">=</span> <span class="mi">17</span>

    <span class="n">profile</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">stat_profile</span><span class="p">(</span><span class="n">datasets</span><span class="o">=</span><span class="n">datasets</span><span class="p">,</span> <span class="n">parameter</span><span class="o">=</span><span class="n">par</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_scan&quot;</span><span class="p">],</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;stat_scan&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">total_stat</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">par</span><span class="o">.</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Delta TS&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">par</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.1e</span><span class="si">}</span><span class="s2"> +- </span><span class="si">{</span><span class="n">par</span><span class="o">.</span><span class="n">error</span><span class="si">:</span><span class="s2">.1e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_api_fitting_26_0.png" src="../../_images/tutorials_api_fitting_26_0.png" />
</div>
</div>
<p>Inspect model residuals. Those can always be accessed using <code class="docutils literal notranslate"><span class="pre">~Dataset.residuals()</span></code>, that will return an array in case a the fitted <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> is a <code class="docutils literal notranslate"><span class="pre">SpectrumDataset</span></code> and a full cube in case of a <code class="docutils literal notranslate"><span class="pre">MapDataset</span></code>. For more details, we refer here to the dedicated fitting tutorials: <a class="reference internal" href="../analysis/3D/analysis_3d.html"><span class="doc">analysis_3d.ipynb</span></a> (for <code class="docutils literal notranslate"><span class="pre">MapDataset</span></code> fitting) and <a class="reference internal" href="../analysis/1D/spectral_analysis.html"><span class="doc">spectrum_analysis.ipynb</span></a> (for <code class="docutils literal notranslate"><span class="pre">SpectrumDataset</span></code> fitting).</p>
</section>
<section id="Covariance-and-parameters-errors">
<h2>Covariance and parameters errors<a class="headerlink" href="#Covariance-and-parameters-errors" title="Permalink to this headline">#</a></h2>
<p>After the fit the covariance matrix is attached to the model. You can get the error on a specific parameter by accessing the <code class="docutils literal notranslate"><span class="pre">.error</span></code> attribute:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crab_model</span><span class="o">.</span><span class="n">spectral_model</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">error</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.2625818137415194
</pre></div></div>
</div>
<p>And you can plot the total parameter correlation as well:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crab_model</span><span class="o">.</span><span class="n">covariance</span><span class="o">.</span><span class="n">plot_correlation</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;AxesSubplot:&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_api_fitting_31_1.png" src="../../_images/tutorials_api_fitting_31_1.png" />
</div>
</div>
<p>As an example, this step is needed to produce a butterfly plot showing the envelope of the model taking into account parameter uncertainties.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">energy_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span>
<span class="n">crab_spectrum</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energy_bounds</span><span class="o">=</span><span class="n">energy_bounds</span><span class="p">,</span> <span class="n">energy_power</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">crab_spectrum</span><span class="o">.</span><span class="n">plot_error</span><span class="p">(</span><span class="n">energy_bounds</span><span class="o">=</span><span class="n">energy_bounds</span><span class="p">,</span> <span class="n">energy_power</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_api_fitting_33_0.png" src="../../_images/tutorials_api_fitting_33_0.png" />
</div>
</div>
</section>
<section id="Confidence-contours">
<h2>Confidence contours<a class="headerlink" href="#Confidence-contours" title="Permalink to this headline">#</a></h2>
<p>In most studies, one wishes to estimate parameters distribution using observed sample data. A 1-dimensional confidence interval gives an estimated range of values which is likely to include an unknown parameter. A confidence contour is a 2-dimensional generalization of a confidence interval, often represented as an ellipsoid around the best-fit value.</p>
<p>Gammapy offers two ways of computing confidence contours, in the dedicated methods <code class="docutils literal notranslate"><span class="pre">Fit.minos_contour()</span></code> and <code class="docutils literal notranslate"><span class="pre">Fit.stat_profile()</span></code>. In the following sections we will describe them.</p>
<p>An important point to keep in mind is: <em>what does a :math:`Nsigma` confidence contour really mean?</em> The answer is it represents the points of the parameter space for which the model likelihood is <span class="math notranslate nohighlight">\(N\sigma\)</span> above the minimum. But one always has to keep in mind that <strong>1 standard deviation in two dimensions has a smaller coverage probability than 68%</strong>, and similarly for all other levels. In particular, in 2-dimensions the probability enclosed by the <span class="math notranslate nohighlight">\(N\sigma\)</span> confidence contour is
<span class="math notranslate nohighlight">\(P(N)=1-e^{-N^2/2}\)</span>.</p>
<section id="Computing-contours-using-Fit.stat_contour()">
<h3>Computing contours using <code class="docutils literal notranslate"><span class="pre">Fit.stat_contour()</span></code><a class="headerlink" href="#Computing-contours-using-Fit.stat_contour()" title="Permalink to this headline">#</a></h3>
<p>After the fit, MINUIT offers the possibility to compute the confidence confours. gammapy provides an interface to this functionality through the <code class="docutils literal notranslate"><span class="pre">Fit</span></code> object using the <code class="docutils literal notranslate"><span class="pre">.stat_contour</span></code> method. Here we defined a function to automate the contour production for the different parameterer and confidence levels (expressed in term of sigma):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_contours</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">npoints</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">):</span>
    <span class="n">cts_sigma</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sigma</span> <span class="ow">in</span> <span class="n">sigmas</span><span class="p">:</span>
        <span class="n">contours</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">par_1</span><span class="p">,</span> <span class="n">par_2</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">([</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;amplitude&quot;</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">contour</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">stat_contour</span><span class="p">(</span>
                <span class="n">datasets</span><span class="o">=</span><span class="n">datasets</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="n">datasets</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">par_1</span><span class="p">],</span>
                <span class="n">y</span><span class="o">=</span><span class="n">datasets</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">par_2</span><span class="p">],</span>
                <span class="n">numpoints</span><span class="o">=</span><span class="n">npoints</span><span class="p">,</span>
                <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">contours</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;contour_</span><span class="si">{</span><span class="n">par_1</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">par_2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">par_1</span><span class="p">:</span> <span class="n">contour</span><span class="p">[</span><span class="n">par_1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="n">par_2</span><span class="p">:</span> <span class="n">contour</span><span class="p">[</span><span class="n">par_2</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="p">}</span>
        <span class="n">cts_sigma</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contours</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cts_sigma</span>
</pre></div>
</div>
</div>
<p>Now we can compute few contours.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">sigmas</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">cts_sigma</span> <span class="o">=</span> <span class="n">make_contours</span><span class="p">(</span>
    <span class="n">fit</span><span class="o">=</span><span class="n">fit</span><span class="p">,</span>
    <span class="n">datasets</span><span class="o">=</span><span class="n">datasets</span><span class="p">,</span>
    <span class="n">result</span><span class="o">=</span><span class="n">result_minuit</span><span class="p">,</span>
    <span class="n">npoints</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">sigmas</span><span class="o">=</span><span class="n">sigmas</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 29.3 s, sys: 88.5 ms, total: 29.3 s
Wall time: 31.5 s
</pre></div></div>
</div>
<p>Then we prepare some aliases and annotations in order to make the plotting nicer.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pars</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;phi&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$\phi_0 \,/\,(10^{-11}\,{\rm TeV}^{-1} \, {\rm cm}^{-2} {\rm s}^{-1})$&quot;</span><span class="p">,</span>
    <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$\alpha$&quot;</span><span class="p">,</span>
    <span class="s2">&quot;beta&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$\beta$&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">panels</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;alpha&quot;</span><span class="p">,</span>
        <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;phi&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cx&quot;</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">ct</span><span class="p">:</span> <span class="n">ct</span><span class="p">[</span><span class="s2">&quot;contour_alpha_amplitude&quot;</span><span class="p">][</span><span class="s2">&quot;alpha&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;cy&quot;</span><span class="p">:</span> <span class="p">(</span>
            <span class="k">lambda</span> <span class="n">ct</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">1e11</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">ct</span><span class="p">[</span><span class="s2">&quot;contour_alpha_amplitude&quot;</span><span class="p">][</span><span class="s2">&quot;amplitude&quot;</span><span class="p">]</span>
        <span class="p">),</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span>
        <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;phi&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cx&quot;</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">ct</span><span class="p">:</span> <span class="n">ct</span><span class="p">[</span><span class="s2">&quot;contour_beta_amplitude&quot;</span><span class="p">][</span><span class="s2">&quot;beta&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;cy&quot;</span><span class="p">:</span> <span class="p">(</span>
            <span class="k">lambda</span> <span class="n">ct</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">1e11</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">ct</span><span class="p">[</span><span class="s2">&quot;contour_beta_amplitude&quot;</span><span class="p">][</span><span class="s2">&quot;amplitude&quot;</span><span class="p">]</span>
        <span class="p">),</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;alpha&quot;</span><span class="p">,</span>
        <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cx&quot;</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">ct</span><span class="p">:</span> <span class="n">ct</span><span class="p">[</span><span class="s2">&quot;contour_alpha_beta&quot;</span><span class="p">][</span><span class="s2">&quot;alpha&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;cy&quot;</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">ct</span><span class="p">:</span> <span class="n">ct</span><span class="p">[</span><span class="s2">&quot;contour_alpha_beta&quot;</span><span class="p">][</span><span class="s2">&quot;beta&quot;</span><span class="p">]),</span>
    <span class="p">},</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<p>Finally we produce the confidence contours figures.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">panels</span><span class="p">,</span> <span class="n">axes</span><span class="p">):</span>
    <span class="n">xlabel</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]]</span>
    <span class="n">ylabel</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">ks</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cts_sigma</span><span class="p">)):</span>
        <span class="n">plot_contour_line</span><span class="p">(</span>
            <span class="n">ax</span><span class="p">,</span>
            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;cx&quot;</span><span class="p">](</span><span class="n">cts_sigma</span><span class="p">[</span><span class="n">ks</span><span class="p">]),</span>
            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;cy&quot;</span><span class="p">](</span><span class="n">cts_sigma</span><span class="p">[</span><span class="n">ks</span><span class="p">]),</span>
            <span class="n">lw</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">ks</span><span class="p">],</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sigmas</span><span class="p">[</span><span class="n">ks</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;$\sigma$&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_api_fitting_44_0.png" src="../../_images/tutorials_api_fitting_44_0.png" />
</div>
</div>
</section>
<section id="Computing-contours-using-Fit.stat_surface()">
<h3>Computing contours using <code class="docutils literal notranslate"><span class="pre">Fit.stat_surface()</span></code><a class="headerlink" href="#Computing-contours-using-Fit.stat_surface()" title="Permalink to this headline">#</a></h3>
<p>This alternative method for the computation of confidence contours, although more time consuming than <code class="docutils literal notranslate"><span class="pre">Fit.minos_contour()</span></code>, is expected to be more stable. It consists of a generalization of <code class="docutils literal notranslate"><span class="pre">Fit.stat_profile()</span></code> to a 2-dimensional parameter space. The algorithm is very simple: - First, passing two arrays of parameters values, a 2-dimensional discrete parameter space is defined; - For each node of the parameter space, the two parameters of interest are frozen. This way, a likelihood value
(<span class="math notranslate nohighlight">\(-2\mathrm{ln}\,\mathcal{L}\)</span>, actually) is computed, by either freezing (default) or fitting all nuisance parameters; - Finally, a 2-dimensional surface of <span class="math notranslate nohighlight">\(-2\mathrm{ln}(\mathcal{L})\)</span> values is returned. Using that surface, one can easily compute a surface of <span class="math notranslate nohighlight">\(TS = -2\Delta\mathrm{ln}(\mathcal{L})\)</span> and compute confidence contours.</p>
<p>Let’s see it step by step.</p>
<p>First of all, we can notice that this method is “backend-agnostic”, meaning that it can be run with MINUIT, sherpa or scipy as fitting tools. Here we will stick with MINUIT, which is the default choice:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<p>As an example, we can compute the confidence contour for the <code class="docutils literal notranslate"><span class="pre">alpha</span></code> and <code class="docutils literal notranslate"><span class="pre">beta</span></code> parameters of the <code class="docutils literal notranslate"><span class="pre">dataset_hess</span></code>. Here we define the parameter space:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">result_minuit</span>
<span class="n">par_alpha</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>
<span class="n">par_beta</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span>

<span class="n">par_alpha</span><span class="o">.</span><span class="n">scan_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.55</span><span class="p">,</span> <span class="mf">2.7</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">par_beta</span><span class="o">.</span><span class="n">scan_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Then we run the algorithm, by choosing <code class="docutils literal notranslate"><span class="pre">reoptimize=False</span></code> for the sake of time saving. In real life applications, we strongly recommend to use <code class="docutils literal notranslate"><span class="pre">reoptimize=True</span></code>, so that all free nuisance parameters will be fit at each grid node. This is the correct way, statistically speaking, of computing confidence contours, but is expected to be time consuming.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fit</span> <span class="o">=</span> <span class="n">Fit</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s2">&quot;minuit&quot;</span><span class="p">,</span> <span class="n">optimize_opts</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;print_level&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
<span class="n">stat_surface</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">stat_surface</span><span class="p">(</span>
    <span class="n">datasets</span><span class="o">=</span><span class="n">datasets</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="n">par_alpha</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">par_beta</span><span class="p">,</span>
    <span class="n">reoptimize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>In order to easily inspect the results, we can convert the <span class="math notranslate nohighlight">\(-2\mathrm{ln}(\mathcal{L})\)</span> surface to a surface of statistical significance (in units of Gaussian standard deviations from the surface minimum):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute TS</span>
<span class="n">TS</span> <span class="o">=</span> <span class="n">stat_surface</span><span class="p">[</span><span class="s2">&quot;stat_scan&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="o">.</span><span class="n">total_stat</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the corresponding statistical significance surface</span>
<span class="n">stat_surface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">TS</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Notice that, as explained before, <span class="math notranslate nohighlight">\(1\sigma\)</span> contour obtained this way will not contain 68% of the probability, but rather</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the corresponding statistical significance surface</span>
<span class="c1"># p_value = 1 - st.chi2(df=1).cdf(TS)</span>
<span class="c1"># gaussian_sigmas = st.norm.isf(p_value / 2).T</span>
</pre></div>
</div>
</div>
<p>Finally, we can plot the surface values together with contours:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">x_values</span> <span class="o">=</span> <span class="n">par_alpha</span><span class="o">.</span><span class="n">scan_values</span>
<span class="n">y_values</span> <span class="o">=</span> <span class="n">par_beta</span><span class="o">.</span><span class="n">scan_values</span>

<span class="c1"># plot surface</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">y_values</span><span class="p">,</span> <span class="n">stat_surface</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;sqrt(TS)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">par_alpha</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">par_beta</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># We choose to plot 1 and 2 sigma confidence contours</span>
<span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">contours</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span>
    <span class="n">x_values</span><span class="p">,</span> <span class="n">y_values</span><span class="p">,</span> <span class="n">stat_surface</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;white&quot;</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">contours</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.0f</span><span class="s2">$\,\sigma$&quot;</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_api_fitting_59_0.png" src="../../_images/tutorials_api_fitting_59_0.png" />
</div>
</div>
<p>Note that, if computed with <code class="docutils literal notranslate"><span class="pre">reoptimize=True</span></code>, this plot would be completely consistent with the third panel of the plot produced with <code class="docutils literal notranslate"><span class="pre">Fit.stat_contour</span></code> (try!).</p>
<p>Finally, it is always remember that confidence contours are approximations. In particular, when the parameter range boundaries are close to the contours lines, it is expected that the statistical meaning of the contours is not well defined. That’s why we advise to always choose a parameter space that com contain the contours you’re interested in.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


              </div>
              
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, The Gammapy developers.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>