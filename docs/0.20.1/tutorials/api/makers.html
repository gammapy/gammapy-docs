
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Makers - Data reduction &#8212; gammapy v0.20.1</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gammapy.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="shortcut icon" href="../../_static/gammapy_logo.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="3D map simulation" href="../analysis/3D/simulate_3d.html" />
    <link rel="prev" title="Ring background" href="../../user-guide/makers/ring.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../index.html">
  <img src="../../_static/gammapy_logo_nav.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../getting-started/index.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../user-guide/index.html">
  User guide
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../api-reference/index.html">
  API reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../development/index.html">
  Developer guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../release-notes/index.html">
  Release notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-primary btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        0.20.1  <!-- this text may get changed later by javascript -->
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
</div>

<!-- NOTE: this JS must live here (not in our global JS file) because it relies
     on being processed by Jinja before it is run (specifically for replacing
     variables tutorials/api/makers and {'json_url': 'https://docs.gammapy.org/stable/switcher.json', 'version_match': '0.20.1'}.
-->

<script type="text/javascript">
// Check if corresponding page path exists in other version of docs
// and, if so, go there instead of the homepage of the other docs version
function checkPageExistsAndRedirect(event) {
    const currentFilePath = "tutorials/api/makers.html",
          tryUrl = event.target.getAttribute("href");
    let otherDocsHomepage = tryUrl.replace(currentFilePath, "");
    $.ajax({
        type: 'HEAD',
        url: tryUrl,
        // if the page exists, go there
        success: function() {
            location.href = tryUrl;
        }
    }).fail(function() {
        location.href = otherDocsHomepage;
    });
    // this prevents the browser from following the href of the clicked node
    // (which is fine because this function takes care of redirecting)
    return false;
}

// Populate the version switcher from the JSON config file
(function () {
    $.getJSON("https://docs.gammapy.org/stable/switcher.json", function(data, textStatus, jqXHR) {
        const currentFilePath = "tutorials/api/makers.html";
        // create links to the corresponding page in the other docs versions
        $.each(data, function(index, entry) {
            // if no custom name specified (e.g., "latest"), use version string
            if (!("name" in entry)) {
                entry.name = entry.version;
            }
            // create the node
            const node = document.createElement("a");
            node.setAttribute("class", "list-group-item list-group-item-action py-1");
            node.textContent = `${entry.name}`;
            node.setAttribute("href", `${entry.url}${currentFilePath}`);
            // on click, AJAX calls will check if the linked page exists before
            // trying to redirect, and if not, will redirect to the homepage
            // for that version of the docs.
            node.onclick = checkPageExistsAndRedirect;
            // Add dataset values for the version and name in case people want
            // to apply CSS styling based on this information.
            node.dataset["versionName"] = entry.name;
            node.dataset["version"] = entry.version;

            $("#version_switcher_menu").append(node);
            // replace dropdown button text with the preferred display name of
            // this version, rather than using sphinx's 0.20.1 variable.
            // also highlight the dropdown entry for the currently-viewed
            // version's entry
            if (entry.version == "0.20.1") {
                node.classList.add("active");
                let btn = document.getElementById("version_switcher_button");
                btn.innerText = btn.dataset["activeVersionName"] = entry.name;
                btn.dataset["activeVersion"] = entry.version;
            }
        });
    });
})();
</script>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/gammapy/gammapy" rel="noopener" target="_blank" title="Github"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">Github</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/gammapyST" rel="noopener" target="_blank" title="Twitter"><span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://gammapy.slack.com/" rel="noopener" target="_blank" title="Slack"><span><i class="fab fa-slack"></i></span>
            <label class="sr-only">Slack</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../starting/analysis_1.html">
   High level interface
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../starting/analysis_2.html">
   Low level API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../starting/overview.html">
   Data structures
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../data/cta.html">
   CTA with Gammapy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data/hess.html">
   H.E.S.S. with Gammapy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data/fermi_lat.html">
   Fermi-LAT with Gammapy
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/1D/spectral_analysis.html">
   Spectral analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/1D/spectral_analysis_rad_max.html">
   Spectral analysis with energy-dependent directional cuts
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/1D/sed_fitting.html">
   Flux point fitting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/1D/extended_source_spectral_analysis.html">
   Spectral analysis of extended sources
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/1D/spectrum_simulation.html">
   1D spectrum simulation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/1D/cta_sensitivity.html">
   Point source sensitivity
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/2D/ring_background.html">
   Ring background map
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/2D/modeling_2D.html">
   2D map fitting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/2D/detect.html">
   Source detection and significance maps
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/3D/cta_data_analysis.html">
   Basic image exploration and fitting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/3D/analysis_3d.html">
   3D detailed analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/3D/simulate_3d.html">
   3D map simulation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/3D/analysis_mwl.html">
   Multi instrument joint 3D and 1D analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/3D/event_sampling.html">
   Event sampling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/3D/flux_profiles.html">
   Flux Profile Estimation
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/time/light_curve_simulation.html">
   Simulating and fitting a time varying source
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/time/light_curve.html">
   Light curves
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/time/light_curve_flare.html">
   Light curves for flares
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/time/pulsar_analysis.html">
   Pulsar analysis
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Makers - Data reduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="catalog.html">
   Source catalogs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="models.html">
   Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="model_management.html">
   Modelling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="fitting.html">
   Fitting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="maps.html">
   Maps
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mask_maps.html">
   Mask maps
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="astro_dark_matter.html">
   Dark matter spatial and spectral models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="datasets.html">
   Datasets - Reduced data, IRFs, models
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../survey_map.html">
   Survey map
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Setup">
   Setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Dataset">
   Dataset
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Safe-data-range-handling">
   Safe data range handling
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Background-estimation">
   Background estimation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#FoV-background">
     FoV background
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Ring-background">
     Ring background
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Reflected-regions-background">
     Reflected regions background
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Data-reduction-loop">
   Data reduction loop
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Spectrum-dataset">
   Spectrum dataset
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<div class="admonition note">
<p class="admonition-title"><strong>This is a fixed-text formatted version of a Jupyter notebook</strong></p>
<ul class="simple">
<li><p>Try online<a class="reference external" href="https://mybinder.org/v2/gh/gammapy/gammapy-webpage/v0.20.1?urlpath=lab/tree/tutorials/api/makers.ipynb"><img alt="Binder" src="https://static.mybinder.org/badge.svg" /></a></p></li>
<li><p>You may download all the notebooks as a <a class="reference external" href="../../_downloads/notebooks-0.20.1.tar">tar file</a>.</p></li>
<li><p><strong>Source files:</strong> <a class="reference external" href="../../_static/notebooks/makers.ipynb">makers.ipynb</a> | <a class="reference external" href="../../_static/notebooks/makers.py">makers.py</a></p></li>
</ul>
</div>
<section id="Makers---Data-reduction">
<h1>Makers - Data reduction<a class="headerlink" href="#Makers---Data-reduction" title="Permalink to this headline">#</a></h1>
<section id="Introduction">
<h2>Introduction<a class="headerlink" href="#Introduction" title="Permalink to this headline">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">gammapy.makers</span></code> sub-package contains classes to perform data reduction tasks from DL3 data to binned datasets. In the data reduction step the DL3 data is prepared for modeling and fitting, by binning events into a counts map and interpolating the exposure, background, psf and energy dispersion on the chosen analysis geometry.</p>
</section>
<section id="Setup">
<h2>Setup<a class="headerlink" href="#Setup" title="Permalink to this headline">#</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gammapy.makers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">MapDatasetMaker</span><span class="p">,</span>
    <span class="n">FoVBackgroundMaker</span><span class="p">,</span>
    <span class="n">SafeMaskMaker</span><span class="p">,</span>
    <span class="n">SpectrumDatasetMaker</span><span class="p">,</span>
    <span class="n">ReflectedRegionsBackgroundMaker</span><span class="p">,</span>
    <span class="n">DatasetsMaker</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">gammapy.datasets</span> <span class="kn">import</span> <span class="n">MapDataset</span><span class="p">,</span> <span class="n">SpectrumDataset</span><span class="p">,</span> <span class="n">Datasets</span>
<span class="kn">from</span> <span class="nn">gammapy.data</span> <span class="kn">import</span> <span class="n">DataStore</span>
<span class="kn">from</span> <span class="nn">gammapy.maps</span> <span class="kn">import</span> <span class="n">MapAxis</span><span class="p">,</span> <span class="n">WcsGeom</span><span class="p">,</span> <span class="n">RegionGeom</span>
<span class="kn">from</span> <span class="nn">regions</span> <span class="kn">import</span> <span class="n">CircleSkyRegion</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
</section>
<section id="Dataset">
<h2>Dataset<a class="headerlink" href="#Dataset" title="Permalink to this headline">#</a></h2>
<p>The counts, exposure, background and IRF maps are bundled together in a data structure named <code class="docutils literal notranslate"><span class="pre">MapDataset</span></code>. To handle on-off observations Gammapy also features a <code class="docutils literal notranslate"><span class="pre">MapDatasetOnOff</span></code> class, which stores in addition the <code class="docutils literal notranslate"><span class="pre">counts_off</span></code>, <code class="docutils literal notranslate"><span class="pre">acceptance</span></code> and <code class="docutils literal notranslate"><span class="pre">acceptance_off</span></code> data.</p>
<p>The first step of the data reduction is to create an empty dataset. A <code class="docutils literal notranslate"><span class="pre">MapDataset</span></code> can be created from any <code class="docutils literal notranslate"><span class="pre">WcsGeom</span></code> object. This is illustrated in the following example:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">energy_axis</span> <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_bounds</span><span class="p">(</span>
    <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TeV&quot;</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s2">&quot;log&quot;</span>
<span class="p">)</span>
<span class="n">geom</span> <span class="o">=</span> <span class="n">WcsGeom</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">skydir</span><span class="o">=</span><span class="p">(</span><span class="mf">83.63</span><span class="p">,</span> <span class="mf">22.01</span><span class="p">),</span>
    <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">energy_axis</span><span class="p">],</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">5</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
    <span class="n">binsz</span><span class="o">=</span><span class="mf">0.05</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
    <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;icrs&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">dataset_empty</span> <span class="o">=</span> <span class="n">MapDataset</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">geom</span><span class="o">=</span><span class="n">geom</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dataset_empty</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
MapDataset
----------

  Name                            : d-DyRjC6

  Total counts                    : 0
  Total background counts         : 0.00
  Total excess counts             : 0.00

  Predicted counts                : 0.00
  Predicted background counts     : 0.00
  Predicted excess counts         : nan

  Exposure min                    : 0.00e+00 m2 s
  Exposure max                    : 0.00e+00 m2 s

  Number of total bins            : 110000
  Number of fit bins              : 0

  Fit statistic type              : cash
  Fit statistic value (-2 log(L)) : nan

  Number of models                : 0
  Number of parameters            : 0
  Number of free parameters       : 0


</pre></div></div>
</div>
<p>It is possible to compute the instrument response functions with different spatial and energy binnings as compared to the counts and background maps. For example, one can specify a true energy axis which defines the energy binning of the IRFs:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">energy_axis_true</span> <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_bounds</span><span class="p">(</span>
    <span class="mf">0.3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">31</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy_true&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TeV&quot;</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s2">&quot;log&quot;</span>
<span class="p">)</span>
<span class="n">dataset_empty</span> <span class="o">=</span> <span class="n">MapDataset</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">geom</span><span class="o">=</span><span class="n">geom</span><span class="p">,</span> <span class="n">energy_axis_true</span><span class="o">=</span><span class="n">energy_axis_true</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>For the detail of the other options availables, you can always call the help:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">help</span><span class="p">(</span><span class="n">MapDataset</span><span class="o">.</span><span class="n">create</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Help on method create in module gammapy.datasets.map:

create(geom, energy_axis_true=None, migra_axis=None, rad_axis=None, binsz_irf=None, reference_time=&#39;2000-01-01&#39;, name=None, meta_table=None, **kwargs) method of abc.ABCMeta instance
    Create a MapDataset object with zero filled maps.

    Parameters
    ----------
    geom : `~gammapy.maps.WcsGeom`
        Reference target geometry in reco energy, used for counts and background maps
    energy_axis_true : `~gammapy.maps.MapAxis`
        True energy axis used for IRF maps
    migra_axis : `~gammapy.maps.MapAxis`
        If set, this provides the migration axis for the energy dispersion map.
        If not set, an EDispKernelMap is produced instead. Default is None
    rad_axis : `~gammapy.maps.MapAxis`
        Rad axis for the psf map
    binsz_irf : float
        IRF Map pixel size in degrees.
    reference_time : `~astropy.time.Time`
        the reference time to use in GTI definition
    name : str
        Name of the returned dataset.
    meta_table : `~astropy.table.Table`
        Table listing information on observations used to create the dataset.
        One line per observation for stacked datasets.

    Returns
    -------
    empty_maps : `MapDataset`
        A MapDataset containing zero filled maps

    Examples
    --------
    &gt;&gt;&gt; from gammapy.datasets import MapDataset
    &gt;&gt;&gt; from gammapy.maps import WcsGeom, MapAxis

    &gt;&gt;&gt; energy_axis = MapAxis.from_energy_bounds(1.0, 10.0, 4, unit=&#34;TeV&#34;)
    &gt;&gt;&gt; energy_axis_true = MapAxis.from_energy_bounds( 0.5, 20, 10, unit=&#34;TeV&#34;, name=&#34;energy_true&#34;)
    &gt;&gt;&gt; geom = WcsGeom.create(skydir=(83.633, 22.014), binsz=0.02, width=(2, 2), frame=&#34;icrs&#34;, proj=&#34;CAR&#34;, axes=[energy_axis])

    &gt;&gt;&gt; empty = MapDataset.create(geom=geom, energy_axis_true=energy_axis_true, name=&#34;empty&#34;)

</pre></div></div>
</div>
<p>Once this empty “reference” dataset is defined, it can be filled with observational data using the <code class="docutils literal notranslate"><span class="pre">MapDatasetMaker</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get observation</span>
<span class="n">data_store</span> <span class="o">=</span> <span class="n">DataStore</span><span class="o">.</span><span class="n">from_dir</span><span class="p">(</span><span class="s2">&quot;$GAMMAPY_DATA/hess-dl3-dr1&quot;</span><span class="p">)</span>
<span class="n">obs</span> <span class="o">=</span> <span class="n">data_store</span><span class="o">.</span><span class="n">get_observations</span><span class="p">([</span><span class="mi">23592</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># fill dataset</span>
<span class="n">maker</span> <span class="o">=</span> <span class="n">MapDatasetMaker</span><span class="p">()</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset_empty</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="n">dataset</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">sum_over_axes</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stretch</span><span class="o">=</span><span class="s2">&quot;sqrt&quot;</span><span class="p">,</span> <span class="n">add_cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
MapDataset
----------

  Name                            : HpOefwuJ

  Total counts                    : 2016
  Total background counts         : 1866.72
  Total excess counts             : 149.28

  Predicted counts                : 1866.72
  Predicted background counts     : 1866.72
  Predicted excess counts         : nan

  Exposure min                    : 1.19e+02 m2 s
  Exposure max                    : 1.09e+09 m2 s

  Number of total bins            : 110000
  Number of fit bins              : 110000

  Fit statistic type              : cash
  Fit statistic value (-2 log(L)) : nan

  Number of models                : 0
  Number of parameters            : 0
  Number of free parameters       : 0


</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_api_makers_10_1.png" src="../../_images/tutorials_api_makers_10_1.png" />
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">MapDatasetMaker</span></code> fills the corresponding <code class="docutils literal notranslate"><span class="pre">counts</span></code>, <code class="docutils literal notranslate"><span class="pre">exposure</span></code>, <code class="docutils literal notranslate"><span class="pre">background</span></code>, <code class="docutils literal notranslate"><span class="pre">psf</span></code> and <code class="docutils literal notranslate"><span class="pre">edisp</span></code> map per observation. The <code class="docutils literal notranslate"><span class="pre">MapDatasetMaker</span></code> has a <code class="docutils literal notranslate"><span class="pre">selection</span></code> parameter, in case some of the maps should not be computed. There is also a <code class="docutils literal notranslate"><span class="pre">background_oversampling</span></code> parameter that defines the oversampling factor in energy used to compute the bakcground (default is None).</p>
</section>
<section id="Safe-data-range-handling">
<h2>Safe data range handling<a class="headerlink" href="#Safe-data-range-handling" title="Permalink to this headline">#</a></h2>
<p>To exclude the data range from a <code class="docutils literal notranslate"><span class="pre">MapDataset</span></code>, that is associated with high systematics on instrument response functions, a <code class="docutils literal notranslate"><span class="pre">mask_safe</span></code> can be defined. The <code class="docutils literal notranslate"><span class="pre">mask_safe</span></code> is a <code class="docutils literal notranslate"><span class="pre">Map</span></code> object with <code class="docutils literal notranslate"><span class="pre">bool</span></code> data type, which indicates for each pixel, whether it should be included in the analysis. The convention is that a value of <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">1</span></code> includes the pixel, while a value of <code class="docutils literal notranslate"><span class="pre">False</span></code> or <code class="docutils literal notranslate"><span class="pre">0</span></code> excludes a pixels from the analysis. To compute safe data range masks according to certain
criteria, Gammapy provides a <code class="docutils literal notranslate"><span class="pre">SafeMaskMaker</span></code> class. The different criteria are given by the <code class="docutils literal notranslate"><span class="pre">methods</span></code>argument, available options are :</p>
<ul class="simple">
<li><p>aeff-default, uses the energy ranged specified in the DL3 data files, if available.</p></li>
<li><p>aeff-max, the lower energy threshold is determined such as the effective area is above a given percentage of its maximum</p></li>
<li><p>edisp-bias, the lower energy threshold is determined such as the energy bias is below a given percentage</p></li>
<li><p>offset-max, the data beyond a given offset radius from the observation center are excluded</p></li>
<li><p>bkg-peak, the energy threshold is defined as the upper edge of the energy bin with the highest predicted background rate. This method was introduced in the HESS DL3 validation paper: <a class="reference external" href="https://arxiv.org/pdf/1910.08088.pdf">https://arxiv.org/pdf/1910.08088.pdf</a></p></li>
</ul>
<p>Multiple methods can be combined. Here is an example :</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">safe_mask_maker</span> <span class="o">=</span> <span class="n">SafeMaskMaker</span><span class="p">(</span>
    <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;aeff-default&quot;</span><span class="p">,</span> <span class="s2">&quot;offset-max&quot;</span><span class="p">],</span> <span class="n">offset_max</span><span class="o">=</span><span class="s2">&quot;3 deg&quot;</span>
<span class="p">)</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset_empty</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">safe_mask_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask_safe</span><span class="p">)</span>
<span class="n">dataset</span><span class="o">.</span><span class="n">mask_safe</span><span class="o">.</span><span class="n">sum_over_axes</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
WcsNDMap

        geom  : WcsGeom
        axes  : [&#39;lon&#39;, &#39;lat&#39;, &#39;energy&#39;]
        shape : (100, 100, 11)
        ndim  : 3
        unit  :
        dtype : bool

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_api_makers_12_1.png" src="../../_images/tutorials_api_makers_12_1.png" />
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">SafeMaskMaker</span></code> does not modify any data, but only defines the <code class="docutils literal notranslate"><span class="pre">MapDataset.mask_safe</span></code> attribute. This means that the safe data range can be defined and modified in between the data reduction and stacking and fitting. For a joint-likelihood analysis of multiple observations the safe mask is applied to the counts and predicted number of counts map during fitting. This correctly accounts for contributions (spill-over) by the PSF from outside the field of view.</p>
</section>
<section id="Background-estimation">
<h2>Background estimation<a class="headerlink" href="#Background-estimation" title="Permalink to this headline">#</a></h2>
<p>The background computed by the <code class="docutils literal notranslate"><span class="pre">MapDatasetMaker</span></code> gives the number of counts predicted by the background IRF of the observation. Because its actual normalization, or even its spectral shape, might be poorly constrained, it is necessary to correct it with the data themselves. This is the role of background estimation Makers.</p>
<section id="FoV-background">
<h3>FoV background<a class="headerlink" href="#FoV-background" title="Permalink to this headline">#</a></h3>
<p>If the background energy dependent morphology is well reproduced by the background model stored in the IRF, it might be that its normalization is incorrect and that some spectral corrections are necessary. This is made possible thanks to the <code class="docutils literal notranslate"><a href='../../api/gammapy.makers.FoVBackgroundMaker.html#gammapy.makers.FoVBackgroundMaker'>gammapy.makers.FoVBackgroundMaker</a></code>. This technique is recommended in most 3D data reductions. For more details and usage, see <a class="reference internal" href="../../user-guide/makers/fov.html"><span class="doc">fov_background</span></a>.</p>
<p>Here we are going to use a <code class="docutils literal notranslate"><a href='../../api/gammapy.makers.FoVBackgroundMaker.html#gammapy.makers.FoVBackgroundMaker'>gammapy.makers.FoVBackgroundMaker</a></code> that will rescale the background model to the data excluding the region where a known source is present. For more details on the way to create exclusion masks see the <a class="reference internal" href="mask_maps.html"><span class="doc">mask maps</span></a> notebook.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">circle</span> <span class="o">=</span> <span class="n">CircleSkyRegion</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">geom</span><span class="o">.</span><span class="n">center_skydir</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
<span class="n">exclusion_mask</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">region_mask</span><span class="p">([</span><span class="n">circle</span><span class="p">],</span> <span class="n">inside</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">fov_bkg_maker</span> <span class="o">=</span> <span class="n">FoVBackgroundMaker</span><span class="p">(</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="n">exclusion_mask</span><span class="o">=</span><span class="n">exclusion_mask</span>
<span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">fov_bkg_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Other backgrounds production methods are available as listed below.</p>
</section>
<section id="Ring-background">
<h3>Ring background<a class="headerlink" href="#Ring-background" title="Permalink to this headline">#</a></h3>
<p>If the background model does not reproduce well the morphology, a classical approach consists in applying local corrections by smoothing the data with a ring kernel. This allows to build a set of OFF counts taking into account the inperfect knowledge of the background. This is implemented in the <code class="docutils literal notranslate"><a href='../../api/gammapy.makers.RingBackgroundMaker.html#gammapy.makers.RingBackgroundMaker'>gammapy.makers.RingBackgroundMaker</a></code> which transforms the Dataset in a <code class="docutils literal notranslate"><span class="pre">MapDatasetOnOff</span></code>. This technique is mostly used for imaging, and should not be applied for 3D modeling and fitting.</p>
<p>For more details and usage, see <a class="reference internal" href="../../user-guide/makers/ring.html"><span class="doc">ring_background</span></a>.</p>
</section>
<section id="Reflected-regions-background">
<h3>Reflected regions background<a class="headerlink" href="#Reflected-regions-background" title="Permalink to this headline">#</a></h3>
<p>In the absence of a solid background model, a classical technique in Cherenkov astronomy for 1D spectral analysis is to estimate the background in a number of OFF regions. When the background can be safely estimated as radially symmetric w.r.t. the pointing direction, one can apply the reflected regions background technique. This is implemented in the <code class="docutils literal notranslate"><a href='../../api/gammapy.makers.ReflectedRegionsBackgroundMaker.html#gammapy.makers.ReflectedRegionsBackgroundMaker'>gammapy.makers.ReflectedRegionsBackgroundMaker</a></code> which transforms a <code class="docutils literal notranslate"><span class="pre">SpectrumDataset</span></code> in a <code class="docutils literal notranslate"><span class="pre">SpectrumDatasetOnOff</span></code>. This technique is only
used for 1D spectral analysis.</p>
<p>For more details and usage, see <a class="reference internal" href="../../user-guide/makers/reflected.html"><span class="doc">reflected_background</span></a>.</p>
</section>
</section>
<section id="Data-reduction-loop">
<h2>Data reduction loop<a class="headerlink" href="#Data-reduction-loop" title="Permalink to this headline">#</a></h2>
<p>The data reduction steps can be combined in a single loop to run a full data reduction chain. For this the <code class="docutils literal notranslate"><span class="pre">MapDatasetMaker</span></code> is run first and the output dataset is the passed on to the next maker step. Finally the dataset per observation is stacked into a larger map.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_store</span> <span class="o">=</span> <span class="n">DataStore</span><span class="o">.</span><span class="n">from_dir</span><span class="p">(</span><span class="s2">&quot;$GAMMAPY_DATA/hess-dl3-dr1&quot;</span><span class="p">)</span>
<span class="n">observations</span> <span class="o">=</span> <span class="n">data_store</span><span class="o">.</span><span class="n">get_observations</span><span class="p">([</span><span class="mi">23523</span><span class="p">,</span> <span class="mi">23592</span><span class="p">,</span> <span class="mi">23526</span><span class="p">,</span> <span class="mi">23559</span><span class="p">])</span>

<span class="n">energy_axis</span> <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_bounds</span><span class="p">(</span>
    <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TeV&quot;</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s2">&quot;log&quot;</span>
<span class="p">)</span>
<span class="n">geom</span> <span class="o">=</span> <span class="n">WcsGeom</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">skydir</span><span class="o">=</span><span class="p">(</span><span class="mf">83.63</span><span class="p">,</span> <span class="mf">22.01</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">energy_axis</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">binsz</span><span class="o">=</span><span class="mf">0.02</span>
<span class="p">)</span>

<span class="n">dataset_maker</span> <span class="o">=</span> <span class="n">MapDatasetMaker</span><span class="p">()</span>
<span class="n">safe_mask_maker</span> <span class="o">=</span> <span class="n">SafeMaskMaker</span><span class="p">(</span>
    <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;aeff-default&quot;</span><span class="p">,</span> <span class="s2">&quot;offset-max&quot;</span><span class="p">],</span> <span class="n">offset_max</span><span class="o">=</span><span class="s2">&quot;3 deg&quot;</span>
<span class="p">)</span>

<span class="n">stacked</span> <span class="o">=</span> <span class="n">MapDataset</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>

<span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">observations</span><span class="p">:</span>
    <span class="n">local_dataset</span> <span class="o">=</span> <span class="n">stacked</span><span class="o">.</span><span class="n">cutout</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">pointing_radec</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;6 deg&quot;</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">local_dataset</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">safe_mask_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">fov_bkg_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">stacked</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">stacked</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
MapDataset
----------

  Name                            : s5OP76ec

  Total counts                    : 7972
  Total background counts         : 7555.42
  Total excess counts             : 416.58

  Predicted counts                : 7555.42
  Predicted background counts     : 7555.42
  Predicted excess counts         : nan

  Exposure min                    : 1.04e+06 m2 s
  Exposure max                    : 3.22e+09 m2 s

  Number of total bins            : 687500
  Number of fit bins              : 687214

  Fit statistic type              : cash
  Fit statistic value (-2 log(L)) : nan

  Number of models                : 0
  Number of parameters            : 0
  Number of free parameters       : 0


</pre></div></div>
</div>
<p>To maintain good performance it is always recommended to do a cutout of the <code class="docutils literal notranslate"><span class="pre">MapDataset</span></code> as shown above. In case you want to increase the offset-cut later, you can also choose a larger width of the cutout than <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">*</span> <span class="pre">offset_max</span></code>.</p>
<p>Note that we stack the individual <code class="docutils literal notranslate"><span class="pre">MapDataset</span></code>, which are computed per observation into a larger dataset. During the stacking the safe data range mask (<code class="docutils literal notranslate"><span class="pre">MapDataset.mask_safe</span></code>) is applied by setting data outside to zero, then data is added to the larger map dataset. To stack multiple observations, the larger dataset must be created first.</p>
<p>The data reduction loop shown above can be done throught the <code class="docutils literal notranslate"><span class="pre">DatasetsMaker</span></code> class that take as argument a list of makers. <strong>Note that the order of the makers list is important as it determines their execution order.</strong> Moreover the <code class="docutils literal notranslate"><span class="pre">stack_datasets</span></code> option offers the possibily to stack or not the output datasets, and the <code class="docutils literal notranslate"><span class="pre">n_jobs</span></code> option allow to use multiple processes on run.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">global_dataset</span> <span class="o">=</span> <span class="n">MapDataset</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
<span class="n">makers</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataset_maker</span><span class="p">,</span> <span class="n">safe_mask_maker</span><span class="p">,</span> <span class="n">fov_bkg_maker</span><span class="p">]</span>  <span class="c1"># the order matter</span>
<span class="n">datasets_maker</span> <span class="o">=</span> <span class="n">DatasetsMaker</span><span class="p">(</span><span class="n">makers</span><span class="p">,</span> <span class="n">stack_datasets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">global_dataset</span><span class="p">,</span> <span class="n">observations</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Datasets
--------

Dataset 0:

  Type       : MapDataset
  Name       : b4oGk99o
  Instrument : HESS
  Models     : [&#39;b4oGk99o-bkg&#39;]

Dataset 1:

  Type       : MapDataset
  Name       : 1aII85oa
  Instrument : HESS
  Models     : [&#39;1aII85oa-bkg&#39;]

Dataset 2:

  Type       : MapDataset
  Name       : UVDNcsK4
  Instrument : HESS
  Models     : [&#39;UVDNcsK4-bkg&#39;]

Dataset 3:

  Type       : MapDataset
  Name       : p0MdaqO5
  Instrument : HESS
  Models     : [&#39;p0MdaqO5-bkg&#39;]


</pre></div></div>
</div>
</section>
<section id="Spectrum-dataset">
<h2>Spectrum dataset<a class="headerlink" href="#Spectrum-dataset" title="Permalink to this headline">#</a></h2>
<p>The spectrum datasets represent 1D spectra along an energy axis whitin a given on region. The <code class="docutils literal notranslate"><span class="pre">SpectrumDataset</span></code> contains a counts spectrum, and a background model. The <code class="docutils literal notranslate"><span class="pre">SpectrumDatasetOnOff</span></code> contains ON and OFF count spectra, background is implicitly modeled via the OFF counts spectrum.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">SpectrumDatasetMaker</span></code> make spectrum dataset for a single observation. In that case the irfs and background are computed at a single fixed offset, which is recommend only for point-sources.</p>
<p>Here is an example of data reduction loop to create <code class="docutils literal notranslate"><span class="pre">SpectrumDatasetOnOff</span></code> datasets:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># on region is given by the CircleSkyRegion previously defined</span>
<span class="n">geom</span> <span class="o">=</span> <span class="n">RegionGeom</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">circle</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">energy_axis</span><span class="p">])</span>
<span class="n">exclusion_mask_2d</span> <span class="o">=</span> <span class="n">exclusion_mask</span><span class="o">.</span><span class="n">reduce_over_axes</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="n">spectrum_dataset_empty</span> <span class="o">=</span> <span class="n">SpectrumDataset</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">geom</span><span class="o">=</span><span class="n">geom</span><span class="p">,</span> <span class="n">energy_axis_true</span><span class="o">=</span><span class="n">energy_axis_true</span>
<span class="p">)</span>

<span class="n">spectrum_dataset_maker</span> <span class="o">=</span> <span class="n">SpectrumDatasetMaker</span><span class="p">(</span>
    <span class="n">containment_correction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="s2">&quot;exposure&quot;</span><span class="p">,</span> <span class="s2">&quot;edisp&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">reflected_bkg_maker</span> <span class="o">=</span> <span class="n">ReflectedRegionsBackgroundMaker</span><span class="p">(</span>
    <span class="n">exclusion_mask</span><span class="o">=</span><span class="n">exclusion_mask_2d</span>
<span class="p">)</span>
<span class="n">safe_mask_masker</span> <span class="o">=</span> <span class="n">SafeMaskMaker</span><span class="p">(</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;aeff-max&quot;</span><span class="p">],</span> <span class="n">aeff_percent</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">datasets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">()</span>

<span class="k">for</span> <span class="n">observation</span> <span class="ow">in</span> <span class="n">observations</span><span class="p">:</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">spectrum_dataset_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="n">spectrum_dataset_empty</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;obs-</span><span class="si">{</span><span class="n">observation</span><span class="o">.</span><span class="n">obs_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="n">observation</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">dataset_on_off</span> <span class="o">=</span> <span class="n">reflected_bkg_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">observation</span><span class="p">)</span>
    <span class="n">dataset_on_off</span> <span class="o">=</span> <span class="n">safe_mask_masker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset_on_off</span><span class="p">,</span> <span class="n">observation</span><span class="p">)</span>
    <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset_on_off</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Datasets
--------

Dataset 0:

  Type       : SpectrumDatasetOnOff
  Name       : obs-23523
  Instrument : HESS
  Models     :

Dataset 1:

  Type       : SpectrumDatasetOnOff
  Name       : obs-23592
  Instrument : HESS
  Models     :

Dataset 2:

  Type       : SpectrumDatasetOnOff
  Name       : obs-23526
  Instrument : HESS
  Models     :

Dataset 3:

  Type       : SpectrumDatasetOnOff
  Name       : obs-23559
  Instrument : HESS
  Models     :


</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


              </div>
              
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, The Gammapy developers.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>