
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>PIG 12 - High level interface &#8212; gammapy v0.20</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gammapy.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <link rel="shortcut icon" href="../../_static/gammapy_logo.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="PIG 13 - Gammapy dependencies and distribution" href="pig-013.html" />
    <link rel="prev" title="PIG 11 - Light curves" href="pig-011.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../index.html">
  <img src="../../_static/gammapy_logo_nav.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../getting-started/index.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../userguide/index.html">
  User guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../tutorials/index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../api.html">
  API reference
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../index.html">
  Development
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../changelog/index.html">
  Release notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-primary btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        0.20  <!-- this text may get changed later by javascript -->
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
</div>

<!-- NOTE: this JS must live here (not in our global JS file) because it relies
     on being processed by Jinja before it is run (specifically for replacing
     variables development/pigs/pig-012 and {'json_url': 'https://docs.gammapy.org/stable/switcher.json', 'version_match': '0.20'}.
-->

<script type="text/javascript">
// Check if corresponding page path exists in other version of docs
// and, if so, go there instead of the homepage of the other docs version
function checkPageExistsAndRedirect(event) {
    const currentFilePath = "development/pigs/pig-012.html",
          tryUrl = event.target.getAttribute("href");
    let otherDocsHomepage = tryUrl.replace(currentFilePath, "");
    $.ajax({
        type: 'HEAD',
        url: tryUrl,
        // if the page exists, go there
        success: function() {
            location.href = tryUrl;
        }
    }).fail(function() {
        location.href = otherDocsHomepage;
    });
    // this prevents the browser from following the href of the clicked node
    // (which is fine because this function takes care of redirecting)
    return false;
}

// Populate the version switcher from the JSON config file
(function () {
    $.getJSON("https://docs.gammapy.org/stable/switcher.json", function(data, textStatus, jqXHR) {
        const currentFilePath = "development/pigs/pig-012.html";
        // create links to the corresponding page in the other docs versions
        $.each(data, function(index, entry) {
            // if no custom name specified (e.g., "latest"), use version string
            if (!("name" in entry)) {
                entry.name = entry.version;
            }
            // create the node
            const node = document.createElement("a");
            node.setAttribute("class", "list-group-item list-group-item-action py-1");
            node.textContent = `${entry.name}`;
            node.setAttribute("href", `${entry.url}${currentFilePath}`);
            // on click, AJAX calls will check if the linked page exists before
            // trying to redirect, and if not, will redirect to the homepage
            // for that version of the docs.
            node.onclick = checkPageExistsAndRedirect;
            // Add dataset values for the version and name in case people want
            // to apply CSS styling based on this information.
            node.dataset["versionName"] = entry.name;
            node.dataset["version"] = entry.version;

            $("#version_switcher_menu").append(node);
            // replace dropdown button text with the preferred display name of
            // this version, rather than using sphinx's 0.20 variable.
            // also highlight the dropdown entry for the currently-viewed
            // version's entry
            if (entry.version == "0.20") {
                node.classList.add("active");
                let btn = document.getElementById("version_switcher_button");
                btn.innerText = btn.dataset["activeVersionName"] = entry.name;
                btn.dataset["activeVersion"] = entry.version;
            }
        });
    });
})();
</script>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/gammapy/gammapy" rel="noopener" target="_blank" title="Github"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">Github</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/gammapyST" rel="noopener" target="_blank" title="Twitter"><span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://gammapy.slack.com/" rel="noopener" target="_blank" title="Slack"><span><i class="fab fa-slack"></i></span>
            <label class="sr-only">Slack</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../setup.html">
   Project setup
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dependencies.html">
   Dependencies
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   How to contribute to Gammapy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../release.html">
   How to make a Gammapy release
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../doc_howto.html">
   Documentation How To
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dev_howto.html">
   Developer How To
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="index.html">
   PIGs
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="pig-001.html">
     PIG 1 - PIG purpose and guidelines
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-002.html">
     PIG 2 - Organization of low level analysis code
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-003.html">
     PIG 3 - Plan for dropping Python 2.7 support
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-004.html">
     PIG 4 - Setup for tutorial notebooks and data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-005.html">
     PIG 5 - Gammapy 1.0 roadmap
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-006.html">
     PIG 6 - CTA observation handling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-007.html">
     PIG 7 - Models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-008.html">
     PIG 8 - Datasets
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-009.html">
     PIG 9 - Event sampling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-010.html">
     PIG 10 - Regions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-011.html">
     PIG 11 - Light curves
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     PIG 12 - High level interface
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-013.html">
     PIG 13 - Gammapy dependencies and distribution
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-014.html">
     PIG 14 - Uncertainty estimation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-016.html">
     PIG 16 - Gammapy package structure
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-018.html">
     PIG 18 - Documentation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-019.html">
     PIG 19 - Gammapy package structure follow up
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-020.html">
     PIG 20 - Global Model API
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-021.html">
     PIG 21 - Models improvements
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-022.html">
     PIG 22 - Unified flux estimators API
    </a>
   </li>
  </ul>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#abstract">
   Abstract
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-we-have">
   What we have
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#proposal">
   Proposal
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#outlook">
   Outlook
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#alternatives">
   Alternatives
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#task-list">
   Task list
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#decision">
   Decision
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="pig-12-high-level-interface">
<span id="pig-012"></span><h1>PIG 12 - High level interface<a class="headerlink" href="#pig-12-high-level-interface" title="Permalink to this headline">#</a></h1>
<ul class="simple">
<li><p>Author: José Enrique Ruiz, Christoph Deil, Axel Donath, Regis Terrier, Lars Mohrmann</p></li>
<li><p>Created: Jun 6, 2019</p></li>
<li><p>Accepted: Aug 19, 2019</p></li>
<li><p>Status: accepted</p></li>
<li><p>Discussion: <a class="reference external" href="https://github.com/gammapy/gammapy/pull/2219">GH 2219</a></p></li>
</ul>
<section id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">#</a></h2>
<p>The high level interface is one of the projects considered in the Gammapy
roadmap for Gammapy v1.0 (see <a class="reference internal" href="pig-003.html#pig-003"><span class="std std-ref">PIG 3 - Plan for dropping Python 2.7 support</span></a>). It should be easy to use and
allow users to do the most common analysis tasks and workflows quickly. It would
be built on top of the existing Gammapy code-base, first on it’s own, but likely
starting to develop it would inform improvements in code organisation throughout
Gammapy.</p>
<p>Achieving a stable high level interface should allow us to continue improving
the Gammapy code-base without breaking user-defined workflows or recipes made
that would have been made with this high level interface.</p>
<p>We propose to develop a high level interface Python API, similar to Fermipy or
HAP in HESS, based on a single <code class="docutils literal notranslate"><span class="pre">Analysis</span></code> class communicating with a set of
tool classes, and that supports config-file driven analysis of the main IACT
source analysis use cases.</p>
</section>
<section id="what-we-have">
<h2>What we have<a class="headerlink" href="#what-we-have" title="Permalink to this headline">#</a></h2>
<p>We have been using <a class="reference external" href="http://click.pocoo.org/">Click</a> to develop a very small set of tools for an
embryonic <a class="reference external" href="https://docs.gammapy.org/0.12/scripts/index.html">Gammapy command line interface</a>. Among the existing tools (<code class="docutils literal notranslate"><span class="pre">gammapy</span>
<span class="pre">image</span></code>, <code class="docutils literal notranslate"><span class="pre">gammapy</span> <span class="pre">info</span></code>, <code class="docutils literal notranslate"><span class="pre">gammapy</span> <span class="pre">download</span></code>, <code class="docutils literal notranslate"><span class="pre">gammapy</span> <span class="pre">jupyter</span></code>), only
<a class="reference external" href="https://docs.gammapy.org/0.12/scripts/index.html#example">gammapy image</a> can be considered as potentially needed in a data analysis
process. It actually creates a counts image from an event-list file and an image
that serves as a reference geometry. Hence, we have a code set-up in
<code class="docutils literal notranslate"><span class="pre">gammapy.scripts</span></code>, that we will not use it for the moment to expose the
high level interface API, but to develop a very small set of specific command
line tools identified (i.e. perform long-time processing tasks, see <em>Command
line tools</em> section below)</p>
<p>We have a set of <a class="reference external" href="https://docs.gammapy.org/0.12/tutorials.html">Jupyter notebooks</a> as examples of tutorials and recipes
demonstrating the use of Gammapy. These notebooks are continuously tested and
are one of the pillars of the user documentation. We could check most of the use
cases are covered by the high level interface with the help of these notebooks.
We will have to translate most of them to use the high level interface, but we
could also use them as a basis for experimental automated workflows driven by
parametrized notebooks executed with  <a class="reference external" href="https://github.com/nteract/papermill/">papermill</a>. (see <em>Outlook</em> section
below) Moreover, some Python scripts have been added recently to perform
<a class="reference external" href="https://github.com/gammapy/gammapy-benchmarks">benchmarks</a> of Gammapy, surely we could rewrite some of all of these
benchmarks to use the high level interface.</p>
<p>We also have some <em>high level analysis</em> classes in the API that concatenate
several atomic actions and provide rough estimated results for more complex
processes. (i.e. <a class="reference external" href="https://docs.gammapy.org/0.12/api/gammapy.scripts.SpectrumAnalysisIACT.html">SpectrumAnalysisIACT</a>, <a class="reference external" href="https://docs.gammapy.org/0.12/api/gammapy.time.LightCurveEstimator.html">LightCurveEstimator</a>) These classes
would serve as a basis to design and prototype some of the tools of the
high level interface.</p>
</section>
<section id="proposal">
<h2>Proposal<a class="headerlink" href="#proposal" title="Permalink to this headline">#</a></h2>
<p>We will develop a high level interface Python API which uses a params-values
configuration file defined by the user. This API would be used in Python
scripts, notebooks or in IPython sessions to perform simple and most common IACT
analysis.</p>
<p>We see then two main options on how to use the high level interface API:</p>
<ul class="simple">
<li><p>Within an IPython session or notebook, mostly dealing with a manager object to perform specific tasks in an <strong>interactive</strong> analysis process</p></li>
<li><p>In a Python script or notebook, declaring the orchestration of the tasks with a manager object for an <strong>automated</strong> process</p></li>
</ul>
<p>This high level interface API is similar to what it is done in <a class="reference external" href="https://github.com/fermiPy/fermipy">Fermipy</a> or HAP
in HESS, including also the options to save and recover session states, as well
as serialization of intermediate data products and logging. It is flexible
enough to allow the user to work with the API at any stage of the analysis
process, and not only from the start to the very end or in automated process.</p>
<p><strong>Use cases</strong></p>
<p>The use cases covered are in the scope of a single analysis and model, not
parametrized variations in a multidimensional grid space of variables, and
within a single region (e.g. 10 deg region with 5 sources).</p>
<p>The main use cases for analysis to be covered are:</p>
<ul class="simple">
<li><p>3D map analysis</p></li>
<li><p>2D map analysis</p></li>
<li><p>1D spectrum analysis</p></li>
<li><p>Light curve estimation</p></li>
</ul>
<p>Including the main methods for data reduction, modeling and fitting:</p>
<ul class="simple">
<li><p>On vs on/off data reduction</p></li>
<li><p>Different background models</p></li>
<li><p>Joint vs stacked likelihood fitting</p></li>
<li><p>Diagnostics (residuals, significance, TS)</p></li>
<li><p>Spectral flux points</p></li>
</ul>
<p>Making a SED may be the final part of the analysis, as many SED methods require
the full model and all energy data.</p>
<p><strong>Configuration file</strong></p>
<p>The configuration file will be in YAML format exposing the parameters and values
needed for each one of the tasks involved in the analysis process. To generate
the config file, we could add a <code class="docutils literal notranslate"><span class="pre">gammapy</span> <span class="pre">analysis</span> <span class="pre">config</span></code> command line tool
which dumps the config file with all lines commented out, and the users can then
uncomment and fill in the parameters and values they care about. As an
alternative users could copy &amp; paste from a config file example in the docs. We
will develop a schema and validate / give good error messages on read.</p>
<p>We roughly sketch below an example of a prototype configuration file in YAML
format, just to illustrate how a structured schema could expose most of the
parameter/values needed in a data analysis process. The configuration file
should be explicit enough for the users to understand which parameters to edit
in order to define a specific configuration for an analysis session or workflow,
and should use units for quantities where it makes sense, e.g. “angle: 3 deg”
instead of “angle: 3”. The final schema for this configuration file will be
achieved iteratively during the development of the high level interface and
later on eventual improvements, also taking user feedback into account.</p>
<p>Prototype configuration file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>analysis:
    process:
        # add options to allow either in-memory or disk-based processing
        out_folder: &quot;.&quot;  # default is current working directory
        store_per_obs: {true, false}
    reduce:
        type: {&quot;1D, &quot;3D&quot;}
        stacked: {true, false}
        background: {&quot;irf&quot;, &quot;reflected&quot;, &quot;ring&quot;}
        roi: max_offset
        exclusion: exclusion.fits
    fit:
        energy_min, energy_max
    logging:
        level: debug

grid:
    spatial: center, width, binsz
    energy: min, max, nbins
    time: min, max
    # PSF RAD and EDISP MIGRA not exposed for now
    # Per-obs energy_safe and roi_max ?

observations:
    data_store: $GAMMAPY_DATA/cta-1dc/index/gps/
    ids: 110380, 111140, 111159
    conesearch:
        ra:
        dec:
        radius:
        energy_min:
        energy_max:
        time_min:
        time_max:

model:
    # Model configuration will mostly be designed in different PIG
    sources:
        source_1:
            spectrum: powerlaw
            spatial: shell
        diffuse: gal_diffuse.fits
    background:
        IRF
</pre></div>
</div>
<p><strong>API design</strong></p>
<p>The design of the high level interface API is driven by the use cases
considered, the different tools (tasks) identified and their responsibilities,
as well as the need of a main <code class="docutils literal notranslate"><span class="pre">Analysis</span></code> session object that drives and
orchestrates internally the different tools involved, their inputs and products.
The <code class="docutils literal notranslate"><span class="pre">Analysis</span></code> session object will be initialized with a configuration file
(see <em>prototype configuration file</em> above) and will be the responsible to
instantiate and run the different tools classes (see <em>session workflow</em> below).
The tools are middle  management agents (e.g. MapMaker, ReflectedBgEstimator,
…) responsible to perform the different tasks identified in the use cases
covered.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Analysis</span></code> session object will provide access to every object involved and
data structure produced during the session. <code class="docutils literal notranslate"><span class="pre">Analysis</span></code> methods calls will
produce and modify datasets (i.e. models, maps,..), but in between method calls
advanced users can do a lot of custom processing by their own with scripting
using the Gammapy Python toolbox.</p>
<p>The code of the <code class="docutils literal notranslate"><span class="pre">Analysis</span></code> class as well as any other eventual class needed
will be placed in <code class="docutils literal notranslate"><span class="pre">gammapy.scripts</span></code>. This module will contain also the set of
different command line tools provided, where some small cleaning and refactoring
may be needed (i.e. remove <code class="docutils literal notranslate"><span class="pre">gammapy</span> <span class="pre">image</span></code> command line tool)</p>
<p><strong>Serialisation</strong></p>
<p>There will be the possibility to save and recover session states with their
associated data products. The user could also choose in the configuration file,
with the help of a boolean parameter, to work with serialised intermediate
products delivered by the tools instead of in memory. The state serialisation
will be a mix of YAML (i.e. models, state) and FITS files (i.e. maps), where the
delegated tools should know how to serialise and read themselves. The solution
to address serialization of different datasets by the different tools is not in
the scope of this PIG.</p>
<p><strong>Session workflow</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mkdir analysis
$ cd analysis
$ edit gammapy_analysis_config.yaml
</pre></div>
</div>
<p>Then the user would type <code class="docutils literal notranslate"><span class="pre">ipython</span></code>, <code class="docutils literal notranslate"><span class="pre">juypter</span> <span class="pre">notebook</span></code> or write a script
with the code below.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gammapy.analysis</span> <span class="kn">import</span> <span class="n">Analysis</span>

<span class="n">analysis</span> <span class="o">=</span> <span class="n">Analysis</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

<span class="n">analysis</span><span class="o">.</span><span class="n">select_observations</span><span class="p">()</span>
<span class="c1"># Select observations using the parameters defined in the configuration file.</span>

<span class="n">analysis</span><span class="o">.</span><span class="n">reduce_data</span><span class="p">()</span>  <span class="c1"># often slow, can be hours</span>
<span class="c1"># If the user wants they can save all results from data reduction and re-start later.</span>
<span class="c1"># This stores config, datasets, ... all the analysis class state.</span>
<span class="c1"># analysis.write()</span>
<span class="c1"># analysis = Analysis.read()</span>

<span class="n">analysis</span><span class="o">.</span><span class="n">optimise</span><span class="p">()</span>  <span class="c1"># often slow, can be hours</span>
<span class="c1"># Again, we could write and read, do the slow things only once.</span>
<span class="c1"># e.g. supervisor comes in and asks about significance of some model component or whatever.</span>
<span class="c1"># analysis.write()</span>
<span class="c1"># analysis = Analysis.read()</span>

<span class="c1"># Since anything is accessible from the Analysis object</span>
<span class="c1"># many advanced use cases can be done with the Analysis API.</span>
<span class="n">analysis</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="s2">&quot;source_42&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="c1"># Should we need energy_binning for the SED points in config or only here?</span>
<span class="n">sed</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">spectral_points</span><span class="p">(</span><span class="s2">&quot;source_42&quot;</span><span class="p">,</span> <span class="n">energy_binning</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Command line tools</strong></p>
<p>In addition to <code class="docutils literal notranslate"><span class="pre">gammapy</span> <span class="pre">analysis</span> <span class="pre">config</span></code>, we will have a <code class="docutils literal notranslate"><span class="pre">gammapy</span> <span class="pre">analysis</span>
<span class="pre">data_reduction</span></code> and a <code class="docutils literal notranslate"><span class="pre">gammapy</span> <span class="pre">analysis</span> <span class="pre">optimise</span></code> which perform the long
processing tasks from the terminal outside an ipython session or jupyter
notebook, using all the information from the config file and/or saved state.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">gammapy</span> <span class="pre">analysis</span> <span class="pre">config</span></code>: dumps a template configuration file</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gammapy</span> <span class="pre">analysis</span> <span class="pre">data_reduction</span></code>: performs a data reduction process</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gammapy</span> <span class="pre">analysis</span> <span class="pre">optimise</span></code>: performs a model fitting process</p></li>
</ul>
</section>
<section id="outlook">
<h2>Outlook<a class="headerlink" href="#outlook" title="Permalink to this headline">#</a></h2>
<p>Some of the use cases not covered by this high level interface API are the
following:</p>
<ul class="simple">
<li><p>Generation of simulated events and/or counts</p></li>
<li><p>Iterative source detection methods</p></li>
<li><p>Complex or memory eager processing on lightcurves</p></li>
</ul>
<p>These use cases can be actually addressed using Gammapy as a Python toolbox,
though in the near future some of them could be incorporated progressively to
the high level interface. For example, making a lightcurve could be part of one
Analysis (like it is in Fermi), or could be done at higher level, creating
Analysis instances and running them for each time bin. This exercise of pro/con
is left to the <a class="reference internal" href="pig-006.html#pig-006"><span class="std std-ref">PIG 6 - CTA observation handling</span></a>. We could expect that restructuring all of Gammapy
to be tools based with good tool chains and config handling will be eventually
achieved after a certain time if we define a solid high level interface API.</p>
<p>We could explore the use of <a class="reference external" href="https://github.com/nteract/papermill/">papermill</a> to run workflows defined in a notebook
using the values of the parameter-value configuration file defined for the
high level interface API. The notebooks could be provided as skeleton-templates
for specific use cases or built by the user. This option would provide a
rich-text formatted report of the analysis process execution.</p>
<p>One extra dimension that arises from the development of this high level
interface API is the possibility to capture data provenance as structured logs
of tasks executions in a session or in an automated workflow. Capturing
provenance in this way is more useful if we also provide the means for it to be
easily queried and inspected in multiple ways, allowing also forensic studies of
the research analysis process as well as improving reproducibility and reuse by
the community. This work will be the scope of another PIG.</p>
</section>
<section id="alternatives">
<h2>Alternatives<a class="headerlink" href="#alternatives" title="Permalink to this headline">#</a></h2>
<p>A different approach to this high level interface API is that of command line
tools executed from the terminal, what  <a class="reference external" href="https://fermi.gsfc.nasa.gov/ssc/data/analysis/scitools/overview.html">Fermitools</a> and <a class="reference external" href="http://cta.irap.omp.eu/ctools">ctools</a> do, where
each tool is simple/atomic enough to allow users to inspect the output results
before taking a decision on how to run and set the parameter values for the next
tool. A similar approach could be done with the Gammapy high level interface
API, but inside a notebook or IPython session.</p>
<p>Concerning the code implementation, <a class="reference external" href="https://cta-observatory.github.io/ctapipe/ctapipe_api/tools/index.html">ctapipe tools</a> provides a solution based
on Python traitlets, acting as an extensible framework to easily transform
Python classes into command line tools. We will explore the adoption of this
approach after Gammapy v1.0 since it requires a considerable effort on
refactoring of the Gammapy code-base.</p>
<p>Another config-file based solution is what is implemented in <a class="reference external" href="https://enrico.readthedocs.io/en/latest/configfile.html">Enrico</a>. It
performs basic orchestrated analysis workflows using a set of input parameters
that the user provides via a configuration file. The user may be guided in the
declaration of values for the config file using an assistant command line tool
for config-file building, which asks for parameter values providing also
defaults. This is done in <a class="reference external" href="https://enrico.readthedocs.io/en/latest/configfile.html">Enrico</a> with  <code class="docutils literal notranslate"><span class="pre">enrico_config</span></code> and <code class="docutils literal notranslate"><span class="pre">enrico_xml</span></code>,
where each workflow is set-up and then run with its own command line tool. In
our case, we define the workflow steps in a simple Python script and declare
parameter-value pairs in a configuration file. The Python script is then
executed to run the workflow.</p>
<p>Also Python scripts and/or notebook files could be generated with an assistant
command line tool. Then, the user could edit and tweak the config files, scripts
or notebooks. There isn’t much precedence for this workflow in science, but a
lot of dev-ops and programming tools work like that, it is a standard technique.
One random example of such a tool is the <a class="reference external" href="https://cli.angular.io/">Angular CLI</a>, or <a class="reference external" href="https://cookiecutter.readthedocs.io">cookiecutter</a>.</p>
</section>
<section id="task-list">
<h2>Task list<a class="headerlink" href="#task-list" title="Permalink to this headline">#</a></h2>
<p>Required for Gammapy v1.0</p>
<ul class="simple">
<li><p>Prototype for a manager class, agents, tools, etc.</p></li>
<li><p>Define a syntax for the declaration of parameter-value pairs needed for all tools in the analysis process.</p></li>
<li><p>Develop the session manager class responsible to drive the orchestration of tools in the analysis process.</p></li>
<li><p>Develop the tools classes responsible to perform each one of the tasks in the analysis process.</p></li>
<li><p>Design use cases and/or choose among the existing tutorials or benchmarks those that may be translated into high level interface notebooks.</p></li>
<li><p>Provide notebooks using the high level interface API for each of the chosen tutorials, benchmarks and/or use cases identified.</p></li>
<li><p>Add documentation for the high level interface API and clean the list of documentation tutorials, making a distinct separation among those using Gammapy as a high level interface API and those using Gammapy as a Python toolbox.</p></li>
</ul>
<p>Extra features (command line tools)</p>
<ul class="simple">
<li><p>Develop the small set of helpers command line tools described above.</p></li>
<li><p>Develop an assistant command line tool that produces Python scripts and/or notebooks using the high level interface API.</p></li>
<li><p>Cleaning and refactoring of <code class="docutils literal notranslate"><span class="pre">gammapy.scripts</span></code> module to remove old and unused command line tools.</p></li>
<li><p>Cleaning present documentation on <code class="docutils literal notranslate"><span class="pre">gammapy.scripts</span></code> to transform into documentation of helper command line tools.</p></li>
</ul>
</section>
<section id="decision">
<h2>Decision<a class="headerlink" href="#decision" title="Permalink to this headline">#</a></h2>
<p>The PIG has benn discussed at the Gammapy coding sprint in July 2019. A final
review announced on the Gammapy and CC mailing lists provided additional
comments that were addressed in <a class="reference external" href="https://github.com/gammapy/gammapy/pull/2219">GH 2219</a>. The PIG was accepted on August 19,
2019.</p>
</section>
</section>


              </div>
              
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, The Gammapy developers.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>