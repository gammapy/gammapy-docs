
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Reflected regions background &#8212; gammapy v0.20</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../_static/gammapy.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <link rel="shortcut icon" href="../_static/gammapy_logo.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Spectral analysis" href="../tutorials/analysis/1D/spectral_analysis.html" />
    <link rel="prev" title="3D detailed analysis" href="../tutorials/analysis/3D/analysis_3d.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/gammapy_logo_nav.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../getting-started/index.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../userguide/index.html">
  User guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../tutorials/index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api.html">
  API reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../development/index.html">
  Development
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../changelog/index.html">
  Release notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-primary btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        0.20  <!-- this text may get changed later by javascript -->
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
</div>

<!-- NOTE: this JS must live here (not in our global JS file) because it relies
     on being processed by Jinja before it is run (specifically for replacing
     variables makers/reflected and {'json_url': 'https://docs.gammapy.org/stable/switcher.json', 'version_match': '0.20'}.
-->

<script type="text/javascript">
// Check if corresponding page path exists in other version of docs
// and, if so, go there instead of the homepage of the other docs version
function checkPageExistsAndRedirect(event) {
    const currentFilePath = "makers/reflected.html",
          tryUrl = event.target.getAttribute("href");
    let otherDocsHomepage = tryUrl.replace(currentFilePath, "");
    $.ajax({
        type: 'HEAD',
        url: tryUrl,
        // if the page exists, go there
        success: function() {
            location.href = tryUrl;
        }
    }).fail(function() {
        location.href = otherDocsHomepage;
    });
    // this prevents the browser from following the href of the clicked node
    // (which is fine because this function takes care of redirecting)
    return false;
}

// Populate the version switcher from the JSON config file
(function () {
    $.getJSON("https://docs.gammapy.org/stable/switcher.json", function(data, textStatus, jqXHR) {
        const currentFilePath = "makers/reflected.html";
        // create links to the corresponding page in the other docs versions
        $.each(data, function(index, entry) {
            // if no custom name specified (e.g., "latest"), use version string
            if (!("name" in entry)) {
                entry.name = entry.version;
            }
            // create the node
            const node = document.createElement("a");
            node.setAttribute("class", "list-group-item list-group-item-action py-1");
            node.textContent = `${entry.name}`;
            node.setAttribute("href", `${entry.url}${currentFilePath}`);
            // on click, AJAX calls will check if the linked page exists before
            // trying to redirect, and if not, will redirect to the homepage
            // for that version of the docs.
            node.onclick = checkPageExistsAndRedirect;
            // Add dataset values for the version and name in case people want
            // to apply CSS styling based on this information.
            node.dataset["versionName"] = entry.name;
            node.dataset["version"] = entry.version;

            $("#version_switcher_menu").append(node);
            // replace dropdown button text with the preferred display name of
            // this version, rather than using sphinx's 0.20 variable.
            // also highlight the dropdown entry for the currently-viewed
            // version's entry
            if (entry.version == "0.20") {
                node.classList.add("active");
                let btn = document.getElementById("version_switcher_button");
                btn.innerText = btn.dataset["activeVersionName"] = entry.name;
                btn.dataset["activeVersion"] = entry.version;
            }
        });
    });
})();
</script>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/gammapy/gammapy" rel="noopener" target="_blank" title="Github"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">Github</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/gammapyST" rel="noopener" target="_blank" title="Twitter"><span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://gammapy.slack.com/" rel="noopener" target="_blank" title="Slack"><span><i class="fab fa-slack"></i></span>
            <label class="sr-only">Slack</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../userguide/package.html">
   Gammapy analysis workflow and package structure
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="../userguide/dl3.html">
     Data access and selection (DL3)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../userguide/irf.html">
     Instrument Response Functions (DL3)
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="reference internal" href="../userguide/makers.html">
     Data reduction (DL3 to DL4)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../userguide/maps.html">
     Sky maps (DL4)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../userguide/dl4.html">
     Datasets (DL4)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../userguide/modeling.html">
     Modeling and Fitting (DL4 to DL5)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../userguide/estimators.html">
     Estimators (DL4 to DL5, and DL6)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../userguide/hli.html">
     High Level Analysis Interface
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../userguide/cli.html">
     Command line tools
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../userguide/catalog.html">
     Source catalogs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../userguide/astro.html">
     Astrophysics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../userguide/stats.html">
     Statistical utility functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../userguide/visualization.html">
     Plotting features
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../userguide/utils.html">
     Utility functions
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../userguide/howto.html">
   How To
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../modeling/gallery/index.html">
   Model gallery
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spatial/plot_constant.html">
     Constant spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spatial/plot_disk.html">
     Disk spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spatial/plot_gauss.html">
     Gaussian spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spatial/plot_gen_gauss.html">
     Generalized gaussian spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spatial/plot_point.html">
     Point spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spatial/plot_shell.html">
     Shell spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spatial/plot_shell2.html">
     Shell2 spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spatial/plot_template.html">
     Template spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spectral/plot_absorbed.html">
     EBL absorbption spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spectral/plot_broken_powerlaw.html">
     Broken power law spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spectral/plot_compound.html">
     Compound spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spectral/plot_constant_spectral.html">
     Constant spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spectral/plot_exp_cutoff_powerlaw.html">
     Exponential cutoff power law spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spectral/plot_exp_cutoff_powerlaw_3fgl.html">
     Exponential cutoff power law spectral model used for 3FGL
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spectral/plot_gauss_spectral.html">
     Gaussian spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spectral/plot_logparabola.html">
     Log parabola spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spectral/plot_naima.html">
     Naima spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spectral/plot_piecewise_norm_spectral.html">
     Piecewise  norm spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spectral/plot_powerlaw.html">
     Power law spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spectral/plot_powerlaw2.html">
     Power law 2 spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spectral/plot_smooth_broken_powerlaw.html">
     Smooth broken power law spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spectral/plot_super_exp_cutoff_powerlaw_3fgl.html">
     Super exponential cutoff power law model used for 3FGL
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spectral/plot_super_exp_cutoff_powerlaw_4fgl.html">
     Super Exponential Cutoff Power Law Model used for 4FGL-DR3
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spectral/plot_super_exp_cutoff_powerlaw_4fgl_dr1.html">
     Super Exponential Cutoff Power Law Model used for 4FGL-DR1 (and DR2)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/spectral/plot_template_spectral.html">
     Template spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/temporal/plot_constant_temporal.html">
     Constant temporal model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/temporal/plot_expdecay_temporal.html">
     ExpDecay temporal model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/temporal/plot_gaussian_temporal.html">
     Gaussian temporal model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/temporal/plot_generalized_gaussian_temporal.html">
     Generalized Gaussian temporal model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/temporal/plot_linear_temporal.html">
     Linear temporal model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/temporal/plot_powerlaw_temporal.html">
     PowerLaw temporal model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/temporal/plot_sine_temporal.html">
     Sine temporal model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../modeling/gallery/temporal/plot_template_temporal.html">
     Light curve temporal model
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://gammapy.github.io/gammapy-recipes">
   Gammapy recipes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../userguide/references.html">
   Glossary and references
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overview">
   Overview
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-regions">
   Using regions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-reflected-region-finder">
   The reflected region finder
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-the-reflected-background-estimator">
   Using the reflected background estimator
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="reflected-regions-background">
<span id="reflected-background"></span><h1>Reflected regions background<a class="headerlink" href="#reflected-regions-background" title="Permalink to this headline">#</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">#</a></h2>
<p>This method is used in classical Cherenkov astronomy to estimate background
for spectral analysis. As illustrated in Fig. 1,
a region on the sky, the ON region, is chosen to select events
around the studied source position. In the absence of a solid template of the
residual hadronic background, a classical method to estimate it is the so-called
Reflected Region Background. The underlying assumption is that the background is
approximately purely radial in the field-of-view. A set of OFF counts is found
in the observation, by rotating the ON region selected around the pointing
position. To avoid that the reflected regions contain actual gamma-ray signal
from other objects, one has to remove the gamma-ray bright parts of the
field-of-view with a exclusion mask. More details on the reflected regions method can
be found in <a class="reference internal" href="../userguide/references.html#berge2007" id="id1"><span>[Berge2007]</span></a>.</p>
<figure class="align-default" id="id3">
<span id="figure-reflected-background"></span><a class="reference internal image-reference" href="../_images/hgps_spectrum_background_estimation.png"><img alt="../_images/hgps_spectrum_background_estimation.png" src="../_images/hgps_spectrum_background_estimation.png" style="width: 50%;" /></a>
<figcaption>
<p><span class="caption-text">Fig.1, Illustration of the reflected regions background estimation method, taken from <a class="reference internal" href="../userguide/references.html#abdalla2018" id="id2"><span>[Abdalla2018]</span></a>.</span><a class="headerlink" href="#id3" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>The extraction of the OFF events from the <a class="reference internal" href="../api/gammapy.data.EventList.html#gammapy.data.EventList" title="gammapy.data.EventList"><code class="xref py py-obj docutils literal notranslate"><span class="pre">EventList</span></code></a> of a
set of observations is performed by the <a class="reference internal" href="../api/gammapy.makers.ReflectedRegionsBackgroundMaker.html#gammapy.makers.ReflectedRegionsBackgroundMaker" title="gammapy.makers.ReflectedRegionsBackgroundMaker"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ReflectedRegionsBackgroundMaker</span></code></a>.
The latter uses the <code class="xref py py-obj docutils literal notranslate"><span class="pre">ReflectedRegionsFinder</span></code> to create reflected
regions for a given circular on region and exclusion mask.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gammapy.makers</span> <span class="kn">import</span> <span class="n">SpectrumDatasetMaker</span><span class="p">,</span> <span class="n">ReflectedRegionsBackgroundMaker</span><span class="p">,</span> <span class="n">SafeMaskMaker</span>
<span class="kn">from</span> <span class="nn">gammapy.datasets</span> <span class="kn">import</span> <span class="n">SpectrumDataset</span><span class="p">,</span> <span class="n">Datasets</span>
<span class="kn">from</span> <span class="nn">gammapy.data</span> <span class="kn">import</span> <span class="n">DataStore</span>
<span class="kn">from</span> <span class="nn">gammapy.maps</span> <span class="kn">import</span> <span class="n">MapAxis</span><span class="p">,</span> <span class="n">Map</span><span class="p">,</span> <span class="n">WcsGeom</span><span class="p">,</span> <span class="n">RegionGeom</span>

<span class="n">data_store</span> <span class="o">=</span> <span class="n">DataStore</span><span class="o">.</span><span class="n">from_dir</span><span class="p">(</span><span class="s2">&quot;$GAMMAPY_DATA/hess-dl3-dr1&quot;</span><span class="p">)</span>
<span class="n">observations</span> <span class="o">=</span> <span class="n">data_store</span><span class="o">.</span><span class="n">get_observations</span><span class="p">([</span><span class="mi">23592</span><span class="p">,</span> <span class="mi">23559</span><span class="p">])</span>

<span class="n">energy_axis</span> <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_energy_bounds</span><span class="p">(</span><span class="s2">&quot;0.5 TeV&quot;</span><span class="p">,</span> <span class="s2">&quot;10 TeV&quot;</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">energy_axis_true</span> <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_energy_bounds</span><span class="p">(</span><span class="s2">&quot;0.3 TeV&quot;</span><span class="p">,</span> <span class="s2">&quot;20 TeV&quot;</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy_true&quot;</span><span class="p">)</span>

<span class="n">geom</span> <span class="o">=</span> <span class="n">RegionGeom</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="s2">&quot;icrs;circle(83.63,22.01,0.11)&quot;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">energy_axis</span><span class="p">])</span>
<span class="n">dataset_empty</span> <span class="o">=</span> <span class="n">SpectrumDataset</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">geom</span><span class="o">=</span><span class="n">geom</span><span class="p">,</span> <span class="n">energy_axis_true</span><span class="o">=</span><span class="n">energy_axis_true</span><span class="p">)</span>

<span class="n">wcsgeom</span> <span class="o">=</span> <span class="n">WcsGeom</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">skydir</span><span class="o">=</span><span class="n">geom</span><span class="o">.</span><span class="n">center_skydir</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">binsz</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
<span class="n">exclusion_mask</span> <span class="o">=</span> <span class="n">wcsgeom</span><span class="o">.</span><span class="n">region_mask</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">inside</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">maker</span> <span class="o">=</span> <span class="n">SpectrumDatasetMaker</span><span class="p">()</span>
<span class="n">safe_mask_maker</span> <span class="o">=</span> <span class="n">SafeMaskMaker</span><span class="p">(</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;aeff-max&quot;</span><span class="p">],</span> <span class="n">aeff_percent</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">bkg_maker</span> <span class="o">=</span> <span class="n">ReflectedRegionsBackgroundMaker</span><span class="p">(</span><span class="n">exclusion_mask</span><span class="o">=</span><span class="n">exclusion_mask</span><span class="p">)</span>

<span class="n">datasets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">()</span>
<span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">observations</span><span class="p">:</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset_empty</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">obs</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">safe_mask_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>
    <span class="n">dataset_on_off</span> <span class="o">=</span> <span class="n">bkg_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>
    <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="using-regions">
<h2>Using regions<a class="headerlink" href="#using-regions" title="Permalink to this headline">#</a></h2>
<p>The on region is a <a class="reference external" href="https://astropy-regions.readthedocs.io/en/latest/api/regions.SkyRegion.html#regions.SkyRegion" title="(in regions v0.7.dev22+gd25fb8a)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">SkyRegion</span></code></a>. It is typically a circle
(<a class="reference external" href="https://astropy-regions.readthedocs.io/en/latest/api/regions.CircleSkyRegion.html#regions.CircleSkyRegion" title="(in regions v0.7.dev22+gd25fb8a)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">CircleSkyRegion</span></code></a>) for pointlike source analysis, but can be a more
complex region such as a <a class="reference external" href="https://astropy-regions.readthedocs.io/en/latest/api/regions.CircleAnnulusSkyRegion.html#regions.CircleAnnulusSkyRegion" title="(in regions v0.7.dev22+gd25fb8a)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">CircleAnnulusSkyRegion</span></code></a> a
<a class="reference external" href="https://astropy-regions.readthedocs.io/en/latest/api/regions.EllipseSkyRegion.html#regions.EllipseSkyRegion" title="(in regions v0.7.dev22+gd25fb8a)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">EllipseSkyRegion</span></code></a>, a <a class="reference external" href="https://astropy-regions.readthedocs.io/en/latest/api/regions.RectangleSkyRegion.html#regions.RectangleSkyRegion" title="(in regions v0.7.dev22+gd25fb8a)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">RectangleSkyRegion</span></code></a> etc.</p>
<p>The following example shows how to create such regions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Example how to compute and plot reflected regions.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span> <span class="nn">regions</span> <span class="kn">import</span> <span class="n">CircleSkyRegion</span><span class="p">,</span> <span class="n">EllipseAnnulusSkyRegion</span><span class="p">,</span> <span class="n">RectangleSkyRegion</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">gammapy.maps</span> <span class="kn">import</span> <span class="n">WcsNDMap</span>

<span class="n">position</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="mf">83.63</span><span class="p">,</span> <span class="mf">22.01</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;icrs&quot;</span><span class="p">)</span>

<span class="n">on_circle</span> <span class="o">=</span> <span class="n">CircleSkyRegion</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>

<span class="n">on_ellipse_annulus</span> <span class="o">=</span> <span class="n">EllipseAnnulusSkyRegion</span><span class="p">(</span>
    <span class="n">center</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
    <span class="n">inner_width</span><span class="o">=</span><span class="mf">1.5</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
    <span class="n">outer_width</span><span class="o">=</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
    <span class="n">inner_height</span><span class="o">=</span><span class="mi">3</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
    <span class="n">outer_height</span><span class="o">=</span><span class="mi">4</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
    <span class="n">angle</span><span class="o">=</span><span class="mi">130</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">another_position</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="mf">80.3</span><span class="p">,</span> <span class="mf">22.0</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span>
<span class="n">on_rectangle</span> <span class="o">=</span> <span class="n">RectangleSkyRegion</span><span class="p">(</span>
    <span class="n">center</span><span class="o">=</span><span class="n">another_position</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">50</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
<span class="p">)</span>

<span class="c1"># Now we plot those regions. We first create an empty map</span>
<span class="n">empty_map</span> <span class="o">=</span> <span class="n">WcsNDMap</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">skydir</span><span class="o">=</span><span class="n">position</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">binsz</span><span class="o">=</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="s2">&quot;TAN&quot;</span>
<span class="p">)</span>
<span class="n">empty_map</span><span class="o">.</span><span class="n">data</span> <span class="o">+=</span> <span class="mf">1.0</span>
<span class="n">empty_map</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># To plot the regions, we convert them to PixelRegion with the map wcs</span>
<span class="n">on_circle</span><span class="o">.</span><span class="n">to_pixel</span><span class="p">(</span><span class="n">empty_map</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">on_rectangle</span><span class="o">.</span><span class="n">to_pixel</span><span class="p">(</span><span class="n">empty_map</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">on_ellipse_annulus</span><span class="o">.</span><span class="n">to_pixel</span><span class="p">(</span><span class="n">empty_map</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>(<a class="reference external" href="../makers/create_region.png">png</a>, <a class="reference external" href="../makers/create_region.hires.png">hires.png</a>, <a class="reference external" href="../makers/create_region.pdf">pdf</a>)</p>
<figure class="align-default">
<img alt="../_images/create_region.png" class="plot-directive" src="../_images/create_region.png" />
</figure>
</section>
<section id="the-reflected-region-finder">
<h2>The reflected region finder<a class="headerlink" href="#the-reflected-region-finder" title="Permalink to this headline">#</a></h2>
<p>The following example illustrates how to create reflected regions for a given
circular on region and exclusion mask using the
<code class="xref py py-obj docutils literal notranslate"><span class="pre">ReflectedRegionsFinder</span></code>. In particular, it shows how to
change the minimal distance between the ON region and the reflected regions.
This is useful to limit contamination by events leaking out the ON region. It
also shows how to change the minimum distance between adjacent regions as well
as the maximum number of reflected regions.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">Angle</span><span class="p">,</span> <span class="n">SkyCoord</span>
<span class="kn">from</span> <span class="nn">regions</span> <span class="kn">import</span> <span class="n">CircleSkyRegion</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">gammapy.makers</span> <span class="kn">import</span> <span class="n">ReflectedRegionsFinder</span>
<span class="kn">from</span> <span class="nn">gammapy.maps</span> <span class="kn">import</span> <span class="n">RegionGeom</span><span class="p">,</span> <span class="n">WcsNDMap</span>

<span class="c1"># Exclude a rectangular region</span>
<span class="n">exclusion_mask</span> <span class="o">=</span> <span class="n">WcsNDMap</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">npix</span><span class="o">=</span><span class="p">(</span><span class="mi">801</span><span class="p">,</span> <span class="mi">701</span><span class="p">),</span> <span class="n">binsz</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">skydir</span><span class="o">=</span><span class="p">(</span><span class="mf">83.6</span><span class="p">,</span> <span class="mf">23.0</span><span class="p">))</span>

<span class="n">coords</span> <span class="o">=</span> <span class="n">exclusion_mask</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">get_coord</span><span class="p">()</span><span class="o">.</span><span class="n">skycoord</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">Angle</span><span class="p">(</span><span class="s2">&quot;23 deg&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">coords</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coords</span><span class="o">.</span><span class="n">dec</span> <span class="o">&lt;</span> <span class="n">Angle</span><span class="p">(</span><span class="s2">&quot;24 deg&quot;</span><span class="p">))</span>
<span class="n">exclusion_mask</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">~</span><span class="n">data</span>

<span class="n">pos</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="mf">83.633</span><span class="p">,</span> <span class="mf">22.014</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span>
<span class="n">radius</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="s2">&quot;deg&quot;</span><span class="p">)</span>
<span class="n">on_region</span> <span class="o">=</span> <span class="n">CircleSkyRegion</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
<span class="n">center</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="mf">83.633</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span>

<span class="c1"># One can impose a minimal distance between ON region and first reflected regions</span>
<span class="n">finder</span> <span class="o">=</span> <span class="n">ReflectedRegionsFinder</span><span class="p">(</span>
    <span class="n">min_distance_input</span><span class="o">=</span><span class="s2">&quot;0.2 rad&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">regions</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">finder</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">region</span><span class="o">=</span><span class="n">on_region</span><span class="p">,</span>
    <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span>
    <span class="n">exclusion_mask</span><span class="o">=</span><span class="n">exclusion_mask</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="n">exclusion_mask</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">wcs</span><span class="p">},</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">plot_regions</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">on_region</span><span class="p">,</span> <span class="n">exclusion_mask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Little helper function to plot off regions&quot;&quot;&quot;</span>
    <span class="n">exclusion_mask</span><span class="o">.</span><span class="n">plot_mask</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
    <span class="n">on_region</span><span class="o">.</span><span class="n">to_pixel</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">)</span>
    <span class="n">geom</span> <span class="o">=</span> <span class="n">RegionGeom</span><span class="o">.</span><span class="n">from_regions</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
    <span class="n">geom</span><span class="o">.</span><span class="n">plot_region</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">)</span>


<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Min. distance first region&quot;</span><span class="p">)</span>
<span class="n">plot_regions</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">regions</span><span class="o">=</span><span class="n">regions</span><span class="p">,</span> <span class="n">on_region</span><span class="o">=</span><span class="n">on_region</span><span class="p">,</span> <span class="n">exclusion_mask</span><span class="o">=</span><span class="n">exclusion_mask</span><span class="p">)</span>


<span class="c1"># One can impose a minimal distance between two adjacent regions</span>
<span class="n">finder</span> <span class="o">=</span> <span class="n">ReflectedRegionsFinder</span><span class="p">(</span>
    <span class="n">min_distance</span><span class="o">=</span><span class="s2">&quot;0.1 rad&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">regions</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">finder</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">region</span><span class="o">=</span><span class="n">on_region</span><span class="p">,</span>
    <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span>
    <span class="n">exclusion_mask</span><span class="o">=</span><span class="n">exclusion_mask</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Min. distance all regions&quot;</span><span class="p">)</span>
<span class="n">plot_regions</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">regions</span><span class="o">=</span><span class="n">regions</span><span class="p">,</span> <span class="n">on_region</span><span class="o">=</span><span class="n">on_region</span><span class="p">,</span> <span class="n">exclusion_mask</span><span class="o">=</span><span class="n">exclusion_mask</span><span class="p">)</span>


<span class="c1"># One can impose a maximal number of regions to be extracted</span>
<span class="n">finder</span> <span class="o">=</span> <span class="n">ReflectedRegionsFinder</span><span class="p">(</span>
    <span class="n">max_region_number</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">min_distance</span><span class="o">=</span><span class="s2">&quot;0.1 rad&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">regions</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">finder</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">region</span><span class="o">=</span><span class="n">on_region</span><span class="p">,</span>
    <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span>
    <span class="n">exclusion_mask</span><span class="o">=</span><span class="n">exclusion_mask</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Max. number of regions&quot;</span><span class="p">)</span>
<span class="n">plot_regions</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">regions</span><span class="o">=</span><span class="n">regions</span><span class="p">,</span> <span class="n">on_region</span><span class="o">=</span><span class="n">on_region</span><span class="p">,</span> <span class="n">exclusion_mask</span><span class="o">=</span><span class="n">exclusion_mask</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>(<a class="reference external" href="../makers/make_reflected_regions.png">png</a>, <a class="reference external" href="../makers/make_reflected_regions.hires.png">hires.png</a>, <a class="reference external" href="../makers/make_reflected_regions.pdf">pdf</a>)</p>
<figure class="align-default">
<img alt="../_images/make_reflected_regions.png" class="plot-directive" src="../_images/make_reflected_regions.png" />
</figure>
</section>
<section id="using-the-reflected-background-estimator">
<h2>Using the reflected background estimator<a class="headerlink" href="#using-the-reflected-background-estimator" title="Permalink to this headline">#</a></h2>
<p>In practice, the user does not usually need to directly interact with the
<code class="xref py py-obj docutils literal notranslate"><span class="pre">ReflectedRegionsFinder</span></code>. This actually is done via the
<a class="reference internal" href="../api/gammapy.makers.ReflectedRegionsBackgroundMaker.html#gammapy.makers.ReflectedRegionsBackgroundMaker" title="gammapy.makers.ReflectedRegionsBackgroundMaker"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ReflectedRegionsBackgroundMaker</span></code></a>, which extracts the ON
and OFF events for an <a class="reference internal" href="../api/gammapy.data.Observations.html#gammapy.data.Observations" title="gammapy.data.Observations"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Observations</span></code></a> object. The last example
shows how to run it on a few observations with a rectangular region.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Example how to compute and plot reflected regions.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span> <span class="nn">regions</span> <span class="kn">import</span> <span class="n">RectangleSkyRegion</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">gammapy.data</span> <span class="kn">import</span> <span class="n">DataStore</span>
<span class="kn">from</span> <span class="nn">gammapy.datasets</span> <span class="kn">import</span> <span class="n">SpectrumDataset</span>
<span class="kn">from</span> <span class="nn">gammapy.makers</span> <span class="kn">import</span> <span class="n">ReflectedRegionsBackgroundMaker</span><span class="p">,</span> <span class="n">SpectrumDatasetMaker</span>
<span class="kn">from</span> <span class="nn">gammapy.maps</span> <span class="kn">import</span> <span class="n">Map</span><span class="p">,</span> <span class="n">MapAxis</span><span class="p">,</span> <span class="n">RegionGeom</span>
<span class="kn">from</span> <span class="nn">gammapy.visualization</span> <span class="kn">import</span> <span class="n">plot_spectrum_datasets_off_regions</span>

<span class="n">data_store</span> <span class="o">=</span> <span class="n">DataStore</span><span class="o">.</span><span class="n">from_dir</span><span class="p">(</span><span class="s2">&quot;$GAMMAPY_DATA/hess-dl3-dr1/&quot;</span><span class="p">)</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">data_store</span><span class="o">.</span><span class="n">obs_table</span><span class="p">[</span><span class="s2">&quot;TARGET_NAME&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Crab&quot;</span>
<span class="n">obs_ids</span> <span class="o">=</span> <span class="n">data_store</span><span class="o">.</span><span class="n">obs_table</span><span class="p">[</span><span class="s2">&quot;OBS_ID&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">observations</span> <span class="o">=</span> <span class="n">data_store</span><span class="o">.</span><span class="n">get_observations</span><span class="p">(</span><span class="n">obs_ids</span><span class="p">)</span>

<span class="n">crab_position</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="mf">83.63</span><span class="p">,</span> <span class="mf">22.01</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;icrs&quot;</span><span class="p">)</span>

<span class="c1"># The ON region center is defined in the icrs frame. The angle is defined w.r.t. to its axis.</span>
<span class="n">rectangle</span> <span class="o">=</span> <span class="n">RectangleSkyRegion</span><span class="p">(</span>
    <span class="n">center</span><span class="o">=</span><span class="n">crab_position</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">0.4</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
<span class="p">)</span>

<span class="n">bkg_maker</span> <span class="o">=</span> <span class="n">ReflectedRegionsBackgroundMaker</span><span class="p">(</span><span class="n">min_distance</span><span class="o">=</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>
<span class="n">dataset_maker</span> <span class="o">=</span> <span class="n">SpectrumDatasetMaker</span><span class="p">(</span><span class="n">selection</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">])</span>

<span class="n">energy_axis</span> <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_energy_bounds</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TeV&quot;</span><span class="p">)</span>
<span class="n">geom</span> <span class="o">=</span> <span class="n">RegionGeom</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">rectangle</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">energy_axis</span><span class="p">])</span>
<span class="n">dataset_empty</span> <span class="o">=</span> <span class="n">SpectrumDataset</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">geom</span><span class="o">=</span><span class="n">geom</span><span class="p">)</span>

<span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">observations</span><span class="p">:</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset_empty</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;obs-</span><span class="si">{</span><span class="n">obs</span><span class="o">.</span><span class="n">obs_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">obs</span><span class="p">)</span>
    <span class="n">dataset_on_off</span> <span class="o">=</span> <span class="n">bkg_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">observation</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset_on_off</span><span class="p">)</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">skydir</span><span class="o">=</span><span class="n">crab_position</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">proj</span><span class="o">=</span><span class="s2">&quot;TAN&quot;</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">rectangle</span><span class="o">.</span><span class="n">to_pixel</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

<span class="n">plot_spectrum_datasets_off_regions</span><span class="p">(</span><span class="n">datasets</span><span class="o">=</span><span class="n">datasets</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>(<a class="reference external" href="../makers/make_rectangular_reflected_background.png">png</a>, <a class="reference external" href="../makers/make_rectangular_reflected_background.hires.png">hires.png</a>, <a class="reference external" href="../makers/make_rectangular_reflected_background.pdf">pdf</a>)</p>
<figure class="align-default">
<img alt="../_images/make_rectangular_reflected_background.png" class="plot-directive" src="../_images/make_rectangular_reflected_background.png" />
</figure>
<p>The following notebook shows an example using
<a class="reference internal" href="../api/gammapy.makers.ReflectedRegionsBackgroundMaker.html#gammapy.makers.ReflectedRegionsBackgroundMaker" title="gammapy.makers.ReflectedRegionsBackgroundMaker"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ReflectedRegionsBackgroundMaker</span></code></a> to perform a spectral
extraction and fitting:</p>
<div class="toctree-wrapper compound">
</div>
<div class="sphx-glr-thumbcontainer" tooltip="Perform a full region based on-off spectral analysis and fit the resulting datasets.">
  <div class="figure align-center">
    <img alt="thumbnail" src="../_images/tutorials_analysis_1D_spectral_analysis_46_0.png" />
    <p class="caption">
      <span class="caption-text">
        <a class="reference internal" href="../tutorials/analysis/1D/spectral_analysis.html">
          <span class="std std-ref">Spectral analysis</span>
        </a>
      </span>
    </p>
  </div>
</div>
<div class="sphx-glr-clear"></div></section>
</section>


              </div>
              
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, The Gammapy developers.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>