
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Mask maps &#8212; gammapy v0.20</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gammapy.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="shortcut icon" href="../../_static/gammapy_logo.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Survey map" href="../survey_map.html" />
    <link rel="prev" title="Pulsar analysis" href="../analysis/time/pulsar_analysis.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../index.html">
  <img src="../../_static/gammapy_logo_nav.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../getting-started/index.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../userguide/index.html">
  User guide
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../api.html">
  API reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../development/index.html">
  Development
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../changelog/index.html">
  Release notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-primary btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        0.20  <!-- this text may get changed later by javascript -->
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
</div>

<!-- NOTE: this JS must live here (not in our global JS file) because it relies
     on being processed by Jinja before it is run (specifically for replacing
     variables tutorials/api/mask_maps and {'json_url': 'https://docs.gammapy.org/stable/switcher.json', 'version_match': '0.20'}.
-->

<script type="text/javascript">
// Check if corresponding page path exists in other version of docs
// and, if so, go there instead of the homepage of the other docs version
function checkPageExistsAndRedirect(event) {
    const currentFilePath = "tutorials/api/mask_maps.html",
          tryUrl = event.target.getAttribute("href");
    let otherDocsHomepage = tryUrl.replace(currentFilePath, "");
    $.ajax({
        type: 'HEAD',
        url: tryUrl,
        // if the page exists, go there
        success: function() {
            location.href = tryUrl;
        }
    }).fail(function() {
        location.href = otherDocsHomepage;
    });
    // this prevents the browser from following the href of the clicked node
    // (which is fine because this function takes care of redirecting)
    return false;
}

// Populate the version switcher from the JSON config file
(function () {
    $.getJSON("https://docs.gammapy.org/stable/switcher.json", function(data, textStatus, jqXHR) {
        const currentFilePath = "tutorials/api/mask_maps.html";
        // create links to the corresponding page in the other docs versions
        $.each(data, function(index, entry) {
            // if no custom name specified (e.g., "latest"), use version string
            if (!("name" in entry)) {
                entry.name = entry.version;
            }
            // create the node
            const node = document.createElement("a");
            node.setAttribute("class", "list-group-item list-group-item-action py-1");
            node.textContent = `${entry.name}`;
            node.setAttribute("href", `${entry.url}${currentFilePath}`);
            // on click, AJAX calls will check if the linked page exists before
            // trying to redirect, and if not, will redirect to the homepage
            // for that version of the docs.
            node.onclick = checkPageExistsAndRedirect;
            // Add dataset values for the version and name in case people want
            // to apply CSS styling based on this information.
            node.dataset["versionName"] = entry.name;
            node.dataset["version"] = entry.version;

            $("#version_switcher_menu").append(node);
            // replace dropdown button text with the preferred display name of
            // this version, rather than using sphinx's 0.20 variable.
            // also highlight the dropdown entry for the currently-viewed
            // version's entry
            if (entry.version == "0.20") {
                node.classList.add("active");
                let btn = document.getElementById("version_switcher_button");
                btn.innerText = btn.dataset["activeVersionName"] = entry.name;
                btn.dataset["activeVersion"] = entry.version;
            }
        });
    });
})();
</script>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/gammapy/gammapy" rel="noopener" target="_blank" title="Github"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">Github</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/gammapyST" rel="noopener" target="_blank" title="Twitter"><span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://gammapy.slack.com/" rel="noopener" target="_blank" title="Slack"><span><i class="fab fa-slack"></i></span>
            <label class="sr-only">Slack</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../starting/analysis_1.html">
   High level interface
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../starting/analysis_2.html">
   Low level API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../starting/overview.html">
   Data structures
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../data/cta.html">
   CTA with Gammapy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data/hess.html">
   H.E.S.S. with Gammapy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data/fermi_lat.html">
   Fermi-LAT with Gammapy
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/1D/spectral_analysis.html">
   Spectral analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/1D/spectral_analysis_rad_max.html">
   Spectral analysis with energy-dependent directional cuts
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/1D/sed_fitting.html">
   Flux point fitting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/1D/extended_source_spectral_analysis.html">
   Spectral analysis of extended sources
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/1D/spectrum_simulation.html">
   1D spectrum simulation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/1D/cta_sensitivity.html">
   Point source sensitivity
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/2D/ring_background.html">
   Ring background map
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/2D/modeling_2D.html">
   2D map fitting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/2D/detect.html">
   Source detection and significance maps
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/3D/cta_data_analysis.html">
   Basic image exploration and fitting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/3D/analysis_3d.html">
   3D detailed analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/3D/simulate_3d.html">
   3D map simulation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/3D/analysis_mwl.html">
   Multi instrument joint 3D and 1D analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/3D/event_sampling.html">
   Event sampling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/3D/flux_profiles.html">
   Flux Profile Estimation
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/time/light_curve_simulation.html">
   Simulating and fitting a time varying source
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/time/light_curve.html">
   Light curves
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/time/light_curve_flare.html">
   Light curves for flares
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis/time/pulsar_analysis.html">
   Pulsar analysis
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="makers.html">
   Makers - Data reduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="catalog.html">
   Source catalogs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="models.html">
   Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="model_management.html">
   Modelling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="fitting.html">
   Fitting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="maps.html">
   Maps
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Mask maps
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="astro_dark_matter.html">
   Dark matter spatial and spectral models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="datasets.html">
   Datasets - Reduced data, IRFs, models
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../survey_map.html">
   Survey map
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Prerequisites">
   Prerequisites
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Context">
   Context
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Masks-for-fitting:-mask_fit">
     Masks for fitting:
     <code class="docutils literal notranslate">
      <span class="pre">
       mask_fit
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Exclusion-masks">
     Exclusion masks
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Proposed-approach">
   Proposed approach
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Setup">
   Setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Creating-a-mask-for-fitting">
   Creating a mask for fitting
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Create-a-mask-in-energy">
     Create a mask in energy
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Mask-some-sky-regions">
     Mask some sky regions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Creating-a-mask-manually">
     Creating a mask manually
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Creating-an-exclusion-mask">
   Creating an exclusion mask
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Define-the-geometry">
     Define the geometry
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Create-the-mask-from-a-list-of-regions">
     Create the mask from a list of regions
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#Create-the-mask-map">
       Create the mask map
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Create-the-mask-from-a-catalog-of-sources">
     Create the mask from a catalog of sources
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Create-the-mask-from-statistically-significant-pixels-in-a-dataset">
     Create the mask from statistically significant pixels in a dataset
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Masks-operations">
   Masks operations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Mask-modifications">
   Mask modifications
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Mask-dilation-and-erosion">
     Mask dilation and erosion
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Boundary-mask">
     Boundary mask
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Reading-and-writing-masks">
   Reading and writing masks
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<div class="admonition note">
<p class="admonition-title"><strong>This is a fixed-text formatted version of a Jupyter notebook</strong></p>
<ul class="simple">
<li><p>Try online<a class="reference external" href="https://mybinder.org/v2/gh/gammapy/gammapy-webpage/v0.20?urlpath=lab/tree/tutorials/api/mask_maps.ipynb"><img alt="Binder" src="https://static.mybinder.org/badge.svg" /></a></p></li>
<li><p>You may download all the notebooks as a <a class="reference external" href="../../_downloads/notebooks-0.20.tar">tar file</a>.</p></li>
<li><p><strong>Source files:</strong> <a class="reference external" href="../../_static/notebooks/mask_maps.ipynb">mask_maps.ipynb</a> | <a class="reference external" href="../../_static/notebooks/mask_maps.py">mask_maps.py</a></p></li>
</ul>
</div>
<section id="Mask-maps">
<h1>Mask maps<a class="headerlink" href="#Mask-maps" title="Permalink to this headline">#</a></h1>
<section id="Prerequisites">
<h2>Prerequisites<a class="headerlink" href="#Prerequisites" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Understanding of basic analyses in 1D or 3D.</p></li>
<li><p>Usage of <code class="docutils literal notranslate"><span class="pre">~regions</span></code> and catalogs, see the <a class="reference internal" href="catalog.html"><span class="doc">catalog notebook</span></a>.</p></li>
</ul>
</section>
<section id="Context">
<h2>Context<a class="headerlink" href="#Context" title="Permalink to this headline">#</a></h2>
<p>There are two main categories of masks in Gammapy for different use cases. - Fitting often requires to ignore some parts of a reduced dataset, e.g. to restrict the fit to a specific energy range or to ignore parts of the region of interest that the user does not want to model, or both. Gammapy’s <code class="docutils literal notranslate"><span class="pre">Datasets</span></code> therefore contain a <code class="docutils literal notranslate"><span class="pre">mask_fit</span></code> sharing the same geometry as the data (i.e. <code class="docutils literal notranslate"><span class="pre">counts</span></code>). - During data reduction, some background makers will normalize the background model template on the
data themselves. To limit contamination by real photons, one has to exclude parts of the field-of-view where signal is expected to be large. To do so, one needs to provide an exclusion mask. The latter can be provided in a different geometry as it will be reprojected by the <code class="docutils literal notranslate"><span class="pre">Makers</span></code>.</p>
<p>We explain in more details these two types of masks below:</p>
<section id="Masks-for-fitting:-mask_fit">
<h3>Masks for fitting: <code class="docutils literal notranslate"><span class="pre">mask_fit</span></code><a class="headerlink" href="#Masks-for-fitting:-mask_fit" title="Permalink to this headline">#</a></h3>
<p>The region of interest used for the fit can defined through the dataset <code class="docutils literal notranslate"><span class="pre">mask_fit</span></code> attribute. The <code class="docutils literal notranslate"><span class="pre">mask_fit</span></code> is a map containing boolean values where pixels used in the fit are stored as True.</p>
<p>A spectral fit (1D or 3D) can be restricted to a specific energy range where e.g. the background is well estimated or where the number of counts is large enough. Similarly, 2D and 3D analyses usually require to work with a wider map than the region of interest so sources laying outside but reconstructed inside because of the PSF are correctly taken into account. Then the <code class="docutils literal notranslate"><span class="pre">mask_fit</span></code> have to include a margin that take into account the PSF width. We will show an example in the boundary mask
sub-section.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">mask_fit</span></code> also can be used to exclude sources or complex regions for which we don’t have good enough models. In that case the masking is an extra security, it is prefereable to include the available models even if the sources are masked and frozen.</p>
<p>Note that a dataset contains also a <code class="docutils literal notranslate"><span class="pre">mask_safe</span></code> attribute that is created and filled during data reduction. It is not to be modified directly by users. The <code class="docutils literal notranslate"><span class="pre">mask_safe</span></code> is defined only from the options passed to the <code class="docutils literal notranslate"><a href='../../api/gammapy.makers.SafeMaskMaker.html#gammapy.makers.SafeMaskMaker'>gammapy.makers.SafeMaskMaker</a></code> (More details <a class="reference external" href="../../makers/index.html#safe-data-range-handling">here</a>).</p>
</section>
<section id="Exclusion-masks">
<h3>Exclusion masks<a class="headerlink" href="#Exclusion-masks" title="Permalink to this headline">#</a></h3>
<p>Background templates stored in the DL3 IRF are often not reliable enough to be used without some corrections. A set of common techniques to perform background or normalisation from the data is implemented in gammapy: reflected regions for 1D spectrum analysis, field-of-view (FoV) background or ring background for 2D and 3D analyses.</p>
<p>To avoid contamination of the background estimate from gamma-ray bright regions these methods require to exclude those regions from the data used for the estimation. To do so, we use exclusion masks. They are maps containing boolean values where excluded pixels are stored as False.</p>
</section>
</section>
<section id="Proposed-approach">
<h2>Proposed approach<a class="headerlink" href="#Proposed-approach" title="Permalink to this headline">#</a></h2>
<p>Even if the use cases for exclusion masks and fit masks are different, the way to create these masks is exactly the same, so in the following we show how to work with masks in general: - Creating masks from scratch - Combining multiple masks - Extending and reducing an existing mask - Reading and writing masks</p>
</section>
<section id="Setup">
<h2>Setup<a class="headerlink" href="#Setup" title="Permalink to this headline">#</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">Angle</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">regions</span> <span class="kn">import</span> <span class="n">CircleSkyRegion</span><span class="p">,</span> <span class="n">Regions</span>
<span class="kn">from</span> <span class="nn">gammapy.maps</span> <span class="kn">import</span> <span class="n">Map</span><span class="p">,</span> <span class="n">WcsGeom</span><span class="p">,</span> <span class="n">MapAxis</span>
<span class="kn">from</span> <span class="nn">gammapy.catalog</span> <span class="kn">import</span> <span class="n">CATALOG_REGISTRY</span>
<span class="kn">from</span> <span class="nn">gammapy.datasets</span> <span class="kn">import</span> <span class="n">Datasets</span>
<span class="kn">from</span> <span class="nn">gammapy.estimators</span> <span class="kn">import</span> <span class="n">ExcessMapEstimator</span>
<span class="kn">from</span> <span class="nn">gammapy.modeling.models</span> <span class="kn">import</span> <span class="n">FoVBackgroundModel</span>
</pre></div>
</div>
</div>
</section>
<section id="Creating-a-mask-for-fitting">
<h2>Creating a mask for fitting<a class="headerlink" href="#Creating-a-mask-for-fitting" title="Permalink to this headline">#</a></h2>
<p>One can build a <code class="docutils literal notranslate"><span class="pre">mask_fit</span></code> to restrict the energy range of pixels used to fit a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>. The mask being a <code class="docutils literal notranslate"><span class="pre">Map</span></code> it needs to use the same geometry (i.e. a <code class="docutils literal notranslate"><span class="pre">Geom</span></code> object) as the <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> it will be applied to.</p>
<p>We show here how to proceed on a <code class="docutils literal notranslate"><span class="pre">MapDataset</span></code> taken from Fermi data used in the 3FHL catalog. The dataset is already in the form of a <code class="docutils literal notranslate"><span class="pre">Datasets</span></code> object. We read it from disk.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;$GAMMAPY_DATA/fermi-3fhl-crab/Fermi-LAT-3FHL_datasets.yaml&quot;</span>
<span class="n">datasets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;Fermi-LAT&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>We can check the default energy range of the dataset. In the absence of a <code class="docutils literal notranslate"><span class="pre">mask_fit</span></code> it is equal to the safe energy range.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fit range : </span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">energy_range</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
HDU &#39;MASK_FIT&#39; not found
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Fit range : (WcsNDMap

        geom  : WcsGeom
        axes  : [&#39;lon&#39;, &#39;lat&#39;]
        shape : (50, 40)
        ndim  : 2
        unit  : TeV
        dtype : float64
, WcsNDMap

        geom  : WcsGeom
        axes  : [&#39;lon&#39;, &#39;lat&#39;]
        shape : (50, 40)
        ndim  : 2
        unit  : TeV
        dtype : float64
)
</pre></div></div>
</div>
<section id="Create-a-mask-in-energy">
<h3>Create a mask in energy<a class="headerlink" href="#Create-a-mask-in-energy" title="Permalink to this headline">#</a></h3>
<p>We show first how to use a simple helper function <code class="docutils literal notranslate"><a href='../../api/gammapy.maps.Geom.html#gammapy.maps.Geom.energy_range'>gammapy.maps.Geom.energy_range()</a></code>.</p>
<p>We obtain the <code class="docutils literal notranslate"><span class="pre">Geom</span></code> that is stored on the <code class="docutils literal notranslate"><span class="pre">counts</span></code> map inside the <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> and we can directly create the <code class="docutils literal notranslate"><span class="pre">Map</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask_energy</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">energy_mask</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">GeV</span><span class="p">,</span> <span class="mi">700</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">GeV</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can now set the dataset <code class="docutils literal notranslate"><span class="pre">mask_fit</span></code> attribute.</p>
<p>And we check that the total fit range has changed accordingly. The bin edges closest to requested range provide the actual fit range.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span><span class="o">.</span><span class="n">mask_fit</span> <span class="o">=</span> <span class="n">mask_energy</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fit range : </span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">energy_range</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Fit range : (WcsNDMap

        geom  : WcsGeom
        axes  : [&#39;lon&#39;, &#39;lat&#39;]
        shape : (50, 40)
        ndim  : 2
        unit  : TeV
        dtype : float64
, WcsNDMap

        geom  : WcsGeom
        axes  : [&#39;lon&#39;, &#39;lat&#39;]
        shape : (50, 40)
        ndim  : 2
        unit  : TeV
        dtype : float64
)
</pre></div></div>
</div>
</section>
<section id="Mask-some-sky-regions">
<h3>Mask some sky regions<a class="headerlink" href="#Mask-some-sky-regions" title="Permalink to this headline">#</a></h3>
<p>One might also exclude some specific part of the sky for the fit. For instance, if one wants not to model a specific source in the region of interest, or if one want to reduce the region of interest in the dataset <code class="docutils literal notranslate"><span class="pre">Geom</span></code>.</p>
<p>In the following we restrict the fit region to a square around the Crab nebula. <strong>Note</strong>: the dataset geometry is aligned on the galactic frame, we use the same frame to define the box to ensure a correct alignment. We can now create the map. We use the <code class="docutils literal notranslate"><span class="pre">WcsGeom.region_mask</span></code> method putting all pixels outside the regions to False (because we only want to consider pixels inside the region. For convenience we can directly pass a ds9 region string to the method:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">regions</span> <span class="o">=</span> <span class="s2">&quot;galactic;box(184.55, -5.78, 3.0, 3.0)&quot;</span>
<span class="n">mask_map</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">region_mask</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can now combine this mask with the energy mask using the logical and operator</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span><span class="o">.</span><span class="n">mask_fit</span> <span class="o">&amp;=</span> <span class="n">mask_map</span>
</pre></div>
</div>
</div>
<p>Let’s check the result and plot the full mask.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">mask_fit</span><span class="o">.</span><span class="n">plot_grid</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_api_mask_maps_18_0.png" src="../../_images/tutorials_api_mask_maps_18_0.png" />
</div>
</div>
</section>
<section id="Creating-a-mask-manually">
<h3>Creating a mask manually<a class="headerlink" href="#Creating-a-mask-manually" title="Permalink to this headline">#</a></h3>
<p>If you are more familiar with the <code class="docutils literal notranslate"><span class="pre">Geom</span></code> and <code class="docutils literal notranslate"><span class="pre">Map</span></code> API, you can also create the mask manually from the coordinates of all pixels in the geometry. Here we simply show how to obtain the same behaviour as the <code class="docutils literal notranslate"><span class="pre">energy_mask</span></code> helper method.</p>
<p>In practice, this allows to create complex energy dependent masks.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coords</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">get_coord</span><span class="p">()</span>
<span class="n">mask_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">GeV</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">700</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">GeV</span><span class="p">)</span>
<span class="n">mask_energy</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">from_geom</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">mask_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="Creating-an-exclusion-mask">
<h2>Creating an exclusion mask<a class="headerlink" href="#Creating-an-exclusion-mask" title="Permalink to this headline">#</a></h2>
<p>Exclusion masks are typically used for background estimation to mask out regions where gamma-ray signal is expected. An exclusion mask is usually a simple 2D boolean <code class="docutils literal notranslate"><span class="pre">Map</span></code> where excluded positions are stored as <code class="docutils literal notranslate"><span class="pre">False</span></code>. Their actual geometries are independent of the target datasets that a user might want to build. The first thing to do is to build the geometry.</p>
<section id="Define-the-geometry">
<h3>Define the geometry<a class="headerlink" href="#Define-the-geometry" title="Permalink to this headline">#</a></h3>
<p>Masks are stored in <code class="docutils literal notranslate"><span class="pre">Map</span></code> objects. We must first define its geometry and then we can determine which pixels to exclude. Here we consider a region at the Galactic anticentre around the crab nebula.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">position</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="mf">83.633083</span><span class="p">,</span> <span class="mf">22.0145</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;icrs&quot;</span><span class="p">)</span>
<span class="n">geom</span> <span class="o">=</span> <span class="n">WcsGeom</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">skydir</span><span class="o">=</span><span class="n">position</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;5 deg&quot;</span><span class="p">,</span> <span class="n">binsz</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;galactic&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Create-the-mask-from-a-list-of-regions">
<h3>Create the mask from a list of regions<a class="headerlink" href="#Create-the-mask-from-a-list-of-regions" title="Permalink to this headline">#</a></h3>
<p>One can build an exclusion mask from regions. We show here how to proceed.</p>
<p>We can rely on known sources positions and properties to build a list of regions (here <code class="docutils literal notranslate"><span class="pre">~regions.SkyRegions</span></code>) enclosing most of the signal that our detector would see from these objects.</p>
<p>A useful function to create region objects is <code class="docutils literal notranslate"><span class="pre">~regions.regions.parse</span></code>. It can take strings defining regions e.g. following the “ds9” format and convert them to <code class="docutils literal notranslate"><span class="pre">regions</span></code>.</p>
<p>Here we use a region enclosing the Crab nebula with 0.3 degrees. The actual region size should depend on the expected PSF of the data used. We also add another region with a different shape as en example.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">regions_ds9</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;galactic;box(185,-4,1.0,0.5, 45);icrs;circle(83.633083, 22.0145, 0.3)&quot;</span>
<span class="p">)</span>
<span class="n">regions</span> <span class="o">=</span> <span class="n">Regions</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">regions_ds9</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;ds9&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;RectangleSkyRegion(center=&lt;SkyCoord (Galactic): (l, b) in deg
    (185., -4.)&gt;, width=1.0 deg, height=0.5 deg, angle=45.0 deg)&gt;, &lt;CircleSkyRegion(center=&lt;SkyCoord (ICRS): (ra, dec) in deg
    (83.633083, 22.0145)&gt;, radius=0.3 deg)&gt;]
</pre></div></div>
</div>
<p>Equivalently the regions can be read from a ds9 file, this time using <code class="docutils literal notranslate"><span class="pre">Regions.read</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># regions = Regions.read(&#39;ds9.reg&#39;, format=&quot;ds9&quot;)</span>
</pre></div>
</div>
</div>
<section id="Create-the-mask-map">
<h4>Create the mask map<a class="headerlink" href="#Create-the-mask-map" title="Permalink to this headline">#</a></h4>
<p>We can now create the map. We use the <code class="docutils literal notranslate"><span class="pre">WcsGeom.region_mask</span></code> method putting all pixels inside the regions to False.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># to define the exclusion mask we take the inverse</span>
<span class="n">mask_map</span> <span class="o">=</span> <span class="o">~</span><span class="n">geom</span><span class="o">.</span><span class="n">region_mask</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask_map</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_api_mask_maps_29_0.png" src="../../_images/tutorials_api_mask_maps_29_0.png" />
</div>
</div>
</section>
</section>
<section id="Create-the-mask-from-a-catalog-of-sources">
<h3>Create the mask from a catalog of sources<a class="headerlink" href="#Create-the-mask-from-a-catalog-of-sources" title="Permalink to this headline">#</a></h3>
<p>We can also build our list of regions from a list of catalog sources. Here we use the Fermi 4FGL catalog which we read using <code class="docutils literal notranslate"><a href='../../api/gammapy.catalog.SourceCatalog.html#gammapy.catalog.SourceCatalog'>gammapy.catalog.SourceCatalog</a></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fgl</span> <span class="o">=</span> <span class="n">CATALOG_REGISTRY</span><span class="o">.</span><span class="n">get_cls</span><span class="p">(</span><span class="s2">&quot;4fgl&quot;</span><span class="p">)()</span>
</pre></div>
</div>
</div>
<p>We now select sources that are contained in the region we are interested in.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inside_geom</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">fgl</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">fgl</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">inside_geom</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>We now create the list of regions using our 0.3 degree radius a priori value. If the sources were extended, one would have to adapt the sizes to account for the larger size.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exclusion_radius</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="s2">&quot;0.3 deg&quot;</span><span class="p">)</span>
<span class="n">regions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">CircleSkyRegion</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">exclusion_radius</span><span class="p">)</span> <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">positions</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<p>Now we can build the mask map the same way as above.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask_map_catalog</span> <span class="o">=</span> <span class="o">~</span><span class="n">geom</span><span class="o">.</span><span class="n">region_mask</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask_map_catalog</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_api_mask_maps_38_0.png" src="../../_images/tutorials_api_mask_maps_38_0.png" />
</div>
</div>
</section>
<section id="Create-the-mask-from-statistically-significant-pixels-in-a-dataset">
<h3>Create the mask from statistically significant pixels in a dataset<a class="headerlink" href="#Create-the-mask-from-statistically-significant-pixels-in-a-dataset" title="Permalink to this headline">#</a></h3>
<p>Here we want to determine an exclusion from the data directly. We will estimate the significance of the data using the <code class="docutils literal notranslate"><span class="pre">ExcessMapEstimator</span></code>, and exclude all pixels above a given threshold.</p>
<p>Here we use the <code class="docutils literal notranslate"><span class="pre">MapDataset</span></code> taken from the Fermi data used above.</p>
<p>We apply a significance estimation. We integrate the counts using a correlation radius of 0.4 degree and apply regular significance estimate.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">estimator</span> <span class="o">=</span> <span class="n">ExcessMapEstimator</span><span class="p">(</span><span class="s2">&quot;0.4 deg&quot;</span><span class="p">,</span> <span class="n">selection_optional</span><span class="o">=</span><span class="p">[])</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Finally, we create the mask map by applying a threshold of 5 sigma to remove pixels.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">significance_mask</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;sqrt_ts&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">5.0</span>
</pre></div>
</div>
</div>
<p>Because the <code class="docutils literal notranslate"><span class="pre">ExcessMapEstimator</span></code> returns NaN for masked pixels, we need to put the NaN values to <code class="docutils literal notranslate"><span class="pre">True</span></code> to avoid incorrectly excluding them.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">invalid_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;sqrt_ts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">significance_mask</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">invalid_pixels</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">significance_mask</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_api_mask_maps_46_0.png" src="../../_images/tutorials_api_mask_maps_46_0.png" />
</div>
</div>
<p>This method frequently yields isolated pixels or weakly significant features if one places the threshold too low.</p>
<p>To overcome this issue, one can use <code class="docutils literal notranslate"><span class="pre">~skimage.filters.apply_hysteresis_threshold</span></code> . This filter allows to define two thresholds and mask only the pixels between the low and high thresholds if they are not continuously connected to a pixel above the high threshold. This allows to better preserve the structure of the excesses.</p>
<p>Note that scikit-image is not a required dependency of gammapy, you might need to install it.</p>
</section>
</section>
<section id="Masks-operations">
<h2>Masks operations<a class="headerlink" href="#Masks-operations" title="Permalink to this headline">#</a></h2>
<p>If two masks share the same geometry it is easy to combine them with <code class="docutils literal notranslate"><span class="pre">Map</span></code> arithmetic.</p>
<p>OR condition is represented by <code class="docutils literal notranslate"><span class="pre">|</span></code> operator :</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask_map</span> <span class="o">|</span> <span class="n">mask_map_catalog</span>
<span class="n">mask</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_api_mask_maps_49_0.png" src="../../_images/tutorials_api_mask_maps_49_0.png" />
</div>
</div>
<p>AND condition is represented by <code class="docutils literal notranslate"><span class="pre">&amp;</span></code> or <code class="docutils literal notranslate"><span class="pre">*</span></code> operators :</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask_map</span> <span class="o">&amp;=</span> <span class="n">mask_map_catalog</span>
<span class="n">mask_map</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_api_mask_maps_51_0.png" src="../../_images/tutorials_api_mask_maps_51_0.png" />
</div>
</div>
<p>The NOT operator is represented by <code class="docutils literal notranslate"><span class="pre">~</span></code> symbol:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">significance_mask_inv</span> <span class="o">=</span> <span class="o">~</span><span class="n">significance_mask</span>
<span class="n">significance_mask_inv</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_api_mask_maps_53_0.png" src="../../_images/tutorials_api_mask_maps_53_0.png" />
</div>
</div>
</section>
<section id="Mask-modifications">
<h2>Mask modifications<a class="headerlink" href="#Mask-modifications" title="Permalink to this headline">#</a></h2>
<section id="Mask-dilation-and-erosion">
<h3>Mask dilation and erosion<a class="headerlink" href="#Mask-dilation-and-erosion" title="Permalink to this headline">#</a></h3>
<p>One can reduce or extend a mask using <code class="docutils literal notranslate"><span class="pre">binary_erode</span></code> and <code class="docutils literal notranslate"><span class="pre">binary_dilate</span></code> methods, respectively.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask</span> <span class="o">=</span> <span class="n">significance_mask_inv</span><span class="o">.</span><span class="n">binary_erode</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s2">&quot;disk&quot;</span><span class="p">)</span>
<span class="n">mask</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_api_mask_maps_55_0.png" src="../../_images/tutorials_api_mask_maps_55_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask</span> <span class="o">=</span> <span class="n">significance_mask_inv</span><span class="o">.</span><span class="n">binary_dilate</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
<span class="n">mask</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_api_mask_maps_56_0.png" src="../../_images/tutorials_api_mask_maps_56_0.png" />
</div>
</div>
</section>
<section id="Boundary-mask">
<h3>Boundary mask<a class="headerlink" href="#Boundary-mask" title="Permalink to this headline">#</a></h3>
<p>In the following example we use the Fermi dataset previously loaded and add its <code class="docutils literal notranslate"><span class="pre">mask_fit</span></code> taking into account a margin based on the psf width. The margin width is determined using the <code class="docutils literal notranslate"><span class="pre">containment_radius</span></code> method of the psf object and the mask is created using the <code class="docutils literal notranslate"><span class="pre">boundary_mask</span></code> method available on the geometry object.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get PSF 95% containment radius</span>
<span class="n">energy_true</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">center</span>
<span class="n">psf_r95</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">psf</span><span class="o">.</span><span class="n">containment_radius</span><span class="p">(</span>
    <span class="n">fraction</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">energy_true</span><span class="o">=</span><span class="n">energy_true</span>
<span class="p">)</span>
<span class="c1"># create mask_fit with margin based on PSF</span>
<span class="n">mask_fit</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">boundary_mask</span><span class="p">(</span><span class="n">psf_r95</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">dataset</span><span class="o">.</span><span class="n">mask_fit</span> <span class="o">=</span> <span class="n">mask_fit</span>
<span class="n">dataset</span><span class="o">.</span><span class="n">mask_fit</span><span class="o">.</span><span class="n">sum_over_axes</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_api_mask_maps_58_0.png" src="../../_images/tutorials_api_mask_maps_58_0.png" />
</div>
</div>
</section>
</section>
<section id="Reading-and-writing-masks">
<h2>Reading and writing masks<a class="headerlink" href="#Reading-and-writing-masks" title="Permalink to this headline">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">gammapy.maps</span></code> can directly read/write maps with boolean content as follows:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To save masks to disk</span>
<span class="n">mask_map</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;exclusion_mask.fits&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="s2">&quot;True&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To read maps from disk</span>
<span class="n">mask_map</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;exclusion_mask.fits&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


              </div>
              
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, The Gammapy developers.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>