<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>gammapy.data.obs_group &#8212; gammapy v0.6</title>
    
    <link rel="stylesheet" href="../../../_static/gammapy.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://media.readthedocs.org/css/badge_only.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/jquery/jquery-2.0.3.min.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/jquery/jquery-migrate-1.2.1.min.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/underscore.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/readthedocs-doc-embed.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <link rel="shortcut icon" href="../../../_static/astropy_logo.ico"/>
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>
<script type="text/javascript" src="../../../_static/copybutton.js"></script>


  
<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="http://docs.gammapy.org/en/latest/_modules/gammapy/data/obs_group.html" />

<link rel="stylesheet" href="https://media.readthedocs.org/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="../../../_static/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = '_modules/gammapy/data/obs_group'
</script>

<script type="text/javascript" src="../../../_static/readthedocs-dynamic-include.js"></script>

<!-- end RTD <extrahead> --></head>
  <body role="document">
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">gamma</span><span id="logotext2">py</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">gammapy v0.6</a>
	 &#187;
      </li>
      <li><a href="../../index.html" >Module code</a> &#187;</li>
      <li><a href="../data.html" accesskey="U">gammapy.data</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for gammapy.data.obs_group</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="k">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">vstack</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="k">import</span> <span class="n">Angle</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">ascii</span>
<span class="kn">from</span> <span class="nn">astropy.units</span> <span class="k">import</span> <span class="n">Quantity</span>
<span class="kn">from</span> <span class="nn">..extern.pathlib</span> <span class="k">import</span> <span class="n">Path</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;ObservationGroupAxis&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ObservationGroups&#39;</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="ObservationGroups"><a class="viewcode-back" href="../../../api/gammapy.data.ObservationGroups.html#gammapy.data.ObservationGroups">[docs]</a><span class="k">class</span> <span class="nc">ObservationGroups</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Observation groups.</span>

<span class="sd">    Class to define observation groups useful for organizing observation</span>
<span class="sd">    lists into groups of observations with similar properties.</span>

<span class="sd">    The properties and their binning are specified via</span>
<span class="sd">    `~gammapy.data.ObservationGroupAxis` objects.</span>

<span class="sd">    The class takes as input a list of `~gammapy.data.ObservationGroupAxis`</span>
<span class="sd">    objects and defines one group for each possible combination of the</span>
<span class="sd">    bins defined in all axes (cartesian product).</span>
<span class="sd">    The groups are identified by a unique ``GROUP_ID`` int value.</span>

<span class="sd">    The definitions of the groups are internally stored as a</span>
<span class="sd">    `~astropy.table.Table` object, the ``obs_groups_table`` member.</span>

<span class="sd">    The axis parameters should be either dimensionless or castable</span>
<span class="sd">    into `~astropy.units.Quantity` objects.</span>

<span class="sd">    For details on the grouping of observations in a list, please</span>
<span class="sd">    refer to the `~gammapy.data.ObservationGroups.apply` method.</span>

<span class="sd">    See also :ref:`obs_observation_grouping`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    axes : list of `~gammapy.data.ObservationGroupAxis`</span>
<span class="sd">        List of observation group axes.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Define an observation grouping:</span>

<span class="sd">    .. code:: python</span>

<span class="sd">        alt = Angle([0, 30, 60, 90], &#39;deg&#39;)</span>
<span class="sd">        az = Angle([-90, 90, 270], &#39;deg&#39;)</span>
<span class="sd">        ntels = np.array([3, 4])</span>
<span class="sd">        obs_groups = ObservationGroups([</span>
<span class="sd">            ObservationGroupAxis(&#39;ALT&#39;, alt, fmt=&#39;edges&#39;),</span>
<span class="sd">            ObservationGroupAxis(&#39;AZ&#39;, az, fmt=&#39;edges&#39;),</span>
<span class="sd">            ObservationGroupAxis(&#39;N_TELS&#39;, ntels, fmt=&#39;values&#39;),</span>
<span class="sd">        ])</span>

<span class="sd">    Print the observation group table (group definitions):</span>

<span class="sd">    &gt;&gt;&gt; print(obs_groups.obs_groups_table)</span>

<span class="sd">    Print the observation group axes:</span>

<span class="sd">    &gt;&gt;&gt; print(obs_groups.info)</span>

<span class="sd">    Group the observations of an observation list and print them:</span>

<span class="sd">    &gt;&gt;&gt; obs_table_grouped = obs_groups.apply(obs_table)</span>
<span class="sd">    &gt;&gt;&gt; print(obs_table_grouped)</span>

<span class="sd">    Get the observations of a particular group and print them:</span>

<span class="sd">    &gt;&gt;&gt; obs_table_group8 = obs_groups.get_group_of_observations(obs_table_grouped, 8)</span>
<span class="sd">    &gt;&gt;&gt; print(obs_table_group8)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axes</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs_groups_table</span> <span class="o">=</span> <span class="n">ObservationGroups</span><span class="o">.</span><span class="n">axes_to_table</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of groups (int).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_groups_table</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">list_of_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of groups (`~numpy.ndarray`).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_groups_table</span><span class="p">[</span><span class="s1">&#39;GROUP_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ObservationGroups.axes_to_table"><a class="viewcode-back" href="../../../api/gammapy.data.ObservationGroups.html#gammapy.data.ObservationGroups.axes_to_table">[docs]</a>    <span class="k">def</span> <span class="nf">axes_to_table</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fill the observation group axes into a table.</span>

<span class="sd">        Define one row for each possible combination of the</span>
<span class="sd">        observation group axis bins. Each row will represent</span>
<span class="sd">        an observation group.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        axes : `~gammapy.data.ObservationGroupAxis`</span>
<span class="sd">            List of observation group axes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        table : `~astropy.table.Table`</span>
<span class="sd">            Table containing the observation group definitions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># define table column data</span>
        <span class="n">column_data_min</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">column_data_max</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># loop over observation axes</span>
        <span class="k">for</span> <span class="n">i_axis</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;values&#39;</span><span class="p">:</span>
                <span class="n">column_data_min</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">bins</span><span class="p">)</span>
                <span class="n">column_data_max</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">bins</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;edges&#39;</span><span class="p">:</span>
                <span class="n">column_data_min</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">column_data_max</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="c1"># define grids of column data</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
        <span class="n">s0</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="n">ndim</span>
        <span class="n">expanding_arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s0</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">s0</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">::])</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">column_data_min</span><span class="p">)]</span>
        <span class="n">column_data_expanded_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_arrays</span><span class="p">(</span><span class="o">*</span><span class="n">expanding_arrays</span><span class="p">)</span>
        <span class="n">expanding_arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s0</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">s0</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">::])</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">column_data_max</span><span class="p">)]</span>
        <span class="n">column_data_expanded_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_arrays</span><span class="p">(</span><span class="o">*</span><span class="n">expanding_arrays</span><span class="p">)</span>

        <span class="c1"># recover units</span>
        <span class="k">for</span> <span class="n">i_dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
            <span class="n">column_data_expanded_min</span><span class="p">[</span><span class="n">i_dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">_recover_units</span><span class="p">(</span><span class="n">column_data_expanded_min</span><span class="p">[</span><span class="n">i_dim</span><span class="p">],</span>
                                                             <span class="n">column_data_min</span><span class="p">[</span><span class="n">i_dim</span><span class="p">])</span>
            <span class="n">column_data_expanded_max</span><span class="p">[</span><span class="n">i_dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">_recover_units</span><span class="p">(</span><span class="n">column_data_expanded_max</span><span class="p">[</span><span class="n">i_dim</span><span class="p">],</span>
                                                             <span class="n">column_data_max</span><span class="p">[</span><span class="n">i_dim</span><span class="p">])</span>

        <span class="c1"># Make the table</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i_axis</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;values&#39;</span><span class="p">:</span>
                <span class="n">table</span><span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_data_expanded_min</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;edges&#39;</span><span class="p">:</span>
                <span class="n">table</span><span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_MIN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_data_expanded_min</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">table</span><span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_MAX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_data_expanded_max</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="n">ObservationGroups</span><span class="o">.</span><span class="n">_add_group_id</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">axes</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">table</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_add_group_id</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">axes</span><span class="p">):</span>
        <span class="c1"># Compute number of groups</span>
        <span class="n">n_groups</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i_axis</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
            <span class="n">n_groups</span> <span class="o">*=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">n_bins</span>

        <span class="c1"># fill table, with first the obs group IDs, then the axis columns</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;GROUP_ID&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_groups</span><span class="p">))</span>
        <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">table</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ObservationGroups.table_to_axes"><a class="viewcode-back" href="../../../api/gammapy.data.ObservationGroups.html#gammapy.data.ObservationGroups.table_to_axes">[docs]</a>    <span class="k">def</span> <span class="nf">table_to_axes</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Define observation group axis list from a table.</span>

<span class="sd">        Interpret the combinations of bins from a table of groups</span>
<span class="sd">        in order to define the corresponding observation group axes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        table : `~astropy.table.Table`</span>
<span class="sd">            Table containing the observation group definitions.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        axes : `~gammapy.data.ObservationGroupAxis`</span>
<span class="sd">            List of observation group axes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># subset table: remove obs groups column</span>
        <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;GROUP_ID&#39;</span><span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">table</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>

        <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i_col</span><span class="p">,</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># recover units</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">_recover_units</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">table</span><span class="p">[</span><span class="n">col_name</span><span class="p">])</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ObservationGroupAxis</span><span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;values&#39;</span><span class="p">))</span>
            <span class="c1"># format will be reviewed in a further step</span>

        <span class="c1"># detect range variables and eventually merge columns</span>
        <span class="k">for</span> <span class="n">i_col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">split_name_min</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i_col</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">split_name_max</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i_col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">split_name_min</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MIN&#39;</span>
                    <span class="ow">and</span> <span class="n">split_name_max</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MAX&#39;</span>
                    <span class="ow">and</span> <span class="n">split_name_min</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">split_name_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">min_values</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i_col</span><span class="p">]</span><span class="o">.</span><span class="n">bins</span>
                    <span class="n">max_values</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i_col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bins</span>
                    <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">min_values</span><span class="p">,</span> <span class="n">max_values</span><span class="p">))</span>
                    <span class="c1"># recover units</span>
                    <span class="n">edges</span> <span class="o">=</span> <span class="n">_recover_units</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">min_values</span><span class="p">)</span>

                    <span class="n">axes</span><span class="p">[</span><span class="n">i_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">ObservationGroupAxis</span><span class="p">(</span><span class="n">split_name_min</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edges</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;edges&#39;</span><span class="p">)</span>
                    <span class="n">axes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i_col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># remove next entry on the list</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">axes</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ObservationGroups.read"><a class="viewcode-back" href="../../../api/gammapy.data.ObservationGroups.html#gammapy.data.ObservationGroups.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read observation group definitions from ECSV file.</span>

<span class="sd">        Using `~astropy.table.Table` and `~astropy.io.ascii`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            Name of the file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        obs_groups : `~gammapy.data.ObservationGroups`</span>
<span class="sd">            Observation groups object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">ObservationGroups</span><span class="o">.</span><span class="n">table_to_axes</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span></div>

<div class="viewcode-block" id="ObservationGroups.write"><a class="viewcode-back" href="../../../api/gammapy.data.ObservationGroups.html#gammapy.data.ObservationGroups.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write observation group definitions to ECSV file.</span>

<span class="sd">        Using `~astropy.table.Table` and `~astropy.io.ascii`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        outfile : str</span>
<span class="sd">            Name of the file.</span>
<span class="sd">        overwrite : bool, optional</span>
<span class="sd">            Flag to control file overwriting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># there is no overwrite option in `~astropy.io.ascii`</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">or</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="n">ascii</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_groups_table</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span>
                        <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ecsv&#39;</span><span class="p">,</span> <span class="n">fast_writer</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Info string (str).&quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="c1"># loop over observation axes</span>
        <span class="k">for</span> <span class="n">i_axis</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">)):</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">info</span>
            <span class="k">if</span> <span class="n">i_axis</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">s</span>

<div class="viewcode-block" id="ObservationGroups.info_group"><a class="viewcode-back" href="../../../api/gammapy.data.ObservationGroups.html#gammapy.data.ObservationGroups.info_group">[docs]</a>    <span class="k">def</span> <span class="nf">info_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Group info string.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_id : int</span>
<span class="sd">            ID of the group to gather info on.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s : str</span>
<span class="sd">            Group info string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;group </span><span class="si">{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group_id</span><span class="p">)</span>
        <span class="c1"># find group row in obs groups table</span>
        <span class="n">group_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_groups_table</span><span class="p">[</span><span class="s1">&#39;GROUP_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">group_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">group_ids</span> <span class="o">==</span> <span class="n">group_id</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">group_index</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># loop over observation axes</span>
        <span class="k">for</span> <span class="n">i_axis</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">i_axis</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;,&#39;</span>

            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;edges&#39;</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;[&#39;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_groups_table</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_MIN&#39;</span><span class="p">][</span><span class="n">row</span><span class="p">])</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;, &#39;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_groups_table</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_MAX&#39;</span><span class="p">][</span><span class="n">row</span><span class="p">])</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;values&#39;</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_groups_table</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">row</span><span class="p">])</span>

            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">bins</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">s</span></div>

<div class="viewcode-block" id="ObservationGroups.apply"><a class="viewcode-back" href="../../../api/gammapy.data.ObservationGroups.html#gammapy.data.ObservationGroups.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs_table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Group observations in a list according to the defined groups.</span>

<span class="sd">        The method returns the same observation table with an extra</span>
<span class="sd">        column in the 1st position indicating the group ID of each</span>
<span class="sd">        observation.</span>

<span class="sd">        The algorithm expects the same format (naming and variable</span>
<span class="sd">        definition range) for both the grouping axis definition and</span>
<span class="sd">        the corresponding variable in the table. For instance, if the</span>
<span class="sd">        azimuth axis binning is defined as ``AZ`` with bin edges</span>
<span class="sd">        ``[-90, 90, 270]`` (North and South bins), the input obs table</span>
<span class="sd">        should have an azimuth column defined as ``AZ`` and wrapped</span>
<span class="sd">        at ``270 deg``. This can easily be done by calling:</span>

<span class="sd">        &gt;&gt;&gt; obs_table[&#39;AZ&#39;] = Angle(obs_table[&#39;AZ&#39;]).wrap_at(Angle(270., &#39;deg&#39;))</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs_table : `~gammapy.data.ObservationTable`</span>
<span class="sd">            Observation list to group.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        obs_table_grouped : `~gammapy.data.ObservationTable`</span>
<span class="sd">            Grouped observation list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># read the obs groups table row by row (i.e. 1 group at</span>
        <span class="c1"># a time) and lookup the range/value for each parameter</span>
        <span class="n">n_axes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
        <span class="n">list_obs_table_grouped</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i_row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_groups</span><span class="p">):</span>
            <span class="n">i_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_groups_table</span><span class="p">[</span><span class="s1">&#39;GROUP_ID&#39;</span><span class="p">][</span><span class="n">i_row</span><span class="p">]</span>
            <span class="c1"># loop over obs group axes to find out the names and formats</span>
            <span class="c1"># of the parameters to define the selection criteria</span>
            <span class="n">obs_table_selected</span> <span class="o">=</span> <span class="n">obs_table</span>
            <span class="k">for</span> <span class="n">i_axis</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_axes</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">]</span><span class="o">.</span><span class="n">fmt</span>

                <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;edges&#39;</span><span class="p">:</span>
                    <span class="n">min_value</span> <span class="o">=</span> <span class="n">_recover_units</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_groups_table</span><span class="p">[</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_MIN&#39;</span><span class="p">][</span><span class="n">i_row</span><span class="p">],</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">obs_groups_table</span><span class="p">[</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_MIN&#39;</span><span class="p">])</span>
                    <span class="n">max_value</span> <span class="o">=</span> <span class="n">_recover_units</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_groups_table</span><span class="p">[</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_MAX&#39;</span><span class="p">][</span><span class="n">i_row</span><span class="p">],</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">obs_groups_table</span><span class="p">[</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_MAX&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;values&#39;</span><span class="p">:</span>
                    <span class="n">min_value</span> <span class="o">=</span> <span class="n">_recover_units</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_groups_table</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">i_row</span><span class="p">],</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">obs_groups_table</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
                    <span class="n">max_value</span> <span class="o">=</span> <span class="n">min_value</span>
                <span class="c1"># apply selection to the table</span>
                <span class="n">selection</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;par_box&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                 <span class="n">value_range</span><span class="o">=</span><span class="p">(</span><span class="n">min_value</span><span class="p">,</span> <span class="n">max_value</span><span class="p">))</span>
                <span class="n">obs_table_selected</span> <span class="o">=</span> <span class="n">obs_table_selected</span><span class="o">.</span><span class="n">select_observations</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>

            <span class="c1"># define group and fill in list of grouped observation tables</span>
            <span class="n">group_id_data</span> <span class="o">=</span> <span class="n">i_group</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_table_selected</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
            <span class="n">obs_table_selected</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;GROUP_ID&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">group_id_data</span><span class="p">),</span>
                                          <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">list_obs_table_grouped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs_table_selected</span><span class="p">)</span>

        <span class="c1"># stack all groups</span>
        <span class="n">obs_table_grouped</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">(</span><span class="n">list_obs_table_grouped</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">obs_table_grouped</span></div>

<div class="viewcode-block" id="ObservationGroups.get_group_of_observations"><a class="viewcode-back" href="../../../api/gammapy.data.ObservationGroups.html#gammapy.data.ObservationGroups.get_group_of_observations">[docs]</a>    <span class="k">def</span> <span class="nf">get_group_of_observations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs_table</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span>
                                  <span class="n">inverted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_grouping</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select the runs corresponding to a particular group.</span>

<span class="sd">        If the inverted flag is activated, the selection is applied to</span>
<span class="sd">        exclude the indicated group and keep all others.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs_table : `~gammapy.data.ObservationTable`</span>
<span class="sd">            Observation list to select from.</span>
<span class="sd">        group : int</span>
<span class="sd">            Group ID to select.</span>
<span class="sd">        inverted : bool, optional</span>
<span class="sd">            Invert selection: exclude the indicated group and keep the rest.</span>
<span class="sd">        apply_grouping : bool, optional</span>
<span class="sd">            Flag to indicate if the observation grouping should take place.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        obs_table_group : `~gammapy.data.ObservationTable`</span>
<span class="sd">            Observation list of a specific group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">apply_grouping</span><span class="p">:</span>
            <span class="n">obs_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">obs_table</span><span class="p">)</span>

        <span class="n">selection</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;par_box&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="s1">&#39;GROUP_ID&#39;</span><span class="p">,</span>
                         <span class="n">value_range</span><span class="o">=</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">group</span><span class="p">),</span> <span class="n">inverted</span><span class="o">=</span><span class="n">inverted</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obs_table</span><span class="o">.</span><span class="n">select_observations</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ObservationGroupAxis"><a class="viewcode-back" href="../../../api/gammapy.data.ObservationGroupAxis.html#gammapy.data.ObservationGroupAxis">[docs]</a><span class="k">class</span> <span class="nc">ObservationGroupAxis</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Observation group axis.</span>

<span class="sd">    Class to define an axis along which to define bins for creating observation groups.</span>

<span class="sd">    Two kinds of axis are supported, depending on the value of the ``fmt`` parameter:</span>

<span class="sd">    - ``fmt=&#39;edges&#39;`` for continuous axes (e.g. altitude angle)</span>
<span class="sd">    - ``fmt=&#39;values&#39;`` for discrete axes (e.g. number of telescopes)</span>

<span class="sd">    In both cases, both, dimensionless and</span>
<span class="sd">    `~astropy.units.Quantity`-like parameter axes are supported.</span>

<span class="sd">    See also :ref:`obs_observation_grouping`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of the parameter to bin.</span>
<span class="sd">    bins : int, float or `~astropy.units.Quantity`-like</span>
<span class="sd">        Array of values or bin edges, depending on the ``fmt`` parameter.</span>
<span class="sd">    fmt : {&#39;edges&#39;, &#39;values&#39;}</span>
<span class="sd">        Format of binning</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Examples how to create ObservationGroupAxis objects:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        zenith = Angle([0, 30, 40, 50], &#39;deg&#39;)</span>
<span class="sd">        zenith_axis = ObservationGroupAxis(&#39;ALT&#39;, alt, fmt=&#39;edges&#39;)</span>

<span class="sd">        ntels = [3, 4]</span>
<span class="sd">        ntels_axis = ObservationGroupAxis(&#39;N_TELS&#39;, ntels, fmt=&#39;values&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">fmt</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid fmt: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fmt</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_bins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of bins (int).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;edges&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;values&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">)</span>

<div class="viewcode-block" id="ObservationGroupAxis.get_bin"><a class="viewcode-back" href="../../../api/gammapy.data.ObservationGroupAxis.html#gammapy.data.ObservationGroupAxis.get_bin">[docs]</a>    <span class="k">def</span> <span class="nf">get_bin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bin_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get bin (int, float or `~astropy.units.Quantity`-like).</span>

<span class="sd">        Value or tuple of bin edges (depending on the ``fmt`` parameter)</span>
<span class="sd">        for the specified bin.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bin_id : int</span>
<span class="sd">            ID of the bin to retrieve.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bin : int, float or `~astropy.units.Quantity`-like</span>
<span class="sd">            Value or tuple of bin edges, depending on the ``fmt`` parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;edges&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="n">bin_id</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="n">bin_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;values&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="n">bin_id</span><span class="p">]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">get_bins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of bins (int, float or `~astropy.units.Quantity`-like).</span>

<span class="sd">        List of bin edges or values (depending on the ``fmt`` parameter)</span>
<span class="sd">        for all bins.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i_bin</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_bins</span><span class="p">):</span>
            <span class="n">bins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bin</span><span class="p">(</span><span class="n">i_bin</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">bins</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ObservationGroupAxis.from_column"><a class="viewcode-back" href="../../../api/gammapy.data.ObservationGroupAxis.html#gammapy.data.ObservationGroupAxis.from_column">[docs]</a>    <span class="k">def</span> <span class="nf">from_column</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Import from astropy column.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        col : `~astropy.table.Column`</span>
<span class="sd">            Column with the axis info.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="n">col</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;axis_format&#39;</span><span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ObservationGroupAxis.to_column"><a class="viewcode-back" href="../../../api/gammapy.data.ObservationGroupAxis.html#gammapy.data.ObservationGroupAxis.to_column">[docs]</a>    <span class="k">def</span> <span class="nf">to_column</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert to astropy column.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        col : `~astropy.table.Column`</span>
<span class="sd">            Column with the axis info.</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">col</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;axis_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span>
        <span class="k">return</span> <span class="n">col</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Info string (str).&quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span></div>


<span class="k">def</span> <span class="nf">_recover_units</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">as_units</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Utility function to recover units.</span>

<span class="sd">    After some numpy operations, `~astropy.units.Quantity`-like objects</span>
<span class="sd">    loose their units. This function shoul recover them.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    array : `~numpy.ndarray` or `~astropy.units.Quantity`-like</span>
<span class="sd">        Array without units.</span>
<span class="sd">    as_units : int, float or `~astropy.units.Quantity`-like</span>
<span class="sd">        Structure to imitate the units.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array : int, float or `~astropy.units.Quantity`-like</span>
<span class="sd">        Array with units.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: this seems wrong to do stuff like this. Review and maybe remove?</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Quantity</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array</span><span class="p">),</span> <span class="n">as_units</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c1"># return unmodified</span>
        <span class="k">return</span> <span class="n">array</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="obs_group.html#">Back to Top</a></p>
  <p>
    &copy; Copyright 2017, The Gammapy developers.<br/>
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.5.5. &nbsp;
    Last built 28 Apr 2017. <br/>
  </p>
</footer>
  </body>
</html>