
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Source detection tools (gammapy.detect) &#8212; gammapy v0.7</title>
    <link rel="stylesheet" href="../_static/gammapy.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.7',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/sidebar.js"></script>
    <link rel="shortcut icon" href="../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="compute_lima_image" href="../api/gammapy.detect.compute_lima_image.html" />
    <link rel="prev" title="gammapy_extra" href="../api/gammapy.datasets.gammapy_extra.html" />
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>
<script type="text/javascript" src="../_static/copybutton.js"></script>


  </head>
  <body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../index.html"><span id="logotext1">gamma</span><span id="logotext2">py</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li class="right">
	<a href="../api/gammapy.detect.compute_lima_image.html" title="compute_lima_image">
	  next &raquo;
	</a>
      </li>
      <li class="right">
	<a href="../api/gammapy.datasets.gammapy_extra.html" title="gammapy_extra">
	  &laquo; previous
	</a>
	 |
      </li>
      <li>
	<a href="../index.html">gammapy v0.7</a>
	 &#187;
      </li>
      
      <li>Source detection tools (<code class="docutils literal"><span class="pre">gammapy.detect</span></code>)</li> 
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="source-detection-tools-gammapy-detect">
<span id="detect"></span><h1>Source detection tools (<a class="reference internal" href="#module-gammapy.detect" title="gammapy.detect"><code class="xref py py-obj docutils literal"><span class="pre">gammapy.detect</span></code></a>)<a class="headerlink" href="#source-detection-tools-gammapy-detect" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference internal" href="#module-gammapy.detect" title="gammapy.detect"><code class="xref py py-obj docutils literal"><span class="pre">gammapy.detect</span></code></a> submodule includes low level functions to compute significance
and test statistics images as well as some high level source detection method
prototypes.</p>
<p>Detailed description of the methods can be found in <a class="reference internal" href="../references.html#stewart2009" id="id1">[Stewart2009]</a>
and <a class="reference internal" href="../references.html#lima1983" id="id2">[LiMa1983]</a>.</p>
</div>
<div class="section" id="computation-of-ts-images">
<h2>Computation of TS images<a class="headerlink" href="#computation-of-ts-images" title="Permalink to this headline">¶</a></h2>
<a class="reference internal image-reference" href="../_images/fermi_ts_image.png"><img alt="../_images/fermi_ts_image.png" src="../_images/fermi_ts_image.png" style="width: 100%;" /></a>
<p>Test statistics image computed using <a class="reference internal" href="../api/gammapy.detect.TSImageEstimator.html#gammapy.detect.TSImageEstimator" title="gammapy.detect.TSImageEstimator"><code class="xref py py-obj docutils literal"><span class="pre">TSImageEstimator</span></code></a> for an
example Fermi dataset.</p>
<p>The <a class="reference internal" href="#module-gammapy.detect" title="gammapy.detect"><code class="xref py py-obj docutils literal"><span class="pre">gammapy.detect</span></code></a> module includes a high performance <a class="reference internal" href="../api/gammapy.detect.TSImageEstimator.html#gammapy.detect.TSImageEstimator" title="gammapy.detect.TSImageEstimator"><code class="xref py py-obj docutils literal"><span class="pre">TSImageEstimator</span></code></a> class to
compute test statistics (TS) images for gamma-ray survey data. The implementation is based on the method
described in <a class="reference internal" href="../references.html#stewart2009" id="id3">[Stewart2009]</a>.</p>
<p>Assuming a certain source morphology, which can be defined by any <a class="reference external" href="http://docs.astropy.org/en/latest/api/astropy.convolution.Kernel2D.html#astropy.convolution.Kernel2D" title="(in Astropy v3.1.dev21536)"><code class="xref py py-obj docutils literal"><span class="pre">astropy.convolution.Kernel2D</span></code></a>
instance, the amplitude of the morphology model is fitted at every pixel of the input data using a
Poisson maximum likelihood procedure. As input data a counts, background and exposure images have to be provided.
Based on the best fit flux amplitude, the change in TS, compared to the null hypothesis is computed
using <a class="reference internal" href="../api/gammapy.stats.cash.html#gammapy.stats.cash" title="gammapy.stats.cash"><code class="xref py py-obj docutils literal"><span class="pre">cash</span></code></a> statistics.</p>
<p>To optimize the performance of the code, the fitting procedure is simplified by finding roots
of the derivative of the fit statistics with respect to the flux amplitude. This approach is
described in detail in Appendix A of <a class="reference internal" href="../references.html#stewart2009" id="id4">[Stewart2009]</a>. To further improve the performance,
Pythons’s <a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html#module-multiprocessing" title="(in Python v3.6)"><code class="xref py py-obj docutils literal"><span class="pre">multiprocessing</span></code></a> facility is used.</p>
<p>In the following the computation of a TS image for prepared Fermi survey data, which is provided in
<a class="reference external" href="https://github.com/gammapy/gammapy-extra/tree/master/datasets/fermi_survey">gammapy-extra</a>, shall be demonstrated:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>    <span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="kn">import</span> <span class="n">Gaussian2DKernel</span>
    <span class="kn">from</span> <span class="nn">gammapy.image</span> <span class="kn">import</span> <span class="n">SkyImageList</span>
    <span class="kn">from</span> <span class="nn">gammapy.detect</span> <span class="kn">import</span> <span class="n">TSImageEstimator</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">SkyImageList</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;$GAMMAPY_EXTRA/datasets/fermi_survey/all.fits.gz&#39;</span><span class="p">)</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">Gaussian2DKernel</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">ts_estimator</span> <span class="o">=</span> <span class="n">TSImageEstimator</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">ts_estimator</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
</pre></div>
</div>
<p>The function returns a <a class="reference internal" href="../api/gammapy.image.SkyImageList.html#gammapy.image.SkyImageList" title="gammapy.image.SkyImageList"><code class="xref py py-obj docutils literal"><span class="pre">SkyImageList</span></code></a> object, that bundles all relevant
data. E.g. the time needed for the TS image computation can be checked by:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">result</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;runtime&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>The TS <a class="reference internal" href="../api/gammapy.image.SkyImage.html#gammapy.image.SkyImage" title="gammapy.image.SkyImage"><code class="xref py py-obj docutils literal"><span class="pre">SkyImage</span></code></a> itself can be accessed from the <a class="reference internal" href="../api/gammapy.image.SkyImageList.html#gammapy.image.SkyImageList" title="gammapy.image.SkyImageList"><code class="xref py py-obj docutils literal"><span class="pre">SkyImageList</span></code></a> object.
E.g. here’s how to find the largest TS value:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="n">ts</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span>
    <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="command-line-tool">
<h3>Command line tool<a class="headerlink" href="#command-line-tool" title="Permalink to this headline">¶</a></h3>
<p>Gammapy also provides a command line tool <code class="docutils literal"><span class="pre">gammapy-image-ts</span></code> for TS image computation, which can be run
on the Fermi example dataset by:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="nv">$GAMMAPY_EXTRA</span>/datasets/fermi_survey
$ gammapy-image-ts all.fits.gz ts_image_0.00.fits --scale <span class="m">0</span>
</pre></div>
</div>
<p>The command line tool additionally requires a psf json file, where the psf shape
is defined by the parameters of a triple Gaussian model. See also
<a class="reference internal" href="../api/gammapy.irf.multi_gauss_psf_kernel.html#gammapy.irf.multi_gauss_psf_kernel" title="gammapy.irf.multi_gauss_psf_kernel"><code class="xref py py-obj docutils literal"><span class="pre">gammapy.irf.multi_gauss_psf_kernel</span></code></a>. By default the command line tool uses
a Gaussian source kernel, where the width in degree can be defined by the
<code class="docutils literal"><span class="pre">--scale</span></code> parameter. Multiple scales can be selected by passing a list to the
<code class="docutils literal"><span class="pre">scales</span></code> parameter.  When setting <code class="docutils literal"><span class="pre">--scale</span> <span class="pre">0</span></code> only the psf is used as source
model, which is the preferred setting to detect point sources. When using scales
that are larger than five times the binning of the data, the data is sampled down
and later sampled up again to speed up the performance. See
<code class="xref py py-obj docutils literal"><span class="pre">downsample_2N</span></code> and <code class="xref py py-obj docutils literal"><span class="pre">upsample_2N</span></code> for details.</p>
<p>Furthermore it is possible to compute residual TS images. Using the following options:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ gammapy-image-ts all.fits.gz residual_ts_image_0.00.fits --scale <span class="m">0</span> --residual --model model.fits.gz
</pre></div>
</div>
<p>When <code class="docutils literal"><span class="pre">--residual</span></code> is set an excess model must be provided using the <code class="docutils literal"><span class="pre">--model</span></code> option.</p>
</div>
</div>
<div class="section" id="computation-of-li-ma-significance-images">
<h2>Computation of Li &amp; Ma significance images<a class="headerlink" href="#computation-of-li-ma-significance-images" title="Permalink to this headline">¶</a></h2>
<p>The method derived by <a class="reference internal" href="../references.html#lima1983" id="id5">[LiMa1983]</a> is one of the standard methods to determine
detection significances for gamma-ray sources. Using the same prepared Fermi
dataset as above, the corresponding images can be computed using the
<a class="reference internal" href="../api/gammapy.detect.compute_lima_image.html#gammapy.detect.compute_lima_image" title="gammapy.detect.compute_lima_image"><code class="xref py py-obj docutils literal"><span class="pre">compute_lima_image</span></code></a> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="kn">import</span> <span class="n">Tophat2DKernel</span>
<span class="kn">from</span> <span class="nn">gammapy.image</span> <span class="kn">import</span> <span class="n">SkyImageList</span>
<span class="kn">from</span> <span class="nn">gammapy.detect</span> <span class="kn">import</span> <span class="n">compute_lima_image</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">SkyImageList</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;$GAMMAPY_EXTRA/datasets/fermi_survey/all.fits.gz&#39;</span><span class="p">)</span>
<span class="n">kernel</span> <span class="o">=</span> <span class="n">Tophat2DKernel</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">compute_lima_image</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="s1">&#39;COUNTS&#39;</span><span class="p">],</span> <span class="n">images</span><span class="p">[</span><span class="s1">&#39;BACKGROUND&#39;</span><span class="p">],</span> <span class="n">kernel</span><span class="p">)</span>
</pre></div>
</div>
<p>The function returns a <a class="reference internal" href="../api/gammapy.image.SkyImageList.html#gammapy.image.SkyImageList" title="gammapy.image.SkyImageList"><code class="xref py py-obj docutils literal"><span class="pre">SkyImageList</span></code></a>, that bundles all resulting
images such as significance, flux and correlated counts and excess images.</p>
</div>
<div class="section" id="iterative-source-detection">
<h2>Iterative source detection<a class="headerlink" href="#iterative-source-detection" title="Permalink to this headline">¶</a></h2>
<p>In addition to <code class="docutils literal"><span class="pre">gammapy-image-ts</span></code> there is also command-line tool <code class="docutils literal"><span class="pre">gammapy-detect-iterative</span></code>, which runs iterative multi-scale source detection.
It takes as arguments count, background and exposure FITS images (in separate files, unlike previous tool)
and a list of <code class="docutils literal"><span class="pre">--scales</span></code> and calls <code class="docutils literal"><span class="pre">~gammapy.detect.iterfind.IterativeSourceDetection</span></code> class.</p>
<p>It implements the following algorithm:</p>
<ol class="arabic simple">
<li>Compute significance images on multiple scales (disk-correlate)</li>
<li>Largest peak on any scale gives a seed position / extension (the scale)</li>
<li>Fit a 2D Gauss-model source using the seed parameters</li>
<li>Add the source to a list of detected sources and the background model</li>
<li>Restart at step 1, but this time with detected sources added to the background model, i.e. significance images will be “residual significance” images.</li>
</ol>
<p>Usage example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="nv">$GAMMAPY_EXTRA</span>/datasets/source_diffuse_separation/galactic_simulations
$ gammapy-detect-iterative --counts fermi_counts.fits --background fermi_diffuse.fits --exposure fermi_exposure_gal.fits output_fits output_regions
</pre></div>
</div>
</div>
<div class="section" id="reference-api">
<h2>Reference/API<a class="headerlink" href="#reference-api" title="Permalink to this headline">¶</a></h2>
<div class="section" id="module-gammapy.detect">
<span id="gammapy-detect-package"></span><h3>gammapy.detect Package<a class="headerlink" href="#module-gammapy.detect" title="Permalink to this headline">¶</a></h3>
<p>Source detection and measurement methods.</p>
<div class="section" id="functions">
<h4>Functions<a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h4>
<table border="1" class="longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><a class="reference internal" href="../api/gammapy.detect.compute_lima_image.html#gammapy.detect.compute_lima_image" title="gammapy.detect.compute_lima_image"><code class="xref py py-obj docutils literal"><span class="pre">compute_lima_image</span></code></a>(counts,&nbsp;background,&nbsp;kernel)</td>
<td>Compute Li &amp; Ma significance and flux images for known background.</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="../api/gammapy.detect.compute_lima_on_off_image.html#gammapy.detect.compute_lima_on_off_image" title="gammapy.detect.compute_lima_on_off_image"><code class="xref py py-obj docutils literal"><span class="pre">compute_lima_on_off_image</span></code></a>(n_on,&nbsp;n_off,&nbsp;a_on,&nbsp;…)</td>
<td>Compute Li &amp; Ma significance and flux images for on-off observations.</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="../api/gammapy.detect.compute_maximum_ts_image.html#gammapy.detect.compute_maximum_ts_image" title="gammapy.detect.compute_maximum_ts_image"><code class="xref py py-obj docutils literal"><span class="pre">compute_maximum_ts_image</span></code></a>(ts_image_results)</td>
<td>Compute maximum TS image across a list of given TS images.</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="../api/gammapy.detect.compute_ts_image_multiscale.html#gammapy.detect.compute_ts_image_multiscale" title="gammapy.detect.compute_ts_image_multiscale"><code class="xref py py-obj docutils literal"><span class="pre">compute_ts_image_multiscale</span></code></a>(images,&nbsp;…[,&nbsp;…])</td>
<td>Compute multi-scale TS images using <code class="docutils literal"><span class="pre">compute_ts_image</span></code>.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="classes">
<h4>Classes<a class="headerlink" href="#classes" title="Permalink to this headline">¶</a></h4>
<table border="1" class="longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><a class="reference internal" href="../api/gammapy.detect.CWT.html#gammapy.detect.CWT" title="gammapy.detect.CWT"><code class="xref py py-obj docutils literal"><span class="pre">CWT</span></code></a>(kernels[,&nbsp;max_iter,&nbsp;tol,&nbsp;…])</td>
<td>Continuous wavelet transform.</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="../api/gammapy.detect.CWTData.html#gammapy.detect.CWTData" title="gammapy.detect.CWTData"><code class="xref py py-obj docutils literal"><span class="pre">CWTData</span></code></a>(counts,&nbsp;background,&nbsp;n_scale)</td>
<td>Images for CWT algorithm.</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="../api/gammapy.detect.CWTKernels.html#gammapy.detect.CWTKernels" title="gammapy.detect.CWTKernels"><code class="xref py py-obj docutils literal"><span class="pre">CWTKernels</span></code></a>(n_scale,&nbsp;min_scale,&nbsp;step_scale[,&nbsp;old])</td>
<td>Conduct arrays of kernels and scales for CWT algorithm.</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="../api/gammapy.detect.KernelBackgroundEstimator.html#gammapy.detect.KernelBackgroundEstimator" title="gammapy.detect.KernelBackgroundEstimator"><code class="xref py py-obj docutils literal"><span class="pre">KernelBackgroundEstimator</span></code></a>(kernel_src,&nbsp;kernel_bkg)</td>
<td>Estimate background and exclusion mask iteratively.</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="../api/gammapy.detect.TSImageEstimator.html#gammapy.detect.TSImageEstimator" title="gammapy.detect.TSImageEstimator"><code class="xref py py-obj docutils literal"><span class="pre">TSImageEstimator</span></code></a>([method,&nbsp;error_method,&nbsp;…])</td>
<td>Compute TS image using different optimization methods.</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>
<ul>
<li><a class="reference internal" href="#">Source detection tools (<code class="docutils literal"><span class="pre">gammapy.detect</span></code>)</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#computation-of-ts-images">Computation of TS images</a><ul>
<li><a class="reference internal" href="#command-line-tool">Command line tool</a></li>
</ul>
</li>
<li><a class="reference internal" href="#computation-of-li-ma-significance-images">Computation of Li &amp; Ma significance images</a></li>
<li><a class="reference internal" href="#iterative-source-detection">Iterative source detection</a></li>
<li><a class="reference internal" href="#reference-api">Reference/API</a><ul>
<li><a class="reference internal" href="#module-gammapy.detect">gammapy.detect Package</a><ul>
<li><a class="reference internal" href="#functions">Functions</a></li>
<li><a class="reference internal" href="#classes">Classes</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right">
    <a href="../_sources/detect/index.rst.txt"
       rel="nofollow">Page Source</a> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2018, The Gammapy developers.<br/>
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.7. &nbsp;
    Last built 01 Mar 2018. <br/>
  </p>
</footer>
  </body>
</html>