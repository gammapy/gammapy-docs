
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>CTA data analysis with Gammapy &#8212; gammapy v0.7</title>
    <link rel="stylesheet" href="../_static/gammapy.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.7',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/sidebar.js"></script>
    <link rel="shortcut icon" href="../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>
<script type="text/javascript" src="../_static/copybutton.js"></script>


  </head>
  <body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../index.html"><span id="logotext1">gamma</span><span id="logotext2">py</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../index.html">gammapy v0.7</a>
	 &#187;
      </li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 9ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }
</style>
<script type="text/javascript" src="../_static/linksdl.js"></script><div class="admonition note">
<p class="first"><strong>This is a fixed-text formatted version of a Jupyter notebook.</strong></p>
<p>You can contribute with your own notebooks in this <a class="reference external" href="https://github.com/gammapy/gammapy-extra/tree/master/notebooks">GitHub
repository</a>.</p>
<p class="last"><strong>Source files:</strong>
<a class="reference external" href="../_static/notebooks/cta_data_analysis.ipynb">cta_data_analysis.ipynb</a>
|
<a class="reference external" href="../_static/notebooks/cta_data_analysis.py">cta_data_analysis.py</a></p>
</div>
<div class="figure" id="id1">
<img alt="CTA first data challenge logo" src="../_images/cta-1dc.png" />
<p class="caption"><span class="caption-text">CTA first data challenge logo</span></p>
</div>
<div class="section" id="CTA-data-analysis-with-Gammapy">
<h1>CTA data analysis with Gammapy<a class="headerlink" href="#CTA-data-analysis-with-Gammapy" title="Permalink to this headline">¶</a></h1>
<div class="section" id="Introduction">
<h2>Introduction<a class="headerlink" href="#Introduction" title="Permalink to this headline">¶</a></h2>
<p><strong>This notebook shows an example how to make a sky image and spectrum
for simulated CTA data with Gammapy.</strong></p>
<p>The dataset we will use is three observation runs on the Galactic
center. This is a tiny (and thus quick to process and play with and
learn) subset of the simulated CTA dataset that was produced for the
first data challenge in August 2017.</p>
<p><strong>This notebook can be considered part 2 of the introduction to CTA 1DC
analysis. Part one is here:
`cta_1dc_introduction.ipynb &lt;cta_1dc_introduction.ipynb&gt;`__</strong></p>
</div>
<div class="section" id="Setup">
<h2>Setup<a class="headerlink" href="#Setup" title="Permalink to this headline">¶</a></h2>
<p>As usual, we’ll start with some setup …</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Check package versions, if something goes wrong here you won&#39;t be able to run the notebook</span>
<span class="kn">import</span> <span class="nn">gammapy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy</span>
<span class="kn">import</span> <span class="nn">regions</span>
<span class="kn">import</span> <span class="nn">sherpa</span>
<span class="kn">import</span> <span class="nn">uncertainties</span>
<span class="kn">import</span> <span class="nn">photutils</span>

<span class="k">print</span><span class="p">(</span><span class="s1">&#39;gammapy:&#39;</span><span class="p">,</span> <span class="n">gammapy</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;numpy:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;astropy:&#39;</span><span class="p">,</span> <span class="n">astropy</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;regions:&#39;</span><span class="p">,</span> <span class="n">regions</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;sherpa:&#39;</span><span class="p">,</span> <span class="n">sherpa</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;uncertainties:&#39;</span><span class="p">,</span> <span class="n">uncertainties</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;photutils:&#39;</span><span class="p">,</span> <span class="n">photutils</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
gammapy: 0.7.dev5344
numpy: 1.13.3
astropy: 3.0.dev20763
regions: 0.2
sherpa: 4.9.1+12.g3626715
uncertainties: 2.4.8.1
photutils: 0.3.2
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="kn">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">Angle</span>
<span class="kn">from</span> <span class="nn">regions</span> <span class="kn">import</span> <span class="n">CircleSkyRegion</span>
<span class="kn">from</span> <span class="nn">photutils.detection</span> <span class="kn">import</span> <span class="n">find_peaks</span>
<span class="kn">from</span> <span class="nn">gammapy.data</span> <span class="kn">import</span> <span class="n">DataStore</span>
<span class="kn">from</span> <span class="nn">gammapy.spectrum</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SpectrumExtraction</span><span class="p">,</span>
    <span class="n">SpectrumFit</span><span class="p">,</span>
    <span class="n">SpectrumResult</span><span class="p">,</span>
    <span class="n">models</span><span class="p">,</span>
    <span class="n">SpectrumEnergyGroupMaker</span><span class="p">,</span>
    <span class="n">FluxPointEstimator</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">gammapy.image</span> <span class="kn">import</span> <span class="n">SkyImage</span><span class="p">,</span> <span class="n">IACTBasicImageEstimator</span>
<span class="kn">from</span> <span class="nn">gammapy.background</span> <span class="kn">import</span> <span class="n">RingBackgroundEstimator</span><span class="p">,</span> <span class="n">ReflectedRegionsBackgroundEstimator</span>
<span class="kn">from</span> <span class="nn">gammapy.utils.energy</span> <span class="kn">import</span> <span class="n">EnergyBounds</span>
<span class="kn">from</span> <span class="nn">gammapy.detect</span> <span class="kn">import</span> <span class="n">TSImageEstimator</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Configure the logger, so that the spectral analysis</span>
<span class="c1"># isn&#39;t so chatty about what it&#39;s doing.</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">()</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;gammapy.spectrum&#39;</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Select-observations">
<h2>Select observations<a class="headerlink" href="#Select-observations" title="Permalink to this headline">¶</a></h2>
<p>Like explained in
<a class="reference internal" href="cta_1dc_introduction.html"><span class="doc">cta_1dc_introduction.ipynb</span></a>, a Gammapy
analysis usually starts by creating a <code class="docutils literal"><span class="pre">DataStore</span></code> and selecting
observations.</p>
<p>This is shown in detail in the other notebook, here we just pick three
observations near the galactic center.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">data_store</span> <span class="o">=</span> <span class="n">DataStore</span><span class="o">.</span><span class="n">from_dir</span><span class="p">(</span><span class="s1">&#39;$CTADATA/index/gps&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Just as a reminder: this is how to select observations</span>
<span class="c1"># from astropy.coordinates import SkyCoord</span>
<span class="c1"># table = data_store.obs_table</span>
<span class="c1"># pos_obs = SkyCoord(table[&#39;GLON_PNT&#39;], table[&#39;GLAT_PNT&#39;], frame=&#39;galactic&#39;, unit=&#39;deg&#39;)</span>
<span class="c1"># pos_target = SkyCoord(0, 0, frame=&#39;galactic&#39;, unit=&#39;deg&#39;)</span>
<span class="c1"># offset = pos_target.separation(pos_obs).deg</span>
<span class="c1"># mask = (1 &lt; offset) &amp; (offset &lt; 2)</span>
<span class="c1"># table = table[mask]</span>
<span class="c1"># table.show_in_browser(jsviewer=True)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">obs_id</span> <span class="o">=</span> <span class="p">[</span><span class="mi">110380</span><span class="p">,</span> <span class="mi">111140</span><span class="p">,</span> <span class="mi">111159</span><span class="p">]</span>
<span class="n">obs_list</span> <span class="o">=</span> <span class="n">data_store</span><span class="o">.</span><span class="n">obs_list</span><span class="p">(</span><span class="n">obs_id</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">obs_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;OBS_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;GLON_PNT&#39;</span><span class="p">,</span> <span class="s1">&#39;GLAT_PNT&#39;</span><span class="p">,</span> <span class="s1">&#39;LIVETIME&#39;</span><span class="p">]</span>
<span class="n">data_store</span><span class="o">.</span><span class="n">obs_table</span><span class="o">.</span><span class="n">select_obs_id</span><span class="p">(</span><span class="n">obs_id</span><span class="p">)[</span><span class="n">obs_cols</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<i>ObservationTable length=3</i>
<table id="table4420611712" class="table-striped table-bordered table-condensed">
<thead><tr><th>OBS_ID</th><th>GLON_PNT</th><th>GLAT_PNT</th><th>LIVETIME</th></tr></thead>
<thead><tr><th>int64</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>110380</td><td>359.999991204</td><td>-1.29999593791</td><td>1764.0</td></tr>
<tr><td>111140</td><td>358.499983383</td><td>1.3000020212</td><td>1764.0</td></tr>
<tr><td>111159</td><td>1.50000565683</td><td>1.29994046834</td><td>1764.0</td></tr>
</table></div>
</div>
</div>
<div class="section" id="Make-sky-images">
<h2>Make sky images<a class="headerlink" href="#Make-sky-images" title="Permalink to this headline">¶</a></h2>
<div class="section" id="Define-map-geometry">
<h3>Define map geometry<a class="headerlink" href="#Define-map-geometry" title="Permalink to this headline">¶</a></h3>
<p>Select the target position and define an ON region for the spectral
analysis</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">target_position</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;galactic&#39;</span><span class="p">)</span>
<span class="n">on_radius</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
<span class="n">on_region</span> <span class="o">=</span> <span class="n">CircleSkyRegion</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">target_position</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">on_radius</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Define reference image centered on the target</span>
<span class="n">xref</span> <span class="o">=</span> <span class="n">target_position</span><span class="o">.</span><span class="n">galactic</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">value</span>
<span class="n">yref</span> <span class="o">=</span> <span class="n">target_position</span><span class="o">.</span><span class="n">galactic</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">value</span>
<span class="c1"># size = 10 * u.deg</span>
<span class="c1"># binsz = 0.02 # degree per pixel</span>
<span class="c1"># npix = int((size / binsz).value)</span>

<span class="n">ref_image</span> <span class="o">=</span> <span class="n">SkyImage</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
    <span class="n">nxpix</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">nypix</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">binsz</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
    <span class="n">xref</span><span class="o">=</span><span class="n">xref</span><span class="p">,</span> <span class="n">yref</span><span class="o">=</span><span class="n">yref</span><span class="p">,</span>
    <span class="n">proj</span><span class="o">=</span><span class="s1">&#39;TAN&#39;</span><span class="p">,</span> <span class="n">coordsys</span><span class="o">=</span><span class="s1">&#39;GAL&#39;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Name: None
Data shape: (600, 800)
Data type: float64
Data unit:
Data mean: 0.000e+00
WCS type: [&#39;GLON-TAN&#39;, &#39;GLAT-TAN&#39;]

</pre></div></div>
</div>
</div>
<div class="section" id="Compute-images">
<h3>Compute images<a class="headerlink" href="#Compute-images" title="Permalink to this headline">¶</a></h3>
<p>We use the ring background estimation method, and an exclusion mask that
excludes the bright source at the Galactic center.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">exclusion_mask</span> <span class="o">=</span> <span class="n">ref_image</span><span class="o">.</span><span class="n">region_mask</span><span class="p">(</span><span class="n">on_region</span><span class="p">)</span>
<span class="n">exclusion_mask</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">exclusion_mask</span><span class="o">.</span><span class="n">data</span>
<span class="n">exclusion_mask</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[11]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>(&lt;matplotlib.figure.Figure at 0x10443af98&gt;,
 &lt;matplotlib.axes._subplots.WCSAxesSubplot at 0x1094d8390&gt;,
 None)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cta_data_analysis_16_1.png" src="../_images/notebooks_cta_data_analysis_16_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">bkg_estimator</span> <span class="o">=</span> <span class="n">RingBackgroundEstimator</span><span class="p">(</span>
    <span class="n">r_in</span><span class="o">=</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">image_estimator</span> <span class="o">=</span> <span class="n">IACTBasicImageEstimator</span><span class="p">(</span>
    <span class="n">reference</span><span class="o">=</span><span class="n">ref_image</span><span class="p">,</span>
    <span class="n">emin</span><span class="o">=</span><span class="mi">100</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">GeV</span><span class="p">,</span>
    <span class="n">emax</span><span class="o">=</span><span class="mi">100</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">,</span>
    <span class="n">offset_max</span><span class="o">=</span><span class="mi">3</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
    <span class="n">background_estimator</span><span class="o">=</span><span class="n">bkg_estimator</span><span class="p">,</span>
    <span class="n">exclusion_mask</span><span class="o">=</span><span class="n">exclusion_mask</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">image_estimator</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">obs_list</span><span class="p">)</span>
<span class="n">images</span><span class="o">.</span><span class="n">names</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
/Users/deil/code/gammapy/gammapy/cube/core.py:76: RuntimeWarning: divide by zero encountered in log
  log_data = np.log(self.data.value)
/opt/local/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/scipy/interpolate/interpolate.py:2477: RuntimeWarning: invalid value encountered in multiply
  values += np.asarray(self.values[edge_indices]) * weight[vslice]
WARNING: AstropyDeprecationWarning: The truth value of a Quantity is ambiguous. In the future this will raise a ValueError. [astropy.units.quantity]
WARNING:astropy:AstropyDeprecationWarning: The truth value of a Quantity is ambiguous. In the future this will raise a ValueError.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[12]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>[&#39;counts&#39;, &#39;exposure&#39;, &#39;background&#39;, &#39;excess&#39;, &#39;flux&#39;, &#39;psf&#39;]
</pre></div>
</div>
</div>
</div>
<div class="section" id="Show-images">
<h3>Show images<a class="headerlink" href="#Show-images" title="Permalink to this headline">¶</a></h3>
<p>Let’s define a little helper function and then show all the resulting
images that were computed.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">show_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Little helper function to show the images for this application here.&quot;&quot;&quot;</span>
    <span class="n">image</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">add_cbar</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">image</span><span class="o">.</span><span class="n">cutout</span><span class="p">(</span>
        <span class="n">position</span><span class="o">=</span><span class="n">SkyCoord</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;galactic&#39;</span><span class="p">),</span>
        <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">add_cbar</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">show_image</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="s1">&#39;counts&#39;</span><span class="p">],</span> <span class="n">radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cta_data_analysis_20_0.png" src="../_images/notebooks_cta_data_analysis_20_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cta_data_analysis_20_1.png" src="../_images/notebooks_cta_data_analysis_20_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">show_image</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="s1">&#39;counts&#39;</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cta_data_analysis_21_0.png" src="../_images/notebooks_cta_data_analysis_21_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cta_data_analysis_21_1.png" src="../_images/notebooks_cta_data_analysis_21_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">show_image</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cta_data_analysis_22_0.png" src="../_images/notebooks_cta_data_analysis_22_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cta_data_analysis_22_1.png" src="../_images/notebooks_cta_data_analysis_22_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">show_image</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="s1">&#39;excess&#39;</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cta_data_analysis_23_0.png" src="../_images/notebooks_cta_data_analysis_23_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cta_data_analysis_23_1.png" src="../_images/notebooks_cta_data_analysis_23_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Significance image</span>
<span class="c1"># Just for fun, let&#39;s compute it by hand ...</span>
<span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="kn">import</span> <span class="n">Tophat2DKernel</span>
<span class="n">kernel</span> <span class="o">=</span> <span class="n">Tophat2DKernel</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">kernel</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s1">&#39;peak&#39;</span><span class="p">)</span>

<span class="n">counts_conv</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="s1">&#39;counts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">kernel</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
<span class="n">background_conv</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">kernel</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">gammapy.stats</span> <span class="kn">import</span> <span class="n">significance</span>
<span class="n">significance_image</span> <span class="o">=</span> <span class="n">SkyImage</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)</span>
<span class="n">significance_image</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">significance</span><span class="p">(</span><span class="n">counts_conv</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">background_conv</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">show_image</span><span class="p">(</span><span class="n">significance_image</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cta_data_analysis_24_0.png" src="../_images/notebooks_cta_data_analysis_24_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cta_data_analysis_24_1.png" src="../_images/notebooks_cta_data_analysis_24_1.png" />
</div>
</div>
</div>
</div>
<div class="section" id="Source-Detection">
<h2>Source Detection<a class="headerlink" href="#Source-Detection" title="Permalink to this headline">¶</a></h2>
<p>Use the class
<a class="reference external" href="http://docs.gammapy.org/0.7/api/gammapy.detect.compute_ts_image.html#gammapy.detect.TSImageEstimator.html">TSImageEstimator</a>
and
<a class="reference external" href="http://photutils.readthedocs.io/en/stable/api/photutils.find_peaks.html">photutils.find_peaks</a>
to detect point-like sources on the images:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># cut out smaller piece of the PSF image to save computing time</span>
<span class="c1"># for covenience we&#39;re &quot;misusing&quot; the SkyImage class represent the PSF on the sky.</span>
<span class="n">kernel</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="s1">&#39;psf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cutout</span><span class="p">(</span><span class="n">target_position</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
<span class="n">kernel</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cta_data_analysis_26_0.png" src="../_images/notebooks_cta_data_analysis_26_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">ts_image_estimator</span> <span class="o">=</span> <span class="n">TSImageEstimator</span><span class="p">()</span>
<span class="n">images_ts</span> <span class="o">=</span> <span class="n">ts_image_estimator</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">kernel</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">images_ts</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;ts&#39;, &#39;sqrt_ts&#39;, &#39;flux&#39;, &#39;flux_err&#39;, &#39;flux_ul&#39;, &#39;niter&#39;]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># find pointlike sources with sqrt(TS) &gt; 5</span>
<span class="n">sources</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">images_ts</span><span class="p">[</span><span class="s1">&#39;sqrt_ts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">images_ts</span><span class="p">[</span><span class="s1">&#39;sqrt_ts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span>
<span class="n">sources</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
/opt/local/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/photutils/detection/core.py:241: RuntimeWarning: invalid value encountered in greater
  peak_goodmask = np.logical_and(peak_goodmask, (data &gt; threshold))
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<i>Table length=11</i>
<table id="table4505950752" class="table-striped table-bordered table-condensed">
<thead><tr><th>x_peak</th><th>y_peak</th><th>icrs_ra_peak</th><th>icrs_dec_peak</th><th>peak_value</th></tr></thead>
<thead><tr><th></th><th></th><th>deg</th><th>deg</th><th></th></tr></thead>
<thead><tr><th>int64</th><th>int64</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>451</td><td>269</td><td>266.386490097</td><td>-30.1329751991</td><td>6.43453671617</td></tr>
<tr><td>328</td><td>279</td><td>267.643982436</td><td>-27.923799443</td><td>5.01020960141</td></tr>
<tr><td>457</td><td>279</td><td>266.116882008</td><td>-30.1308815126</td><td>6.99895391199</td></tr>
<tr><td>420</td><td>295</td><td>266.248069224</td><td>-29.332923145</td><td>7.40642882084</td></tr>
<tr><td>319</td><td>296</td><td>267.418588423</td><td>-27.5950146565</td><td>5.43758078846</td></tr>
<tr><td>403</td><td>296</td><td>266.431608887</td><td>-29.0323948208</td><td>31.2056071515</td></tr>
<tr><td>328</td><td>297</td><td>267.294781246</td><td>-27.7389955437</td><td>6.11383181087</td></tr>
<tr><td>428</td><td>297</td><td>266.112959439</td><td>-29.4484139711</td><td>8.3317349187</td></tr>
<tr><td>336</td><td>303</td><td>267.085428324</td><td>-27.814186889</td><td>5.95486458885</td></tr>
<tr><td>357</td><td>303</td><td>266.839564958</td><td>-28.1735568192</td><td>15.2891666272</td></tr>
<tr><td>523</td><td>305</td><td>264.795749993</td><td>-30.9762549663</td><td>7.50175705691</td></tr>
</table></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Plot sources on top of significance sky image</span>
<span class="n">images_ts</span><span class="p">[</span><span class="s1">&#39;sqrt_ts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cutout</span><span class="p">(</span>
    <span class="n">position</span><span class="o">=</span><span class="n">SkyCoord</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;galactic&#39;</span><span class="p">),</span>
    <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">add_cbar</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;icrs_ra_peak&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;icrs_dec_peak&#39;</span><span class="p">],</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;icrs&#39;</span><span class="p">),</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[22]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>&lt;matplotlib.collections.PathCollection at 0x10b9cb470&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cta_data_analysis_29_1.png" src="../_images/notebooks_cta_data_analysis_29_1.png" />
</div>
</div>
</div>
<div class="section" id="Spatial-analysis">
<h2>Spatial analysis<a class="headerlink" href="#Spatial-analysis" title="Permalink to this headline">¶</a></h2>
<p>To do a spatial analysis of the data, you can pass the <code class="docutils literal"><span class="pre">counts</span></code>,
<code class="docutils literal"><span class="pre">exposure</span></code> and <code class="docutils literal"><span class="pre">background</span></code> image, as well as the <code class="docutils literal"><span class="pre">psf</span></code> kernel to
Sherpa and use Sherpa to fit spatial models.</p>
<p>We plan to add an example to this notebook.</p>
<p>For now, please see
<a class="reference internal" href="image_fitting_with_sherpa.html"><span class="doc">image_fitting_with_sherpa.ipynb</span></a>
as an extensive tutorial on how to model complex spatial models with
Sherpa.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># TODO: fit a Gaussian to the GC source</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Spectrum">
<h2>Spectrum<a class="headerlink" href="#Spectrum" title="Permalink to this headline">¶</a></h2>
<p>We’ll run a spectral analysis using the classical reflected regions
background estimation method, and using the on-off (often called WSTAT)
likelihood function.</p>
<div class="section" id="Extraction">
<h3>Extraction<a class="headerlink" href="#Extraction" title="Permalink to this headline">¶</a></h3>
<p>The first step is to “extract” the spectrum, i.e. 1-dimensional counts
and exposure and background vectors, as well as an energy dispersion
matrix from the data and IRFs.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">bkg_estimator</span> <span class="o">=</span> <span class="n">ReflectedRegionsBackgroundEstimator</span><span class="p">(</span>
    <span class="n">obs_list</span><span class="o">=</span><span class="n">obs_list</span><span class="p">,</span>
    <span class="n">on_region</span><span class="o">=</span><span class="n">on_region</span><span class="p">,</span>
    <span class="n">exclusion_mask</span><span class="o">=</span><span class="n">exclusion_mask</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">bkg_estimator</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">bkg_estimate</span> <span class="o">=</span> <span class="n">bkg_estimator</span><span class="o">.</span><span class="n">result</span>
<span class="n">bkg_estimator</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[24]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>(&lt;matplotlib.figure.Figure at 0x10c7459e8&gt;,
 &lt;matplotlib.axes._subplots.WCSAxesSubplot at 0x10c745e80&gt;,
 None)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cta_data_analysis_33_1.png" src="../_images/notebooks_cta_data_analysis_33_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">extract</span> <span class="o">=</span> <span class="n">SpectrumExtraction</span><span class="p">(</span>
    <span class="n">obs_list</span><span class="o">=</span><span class="n">obs_list</span><span class="p">,</span>
    <span class="n">bkg_estimate</span><span class="o">=</span><span class="n">bkg_estimate</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">extract</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Model-fit">
<h3>Model fit<a class="headerlink" href="#Model-fit" title="Permalink to this headline">¶</a></h3>
<p>The next step is to fit a spectral model, using all data (i.e. a
“global” fit, using all energies).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PowerLaw</span><span class="p">(</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
    <span class="n">amplitude</span> <span class="o">=</span> <span class="mf">1e-11</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;cm-2 s-1 TeV-1&#39;</span><span class="p">),</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">fit</span> <span class="o">=</span> <span class="n">SpectrumFit</span><span class="p">(</span><span class="n">extract</span><span class="o">.</span><span class="n">observations</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
<span class="n">fit</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">fit</span><span class="o">.</span><span class="n">est_errors</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">fit</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
/Users/deil/code/gammapy/gammapy/stats/fit_statistics.py:161: RuntimeWarning: divide by zero encountered in log
  term2_ = - n_on * np.log(mu_sig + alpha * mu_bkg)
/Users/deil/code/gammapy/gammapy/stats/fit_statistics.py:166: RuntimeWarning: divide by zero encountered in log
  term3_ = - n_off * np.log(mu_bkg)
/Users/deil/code/gammapy/gammapy/stats/fit_statistics.py:203: RuntimeWarning: divide by zero encountered in log
  term1 = - n_on * (1 - np.log(n_on))
/Users/deil/code/gammapy/gammapy/stats/fit_statistics.py:204: RuntimeWarning: divide by zero encountered in log
  term2 = - n_off * (1 - np.log(n_off))
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Fit result info
---------------
Model: PowerLaw

Parameters:

           name     value     error         unit      min max frozen
        --------- --------- --------- --------------- --- --- ------
            index 2.226e+00 2.611e-02                 nan nan  False
        amplitude 3.019e-12 1.397e-13 1 / (cm2 s TeV) nan nan  False
        reference 1.000e+00 0.000e+00             TeV nan nan   True

Covariance:

        name/name   index   amplitude
        --------- --------- ---------
            index  0.000682 -9.96e-16
        amplitude -9.96e-16  1.95e-26

Statistic: 91.257 (wstat)
Fit Range: [  1.00000000e-02   1.00000000e+02] TeV

</pre></div></div>
</div>
</div>
<div class="section" id="Spectral-points">
<h3>Spectral points<a class="headerlink" href="#Spectral-points" title="Permalink to this headline">¶</a></h3>
<p>Finally, let’s compute spectral points. The method used is to first
choose an energy binning, and then to do a 1-dim likelihood fit /
profile to compute the flux and flux error.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Flux points are computed on stacked observation</span>
<span class="n">stacked_obs</span> <span class="o">=</span> <span class="n">extract</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">stacked_obs</span><span class="p">)</span>

<span class="n">ebounds</span> <span class="o">=</span> <span class="n">EnergyBounds</span><span class="o">.</span><span class="n">equal_log_spacing</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">)</span>

<span class="n">seg</span> <span class="o">=</span> <span class="n">SpectrumEnergyGroupMaker</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="n">stacked_obs</span><span class="p">)</span>
<span class="n">seg</span><span class="o">.</span><span class="n">compute_range_safe</span><span class="p">()</span>
<span class="n">seg</span><span class="o">.</span><span class="n">compute_groups_fixed</span><span class="p">(</span><span class="n">ebounds</span><span class="o">=</span><span class="n">ebounds</span><span class="p">)</span>

<span class="n">fpe</span> <span class="o">=</span> <span class="n">FluxPointEstimator</span><span class="p">(</span>
    <span class="n">obs</span><span class="o">=</span><span class="n">stacked_obs</span><span class="p">,</span>
    <span class="n">groups</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">groups</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="n">fit</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fpe</span><span class="o">.</span><span class="n">compute_points</span><span class="p">()</span>
<span class="n">fpe</span><span class="o">.</span><span class="n">flux_points</span><span class="o">.</span><span class="n">table</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
WARNING: AstropyDeprecationWarning: The truth value of a Quantity is ambiguous. In the future this will raise a ValueError. [astropy.units.quantity]
WARNING:astropy:AstropyDeprecationWarning: The truth value of a Quantity is ambiguous. In the future this will raise a ValueError.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
*** Observation summary report ***
Observation Id: [110380-111159]
Livetime: 1.470 h
On events: 2377
Off events: 34781
Alpha: 0.041
Bkg events in On region: 1432.16
Excess: 944.84
Excess / Background: 0.66
Gamma rate: 0.15 1 / min
Bkg rate: 0.23 1 / min
Sigma: 22.24
energy range: 0.01 TeV - 100.00 TeV
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
/Users/deil/code/gammapy/gammapy/stats/poisson.py:383: RuntimeWarning: divide by zero encountered in double_scalars
  temp = (alpha + 1) / (n_on + n_off)
/Users/deil/code/gammapy/gammapy/stats/poisson.py:384: RuntimeWarning: divide by zero encountered in log
  l = n_on * log(n_on * temp / alpha)
/Users/deil/code/gammapy/gammapy/stats/fit_statistics.py:161: RuntimeWarning: divide by zero encountered in log
  term2_ = - n_on * np.log(mu_sig + alpha * mu_bkg)
/Users/deil/code/gammapy/gammapy/stats/fit_statistics.py:166: RuntimeWarning: divide by zero encountered in log
  term3_ = - n_off * np.log(mu_bkg)
/Users/deil/code/gammapy/gammapy/stats/fit_statistics.py:203: RuntimeWarning: divide by zero encountered in log
  term1 = - n_on * (1 - np.log(n_on))
/Users/deil/code/gammapy/gammapy/stats/fit_statistics.py:204: RuntimeWarning: divide by zero encountered in log
  term2 = - n_off * (1 - np.log(n_off))
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<i>Table length=4</i>
<table id="table4488688808" class="table-striped table-bordered table-condensed">
<thead><tr><th>e_ref</th><th>e_min</th><th>e_max</th><th>dnde</th><th>dnde_err</th><th>dnde_ul</th><th>is_ul</th><th>sqrt_ts</th><th>dnde_errp</th><th>dnde_errn</th></tr></thead>
<thead><tr><th>TeV</th><th>TeV</th><th>TeV</th><th>1 / (cm2 s TeV)</th><th>1 / (cm2 s TeV)</th><th>1 / (cm2 s TeV)</th><th></th><th></th><th>1 / (cm2 s TeV)</th><th>1 / (cm2 s TeV)</th></tr></thead>
<thead><tr><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>bool</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>1.56474814166</td><td>1.0</td><td>2.44843674682</td><td>1.09929677082e-12</td><td>1.23399567803e-13</td><td>1.36112562438e-12</td><td>False</td><td>13.9252559708</td><td>1.26220310761e-13</td><td>1.21722152847e-13</td></tr>
<tr><td>3.83118684956</td><td>2.44843674682</td><td>5.99484250319</td><td>1.57115663963e-13</td><td>1.94350698019e-14</td><td>1.9835646019e-13</td><td>False</td><td>13.6831790276</td><td>1.98236158774e-14</td><td>1.86031714233e-14</td></tr>
<tr><td>9.3804186664</td><td>5.99484250319</td><td>14.6779926762</td><td>1.30447549626e-14</td><td>3.09086142947e-15</td><td>2.00964479695e-14</td><td>False</td><td>6.83528872</td><td>3.32268015634e-15</td><td>2.88496727552e-15</td></tr>
<tr><td>22.9673617634</td><td>14.6779926762</td><td>35.938136638</td><td>1.27557550214e-15</td><td>5.70818610801e-16</td><td>2.7176911792e-15</td><td>False</td><td>3.55481035321</td><td>6.49472424329e-16</td><td>5.04683615003e-16</td></tr>
</table></div>
</div>
</div>
<div class="section" id="Plot">
<h3>Plot<a class="headerlink" href="#Plot" title="Permalink to this headline">¶</a></h3>
<p>Let’s plot the spectral model and points. You could do it directly, but
there is a helper class. Note that a spectral uncertainty band, a
“butterfly” is drawn, but it is very thin, i.e. barely visible.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">total_result</span> <span class="o">=</span> <span class="n">SpectrumResult</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">fit</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
    <span class="n">points</span><span class="o">=</span><span class="n">fpe</span><span class="o">.</span><span class="n">flux_points</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">total_result</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">energy_range</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">,</span>
    <span class="n">fig_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">)),</span>
    <span class="n">point_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[28]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>(&lt;matplotlib.axes._subplots.AxesSubplot at 0x10b8bebe0&gt;,
 &lt;matplotlib.axes._subplots.AxesSubplot at 0x10b2c67f0&gt;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_cta_data_analysis_40_1.png" src="../_images/notebooks_cta_data_analysis_40_1.png" />
</div>
</div>
</div>
</div>
<div class="section" id="Exercises">
<h2>Exercises<a class="headerlink" href="#Exercises" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Re-run the analysis above, varying some analysis parameters, e.g.<ul>
<li>Select a few other observations</li>
<li>Change the energy band for the map</li>
<li>Change the spectral model for the fit</li>
<li>Change the energy binning for the spectral points</li>
</ul>
</li>
<li>Change the target. Make a sky image and spectrum for your favourite
source.<ul>
<li>If you don’t know any, the Crab nebula is the “hello world!”
analysis of gamma-ray astronomy.</li>
</ul>
</li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># print(&#39;hello world&#39;)</span>
<span class="c1"># SkyCoord.from_name(&#39;crab&#39;)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="What-next?">
<h2>What next?<a class="headerlink" href="#What-next?" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>This notebook showed an example of a first CTA analysis with Gammapy,
using simulated 1DC data.</li>
<li>This was part 2 for CTA 1DC turorial, the first part was here:
<a class="reference internal" href="cta_1dc_introduction.html"><span class="doc">cta_1dc_introduction.ipynb</span></a></li>
<li>More tutorials (not 1DC or CTA specific) with Gammapy are
<a class="reference internal" href="../index.html"><span class="doc">here</span></a></li>
<li>Let us know if you have any question or issues!</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>
<ul>
<li><a class="reference internal" href="#">CTA data analysis with Gammapy</a><ul>
<li><a class="reference internal" href="#Introduction">Introduction</a></li>
<li><a class="reference internal" href="#Setup">Setup</a></li>
<li><a class="reference internal" href="#Select-observations">Select observations</a></li>
<li><a class="reference internal" href="#Make-sky-images">Make sky images</a><ul>
<li><a class="reference internal" href="#Define-map-geometry">Define map geometry</a></li>
<li><a class="reference internal" href="#Compute-images">Compute images</a></li>
<li><a class="reference internal" href="#Show-images">Show images</a></li>
</ul>
</li>
<li><a class="reference internal" href="#Source-Detection">Source Detection</a></li>
<li><a class="reference internal" href="#Spatial-analysis">Spatial analysis</a></li>
<li><a class="reference internal" href="#Spectrum">Spectrum</a><ul>
<li><a class="reference internal" href="#Extraction">Extraction</a></li>
<li><a class="reference internal" href="#Model-fit">Model fit</a></li>
<li><a class="reference internal" href="#Spectral-points">Spectral points</a></li>
<li><a class="reference internal" href="#Plot">Plot</a></li>
</ul>
</li>
<li><a class="reference internal" href="#Exercises">Exercises</a></li>
<li><a class="reference internal" href="#What-next?">What next?</a></li>
</ul>
</li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right">
    <a href="../_sources/notebooks/cta_data_analysis.ipynb.txt"
       rel="nofollow">Page Source</a> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2018, The Gammapy developers.<br/>
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.7. &nbsp;
    Last built 01 Mar 2018. <br/>
  </p>
</footer>
  </body>
</html>