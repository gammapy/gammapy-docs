
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Cube analysis with Gammapy (part 2) &#8212; gammapy v0.7</title>
    <link rel="stylesheet" href="../_static/gammapy.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.7',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/sidebar.js"></script>
    <link rel="shortcut icon" href="../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>
<script type="text/javascript" src="../_static/copybutton.js"></script>


  </head>
  <body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../index.html"><span id="logotext1">gamma</span><span id="logotext2">py</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../index.html">gammapy v0.7</a>
	 &#187;
      </li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 9ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }
</style>
<script type="text/javascript" src="../_static/linksdl.js"></script><div class="admonition note">
<p class="first"><strong>This is a fixed-text formatted version of a Jupyter notebook.</strong></p>
<p>You can contribute with your own notebooks in this <a class="reference external" href="https://github.com/gammapy/gammapy-extra/tree/master/notebooks">GitHub
repository</a>.</p>
<p class="last"><strong>Source files:</strong>
<a class="reference external" href="../_static/notebooks/cube_analysis_part2.ipynb">cube_analysis_part2.ipynb</a>
|
<a class="reference external" href="../_static/notebooks/cube_analysis_part2.py">cube_analysis_part2.py</a></p>
</div>
<div class="section" id="Cube-analysis-with-Gammapy-(part-2)">
<h1>Cube analysis with Gammapy (part 2)<a class="headerlink" href="#Cube-analysis-with-Gammapy-(part-2)" title="Permalink to this headline">¶</a></h1>
<div class="section" id="Introduction">
<h2>Introduction<a class="headerlink" href="#Introduction" title="Permalink to this headline">¶</a></h2>
<p>In this tutorial we will learn how to compute a morphological and
spectral fit simultanously.</p>
<p>This is part 2 of 2 for IACT cube analysis. If you haven’t prepared your
cubes, PSF and EDISP yet, do part 1 first.</p>
<p>The fitting is done using
<a class="reference external" href="http://cxc.harvard.edu/contrib/sherpa47/">Sherpa</a>.</p>
<p>We will use the following classes:</p>
<ul class="simple">
<li><a class="reference external" href="http://docs.gammapy.org/0.7/cube/index.html">gammapy.cube</a> where
are strored the counts, the background, the exposure and the mean psf
of this Crab dataset.</li>
<li><a class="reference external" href="http://docs.gammapy.org/0.7/api/gammapy.irf.EnergyDispersion.html">gammapy.irf.EnergyDispersion</a>
where is stored the mean rmf of this Crab dataset.</li>
<li>the method
<a class="reference external" href="http://docs.gammapy.org/0.7/api/gammapy.cube.SkyCube.html#gammapy.cube.SkyCube.to_sherpa_data3d">gammapy.cube.SkyCube.to_sherpa_data3d</a>
to transform the counts cube in Sherpa object.</li>
<li><a class="reference external" href="http://docs.gammapy.org/0.7/api/gammapy.cube.CombinedModel3DInt.html">gammapy.cube.CombinedModel3DInt</a>
to combine the spectral and spatial model for the fit if you consider
a perfect energy resolution</li>
<li><a class="reference external" href="http://docs.gammapy.org/0.7/api/gammapy.cube.CombinedModel3DIntConvolveEdisp.html">gammapy.cube.CombinedModel3DIntConvolveEdisp</a>
to combine the spectral and spatial model for the fit taking into
account that the true energy is different than the reconstructed one.</li>
</ul>
<p>We will use the cubes built on the 4 Crab observations of gammapy-extra.</p>
<p>You could use the cubes we just created with the notebook
<code class="docutils literal"><span class="pre">cube_analysis_part1.ipynb</span></code></p>
</div>
<div class="section" id="Setup">
<h2>Setup<a class="headerlink" href="#Setup" title="Permalink to this headline">¶</a></h2>
<p>As always, we start with some notebook setup and imports</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;sherpa.fit&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">Angle</span>
<span class="kn">from</span> <span class="nn">regions</span> <span class="kn">import</span> <span class="n">CircleSkyRegion</span>

<span class="kn">from</span> <span class="nn">gammapy.extern.pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">gammapy.irf</span> <span class="kn">import</span> <span class="n">EnergyDispersion</span>
<span class="kn">from</span> <span class="nn">gammapy.cube</span> <span class="kn">import</span> <span class="n">SkyCube</span>
<span class="kn">from</span> <span class="nn">gammapy.cube.sherpa_</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CombinedModel3DInt</span><span class="p">,</span>
    <span class="n">CombinedModel3DIntConvolveEdisp</span><span class="p">,</span>
    <span class="n">NormGauss2DInt</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">sherpa.models</span> <span class="kn">import</span> <span class="n">PowLaw1D</span><span class="p">,</span> <span class="n">TableModel</span>
<span class="kn">from</span> <span class="nn">sherpa.estmethods</span> <span class="kn">import</span> <span class="n">Covariance</span>
<span class="kn">from</span> <span class="nn">sherpa.optmethods</span> <span class="kn">import</span> <span class="n">NelderMead</span>
<span class="kn">from</span> <span class="nn">sherpa.stats</span> <span class="kn">import</span> <span class="n">Cash</span>
<span class="kn">from</span> <span class="nn">sherpa.fit</span> <span class="kn">import</span> <span class="n">Fit</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
WARNING: imaging routines will not be available,
failed to import sherpa.image.ds9_backend due to
&#39;RuntimeErr: DS9Win unusable: Could not find xpaget on your PATH&#39;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
WARNING:sherpa.image:imaging routines will not be available,
failed to import sherpa.image.ds9_backend due to
&#39;RuntimeErr: DS9Win unusable: Could not find xpaget on your PATH&#39;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
WARNING: failed to import sherpa.astro.xspec; XSPEC models will not be available
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
WARNING:sherpa.astro.all:failed to import sherpa.astro.xspec; XSPEC models will not be available
</pre></div></div>
</div>
</div>
<div class="section" id="3D-analysis-assuming-that-there-is-no-energy-dispersion-(perfect-energy-resolution)">
<h2>3D analysis assuming that there is no energy dispersion (perfect energy resolution)<a class="headerlink" href="#3D-analysis-assuming-that-there-is-no-energy-dispersion-(perfect-energy-resolution)" title="Permalink to this headline">¶</a></h2>
<div class="section" id="Load-the-different-cubes-needed-for-the-analysis">
<h3>Load the different cubes needed for the analysis<a class="headerlink" href="#Load-the-different-cubes-needed-for-the-analysis" title="Permalink to this headline">¶</a></h3>
<p>We will use the Cubes build on the 4 Crab observations of gammapy-extra.
You could use the Cubes we just created with the notebook
cube_analysis.ipynb by changing the cube_directory by your local path.</p>
<ul class="simple">
<li>Counts cube</li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">cube_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;$GAMMAPY_EXTRA/test_datasets/cube&#39;</span><span class="p">)</span>
<span class="n">counts_3d</span> <span class="o">=</span> <span class="n">SkyCube</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cube_dir</span> <span class="o">/</span> <span class="s1">&#39;counts_cube.fits&#39;</span><span class="p">)</span>
<span class="c1"># Transformation to a sherpa object</span>
<span class="n">cube</span> <span class="o">=</span> <span class="n">counts_3d</span><span class="o">.</span><span class="n">to_sherpa_data3d</span><span class="p">(</span><span class="n">dstype</span><span class="o">=</span><span class="s1">&#39;Data3DInt&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li>Background Cube</li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">bkg_3d</span> <span class="o">=</span> <span class="n">SkyCube</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cube_dir</span> <span class="o">/</span> <span class="s1">&#39;bkg_cube.fits&#39;</span><span class="p">)</span>
<span class="n">bkg</span> <span class="o">=</span> <span class="n">TableModel</span><span class="p">(</span><span class="s1">&#39;bkg&#39;</span><span class="p">)</span>
<span class="n">bkg</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">bkg_3d</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
<span class="n">bkg</span><span class="o">.</span><span class="n">ampl</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">bkg</span><span class="o">.</span><span class="n">ampl</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li>Exposure Cube</li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">exposure_3d</span> <span class="o">=</span> <span class="n">SkyCube</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cube_dir</span> <span class="o">/</span> <span class="s1">&#39;exposure_cube.fits&#39;</span><span class="p">)</span>
<span class="n">i_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">exposure_3d</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
<span class="n">exposure_3d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i_nan</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># In order to have the exposure in cm2 s</span>
<span class="n">exposure_3d</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">exposure_3d</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;m2 / cm2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li>PSF Cube</li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">psf_3d</span> <span class="o">=</span> <span class="n">SkyCube</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cube_dir</span> <span class="o">/</span> <span class="s1">&#39;psf_cube.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Setup-Combined-spatial-and-spectral-model">
<h3>Setup Combined spatial and spectral model<a class="headerlink" href="#Setup-Combined-spatial-and-spectral-model" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Define a 2D gaussian for the spatial model</span>
<span class="n">spatial_model</span> <span class="o">=</span> <span class="n">NormGauss2DInt</span><span class="p">(</span><span class="s1">&#39;spatial-model&#39;</span><span class="p">)</span>

<span class="c1"># Define a power law for the spectral model</span>
<span class="n">spectral_model</span> <span class="o">=</span> <span class="n">PowLaw1D</span><span class="p">(</span><span class="s1">&#39;spectral-model&#39;</span><span class="p">)</span>

<span class="c1"># Combine spectral and spatial model</span>
<span class="n">coord</span> <span class="o">=</span> <span class="n">counts_3d</span><span class="o">.</span><span class="n">sky_image_ref</span><span class="o">.</span><span class="n">coordinates</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;edges&quot;</span><span class="p">)</span>
<span class="n">energies</span> <span class="o">=</span> <span class="n">counts_3d</span><span class="o">.</span><span class="n">energies</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;edges&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;TeV&quot;</span><span class="p">)</span>
<span class="c1"># Here the source model will be convolve by the psf:</span>
<span class="c1"># PSF * (source_model * exposure)</span>
<span class="n">source_model</span> <span class="o">=</span> <span class="n">CombinedModel3DInt</span><span class="p">(</span>
    <span class="n">coord</span><span class="o">=</span><span class="n">coord</span><span class="p">,</span>
    <span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
    <span class="n">use_psf</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">exposure</span><span class="o">=</span><span class="n">exposure_3d</span><span class="p">,</span>
    <span class="n">psf</span><span class="o">=</span><span class="n">psf_3d</span><span class="p">,</span>
    <span class="n">spatial_model</span><span class="o">=</span><span class="n">spatial_model</span><span class="p">,</span>
    <span class="n">spectral_model</span><span class="o">=</span><span class="n">spectral_model</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Set-starting-value">
<h3>Set starting value<a class="headerlink" href="#Set-starting-value" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">center</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="mf">83.633083</span><span class="p">,</span> <span class="mf">22.0145</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">galactic</span>
<span class="n">source_model</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="mf">2.2</span>
<span class="n">source_model</span><span class="o">.</span><span class="n">xpos</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">value</span>
<span class="n">source_model</span><span class="o">.</span><span class="n">ypos</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">value</span>
<span class="n">source_model</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="mf">0.12</span>
<span class="n">source_model</span><span class="o">.</span><span class="n">ampl</span> <span class="o">=</span> <span class="mf">1.0</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Fit">
<h3>Fit<a class="headerlink" href="#Fit" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Define the model</span>
<span class="n">flux_factor</span> <span class="o">=</span> <span class="mf">1e-11</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">bkg</span> <span class="o">+</span> <span class="n">flux_factor</span> <span class="o">*</span> <span class="n">source_model</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Fit to the counts Cube sherpa object</span>
<span class="n">fit</span> <span class="o">=</span> <span class="n">Fit</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">cube</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">stat</span><span class="o">=</span><span class="n">Cash</span><span class="p">(),</span>
    <span class="n">method</span><span class="o">=</span><span class="n">NelderMead</span><span class="p">(),</span>
    <span class="n">estmethod</span><span class="o">=</span><span class="n">Covariance</span><span class="p">(),</span>
<span class="p">)</span>
<span class="n">fit_results</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">fit_results</span><span class="o">.</span><span class="n">format</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Method                = neldermead
Statistic             = cash
Initial fit statistic = 8614.61
Final fit statistic   = 8028.8 at function evaluation 619
Data points           = 12500
Degrees of freedom    = 12495
Change in statistic   = 585.806
   spatial-model.xpos   184.195
   spatial-model.ypos   -6.16917
   spatial-model.ampl   6.16628
   spatial-model.fwhm   0.0765675
   spectral-model.gamma   2.30648
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">err_est_results</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">est_errors</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">err_est_results</span><span class="o">.</span><span class="n">format</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Confidence Method     = covariance
Iterative Fit Method  = None
Fitting Method        = neldermead
Statistic             = cash
covariance 1-sigma (68.2689%) bounds:
   Param            Best-Fit  Lower Bound  Upper Bound
   -----            --------  -----------  -----------
   spatial-model.xpos      184.195   -0.0128654    0.0128654
   spatial-model.ypos     -6.16917   -0.0124289    0.0124289
   spatial-model.ampl      6.16628    -0.308859     0.308859
   spatial-model.fwhm    0.0765675     -0.01881      0.01881
   spectral-model.gamma      2.30648   -0.0599405    0.0599405
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Add-an-exlusion-mask-for-the-Fit">
<h2>Add an exlusion mask for the Fit<a class="headerlink" href="#Add-an-exlusion-mask-for-the-Fit" title="Permalink to this headline">¶</a></h2>
<p>For example if you want to exclude a region in the FoV of your cube, you
just have to provide a SkyCube with the same dimension than the Counts
cube and with 0 in the region you want to exlude and 1 outside. With
this SkyCube mask you can select only some energy band for the fit or
just some spatial region whatever the energy band or both.</p>
<div class="section" id="Define-the-mask">
<h3>Define the mask<a class="headerlink" href="#Define-the-mask" title="Permalink to this headline">¶</a></h3>
<p>Here this is a test case, there is no source to exlude in our FOV but we
will create a mask that remove some events from the source. You just see
at the end that the amplitude fitted in the 3D analysis is lower than
the one when you use all the events from the Crab. The principle works
even if this is not usefull here, just a testcase.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">exclusion_region</span> <span class="o">=</span> <span class="n">CircleSkyRegion</span><span class="p">(</span>
    <span class="n">center</span><span class="o">=</span><span class="n">SkyCoord</span><span class="p">(</span><span class="mf">83.60</span><span class="p">,</span> <span class="mf">21.88</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">),</span>
    <span class="n">radius</span><span class="o">=</span><span class="n">Angle</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;deg&quot;</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">sky_mask_cube</span> <span class="o">=</span> <span class="n">counts_3d</span><span class="o">.</span><span class="n">region_mask</span><span class="p">(</span><span class="n">exclusion_region</span><span class="p">)</span>
<span class="n">sky_mask_cube</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">sky_mask_cube</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">index_region_selected_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sky_mask_cube</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Add the mask to the data</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Set the counts</span>
<span class="n">cube</span> <span class="o">=</span> <span class="n">counts_3d</span><span class="o">.</span><span class="n">to_sherpa_data3d</span><span class="p">(</span><span class="n">dstype</span><span class="o">=</span><span class="s1">&#39;Data3DInt&#39;</span><span class="p">)</span>
<span class="n">cube</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">sky_mask_cube</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Select only the background pixels of the cube of the selected region to
create the background model</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Set the bkg and select only the data points of the selected region</span>
<span class="n">bkg</span> <span class="o">=</span> <span class="n">TableModel</span><span class="p">(</span><span class="s1">&#39;bkg&#39;</span><span class="p">)</span>
<span class="n">bkg</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">bkg_3d</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">index_region_selected_3d</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
<span class="n">bkg</span><span class="o">.</span><span class="n">ampl</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">bkg</span><span class="o">.</span><span class="n">ampl</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Add the indices of the selected region of the Cube to combine the model</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># The model is evaluated on all the points then it is compared with the data only on the selected_region</span>
<span class="n">source_model</span> <span class="o">=</span> <span class="n">CombinedModel3DInt</span><span class="p">(</span>
    <span class="n">coord</span><span class="o">=</span><span class="n">coord</span><span class="p">,</span>
    <span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
    <span class="n">use_psf</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">exposure</span><span class="o">=</span><span class="n">exposure_3d</span><span class="p">,</span>
    <span class="n">psf</span><span class="o">=</span><span class="n">psf_3d</span><span class="p">,</span>
    <span class="n">spatial_model</span><span class="o">=</span><span class="n">spatial_model</span><span class="p">,</span>
    <span class="n">spectral_model</span><span class="o">=</span><span class="n">spectral_model</span><span class="p">,</span>
    <span class="n">select_region</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">index_selected_region</span><span class="o">=</span><span class="n">index_region_selected_3d</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Set starting values</span>
<span class="n">source_model</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="mf">2.2</span>
<span class="n">source_model</span><span class="o">.</span><span class="n">xpos</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">value</span>
<span class="n">source_model</span><span class="o">.</span><span class="n">ypos</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">value</span>
<span class="n">source_model</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="mf">0.12</span>
<span class="n">source_model</span><span class="o">.</span><span class="n">ampl</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="c1"># Define the model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">bkg</span> <span class="o">+</span> <span class="n">flux_factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">source_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">fit</span> <span class="o">=</span> <span class="n">Fit</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">cube</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">stat</span><span class="o">=</span><span class="n">Cash</span><span class="p">(),</span>
    <span class="n">method</span><span class="o">=</span><span class="n">NelderMead</span><span class="p">(),</span>
    <span class="n">estmethod</span><span class="o">=</span><span class="n">Covariance</span><span class="p">(),</span>
<span class="p">)</span>
<span class="n">fit_results</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">fit_results</span><span class="o">.</span><span class="n">format</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Method                = neldermead
Statistic             = cash
Initial fit statistic = 670.276
Final fit statistic   = 448.967 at function evaluation 553
Data points           = 390
Degrees of freedom    = 385
Change in statistic   = 221.309
   spatial-model.xpos   184.607
   spatial-model.ypos   -5.81938
   spatial-model.ampl   10.4384
   spatial-model.fwhm   0.00276986
   spectral-model.gamma   2.41052
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">err_est_results</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">est_errors</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="n">err_est_results</span><span class="o">.</span><span class="n">format</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Confidence Method     = covariance
Iterative Fit Method  = None
Fitting Method        = neldermead
Statistic             = cash
covariance 1-sigma (68.2689%) bounds:
   Param            Best-Fit  Lower Bound  Upper Bound
   -----            --------  -----------  -----------
   spatial-model.xpos      184.607        -----        -----
   spatial-model.ypos     -5.81938        -----        -----
   spatial-model.ampl      10.4384        -----        -----
   spatial-model.fwhm   0.00276986        -----        -----
   spectral-model.gamma      2.41052        -----        -----
</pre></div></div>
</div>
<p>The fitted flux is less than in the previous example since here the mask
remove some events from the Crab</p>
</div>
</div>
<div class="section" id="3D-analysis-taking-into-account-the-energy-dispersion">
<h2>3D analysis taking into account the energy dispersion<a class="headerlink" href="#3D-analysis-taking-into-account-the-energy-dispersion" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Set the counts</span>
<span class="n">counts_3d</span> <span class="o">=</span> <span class="n">SkyCube</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cube_dir</span> <span class="o">/</span> <span class="s2">&quot;counts_cube.fits&quot;</span><span class="p">)</span>
<span class="n">cube</span> <span class="o">=</span> <span class="n">counts_3d</span><span class="o">.</span><span class="n">to_sherpa_data3d</span><span class="p">(</span><span class="n">dstype</span><span class="o">=</span><span class="s1">&#39;Data3DInt&#39;</span><span class="p">)</span>

<span class="c1"># Set the bkg</span>
<span class="n">bkg_3d</span> <span class="o">=</span> <span class="n">SkyCube</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cube_dir</span> <span class="o">/</span> <span class="s1">&#39;bkg_cube.fits&#39;</span><span class="p">)</span>
<span class="n">bkg</span> <span class="o">=</span> <span class="n">TableModel</span><span class="p">(</span><span class="s1">&#39;bkg&#39;</span><span class="p">)</span>
<span class="n">bkg</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">bkg_3d</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
<span class="n">bkg</span><span class="o">.</span><span class="n">ampl</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">bkg</span><span class="o">.</span><span class="n">ampl</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>

<span class="c1"># Set the exposure</span>
<span class="n">exposure_3d</span> <span class="o">=</span> <span class="n">SkyCube</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cube_dir</span> <span class="o">/</span> <span class="s1">&#39;exposure_cube_etrue.fits&#39;</span><span class="p">)</span>
<span class="n">i_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">exposure_3d</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
<span class="n">exposure_3d</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i_nan</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">exposure_3d</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">exposure_3d</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="mf">1e4</span>

<span class="c1"># Set the mean psf model</span>
<span class="n">psf_3d</span> <span class="o">=</span> <span class="n">SkyCube</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cube_dir</span> <span class="o">/</span> <span class="s1">&#39;psf_cube_etrue.fits&#39;</span><span class="p">)</span>

<span class="c1"># Load the mean rmf calculated for the 4 Crab runs</span>
<span class="n">rmf</span> <span class="o">=</span> <span class="n">EnergyDispersion</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cube_dir</span> <span class="o">/</span> <span class="s1">&#39;rmf.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Setup combined spatial and spectral model</span>
<span class="n">spatial_model</span> <span class="o">=</span> <span class="n">NormGauss2DInt</span><span class="p">(</span><span class="s1">&#39;spatial-model&#39;</span><span class="p">)</span>
<span class="n">spectral_model</span> <span class="o">=</span> <span class="n">PowLaw1D</span><span class="p">(</span><span class="s1">&#39;spectral-model&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Add-the-mean-RMF-to-the-Combine3DInt-object">
<h3>Add the mean RMF to the Combine3DInt object<a class="headerlink" href="#Add-the-mean-RMF-to-the-Combine3DInt-object" title="Permalink to this headline">¶</a></h3>
<p>The model is evaluated on the true energy bin then it is convolved by
the energy dispersion to compare to the counts data in reconstructed
energy</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">coord</span> <span class="o">=</span> <span class="n">counts_3d</span><span class="o">.</span><span class="n">sky_image_ref</span><span class="o">.</span><span class="n">coordinates</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;edges&quot;</span><span class="p">)</span>
<span class="n">energies</span> <span class="o">=</span> <span class="n">counts_3d</span><span class="o">.</span><span class="n">energies</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;edges&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;TeV&quot;</span><span class="p">)</span>
<span class="n">source_model</span> <span class="o">=</span> <span class="n">CombinedModel3DIntConvolveEdisp</span><span class="p">(</span>
    <span class="n">coord</span><span class="o">=</span><span class="n">coord</span><span class="p">,</span>
    <span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
    <span class="n">use_psf</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">exposure</span><span class="o">=</span><span class="n">exposure_3d</span><span class="p">,</span>
    <span class="n">psf</span><span class="o">=</span><span class="n">psf_3d</span><span class="p">,</span>
    <span class="n">spatial_model</span><span class="o">=</span><span class="n">spatial_model</span><span class="p">,</span>
    <span class="n">spectral_model</span><span class="o">=</span><span class="n">spectral_model</span><span class="p">,</span>
    <span class="n">edisp</span><span class="o">=</span><span class="n">rmf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Set starting values</span>
<span class="n">center</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="mf">83.633083</span><span class="p">,</span> <span class="mf">22.0145</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">galactic</span>
<span class="n">source_model</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="mf">2.2</span>
<span class="n">source_model</span><span class="o">.</span><span class="n">xpos</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">value</span>
<span class="n">source_model</span><span class="o">.</span><span class="n">ypos</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">value</span>
<span class="n">source_model</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="mf">0.12</span>
<span class="n">source_model</span><span class="o">.</span><span class="n">ampl</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="c1"># Define the model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">bkg</span> <span class="o">+</span> <span class="n">flux_factor</span> <span class="o">*</span> <span class="n">source_model</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">fit</span> <span class="o">=</span> <span class="n">Fit</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">cube</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">stat</span><span class="o">=</span><span class="n">Cash</span><span class="p">(),</span>
    <span class="n">method</span><span class="o">=</span><span class="n">NelderMead</span><span class="p">(),</span>
    <span class="n">estmethod</span><span class="o">=</span><span class="n">Covariance</span><span class="p">(),</span>
<span class="p">)</span>
<span class="n">fit_results</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">fit_results</span><span class="o">.</span><span class="n">format</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Method                = neldermead
Statistic             = cash
Initial fit statistic = 6415.62
Final fit statistic   = 5848.02 at function evaluation 704
Data points           = 12500
Degrees of freedom    = 12495
Change in statistic   = 567.598
   spatial-model.xpos   184.192
   spatial-model.ypos   -6.17565
   spatial-model.ampl   6.22776
   spatial-model.fwhm   0.0712976
   spectral-model.gamma   2.26903
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">err_est_results</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">est_errors</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">err_est_results</span><span class="o">.</span><span class="n">format</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Confidence Method     = covariance
Iterative Fit Method  = None
Fitting Method        = neldermead
Statistic             = cash
covariance 1-sigma (68.2689%) bounds:
   Param            Best-Fit  Lower Bound  Upper Bound
   -----            --------  -----------  -----------
   spatial-model.xpos      184.192   -0.0117762    0.0117762
   spatial-model.ypos     -6.17565   -0.0136609    0.0136609
   spatial-model.ampl      6.22776    -0.312187     0.312187
   spatial-model.fwhm    0.0712976   -0.0205746    0.0205746
   spectral-model.gamma      2.26903   -0.0515044    0.0515044
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Discussion">
<h2>Discussion<a class="headerlink" href="#Discussion" title="Permalink to this headline">¶</a></h2>
<p>Here the Cubes are constructed from dummy data. We don’t expect to find
the good spectral shape or amplitude since there is a lot of problem
with the PFS, rmf etc.. in these dummy data. On real data, we find the
good Crab position and spectral shape for a power law or a power law
with an exponential cutoff….</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># TODO: there should be some visualisation of results.</span>
<span class="c1"># E.g. a plotted spectral model + butterfly</span>
<span class="c1"># Or a counts, model and residual image</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>
<ul>
<li><a class="reference internal" href="#">Cube analysis with Gammapy (part 2)</a><ul>
<li><a class="reference internal" href="#Introduction">Introduction</a></li>
<li><a class="reference internal" href="#Setup">Setup</a></li>
<li><a class="reference internal" href="#3D-analysis-assuming-that-there-is-no-energy-dispersion-(perfect-energy-resolution)">3D analysis assuming that there is no energy dispersion (perfect energy resolution)</a><ul>
<li><a class="reference internal" href="#Load-the-different-cubes-needed-for-the-analysis">Load the different cubes needed for the analysis</a></li>
<li><a class="reference internal" href="#Setup-Combined-spatial-and-spectral-model">Setup Combined spatial and spectral model</a></li>
<li><a class="reference internal" href="#Set-starting-value">Set starting value</a></li>
<li><a class="reference internal" href="#Fit">Fit</a></li>
</ul>
</li>
<li><a class="reference internal" href="#Add-an-exlusion-mask-for-the-Fit">Add an exlusion mask for the Fit</a><ul>
<li><a class="reference internal" href="#Define-the-mask">Define the mask</a></li>
</ul>
</li>
<li><a class="reference internal" href="#3D-analysis-taking-into-account-the-energy-dispersion">3D analysis taking into account the energy dispersion</a><ul>
<li><a class="reference internal" href="#Add-the-mean-RMF-to-the-Combine3DInt-object">Add the mean RMF to the Combine3DInt object</a></li>
</ul>
</li>
<li><a class="reference internal" href="#Discussion">Discussion</a></li>
</ul>
</li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right">
    <a href="../_sources/notebooks/cube_analysis_part2.ipynb.txt"
       rel="nofollow">Page Source</a> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2018, The Gammapy developers.<br/>
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.7. &nbsp;
    Last built 01 Mar 2018. <br/>
  </p>
</footer>
  </body>
</html>