
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>PIG 20 - Global Model API &#8212; gammapy v1.0rc1</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gammapy.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../../_static/gammapy_logo.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="PIG 21 - Models improvements" href="pig-021.html" />
    <link rel="prev" title="PIG 19 - Gammapy package structure follow up" href="pig-019.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../index.html">
  <img src="../../_static/gammapy_logo_nav.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../getting-started/index.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../user-guide/index.html">
  User guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../tutorials/index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../api-reference/index.html">
  API reference
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../index.html">
  Developer guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../release-notes/index.html">
  Release notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-primary btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        1.0rc1  <!-- this text may get changed later by javascript -->
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
</div>

<!-- NOTE: this JS must live here (not in our global JS file) because it relies
     on being processed by Jinja before it is run (specifically for replacing
     variables development/pigs/pig-020 and {'json_url': 'https://docs.gammapy.org/stable/switcher.json', 'version_match': '1.0rc1'}.
-->

<script type="text/javascript">
// Check if corresponding page path exists in other version of docs
// and, if so, go there instead of the homepage of the other docs version
function checkPageExistsAndRedirect(event) {
    const currentFilePath = "development/pigs/pig-020.html",
          tryUrl = event.target.getAttribute("href");
    let otherDocsHomepage = tryUrl.replace(currentFilePath, "");
    $.ajax({
        type: 'HEAD',
        url: tryUrl,
        // if the page exists, go there
        success: function() {
            location.href = tryUrl;
        }
    }).fail(function() {
        location.href = otherDocsHomepage;
    });
    // this prevents the browser from following the href of the clicked node
    // (which is fine because this function takes care of redirecting)
    return false;
}

// Populate the version switcher from the JSON config file
(function () {
    $.getJSON("https://docs.gammapy.org/stable/switcher.json", function(data, textStatus, jqXHR) {
        const currentFilePath = "development/pigs/pig-020.html";
        // create links to the corresponding page in the other docs versions
        $.each(data, function(index, entry) {
            // if no custom name specified (e.g., "latest"), use version string
            if (!("name" in entry)) {
                entry.name = entry.version;
            }
            // create the node
            const node = document.createElement("a");
            node.setAttribute("class", "list-group-item list-group-item-action py-1");
            node.textContent = `${entry.name}`;
            node.setAttribute("href", `${entry.url}${currentFilePath}`);
            // on click, AJAX calls will check if the linked page exists before
            // trying to redirect, and if not, will redirect to the homepage
            // for that version of the docs.
            node.onclick = checkPageExistsAndRedirect;
            // Add dataset values for the version and name in case people want
            // to apply CSS styling based on this information.
            node.dataset["versionName"] = entry.name;
            node.dataset["version"] = entry.version;

            $("#version_switcher_menu").append(node);
            // replace dropdown button text with the preferred display name of
            // this version, rather than using sphinx's 1.0rc1 variable.
            // also highlight the dropdown entry for the currently-viewed
            // version's entry
            if (entry.version == "1.0rc1") {
                node.classList.add("active");
                let btn = document.getElementById("version_switcher_button");
                btn.innerText = btn.dataset["activeVersionName"] = entry.name;
                btn.dataset["activeVersion"] = entry.version;
            }
        });
    });
})();
</script>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/gammapy/gammapy" rel="noopener" target="_blank" title="Github"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">Github</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/gammapyST" rel="noopener" target="_blank" title="Twitter"><span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://gammapy.slack.com/" rel="noopener" target="_blank" title="Slack"><span><i class="fab fa-slack"></i></span>
            <label class="sr-only">Slack</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../setup.html">
   Project setup
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dependencies.html">
   Dependencies
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   How to contribute to Gammapy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../release.html">
   How to make a Gammapy release
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../doc_howto.html">
   Documentation How To
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dev_howto.html">
   Developer How To
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="index.html">
   PIGs
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="pig-001.html">
     PIG 1 - PIG purpose and guidelines
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-002.html">
     PIG 2 - Organization of low level analysis code
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-003.html">
     PIG 3 - Plan for dropping Python 2.7 support
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-004.html">
     PIG 4 - Setup for tutorial notebooks and data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-005.html">
     PIG 5 - Gammapy 1.0 roadmap
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-006.html">
     PIG 6 - CTA observation handling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-007.html">
     PIG 7 - Models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-008.html">
     PIG 8 - Datasets
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-009.html">
     PIG 9 - Event sampling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-010.html">
     PIG 10 - Regions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-011.html">
     PIG 11 - Light curves
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-012.html">
     PIG 12 - High level interface
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-013.html">
     PIG 13 - Gammapy dependencies and distribution
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-014.html">
     PIG 14 - Uncertainty estimation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-016.html">
     PIG 16 - Gammapy package structure
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-018.html">
     PIG 18 - Documentation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-019.html">
     PIG 19 - Gammapy package structure follow up
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     PIG 20 - Global Model API
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-021.html">
     PIG 21 - Models improvements
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-022.html">
     PIG 22 - Unified flux estimators API
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-023.html">
     PIG 23 - Gammapy release cycle and version numbering
    </a>
   </li>
  </ul>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#abstract">
   Abstract
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#proposal">
   Proposal
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#global-model-handling">
     Global Model Handling
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#interaction-between-models-and-dataset-objects">
     Interaction Between Models and Dataset Objects
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#background-model-handling">
     Background Model Handling
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#decision">
   Decision
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="pig-20-global-model-api">
<span id="pig-020"></span><h1>PIG 20 - Global Model API<a class="headerlink" href="#pig-20-global-model-api" title="Permalink to this headline">#</a></h1>
<ul class="simple">
<li><p>Author: Axel Donath, Régis Terrier and Quentin Remy</p></li>
<li><p>Created: Jun 10, 2020</p></li>
<li><p>Withdrawn: Apr 26th, 2021</p></li>
<li><p>Status: withdrawn</p></li>
<li><p>Discussion: <a class="reference external" href="https://github.com/gammapy/gammapy/pull/2942">GH 2942</a></p></li>
</ul>
<section id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">#</a></h2>
<p>Gammapy already supports joint-likelihood analyses, where indiviudal, statistically
independent datasets are represented by a <code class="xref py py-obj docutils literal notranslate"><span class="pre">Dataset</span></code> object. In a typical analysis
scenario there are components in the model, that are only fitted to one of the datasets,
while other model components are shared between all datasets. This PIG proposes the
introduction of a global model API for Gammapy, which handles all model components
involved in an analysis in a single global models object to resolve the spread
model definition in the current implementation. We consider the global model API
as a key solution for future support for distributed computing in Gammapy.</p>
</section>
<section id="proposal">
<h2>Proposal<a class="headerlink" href="#proposal" title="Permalink to this headline">#</a></h2>
<section id="global-model-handling">
<h3>Global Model Handling<a class="headerlink" href="#global-model-handling" title="Permalink to this headline">#</a></h3>
<p>Currently different model components are handled in Gammapy by having a different
selection of models in the <code class="docutils literal notranslate"><span class="pre">Dataset.models</span></code> attributes and pointing to the same
instance of a model, if the component is shared between multiple datasets. This
works as long as all objects reside in the same memory space.</p>
<p>If datasets are distributed to different processes in future, it is technically
complex and probably in-efficient to share model states between all sub-processes.
It is conceptionally simpler if processes communicate with a single server process
that contains the single global model object.</p>
<p>The fundamental important difference to the current design is, that the model objects
defined in <code class="docutils literal notranslate"><span class="pre">Dataset.models</span></code> can represent copies of the global model object components.
To avoid</p>
<p>Using the <code class="docutils literal notranslate"><span class="pre">.set_models()</span></code> API we propose to hide the <code class="docutils literal notranslate"><span class="pre">dataset.models</span></code> attribute.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gammapy.modeling.models</span> <span class="kn">import</span> <span class="n">Models</span>
<span class="kn">from</span> <span class="nn">gammapy.datasets</span> <span class="kn">import</span> <span class="n">Datasets</span>

<span class="n">models</span> <span class="o">=</span> <span class="n">Models</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;my-models.yaml&quot;</span><span class="p">)</span>
<span class="n">datasets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;my-datasets.yaml&quot;</span><span class="p">)</span>

<span class="c1"># the .set_models call distributes the model components to the datasets</span>
<span class="n">datasets</span><span class="o">.</span><span class="n">set_models</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>

<span class="c1"># this initialises the model evaluators</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">set_models</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>

<span class="c1"># and to update parameters during fitting, a manual parameter modification by the user</span>
<span class="c1"># requires an update as well, maybe we can &quot;detect&quot; parameter changes automatically by</span>
<span class="c1"># caching the last parameters state?</span>
<span class="n">datasets</span><span class="o">.</span><span class="n">set_models_parameters</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
</pre></div>
</div>
<p>It also requires adapting our fitting API as well to handle the model separately:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gammapy.modeling</span> <span class="kn">import</span> <span class="n">Fit</span>

<span class="n">fit</span> <span class="o">=</span> <span class="n">Fit</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>

<span class="c1"># or for estimators</span>

<span class="n">fpe</span> <span class="o">=</span> <span class="n">FluxPointsEstimator</span><span class="p">(</span>
    <span class="n">source</span><span class="o">=</span><span class="s2">&quot;my_source&quot;</span>
<span class="p">)</span>

<span class="n">fpe</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">models</span><span class="p">)</span>
</pre></div>
</div>
<p>The public model attribute allows to create a global model on data reduction like so:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="n">Models</span><span class="p">()</span>

<span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">observations</span><span class="p">:</span>
    <span class="n">dataset</span><span class="p">,</span> <span class="n">bkg_model</span> <span class="o">=</span> <span class="n">bkg_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dataset-</span><span class="si">{</span><span class="n">obs</span><span class="o">.</span><span class="n">obs_id</span><span class="si">}</span><span class="s2">.fits.gz&quot;</span><span class="p">)</span>
    <span class="n">models</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

<span class="n">models</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;my-model.yaml&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="interaction-between-models-and-dataset-objects">
<h3>Interaction Between Models and Dataset Objects<a class="headerlink" href="#interaction-between-models-and-dataset-objects" title="Permalink to this headline">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">MapDataset</span></code> object features methods such as <code class="docutils literal notranslate"><span class="pre">.to_spectrum_dataset()</span></code>, <code class="docutils literal notranslate"><span class="pre">.to_image()</span></code>
and <code class="docutils literal notranslate"><span class="pre">.stack()</span></code> and <code class="docutils literal notranslate"><span class="pre">.copy()</span></code>. It is convenient for the user if those methods modify the
models contained in the dataset as well. In particular this is useful for the background model.
We propose a uniform scheme on how the dataset methods interact with the model.</p>
<p>We propose that in general datasets can modify their own models i.e. copies contained
in      <code class="docutils literal notranslate"><span class="pre">DatasetModels</span></code>, but never interact “bottom to top” with the global <code class="docutils literal notranslate"><span class="pre">Models</span></code>
object. So the global model object needs to be re-defined or updated explicitly.</p>
<p>The proposed behaviour is as follows:
- <code class="docutils literal notranslate"><span class="pre">Dataset.copy()</span></code>, copy the dataset and model, if a new name is specified for the dataset, the <code class="docutils literal notranslate"><span class="pre">Model.dataset_names</span></code> are adapted.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Dataset.stack()</span></code>, stack the model components by concatenating the model lists. The background model is stacked in place.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.to_image()</span></code> sums up the background model component and <code class="docutils literal notranslate"><span class="pre">TemplateSpatialModel</span></code> if it defines an energy axis.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.to_spectrum_dataset</span></code>, creates a fixed <code class="docutils literal notranslate"><span class="pre">BackgroundModel</span></code> by summing up the data in the same region. Further suggestions? Check which model contributes npred to the region?</p></li>
</ul>
<p>In this case we drop the model from the dataset.</p>
</section>
<section id="background-model-handling">
<h3>Background Model Handling<a class="headerlink" href="#background-model-handling" title="Permalink to this headline">#</a></h3>
<p>We also propose to extend the <code class="docutils literal notranslate"><span class="pre">BackgroundModel</span></code> to include a spectral model
component like so:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gammapy.modeling.models</span> <span class="kn">import</span> <span class="n">BackgroundIRFModel</span><span class="p">,</span> <span class="n">PowerLawNormSpectralModel</span>

<span class="n">norm</span> <span class="o">=</span> <span class="n">PowerLawNormSpectralModel</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tilt</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">bkg_model</span> <span class="o">=</span> <span class="n">BackgroundIRFModel</span><span class="p">(</span>
    <span class="n">spectral_model</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
    <span class="n">dataset_name</span><span class="o">=</span><span class="s2">&quot;my-dataset&quot;</span>
<span class="p">)</span>

<span class="n">bkg_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="nb">map</span><span class="p">)</span>
</pre></div>
</div>
<p>After introduction of the global model we propose to remove <code class="docutils literal notranslate"><span class="pre">MapDataset.background_model</span></code>
and use <code class="docutils literal notranslate"><span class="pre">MapDataset.models[&quot;dataset-name-bkg&quot;]</span></code> instead. Introduce a naming convention?</p>
<p>The background data can be stored either in the <code class="docutils literal notranslate"><span class="pre">BackgroundModel</span></code> class
or the <code class="docutils literal notranslate"><span class="pre">MapDataset</span></code> object as an IRF. This has implications on the
serialisation and memory management once we introduce distributed
computing. In one case the data is stored in the server process
in the other case it is stored on the sub-process.</p>
<p>To support spectral background models we propose to support <code class="docutils literal notranslate"><span class="pre">RegionGeom</span></code> in
the <code class="docutils literal notranslate"><span class="pre">BackgroundModel</span></code> class.</p>
</section>
</section>
<section id="decision">
<h2>Decision<a class="headerlink" href="#decision" title="Permalink to this headline">#</a></h2>
<p>The authors decided to withdraw the PIG. Most of the proposed changes have been
discussed and implemented independently in small contributions and discussion
with the Gammapy developer team.</p>
</section>
</section>


              </div>
              
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, The Gammapy developers.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>