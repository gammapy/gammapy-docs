
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>PIG 10 - Regions &#8212; gammapy v1.0rc2</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gammapy.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../../_static/gammapy_logo.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="PIG 11 - Light curves" href="pig-011.html" />
    <link rel="prev" title="PIG 9 - Event sampling" href="pig-009.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../index.html">
  <img src="../../_static/gammapy_logo_nav.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../getting-started/index.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../user-guide/index.html">
  User guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../tutorials/index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../api-reference/index.html">
  API reference
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../index.html">
  Developer guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../release-notes/index.html">
  Release notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-primary btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        1.0rc2  <!-- this text may get changed later by javascript -->
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
</div>

<!-- NOTE: this JS must live here (not in our global JS file) because it relies
     on being processed by Jinja before it is run (specifically for replacing
     variables development/pigs/pig-010 and {'json_url': 'https://docs.gammapy.org/stable/switcher.json', 'version_match': '1.0rc2'}.
-->

<script type="text/javascript">
// Check if corresponding page path exists in other version of docs
// and, if so, go there instead of the homepage of the other docs version
function checkPageExistsAndRedirect(event) {
    const currentFilePath = "development/pigs/pig-010.html",
          tryUrl = event.target.getAttribute("href");
    let otherDocsHomepage = tryUrl.replace(currentFilePath, "");
    $.ajax({
        type: 'HEAD',
        url: tryUrl,
        // if the page exists, go there
        success: function() {
            location.href = tryUrl;
        }
    }).fail(function() {
        location.href = otherDocsHomepage;
    });
    // this prevents the browser from following the href of the clicked node
    // (which is fine because this function takes care of redirecting)
    return false;
}

// Populate the version switcher from the JSON config file
(function () {
    $.getJSON("https://docs.gammapy.org/stable/switcher.json", function(data, textStatus, jqXHR) {
        const currentFilePath = "development/pigs/pig-010.html";
        // create links to the corresponding page in the other docs versions
        $.each(data, function(index, entry) {
            // if no custom name specified (e.g., "latest"), use version string
            if (!("name" in entry)) {
                entry.name = entry.version;
            }
            // create the node
            const node = document.createElement("a");
            node.setAttribute("class", "list-group-item list-group-item-action py-1");
            node.textContent = `${entry.name}`;
            node.setAttribute("href", `${entry.url}${currentFilePath}`);
            // on click, AJAX calls will check if the linked page exists before
            // trying to redirect, and if not, will redirect to the homepage
            // for that version of the docs.
            node.onclick = checkPageExistsAndRedirect;
            // Add dataset values for the version and name in case people want
            // to apply CSS styling based on this information.
            node.dataset["versionName"] = entry.name;
            node.dataset["version"] = entry.version;

            $("#version_switcher_menu").append(node);
            // replace dropdown button text with the preferred display name of
            // this version, rather than using sphinx's 1.0rc2 variable.
            // also highlight the dropdown entry for the currently-viewed
            // version's entry
            if (entry.version == "1.0rc2") {
                node.classList.add("active");
                let btn = document.getElementById("version_switcher_button");
                btn.innerText = btn.dataset["activeVersionName"] = entry.name;
                btn.dataset["activeVersion"] = entry.version;
            }
        });
    });
})();
</script>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/gammapy/gammapy" rel="noopener" target="_blank" title="Github"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">Github</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/gammapyST" rel="noopener" target="_blank" title="Twitter"><span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://gammapy.slack.com/" rel="noopener" target="_blank" title="Slack"><span><i class="fab fa-slack"></i></span>
            <label class="sr-only">Slack</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../setup.html">
   Project setup
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dependencies.html">
   Dependencies
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   How to contribute to Gammapy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../release.html">
   How to make a Gammapy release
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../doc_howto.html">
   Documentation How To
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dev_howto.html">
   Developer How To
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="index.html">
   PIGs
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="pig-001.html">
     PIG 1 - PIG purpose and guidelines
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-002.html">
     PIG 2 - Organization of low level analysis code
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-003.html">
     PIG 3 - Plan for dropping Python 2.7 support
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-004.html">
     PIG 4 - Setup for tutorial notebooks and data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-005.html">
     PIG 5 - Gammapy 1.0 roadmap
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-006.html">
     PIG 6 - CTA observation handling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-007.html">
     PIG 7 - Models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-008.html">
     PIG 8 - Datasets
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-009.html">
     PIG 9 - Event sampling
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     PIG 10 - Regions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-011.html">
     PIG 11 - Light curves
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-012.html">
     PIG 12 - High level interface
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-013.html">
     PIG 13 - Gammapy dependencies and distribution
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-014.html">
     PIG 14 - Uncertainty estimation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-016.html">
     PIG 16 - Gammapy package structure
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-018.html">
     PIG 18 - Documentation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-019.html">
     PIG 19 - Gammapy package structure follow up
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-020.html">
     PIG 20 - Global Model API
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-021.html">
     PIG 21 - Models improvements
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-022.html">
     PIG 22 - Unified flux estimators API
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-023.html">
     PIG 23 - Gammapy release cycle and version numbering
    </a>
   </li>
  </ul>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#abstract">
   Abstract
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#proposal">
   Proposal
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#region-arguments">
     Region arguments
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sky-and-pixel-regions">
     Sky and pixel regions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rotated-regions">
     Rotated regions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#images-and-masks">
     Images and masks
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#outlook">
   Outlook
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#task-list">
   Task list
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#alternatives">
   Alternatives
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#decision">
   Decision
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="pig-10-regions">
<span id="pig-010"></span><h1>PIG 10 - Regions<a class="headerlink" href="#pig-10-regions" title="Permalink to this headline">#</a></h1>
<ul class="simple">
<li><p>Author: Christoph Deil, Axel Donath, Régis Terrier</p></li>
<li><p>Created: May 3, 2019</p></li>
<li><p>Accepted: Jun 17, 2019</p></li>
<li><p>Status: accepted</p></li>
<li><p>Discussion: <a class="reference external" href="https://github.com/gammapy/gammapy/pull/2129">GH 2129</a></p></li>
</ul>
<section id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">#</a></h2>
<p>We propose to use <a class="reference external" href="https://astropy-regions.readthedocs.io">astropy-regions</a> to handle spatial sky and pixel regions
throughout Gammapy. We already use <code class="docutils literal notranslate"><span class="pre">astropy-regions</span></code>, so why a PIG? There are
a few decisions we need to make concerning where to use sky and where to use
pixel regions and where to support both. This affects the algorithms used (e.g.
for rotated region background estimation) and the API (where a WCS or exclusion
map is needed in functions and methods working with regions). Also
<code class="docutils literal notranslate"><span class="pre">astropy-regions</span></code> was started after Gammapy - so we have some code to work
with sky cones and boxes that should partially be removed, partially refactored
to use <code class="docutils literal notranslate"><span class="pre">astropy-regions</span></code>.</p>
<p>The scope of this PIG is small and limited to spatial sky and pixel regions. The
work to implement it is small, we propose to complete it for Gammapy v0.13 in
July 2019.</p>
<p>The question of more general data subspace selections that include energy, time
or phase regions and selections, or general n-dimensional regions, or whether to
introduce a field of view (FOV) coordinate frame and special FOV regions is not
addressed here. Also some things like the clean-up of <code class="docutils literal notranslate"><span class="pre">gammapy.image</span></code> which
contains some region-related code is left as future work.</p>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">#</a></h2>
<p>This long introduction describes the history and design of <a class="reference external" href="https://astropy-regions.readthedocs.io">astropy-regions</a>
and regions in Gammapy. It is background information, you are welcome to skip
ahead to the <a class="reference internal" href="#proposal">Proposal</a> and <a class="reference internal" href="#task-list">Task list</a> in this PIG below.</p>
<p>Spatial regions are used a lot in gamma-ray astronomy (and other domains of
astronomy as well). Often a users chooses a region of interest, and then selects
the observations or events or pixels for analysis. Besides “on regions” or
“regions of interest”, there are a few use cases to create regions within
Gammapy, e.g. to restrict analysis to a maximum field of view offset, or to
compute “off” regions for background estimation for a given “on” region.</p>
<p>In early versions of Gammapy we started to develop <code class="docutils literal notranslate"><span class="pre">gammapy.regions</span></code>, but soon
realised that the functionality really is very generic, and also needed by many
other astronomers (radio, optical, X-ray, …). Astropy and <a class="reference external" href="https://photutils.readthedocs.io">photutils</a> was
being developed, there was <a class="reference external" href="https://pyregion.readthedocs.io">pyregion</a>. At <a class="reference external" href="http://openastronomy.org/pyastro/2015/">Python in Astronomy 2015</a> we
discussed and decided to create a new Astropy-affiliated regions package from
scratch and have been developing it since: <a class="reference external" href="https://astropy-regions.readthedocs.io">astropy-regions</a>. The goal is to
merge it as <code class="docutils literal notranslate"><span class="pre">astropy.regions</span></code> into the Astropy core once it’s in a certain
sense complete, for now it is an extra package that has been a dependency of
Gammapy since Gammapy v0.5 in 2016. This is OK, the situation for
<code class="docutils literal notranslate"><span class="pre">astropy-regions</span></code> is the same as for <a class="reference external" href="https://reproject.readthedocs.io">reproject</a> and soon  <a class="reference external" href="https://astropy-healpix.readthedocs.io">astropy-healpix</a>
(see <a class="reference external" href="https://github.com/gammapy/gammapy/pull/1167">GH 1167</a>), they are extra packages and dependencies of Gammapy. We should
continue to contribute to these three projects until they are complete and help
get them in Astropy core some day.</p>
<p>The <a class="reference external" href="https://astropy-regions.readthedocs.io">astropy-regions</a> package contains sky and pixel regions with methods to
filter positions and to make masks, ways to transform between sky and pixel
region for a given WCS, support for plotting with matplotlib and I/O (string
serialisation and parsing) for the <a class="reference external" href="http://ds9.si.edu/doc/ref/region.html">DS9 region format</a>. As described below,
there are a few things still missing in astropy-regions that we need in Gammapy,
thus the work described in this PIG is partly for <a class="reference external" href="https://astropy-regions.readthedocs.io">astropy-regions</a> and partly
in Gammapy.</p>
<p>The places where regions appear in the Gammapy code and API are very few and
overall region handling is pretty simple. Gammapy is mostly a binned analysis
framework, so mainly regions are used to create pixel masks, and then the
analysis is mask-based, not involving region objects any more (see section
below: <a class="reference internal" href="#images-and-masks">Images and masks</a>). The second place where regions appear is to select
objects of interest (events, observations, sources) for a given region (see
section below: <a class="reference internal" href="#sky-and-pixel-regions">Sky and pixel regions</a>). Finally, there is the use case of
rotated regions for background estimation in  1D spectral analysis (see section
below: <a class="reference internal" href="#rotated-regions">Rotated regions</a>).</p>
<p>However, it turns out that working with regions is surprisingly tricky, because
there are different ways to define the basic semantics and computations for
“contains” of a region, how to transform between pixel and sky regions and how
to visualise them. The origin of the issue is that to make an image for analysis
or visualisation, one has to choose a projection that maps sky to pixel
coordinates, and there are many different projections, and they all have
distortions. For example, the <a class="reference external" href="https://en.wikipedia.org/wiki/Aitoff_projection">Wikipedia page on Aitoff projection</a> contains an
illustration of how sky circles map to pixel regions that are to a good
approximation pixel circles in some parts of the image, but in others have
complex shapes and different sizes, and at the edge even split in two disjoint
pixel regions on the left and right part of the image.</p>
<p>In <a class="reference external" href="https://astropy-regions.readthedocs.io">astropy-regions</a>, after a lot of discussions, we have agreed to keep it
simple, and to follow the lead of DS9 and to handle sky and pixel regions and
their transforms in the same way that DS9 does. This has the advantage that we
can use the DS9 string format to define and exchange regions (see section below:
<a class="reference internal" href="#region-arguments">Region arguments</a>), and we can use DS9 to view them. As can be seen in the
<code class="docutils literal notranslate"><span class="pre">CircleSkyRegion.to_pixel</span></code> method implementation below, the definition used to
map a sky circle to a pixel circle region is an approximation where the center
is transformed according to the given <code class="docutils literal notranslate"><span class="pre">wcs</span></code>, and the radius is transformed
using the local pixel scale at the center point for the given <code class="docutils literal notranslate"><span class="pre">wcs</span></code>.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CircleSkyRegion</span><span class="p">(</span><span class="n">SkyRegion</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">to_pixel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wcs</span><span class="p">):</span>
        <span class="n">center</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">skycoord_to_pixel_scale_angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="n">wcs</span><span class="p">)</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">scale</span>
        <span class="k">return</span> <span class="n">CirclePixelRegion</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">visual</span><span class="p">)</span>
</pre></div>
</div>
<p>So a sky circle is converted to a pixel circle. This works well for most use
cases where one has an image with an extent and WCS of roughly constant pixel
scale, e.g. a local TAN projection at a source location and 10 deg image size.
In general the strategy in Gammapy will be to accept both pixel or sky regions
as inputs, but to internally always call <code class="docutils literal notranslate"><span class="pre">to_pixel</span></code> first if a sky region is
passed, and to internally always work with pixel regions.</p>
<p>This approximation fails for all-sky analysis and image parts where the
projection has a shear or is varying like the sky circles that are distorted in
the image on the  <a class="reference external" href="https://en.wikipedia.org/wiki/Aitoff_projection">Wikipedia page on Aitoff projection</a>. One possible future
improvement to <code class="docutils literal notranslate"><span class="pre">astropy-regions</span></code> would be to implement sky contains directly
for <code class="docutils literal notranslate"><span class="pre">CircleSkyRegion</span></code> using sky distance, and for <code class="docutils literal notranslate"><span class="pre">PolygonSkyRegion</span></code> using
the assumption that polygon edges follow great circles, and for other shapes to
implement <code class="docutils literal notranslate"><span class="pre">to_polygon</span></code> methods that approximate any region as a
<code class="docutils literal notranslate"><span class="pre">PolygonSkyRegion</span></code> (using any number of points and accuracy the user wants),
and then transforming the <code class="docutils literal notranslate"><span class="pre">PolygonSkyRegion</span></code> to <code class="docutils literal notranslate"><span class="pre">PolygonPixelRegion</span></code>, as
defined already by simply transforming the vertex points. This is feasible and
useful for circles, ellipses and polygons (one would have to decide what to do
with image projection edges like at longitude 180 deg in the Aitoff example,
whether to split into disjoint pixel region parts), but is difficult for other
shapes such as wedges or already for rectangles, because their shape only
becomes well-defined for a given projection. These things are not in scope for
this PIG or needed for Gammapy for now, Gammapy simply doesn’t have all-sky
analysis support built in yet, although already now users could write Python
scripts to do it using a combination of HEALPix and WCS maps and Gammapy.</p>
<p>Now that we know how <a class="reference external" href="https://astropy-regions.readthedocs.io">astropy-regions</a> works and how we plan to handle pixel
and sky regions in Gammapy, let’s move on to the detailed proposal and task list
outlining additions and changes to make.</p>
</section>
<section id="proposal">
<h2>Proposal<a class="headerlink" href="#proposal" title="Permalink to this headline">#</a></h2>
<p>This section contains a detailed proposal concerning region-related code in
Gammapy. The <a class="reference internal" href="#task-list">Task list</a> at the end of this PIG references these descriptions.</p>
<section id="region-arguments">
<h3>Region arguments<a class="headerlink" href="#region-arguments" title="Permalink to this headline">#</a></h3>
<p>We propose to add support for DS9 region strings (in addition to region objects)
in all functions in Gammapy that take a <code class="docutils literal notranslate"><span class="pre">region</span></code> argument. This can be
achieved via a <code class="docutils literal notranslate"><span class="pre">make_region</span></code> helper function:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">regions</span> <span class="kn">import</span> <span class="n">DS9Parser</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">make_region</span><span class="p">(</span><span class="n">region</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="gp">... </span>        <span class="c1"># This is basic and works for simple regions</span>
<span class="gp">... </span>        <span class="c1"># It could be extended to cover more things,</span>
<span class="gp">... </span>        <span class="c1"># like e.g. compound regions, exclusion regions, ....</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">DS9Parser</span><span class="p">(</span><span class="n">region</span><span class="p">)</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_region</span><span class="p">()</span>
<span class="gp">... </span>    <span class="k">else</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">region</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">make_region</span><span class="p">(</span><span class="s2">&quot;image;circle(42,43,3)&quot;</span><span class="p">)</span>
<span class="go">&lt;CirclePixelRegion(center=PixCoord(x=41.0, y=42.0), radius=3.0)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">make_region</span><span class="p">(</span><span class="s2">&quot;galactic;circle(42,43,3)&quot;</span><span class="p">)</span>
<span class="go">&lt;CircleSkyRegion(center=&lt;SkyCoord (Galactic): (l, b) in deg</span>
<span class="go">    (42., 43.)&gt;, radius=3.0 deg)&gt;</span>
</pre></div>
</div>
<p>This is convenient, a simple <code class="docutils literal notranslate"><span class="pre">region=&quot;galactic;circle(42,43,3)&quot;</span></code> is much
shorter than having to remember and type this equivalent code:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">Angle</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">regions</span> <span class="kn">import</span> <span class="n">CircleSkyRegion</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">center</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;galactic&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">radius</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;deg&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">region</span> <span class="o">=</span> <span class="n">CircleSkyRegion</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">region</span>
<span class="go">&lt;CircleSkyRegion(center=&lt;SkyCoord (Galactic): (l, b) in deg</span>
<span class="go">    (42., 43.)&gt;, radius=3.0 deg)&gt;</span>
</pre></div>
</div>
<p>There is precedence for this pattern in Gammapy, we usually pass <code class="docutils literal notranslate"><span class="pre">Quantity</span></code>
and <code class="docutils literal notranslate"><span class="pre">Angle</span></code> arguments through via e.g. <code class="docutils literal notranslate"><span class="pre">angle</span> <span class="pre">=</span> <span class="pre">Angle(angle)</span></code> in Gammapy
functions, and often call them with strings <code class="docutils literal notranslate"><span class="pre">angle=&quot;3</span> <span class="pre">deg&quot;</span></code>.</p>
<p>We propose to add a second function <code class="docutils literal notranslate"><span class="pre">make_pixel_region</span></code> which in addition to
the string case handling also does the sky region case handling, and gives good
error messages on invalid inputs.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">regions</span> <span class="kn">import</span> <span class="n">DS9Parser</span><span class="p">,</span> <span class="n">SkyRegion</span><span class="p">,</span> <span class="n">PixelRegion</span>

<span class="k">def</span> <span class="nf">make_pixel_region</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">make_region</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">SkyRegion</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">wcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Sky regions not supported here.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">region</span><span class="o">.</span><span class="n">to_pixel</span><span class="p">(</span><span class="n">wcs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">PixelRegion</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">region</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;What is this? Giving up.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Since in Gammapy we implement almost all algorithms using pixel regions, we
could then call this helper function on each Gammapy method or function on the
first line. E.g. <a class="reference external" href="https://docs.gammapy.org/0.11/api/gammapy.maps.WcsGeom.html#gammapy.maps.WcsGeom.region_mask">gammapy.maps.WcsGeom.region_mask</a> would start like this:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">region_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
    <span class="n">region</span> <span class="o">=</span> <span class="n">make_pixel_region</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
    <span class="c1"># do computation, knowing region is a PixelRegion object</span>
</pre></div>
</div>
<p>We suggest to start by implementing these two helper functions in
<code class="docutils literal notranslate"><span class="pre">gammapy/utils/regions.py</span></code> and to use it internally, but not expose it as part
of the public API via the Gammapy docs. Once this is done, we would open an
issue in <code class="docutils literal notranslate"><span class="pre">astropy-regions</span></code> asking whether inclusion there is welcome. This
might or might not be the case, because <code class="docutils literal notranslate"><span class="pre">make_region</span></code> is basically a
one-liner, and is DS9 format specific, whereas <code class="docutils literal notranslate"><span class="pre">astropy-regions</span></code> supports
other region formats as well. Based on the outcome of this discussion, we would
then either move <code class="docutils literal notranslate"><span class="pre">gammapy/utils/regions.py</span></code> to <code class="docutils literal notranslate"><span class="pre">astropy-regions</span></code>, or expose
it as part of the public Gammapy API in the docs, since users might want to call
them directly in their scripts or analysis codes that build on Gammapy.</p>
<p>We note that this means that we commit to support DS9 region strings as part of
the Gammapy API. Many users will use this feature, so changing to something else
would break user scripts. If we add this now, there are still a few months to
gather user feedback, and to possibly add as similar <code class="docutils literal notranslate"><span class="pre">make_sky_coord</span></code> helper
function throughout Gammapy and to consider how the format there compares with
the regions format. There is also the <a class="reference external" href="https://gamma-astro-data-formats.readthedocs.io/en/latest/skymaps/healpix/index.html#healpix-region-string">HEALPix region string</a> format in the
HEALPix map spec and support in <code class="docutils literal notranslate"><span class="pre">gammapy.maps</span></code>; ideally this format wouldn’t
exist, but avoiding it probably isn’t possible, since it includes the
<code class="docutils literal notranslate"><span class="pre">DISK_INC</span></code> and <code class="docutils literal notranslate"><span class="pre">HPX_PIXEL</span></code> regions cannot be represented in the DS9 or any
other existing region format. So at this time, there are no plans to improve or
unify that region format.</p>
<p>We propose to change the current <a class="reference external" href="https://docs.gammapy.org/0.11/api/gammapy.maps.WcsGeom.html#gammapy.maps.WcsGeom.region_mask">gammapy.maps.WcsGeom.region_mask</a> input (and
everywhere else) from a list of regions, to a single region. The same effect of
a list of regions (meaning “union”) can be achieved by creating a <a class="reference external" href="https://astropy-regions.readthedocs.io/en/latest/compound.html">Compound
region</a>. That should be as efficient computationally, and more flexible (e.g.
one could also do “intersection” in the region definition). It might be useful
to add a factory function in <code class="docutils literal notranslate"><span class="pre">astropy-regions</span></code> that makes the creation of such
compound regions a bit simpler.</p>
</section>
<section id="sky-and-pixel-regions">
<h3>Sky and pixel regions<a class="headerlink" href="#sky-and-pixel-regions" title="Permalink to this headline">#</a></h3>
<p>As already explained in the <a class="reference internal" href="#introduction">Introduction</a> above, there are projection-related
issues when it comes to defining the basic operations for sky regions like
<code class="docutils literal notranslate"><span class="pre">contains</span></code>, <code class="docutils literal notranslate"><span class="pre">to_pixel</span></code> or <code class="docutils literal notranslate"><span class="pre">plot</span></code>. Currently <code class="docutils literal notranslate"><span class="pre">contains</span></code> and <code class="docutils literal notranslate"><span class="pre">plot</span></code>
methods simply aren’t defined for <code class="docutils literal notranslate"><span class="pre">SkyRegion</span></code>, and for <code class="docutils literal notranslate"><span class="pre">to_pixel</span></code> only the
local pixel scale approximation method is implemented.</p>
<p>This could be improved in <code class="docutils literal notranslate"><span class="pre">astropy-regions</span></code>:</p>
<ul class="simple">
<li><p>Implement contains for <code class="docutils literal notranslate"><span class="pre">PolygonSkyRegion</span></code> (see <a class="reference external" href="https://github.com/astropy/regions/issues/46">astropy-regions GH 46</a>)</p></li>
<li><p>Is is possible to define <code class="docutils literal notranslate"><span class="pre">RectangleSkyRegion.contains</span></code>
without a WCS (i.e. to compute corners from data members)?</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">SkyRegion.plot</span></code> (see <a class="reference external" href="https://github.com/astropy/regions/pull/221">astropy-regions GH 221</a>)?</p></li>
<li><p>Add generic <code class="docutils literal notranslate"><span class="pre">SkyRegion.contains</span></code> using a local TAN or CAR projection
with reference point at the region center, to allow use without a WCS?</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">SkyRegion.to_polygon</span></code>, try to be consistent with plot and contains.</p></li>
</ul>
<p>Having improved support for sky regions would make it convenient to do some
things without requiring a WCS. Especially for circle and polygon, it can be
useful to filter positions from an observation or event list, and it is possible
and common to do this. In Gammapy we currently have  <a class="reference external" href="https://docs.gammapy.org/0.11/api/gammapy.catalog.select_sky_box.html">select_sky_box</a>,
<a class="reference external" href="https://docs.gammapy.org/0.11/api/gammapy.catalog.select_sky_circle.html">select_sky_circle</a> and <a class="reference external" href="https://docs.gammapy.org/0.11/api/gammapy.catalog.skycoord_from_table.html">skycoord_from_table</a> which do this in an ad-hoc way.
They are called from <a class="reference external" href="https://docs.gammapy.org/0.11/api/gammapy.data.EventList.html">gammapy.data.EventList</a>, <a class="reference external" href="https://docs.gammapy.org/0.11/api/gammapy.data.ObservationTable.html">gammapy.data.ObservationTable</a>
and <a class="reference external" href="https://docs.gammapy.org/0.11/api/gammapy.catalog.SourceCatalog.html">gammapy.catalog.SourceCatalog</a> which each are a wrapper or subclass of an
<a class="reference external" href="https://docs.astropy.org/en/latest/api/astropy.table.Table.html#astropy.table.Table" title="(in Astropy v5.2)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">astropy.table.Table</span></code></a>.</p>
<p>We propose to replace those functions and methods with a <code class="docutils literal notranslate"><span class="pre">select_region</span></code>
method, which for now requires a WCS to be passed on call.</p>
<p>In the future, if <code class="docutils literal notranslate"><span class="pre">astropy-healpix</span></code> sky region methods improve, passing a
<code class="docutils literal notranslate"><span class="pre">WCS</span></code> might no longer be needed. Depending on the details of how
<code class="docutils literal notranslate"><span class="pre">SkyRegion.contains</span></code> is defined, this change might or might not be backward
compatible for Gammapy users. So ideally, this work should be done soon, but it
is better discussed in the <code class="docutils literal notranslate"><span class="pre">astropy-healpix</span></code> issue tracker, not this Gammapy
PIG.</p>
</section>
<section id="rotated-regions">
<h3>Rotated regions<a class="headerlink" href="#rotated-regions" title="Permalink to this headline">#</a></h3>
<p>Rotated regions are used for background estimation in 1D spectral analysis in
gamma-ray astronomy (see <a class="reference internal" href="../../user-guide/references.html#berge2007" id="id1"><span>[Berge2007]</span></a>). The rotation is done around the pointing
position of the IACT telescope array. This method is also called “reflected
regions”, but really that’s a bad name, reflecting would only give one region on
the other side; what is done is rotating the regions.</p>
<p>In Gammapy, rotated regions are implemented in
<code class="docutils literal notranslate"><span class="pre">gammapy/background/reflected.py</span></code>. This is one of the most complex pieces of
code in Gammapy, because it was started before <code class="docutils literal notranslate"><span class="pre">astropy.coordinates</span></code> or
<code class="docutils literal notranslate"><span class="pre">astropy-regions</span></code> existed and then adapted many times, never achieving a clean
design and implementation until now. The problem was that <code class="docutils literal notranslate"><span class="pre">astropy-region</span></code>
objects didn’t support a rotate operation, and also their representation is such
that it’s not clear how to compute and represent e.g. a rotated
<code class="docutils literal notranslate"><span class="pre">RectangleSkyRegion</span></code> (see discussion of ambiguity in <code class="docutils literal notranslate"><span class="pre">SkyRegion.contains</span></code>
above). Also, the current code tried to handle the case with and without having
an exclusion mask and a WCS.</p>
<p>A recent attempt to improve our rotated regions code is <a class="reference external" href="https://github.com/gammapy/gammapy/pull/2089">GH 2089</a>, which shows
that it is difficult to to in a clean way without having a <code class="docutils literal notranslate"><span class="pre">Region.rotate</span></code>
method, because if-else and specific case handling is needed for the operation.</p>
<p>We propose to add a <code class="docutils literal notranslate"><span class="pre">PixelRegion.rotate(center,</span> <span class="pre">angle)</span></code> method for all regions
in <code class="docutils literal notranslate"><span class="pre">astropy-regions</span></code> (or all that can be represented again as a pixel region
object after rotating), and to only handle the case of pixel regions and a given
exclusion mask and WCS in <code class="docutils literal notranslate"><span class="pre">reflected.py</span></code>. For convenience, a dummy WCS as a
local TAN projection to the pointing position is used, if the user doesn’t need
of have an exclusion mask, as is already done in the current code. This is a
common case e.g. for isolated point sources like AGN, where the rotated regions
method is most commonly used.</p>
<p>One complication is that in the current code, to have fewer off test regions,
the algorithm takes a large step <code class="docutils literal notranslate"><span class="pre">arctan(2*radius/offset)</span></code> at the start and
after placing an off region. This requires a “radius”, which is is not available
for regions of a complex shape. We propose that this optimisation is only left
for the circle case (which already has a specialised fast algorithm anyways
using a distance mask), and for other regions for now the normal thing is done
to test all positions in small angle increments.</p>
</section>
<section id="images-and-masks">
<h3>Images and masks<a class="headerlink" href="#images-and-masks" title="Permalink to this headline">#</a></h3>
<p>Often regions are used to analyse images, and usually this happens via binary
masks (with <code class="docutils literal notranslate"><span class="pre">False</span></code> for “outside” and <code class="docutils literal notranslate"><span class="pre">True</span></code> for “inside”), or in some cases
integer label images (with 0 for “outside”, 1 for “in region 1”, 2 for “in
region 2” and N for “in region N”). This is used in Gammapy, but also in
<code class="docutils literal notranslate"><span class="pre">scipy.ndimage</span></code>, <code class="docutils literal notranslate"><span class="pre">scikit-image</span></code>, <code class="docutils literal notranslate"><span class="pre">photutils</span></code> and other packages.</p>
<p>We leave the description of the details how we work with images and masks in
Gammapy as future work. This could be done in another PIG, or just directly by
improving the Gammapy code and documentation.</p>
<p>There are open issues already discussing when to use <code class="docutils literal notranslate"><span class="pre">bool</span></code> or <code class="docutils literal notranslate"><span class="pre">int</span></code> arrays,
and a lot of code in <code class="docutils literal notranslate"><span class="pre">gammapy.image</span></code> (especially <code class="docutils literal notranslate"><span class="pre">gammapy/image/measure.py</span></code>
and <code class="docutils literal notranslate"><span class="pre">gammapy/image/profile.py</span></code>) should either be removed from Gammapy,
replaced by documentation examples, or improved to in some cases used regions.
This is not high priority and a separate task, since this functionality isn’t
used anywhere else in Gammapy.</p>
</section>
</section>
<section id="outlook">
<h2>Outlook<a class="headerlink" href="#outlook" title="Permalink to this headline">#</a></h2>
<p>This PIG only describes some short-term improvements to spatial regions.
Long-term, we might want to develop a more general solution for regions that
also includes non-spatial regions, e.g. spectral regions or time regions.</p>
<p>Just to mention what we have at the moment: spectral “regions” are handled via
<code class="docutils literal notranslate"><span class="pre">energy_bounds</span></code> or <code class="docutils literal notranslate"><span class="pre">(energy_min,</span> <span class="pre">energy_max)</span></code> in a not very consistent way.
We could look towards the Astropy <a class="reference external" href="https://specutils.readthedocs.io">specutils</a> package and the
<a class="reference external" href="https://specutils.readthedocs.io/en/latest/spectral_regions.html">specutils.SpectralRegion</a> object as an example how to implement spectral
regions. Currently there is plan to integrate <code class="docutils literal notranslate"><span class="pre">astropy-regions</span></code> and
<code class="docutils literal notranslate"><span class="pre">specutils</span></code>, <a class="reference external" href="https://github.com/astropy/regions/issues/228">astropy-regions GH 228</a> has been opened for discussion.</p>
<p>Supporting an energy-dependent maximum field of view radius selection, or a
field-of-view dependent safe energy offset might be a motivation to couple
spatial and spectral region, possibly supported via <code class="docutils literal notranslate"><span class="pre">gammapy.maps</span></code>.</p>
<p>For time regions we currently often have <code class="docutils literal notranslate"><span class="pre">(time_min,</span> <span class="pre">time_max)</span></code> in the API,
and we have the <a class="reference external" href="https://docs.gammapy.org/0.11/api/gammapy.data.GTI.html">gammapy.data.GTI</a> class to represent multiple intervals. It’s
not clear if this needs to be changed or wrapped somehow into a “time region”,
or if there are any use cases to couple time with the spatial and spectral
regions, e.g. for a time-dependent safe energy threshold or user analysis
option.</p>
<p>There is an issue <a class="reference external" href="https://github.com/gammapy/gammapy/issues/1805">GH 1805</a> “Introduce RegionGeom and RegionNDMap?” with first
thoughts in this direction. Discussion or working out a solution for that is
beyond the scope of this PIG.</p>
<p>In the HESS software, there is a region class that wraps a mask, and that is
sometimes useful, specifically because in the HESS software exclusion regions
are region objects, sometimes compound with a mask region and other regions like
circles. It’s clearly an option, easy to implement as a <code class="docutils literal notranslate"><span class="pre">SkyRegion</span></code> sub-class.
But also causes problems, especially when it comes to serialisation. Thoughts?
I’m OK to not add this for now, and just use <code class="docutils literal notranslate"><span class="pre">Map</span></code> objects for exclusion
masks, and require that users create that before using Gammapy, in case they
e.g. have a list of circles or whatever they want to use as exclusion region.</p>
</section>
<section id="task-list">
<h2>Task list<a class="headerlink" href="#task-list" title="Permalink to this headline">#</a></h2>
<p>We propose to implement this PIG though a series of small pull requests. Some are
dependent on others, but for many also the order doesn’t matter and overall the
amount of work is limited.</p>
<ul class="simple">
<li><p>Add region copy method, needed for region rotate (see <a class="reference external" href="https://github.com/astropy/regions/issues/266">astropy-regions GH 266</a>)</p></li>
<li><p>Add region rotate method (see <a class="reference external" href="https://github.com/astropy/regions/issues/265">astropy-regions GH 265</a> and <a class="reference internal" href="#rotated-regions">Rotated regions</a> above)</p></li>
<li><p>Release <code class="docutils literal notranslate"><span class="pre">astropy-regions</span></code> v0.4, then bump Gammapy dependency to that version.</p></li>
<li><p>Improve rotated region code and tests and docs in Gammapy.
This could mean a rebase and continuation of <a class="reference external" href="https://github.com/gammapy/gammapy/pull/2089">GH 2089</a>, or closing that and
re-starting from master, copying over the useful parts or cherry-picking
useful commits from that branch.</p></li>
</ul>
<p>Other tasks, mostly independent from the previous ones, can happen in any order:</p>
<ul class="simple">
<li><p>Add <code class="docutils literal notranslate"><span class="pre">gammapy/utils/regions.py</span></code> with two helper functions. See <a class="reference internal" href="#region-arguments">Region arguments</a> above.</p></li>
<li><p>Use the helper functions throughout Gammapy. Should be 5-10 cases, could be
several PRs. See <a class="reference internal" href="#region-arguments">Region arguments</a> above.</p></li>
<li><p>Replace sky circle and box select with generic region select (see <a class="reference internal" href="#sky-and-pixel-regions">Sky and
pixel regions</a>, resolves <a class="reference external" href="https://github.com/gammapy/gammapy/issues/1172">GH 1172</a>)</p></li>
</ul>
<p>Beyond those core tasks that really should be done for Gammapy v0.13, further
improvements in <code class="docutils literal notranslate"><span class="pre">astropy-healpix</span></code> and Gammapy should be done, but are lower
priority:</p>
<ul class="simple">
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">SkyRegion.contains(point)</span></code> (see <a class="reference internal" href="#sky-and-pixel-regions">Sky and pixel regions</a> above)</p></li>
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">SkyRegion.plot</span></code> (see <a class="reference internal" href="#sky-and-pixel-regions">Sky and pixel regions</a> above)</p></li>
<li><p>Review and improve region-related tests, especially for complicated edge lon = 0 / 360 and the poles.</p></li>
<li><p>Review and improve region-related end-user docs. Possibly add a dedicated tutorial notebook.</p></li>
<li><p>“Support region_mask for multi-resolution maps” (<a class="reference external" href="https://github.com/gammapy/gammapy/issues/1715">GH 1715</a>)</p></li>
<li><p>“HPX up/down sample issue with partial skymaps” (<a class="reference external" href="https://github.com/gammapy/gammapy/issues/1445">GH 1445</a>)</p></li>
<li><p>“Introduce RegionGeom and RegionNDMap?” (<a class="reference external" href="https://github.com/gammapy/gammapy/issues/1805">GH 1805</a>)</p></li>
</ul>
</section>
<section id="alternatives">
<h2>Alternatives<a class="headerlink" href="#alternatives" title="Permalink to this headline">#</a></h2>
<p>As mentioned in <a class="reference internal" href="#sky-and-pixel-regions">Sky and pixel regions</a> and <a class="reference internal" href="#rotated-regions">Rotated regions</a>, we could use
sky regions more instead of pixel regions, and restrict analysis to sky regions
where contains or rotate is well defined, namely circles and polygons, and to
polygonise other sky regions using some approximation, before passing them to
Gammapy.</p>
<p>In the future we might want a more general solution, and there’s the question
whether a mask-backed region should be added (see <a class="reference internal" href="#outlook">Outlook</a>)</p>
</section>
<section id="decision">
<h2>Decision<a class="headerlink" href="#decision" title="Permalink to this headline">#</a></h2>
<p>The PIG was discussed in <a class="reference external" href="https://github.com/gammapy/gammapy/pull/2129">GH 2129</a> and the weekly Gammapy developer calls. A
final review announced on the Gammapy and CC mailing list did not yield any
additional comments. Therefore the PIG was accepted on June 17, 2019.</p>
</section>
</section>


              </div>
              
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, The Gammapy developers.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>