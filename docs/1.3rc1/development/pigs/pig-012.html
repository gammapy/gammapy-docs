
<!DOCTYPE html>


<html lang="en" data-content_root="../../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>PIG 12 - High level interface &#8212; gammapy v1.3rc1</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=203afaf9" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../_static/documentation_options.js?v=e3e1e26b"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=30646c52"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'development/pigs/pig-012';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.0';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://docs.gammapy.org/stable/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '1.3rc1';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = false;
        </script>
    <script src="../../_static/matomo.js?v=52704cab"></script>
    <link rel="icon" href="../../_static/gammapy_logo.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="PIG 13 - Gammapy dependencies and distribution" href="pig-013.html" />
    <link rel="prev" title="PIG 11 - Light curves" href="pig-011.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="1.3rc1" />
    <meta name="docbuild:last-update" content="15 Nov 2024"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
    
    <img src="../../_static/gammapy_logo_nav.png" class="logo__image only-light" alt="gammapy v1.3rc1 - Home"/>
    <img src="../../_static/gammapy_logo_nav.png" class="logo__image only-dark pst-js-only" alt="gammapy v1.3rc1 - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../getting-started/index.html">
    Getting started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../user-guide/index.html">
    User guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api-reference/index.html">
    API reference
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    Developer guide
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../release-notes/index.html">
    Release notes
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/gammapy/gammapy" title="Github" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Github</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/gammapyST" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-square-x-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://gammapy.slack.com/" title="Slack" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-slack fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Slack</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../getting-started/index.html">
    Getting started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../user-guide/index.html">
    User guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api-reference/index.html">
    API reference
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    Developer guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../release-notes/index.html">
    Release notes
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/gammapy/gammapy" title="Github" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Github</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/gammapyST" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-square-x-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://gammapy.slack.com/" title="Slack" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-slack fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Slack</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../setup.html">Project setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dependencies.html">Dependencies</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">How to contribute to Gammapy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release.html">How to make a Gammapy release</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../doc_howto.html">Documentation How To</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_howto.html">Developer How To</a></li>
</ul>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">PIGs</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="pig-001.html">PIG 1 - PIG purpose and guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-002.html">PIG 2 - Organization of low level analysis code</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-003.html">PIG 3 - Plan for dropping Python 2.7 support</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-004.html">PIG 4 - Setup for tutorial notebooks and data</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-005.html">PIG 5 - Gammapy 1.0 roadmap</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-006.html">PIG 6 - CTA observation handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-007.html">PIG 7 - Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-008.html">PIG 8 - Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-009.html">PIG 9 - Event sampling</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-010.html">PIG 10 - Regions</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-011.html">PIG 11 - Light curves</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">PIG 12 - High level interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-013.html">PIG 13 - Gammapy dependencies and distribution</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-014.html">PIG 14 - Uncertainty estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-016.html">PIG 16 - Gammapy package structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-018.html">PIG 18 - Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-019.html">PIG 19 - Gammapy package structure follow up</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-020.html">PIG 20 - Global Model API</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-021.html">PIG 21 - Models improvements</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-022.html">PIG 22 - Unified flux estimators API</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-023.html">PIG 23 - Gammapy release cycle and version numbering</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-024.html">PIG 24 - Authorship policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-025.html">PIG 25 - Metadata container for Gammapy</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-026.html">PIG 26 - Model Priors API</a></li>
</ul>
</details></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Developer guide</a></li>
    
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">PIGs</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">PIG 12 - High level interface</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="pig-12-high-level-interface">
<span id="pig-012"></span><h1>PIG 12 - High level interface<a class="headerlink" href="#pig-12-high-level-interface" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>Author: José Enrique Ruiz, Christoph Deil, Axel Donath, Regis Terrier, Lars Mohrmann</p></li>
<li><p>Created: Jun 6, 2019</p></li>
<li><p>Accepted: Aug 19, 2019</p></li>
<li><p>Status: accepted</p></li>
<li><p>Discussion: <a class="reference external" href="https://github.com/gammapy/gammapy/pull/2219">GH 2219</a></p></li>
</ul>
<section id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Link to this heading">#</a></h2>
<p>The high level interface is one of the projects considered in the Gammapy
roadmap for Gammapy v1.0 (see <a class="reference internal" href="pig-003.html#pig-003"><span class="std std-ref">PIG 3 - Plan for dropping Python 2.7 support</span></a>). It should be easy to use and
allow users to do the most common analysis tasks and workflows quickly. It would
be built on top of the existing Gammapy code-base, first on it’s own, but likely
starting to develop it would inform improvements in code organisation throughout
Gammapy.</p>
<p>Achieving a stable high level interface should allow us to continue improving
the Gammapy code-base without breaking user-defined workflows or recipes made
that would have been made with this high level interface.</p>
<p>We propose to develop a high level interface Python API, similar to Fermipy or
HAP in HESS, based on a single <code class="docutils literal notranslate"><span class="pre">Analysis</span></code> class communicating with a set of
tool classes, and that supports config-file driven analysis of the main IACT
source analysis use cases.</p>
</section>
<section id="what-we-have">
<h2>What we have<a class="headerlink" href="#what-we-have" title="Link to this heading">#</a></h2>
<p>We have been using <a class="reference external" href="http://click.pocoo.org/">Click</a> to develop a very small set of tools for an
embryonic <a class="reference external" href="https://docs.gammapy.org/0.12/scripts/index.html">Gammapy command line interface</a>. Among the existing tools (<code class="docutils literal notranslate"><span class="pre">gammapy</span>
<span class="pre">image</span></code>, <code class="docutils literal notranslate"><span class="pre">gammapy</span> <span class="pre">info</span></code>, <code class="docutils literal notranslate"><span class="pre">gammapy</span> <span class="pre">download</span></code>, <code class="docutils literal notranslate"><span class="pre">gammapy</span> <span class="pre">jupyter</span></code>), only
<a class="reference external" href="https://docs.gammapy.org/0.12/scripts/index.html#example">gammapy image</a> can be considered as potentially needed in a data analysis
process. It actually creates a counts image from an event-list file and an image
that serves as a reference geometry. Hence, we have a code set-up in
<code class="docutils literal notranslate"><span class="pre">gammapy.scripts</span></code>, that we will not use it for the moment to expose the
high level interface API, but to develop a very small set of specific command
line tools identified (i.e. perform long-time processing tasks, see <em>Command
line tools</em> section below)</p>
<p>We have a set of <a class="reference external" href="https://docs.gammapy.org/0.12/tutorials.html">Jupyter notebooks</a> as examples of tutorials and recipes
demonstrating the use of Gammapy. These notebooks are continuously tested and
are one of the pillars of the user documentation. We could check most of the use
cases are covered by the high level interface with the help of these notebooks.
We will have to translate most of them to use the high level interface, but we
could also use them as a basis for experimental automated workflows driven by
parametrized notebooks executed with  <a class="reference external" href="https://github.com/nteract/papermill/">papermill</a>. (see <em>Outlook</em> section
below) Moreover, some Python scripts have been added recently to perform
<a class="reference external" href="https://github.com/gammapy/gammapy-benchmarks">benchmarks</a> of Gammapy, surely we could rewrite some of all of these
benchmarks to use the high level interface.</p>
<p>We also have some <em>high level analysis</em> classes in the API that concatenate
several atomic actions and provide rough estimated results for more complex
processes. (i.e. <a class="reference external" href="https://docs.gammapy.org/0.12/api/gammapy.scripts.SpectrumAnalysisIACT.html">SpectrumAnalysisIACT</a>, <a class="reference external" href="https://docs.gammapy.org/0.12/api/gammapy.time.LightCurveEstimator.html">LightCurveEstimator</a>) These classes
would serve as a basis to design and prototype some of the tools of the
high level interface.</p>
</section>
<section id="proposal">
<h2>Proposal<a class="headerlink" href="#proposal" title="Link to this heading">#</a></h2>
<p>We will develop a high level interface Python API which uses a params-values
configuration file defined by the user. This API would be used in Python
scripts, notebooks or in IPython sessions to perform simple and most common IACT
analysis.</p>
<p>We see then two main options on how to use the high level interface API:</p>
<ul class="simple">
<li><p>Within an IPython session or notebook, mostly dealing with a manager object to perform specific tasks in an <strong>interactive</strong> analysis process</p></li>
<li><p>In a Python script or notebook, declaring the orchestration of the tasks with a manager object for an <strong>automated</strong> process</p></li>
</ul>
<p>This high level interface API is similar to what it is done in <a class="reference external" href="https://github.com/fermiPy/fermipy">Fermipy</a> or HAP
in HESS, including also the options to save and recover session states, as well
as serialization of intermediate data products and logging. It is flexible
enough to allow the user to work with the API at any stage of the analysis
process, and not only from the start to the very end or in automated process.</p>
<p><strong>Use cases</strong></p>
<p>The use cases covered are in the scope of a single analysis and model, not
parametrized variations in a multidimensional grid space of variables, and
within a single region (e.g. 10 deg region with 5 sources).</p>
<p>The main use cases for analysis to be covered are:</p>
<ul class="simple">
<li><p>3D map analysis</p></li>
<li><p>2D map analysis</p></li>
<li><p>1D spectrum analysis</p></li>
<li><p>Light curve estimation</p></li>
</ul>
<p>Including the main methods for data reduction, modeling and fitting:</p>
<ul class="simple">
<li><p>On vs on/off data reduction</p></li>
<li><p>Different background models</p></li>
<li><p>Joint vs stacked likelihood fitting</p></li>
<li><p>Diagnostics (residuals, significance, TS)</p></li>
<li><p>Spectral flux points</p></li>
</ul>
<p>Making a SED may be the final part of the analysis, as many SED methods require
the full model and all energy data.</p>
<p><strong>Configuration file</strong></p>
<p>The configuration file will be in YAML format exposing the parameters and values
needed for each one of the tasks involved in the analysis process. To generate
the config file, we could add a <code class="docutils literal notranslate"><span class="pre">gammapy</span> <span class="pre">analysis</span> <span class="pre">config</span></code> command line tool
which dumps the config file with all lines commented out, and the users can then
uncomment and fill in the parameters and values they care about. As an
alternative users could copy &amp; paste from a config file example in the docs. We
will develop a schema and validate / give good error messages on read.</p>
<p>We roughly sketch below an example of a prototype configuration file in YAML
format, just to illustrate how a structured schema could expose most of the
parameter/values needed in a data analysis process. The configuration file
should be explicit enough for the users to understand which parameters to edit
in order to define a specific configuration for an analysis session or workflow,
and should use units for quantities where it makes sense, e.g. “angle: 3 deg”
instead of “angle: 3”. The final schema for this configuration file will be
achieved iteratively during the development of the high level interface and
later on eventual improvements, also taking user feedback into account.</p>
<p>Prototype configuration file.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">analysis</span><span class="p">:</span>
<span class="w">    </span><span class="nt">process</span><span class="p">:</span>
<span class="w">        </span><span class="c1"># add options to allow either in-memory or disk-based processing</span>
<span class="w">        </span><span class="nt">out_folder</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="w">  </span><span class="c1"># default is current working directory</span>
<span class="w">        </span><span class="nt">store_per_obs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nv">true</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">false</span><span class="p p-Indicator">}</span>
<span class="w">    </span><span class="nt">reduce</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="s">&quot;1D,</span><span class="nv"> </span><span class="s">&quot;</span><span class="nv">3D&quot;</span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="nt">stacked</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nv">true</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">false</span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="nt">background</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="s">&quot;irf&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;reflected&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;ring&quot;</span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="nt">roi</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">max_offset</span>
<span class="w">        </span><span class="nt">exclusion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">exclusion.fits</span>
<span class="w">    </span><span class="nt">fit</span><span class="p">:</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">energy_min, energy_max</span>
<span class="w">    </span><span class="nt">logging</span><span class="p">:</span>
<span class="w">        </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">debug</span>

<span class="nt">grid</span><span class="p">:</span>
<span class="w">    </span><span class="nt">spatial</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">center, width, binsz</span>
<span class="w">    </span><span class="nt">energy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">min, max, nbins</span>
<span class="w">    </span><span class="nt">time</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">min, max</span>
<span class="w">    </span><span class="c1"># PSF RAD and EDISP MIGRA not exposed for now</span>
<span class="w">    </span><span class="c1"># Per-obs energy_safe and roi_max ?</span>

<span class="nt">observations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">data_store</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$GAMMAPY_DATA/cta-1dc/index/gps/</span>
<span class="w">    </span><span class="nt">ids</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">110380, 111140, 111159</span>
<span class="w">    </span><span class="nt">conesearch</span><span class="p">:</span>
<span class="w">        </span><span class="nt">ra</span><span class="p">:</span>
<span class="w">        </span><span class="nt">dec</span><span class="p">:</span>
<span class="w">        </span><span class="nt">radius</span><span class="p">:</span>
<span class="w">        </span><span class="nt">energy_min</span><span class="p">:</span>
<span class="w">        </span><span class="nt">energy_max</span><span class="p">:</span>
<span class="w">        </span><span class="nt">time_min</span><span class="p">:</span>
<span class="w">        </span><span class="nt">time_max</span><span class="p">:</span>

<span class="nt">model</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># Model configuration will mostly be designed in different PIG</span>
<span class="w">    </span><span class="nt">sources</span><span class="p">:</span>
<span class="w">        </span><span class="nt">source_1</span><span class="p">:</span>
<span class="w">            </span><span class="nt">spectrum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">powerlaw</span>
<span class="w">            </span><span class="nt">spatial</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">shell</span>
<span class="w">        </span><span class="nt">diffuse</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gal_diffuse.fits</span>
<span class="w">    </span><span class="nt">background</span><span class="p">:</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">IRF</span>
</pre></div>
</div>
<p><strong>API design</strong></p>
<p>The design of the high level interface API is driven by the use cases
considered, the different tools (tasks) identified and their responsibilities,
as well as the need of a main <code class="docutils literal notranslate"><span class="pre">Analysis</span></code> session object that drives and
orchestrates internally the different tools involved, their inputs and products.
The <code class="docutils literal notranslate"><span class="pre">Analysis</span></code> session object will be initialized with a configuration file
(see <em>prototype configuration file</em> above) and will be the responsible to
instantiate and run the different tools classes (see <em>session workflow</em> below).
The tools are middle  management agents (e.g. MapMaker, ReflectedBgEstimator,
…) responsible to perform the different tasks identified in the use cases
covered.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Analysis</span></code> session object will provide access to every object involved and
data structure produced during the session. <code class="docutils literal notranslate"><span class="pre">Analysis</span></code> methods calls will
produce and modify datasets (i.e. models, maps,..), but in between method calls
advanced users can do a lot of custom processing by their own with scripting
using the Gammapy Python toolbox.</p>
<p>The code of the <code class="docutils literal notranslate"><span class="pre">Analysis</span></code> class as well as any other eventual class needed
will be placed in <code class="docutils literal notranslate"><span class="pre">gammapy.scripts</span></code>. This module will contain also the set of
different command line tools provided, where some small cleaning and refactoring
may be needed (i.e. remove <code class="docutils literal notranslate"><span class="pre">gammapy</span> <span class="pre">image</span></code> command line tool)</p>
<p><strong>Serialisation</strong></p>
<p>There will be the possibility to save and recover session states with their
associated data products. The user could also choose in the configuration file,
with the help of a boolean parameter, to work with serialised intermediate
products delivered by the tools instead of in memory. The state serialisation
will be a mix of YAML (i.e. models, state) and FITS files (i.e. maps), where the
delegated tools should know how to serialise and read themselves. The solution
to address serialization of different datasets by the different tools is not in
the scope of this PIG.</p>
<p><strong>Session workflow</strong></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ mkdir analysis
$ cd analysis
$ edit gammapy_analysis_config.yaml
</pre></div>
</div>
<p>Then the user would type <code class="docutils literal notranslate"><span class="pre">ipython</span></code>, <code class="docutils literal notranslate"><span class="pre">juypter</span> <span class="pre">notebook</span></code> or write a script
with the code below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gammapy.analysis</span> <span class="kn">import</span> <span class="n">Analysis</span>

<span class="n">analysis</span> <span class="o">=</span> <span class="n">Analysis</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

<span class="n">analysis</span><span class="o">.</span><span class="n">select_observations</span><span class="p">()</span>
<span class="c1"># Select observations using the parameters defined in the configuration file.</span>

<span class="n">analysis</span><span class="o">.</span><span class="n">reduce_data</span><span class="p">()</span>  <span class="c1"># often slow, can be hours</span>
<span class="c1"># If the user wants they can save all results from data reduction and re-start later.</span>
<span class="c1"># This stores config, datasets, ... all the analysis class state.</span>
<span class="c1"># analysis.write()</span>
<span class="c1"># analysis = Analysis.read()</span>

<span class="n">analysis</span><span class="o">.</span><span class="n">optimise</span><span class="p">()</span>  <span class="c1"># often slow, can be hours</span>
<span class="c1"># Again, we could write and read, do the slow things only once.</span>
<span class="c1"># e.g. supervisor comes in and asks about significance of some model component or whatever.</span>
<span class="c1"># analysis.write()</span>
<span class="c1"># analysis = Analysis.read()</span>

<span class="c1"># Since anything is accessible from the Analysis object</span>
<span class="c1"># many advanced use cases can be done with the Analysis API.</span>
<span class="n">analysis</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="s2">&quot;source_42&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="c1"># Should we need energy_binning for the SED points in config or only here?</span>
<span class="n">sed</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">spectral_points</span><span class="p">(</span><span class="s2">&quot;source_42&quot;</span><span class="p">,</span> <span class="n">energy_binning</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Command line tools</strong></p>
<p>In addition to <code class="docutils literal notranslate"><span class="pre">gammapy</span> <span class="pre">analysis</span> <span class="pre">config</span></code>, we will have a <code class="docutils literal notranslate"><span class="pre">gammapy</span> <span class="pre">analysis</span>
<span class="pre">data_reduction</span></code> and a <code class="docutils literal notranslate"><span class="pre">gammapy</span> <span class="pre">analysis</span> <span class="pre">optimise</span></code> which perform the long
processing tasks from the terminal outside an ipython session or jupyter
notebook, using all the information from the config file and/or saved state.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">gammapy</span> <span class="pre">analysis</span> <span class="pre">config</span></code>: dumps a template configuration file</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gammapy</span> <span class="pre">analysis</span> <span class="pre">data_reduction</span></code>: performs a data reduction process</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gammapy</span> <span class="pre">analysis</span> <span class="pre">optimise</span></code>: performs a model fitting process</p></li>
</ul>
</section>
<section id="outlook">
<h2>Outlook<a class="headerlink" href="#outlook" title="Link to this heading">#</a></h2>
<p>Some of the use cases not covered by this high level interface API are the
following:</p>
<ul class="simple">
<li><p>Generation of simulated events and/or counts</p></li>
<li><p>Iterative source detection methods</p></li>
<li><p>Complex or memory eager processing on lightcurves</p></li>
</ul>
<p>These use cases can be actually addressed using Gammapy as a Python toolbox,
though in the near future some of them could be incorporated progressively to
the high level interface. For example, making a lightcurve could be part of one
Analysis (like it is in Fermi), or could be done at higher level, creating
Analysis instances and running them for each time bin. This exercise of pro/con
is left to the <a class="reference internal" href="pig-006.html#pig-006"><span class="std std-ref">PIG 6 - CTA observation handling</span></a>. We could expect that restructuring all of Gammapy
to be tools based with good tool chains and config handling will be eventually
achieved after a certain time if we define a solid high level interface API.</p>
<p>We could explore the use of <a class="reference external" href="https://github.com/nteract/papermill/">papermill</a> to run workflows defined in a notebook
using the values of the parameter-value configuration file defined for the
high level interface API. The notebooks could be provided as skeleton-templates
for specific use cases or built by the user. This option would provide a
rich-text formatted report of the analysis process execution.</p>
<p>One extra dimension that arises from the development of this high level
interface API is the possibility to capture data provenance as structured logs
of tasks executions in a session or in an automated workflow. Capturing
provenance in this way is more useful if we also provide the means for it to be
easily queried and inspected in multiple ways, allowing also forensic studies of
the research analysis process as well as improving reproducibility and reuse by
the community. This work will be the scope of another PIG.</p>
</section>
<section id="alternatives">
<h2>Alternatives<a class="headerlink" href="#alternatives" title="Link to this heading">#</a></h2>
<p>A different approach to this high level interface API is that of command line
tools executed from the terminal, what  <a class="reference external" href="https://fermi.gsfc.nasa.gov/ssc/data/analysis/scitools/overview.html">Fermitools</a> and <a class="reference external" href="http://cta.irap.omp.eu/ctools">ctools</a> do, where
each tool is simple/atomic enough to allow users to inspect the output results
before taking a decision on how to run and set the parameter values for the next
tool. A similar approach could be done with the Gammapy high level interface
API, but inside a notebook or IPython session.</p>
<p>Concerning the code implementation, <a class="reference external" href="https://ctapipe.readthedocs.io/en/latest/api-reference/tools/index.html">ctapipe tools</a> provides a solution based
on Python traitlets, acting as an extensible framework to easily transform
Python classes into command line tools. We will explore the adoption of this
approach after Gammapy v1.0 since it requires a considerable effort on
refactoring of the Gammapy code-base.</p>
<p>Another config-file based solution is what is implemented in <a class="reference external" href="https://enrico.readthedocs.io/en/latest/configfile.html">Enrico</a>. It
performs basic orchestrated analysis workflows using a set of input parameters
that the user provides via a configuration file. The user may be guided in the
declaration of values for the config file using an assistant command line tool
for config-file building, which asks for parameter values providing also
defaults. This is done in <a class="reference external" href="https://enrico.readthedocs.io/en/latest/configfile.html">Enrico</a> with  <code class="docutils literal notranslate"><span class="pre">enrico_config</span></code> and <code class="docutils literal notranslate"><span class="pre">enrico_xml</span></code>,
where each workflow is set-up and then run with its own command line tool. In
our case, we define the workflow steps in a simple Python script and declare
parameter-value pairs in a configuration file. The Python script is then
executed to run the workflow.</p>
<p>Also Python scripts and/or notebook files could be generated with an assistant
command line tool. Then, the user could edit and tweak the config files, scripts
or notebooks. There isn’t much precedence for this workflow in science, but a
lot of dev-ops and programming tools work like that, it is a standard technique.
One random example of such a tool is the <a class="reference external" href="https://cli.angular.io/">Angular CLI</a>, or <a class="reference external" href="https://cookiecutter.readthedocs.io">cookiecutter</a>.</p>
</section>
<section id="task-list">
<h2>Task list<a class="headerlink" href="#task-list" title="Link to this heading">#</a></h2>
<p>Required for Gammapy v1.0</p>
<ul class="simple">
<li><p>Prototype for a manager class, agents, tools, etc.</p></li>
<li><p>Define a syntax for the declaration of parameter-value pairs needed for all tools in the analysis process.</p></li>
<li><p>Develop the session manager class responsible to drive the orchestration of tools in the analysis process.</p></li>
<li><p>Develop the tools classes responsible to perform each one of the tasks in the analysis process.</p></li>
<li><p>Design use cases and/or choose among the existing tutorials or benchmarks those that may be translated into high level interface notebooks.</p></li>
<li><p>Provide notebooks using the high level interface API for each of the chosen tutorials, benchmarks and/or use cases identified.</p></li>
<li><p>Add documentation for the high level interface API and clean the list of documentation tutorials, making a distinct separation among those using Gammapy as a high level interface API and those using Gammapy as a Python toolbox.</p></li>
</ul>
<p>Extra features (command line tools)</p>
<ul class="simple">
<li><p>Develop the small set of helpers command line tools described above.</p></li>
<li><p>Develop an assistant command line tool that produces Python scripts and/or notebooks using the high level interface API.</p></li>
<li><p>Cleaning and refactoring of <code class="docutils literal notranslate"><span class="pre">gammapy.scripts</span></code> module to remove old and unused command line tools.</p></li>
<li><p>Cleaning present documentation on <code class="docutils literal notranslate"><span class="pre">gammapy.scripts</span></code> to transform into documentation of helper command line tools.</p></li>
</ul>
</section>
<section id="decision">
<h2>Decision<a class="headerlink" href="#decision" title="Link to this heading">#</a></h2>
<p>The PIG has benn discussed at the Gammapy coding sprint in July 2019. A final
review announced on the Gammapy and CC mailing lists provided additional
comments that were addressed in <a class="reference external" href="https://github.com/gammapy/gammapy/pull/2219">GH 2219</a>. The PIG was accepted on August 19,
2019.</p>
</section>
</section>


                </article>
              
              
              
              
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#abstract">Abstract</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-we-have">What we have</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#proposal">Proposal</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlook">Outlook</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#alternatives">Alternatives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#task-list">Task list</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decision">Decision</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../../_sources/development/pigs/pig-012.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, The Gammapy developers.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
    
     <a href="https://gammapy.org/DataPrivacy.html">Data Privacy.</a>
</div>
      
    </div>
  
  
    <div class="footer-items__center">
      
        <div class="footer-item"><p class="last-updated">
  Last updated on 15 Nov 2024.
  <br/>
</p></div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    <br/>
  </p>
</div>
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.0.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>