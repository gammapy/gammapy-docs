
<!DOCTYPE html>


<html lang="en" data-content_root="../../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>PIG 14 - Uncertainty estimation &#8212; gammapy v1.3rc1</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=203afaf9" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../_static/documentation_options.js?v=e3e1e26b"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=30646c52"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'development/pigs/pig-014';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.0';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://docs.gammapy.org/stable/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '1.3rc1';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = false;
        </script>
    <script src="../../_static/matomo.js?v=52704cab"></script>
    <link rel="icon" href="../../_static/gammapy_logo.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="PIG 16 - Gammapy package structure" href="pig-016.html" />
    <link rel="prev" title="PIG 13 - Gammapy dependencies and distribution" href="pig-013.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="1.3rc1" />
    <meta name="docbuild:last-update" content="15 Nov 2024"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
    
    <img src="../../_static/gammapy_logo_nav.png" class="logo__image only-light" alt="gammapy v1.3rc1 - Home"/>
    <img src="../../_static/gammapy_logo_nav.png" class="logo__image only-dark pst-js-only" alt="gammapy v1.3rc1 - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../getting-started/index.html">
    Getting started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../user-guide/index.html">
    User guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api-reference/index.html">
    API reference
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    Developer guide
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../release-notes/index.html">
    Release notes
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/gammapy/gammapy" title="Github" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Github</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/gammapyST" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-square-x-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://gammapy.slack.com/" title="Slack" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-slack fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Slack</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../getting-started/index.html">
    Getting started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../user-guide/index.html">
    User guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api-reference/index.html">
    API reference
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    Developer guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../release-notes/index.html">
    Release notes
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/gammapy/gammapy" title="Github" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Github</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/gammapyST" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-square-x-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://gammapy.slack.com/" title="Slack" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-slack fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Slack</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../setup.html">Project setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dependencies.html">Dependencies</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">How to contribute to Gammapy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release.html">How to make a Gammapy release</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../doc_howto.html">Documentation How To</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_howto.html">Developer How To</a></li>
</ul>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">PIGs</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="pig-001.html">PIG 1 - PIG purpose and guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-002.html">PIG 2 - Organization of low level analysis code</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-003.html">PIG 3 - Plan for dropping Python 2.7 support</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-004.html">PIG 4 - Setup for tutorial notebooks and data</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-005.html">PIG 5 - Gammapy 1.0 roadmap</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-006.html">PIG 6 - CTA observation handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-007.html">PIG 7 - Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-008.html">PIG 8 - Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-009.html">PIG 9 - Event sampling</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-010.html">PIG 10 - Regions</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-011.html">PIG 11 - Light curves</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-012.html">PIG 12 - High level interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-013.html">PIG 13 - Gammapy dependencies and distribution</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">PIG 14 - Uncertainty estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-016.html">PIG 16 - Gammapy package structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-018.html">PIG 18 - Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-019.html">PIG 19 - Gammapy package structure follow up</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-020.html">PIG 20 - Global Model API</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-021.html">PIG 21 - Models improvements</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-022.html">PIG 22 - Unified flux estimators API</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-023.html">PIG 23 - Gammapy release cycle and version numbering</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-024.html">PIG 24 - Authorship policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-025.html">PIG 25 - Metadata container for Gammapy</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-026.html">PIG 26 - Model Priors API</a></li>
</ul>
</details></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Developer guide</a></li>
    
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">PIGs</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">PIG 14 - Uncertainty estimation</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="pig-14-uncertainty-estimation">
<span id="pig-014"></span><h1>PIG 14 - Uncertainty estimation<a class="headerlink" href="#pig-14-uncertainty-estimation" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>Author: Christoph Deil, Axel Donath, Quentin Rémy, Fabio Acero</p></li>
<li><p>Created: June 20, 2019</p></li>
<li><p>Accepted: Nov 19, 2019</p></li>
<li><p>Status: accepted</p></li>
<li><p>Discussion: <a class="reference external" href="https://github.com/gammapy/gammapy/pull/2255">GH 2255</a></p></li>
</ul>
<section id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Link to this heading">#</a></h2>
<p>Currently Gammapy uses the <a class="reference external" href="http://pythonhosted.org/uncertainties/">uncertainties</a> package to do error propagation for
differential and integral flux of spectral models, e.g. to compute spectral
model error bands. This is cumbersome since <code class="docutils literal notranslate"><span class="pre">uncertainties</span></code> doesn’t support
<code class="docutils literal notranslate"><span class="pre">astropy.units.Quantity</span></code> (which we currently use in spectral model
evaluation), and doesn’t work at all for some spectral models (e.g. EBL
absorption and Naima), since <code class="docutils literal notranslate"><span class="pre">uncertainties</span></code> uses autodiff and needs explicit
support for any Numpy, Scipy, Astropy, … function involved.</p>
<p>We propose to replace this with a custom uncertainty propagation implementation
using finite differences. This will be less precise and slower than
<code class="docutils literal notranslate"><span class="pre">uncertainties</span></code>, but it will work for any derived quantity and code that we
call, and any spectral model.</p>
<p>We also propose to add support for a second method to propagate uncertainty from
fit parameters to derived quantities, based on parameter samples. This is the
standard technique in MCMC Bayesian analyses, but it can be used as well for
normal likelihood analyses.</p>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>In Gammapy, <code class="docutils literal notranslate"><span class="pre">gammapy.modeling</span></code> and specifically the <code class="docutils literal notranslate"><span class="pre">gammapy.modeling.Fit</span></code>
class support likelihood fitting to determine best-fit parameters, and to obtain
a covariance matrix that represents parameter uncertainties and correlations.
Parameter standard errors are obtained as the square root of the elements on the
diagonal of the covariance matrix (see e.g. <a class="reference external" href="http://lmu.web.psi.ch/docu/manuals/software_manuals/minuit2/mnerror.pdf">The interpretation of errors</a>).
Asymmetric errors and confidence intervals can be obtained via likelihood
profile shape analysis, using methods on the <code class="docutils literal notranslate"><span class="pre">gammapy.modeling.Fit</span></code> class,
partially re-implementing, partially calling the methods available in Minuit or
Sherpa (see e.g. <a class="reference external" href="http://conference.scipy.org/proceedings/scipy2011/pdfs/brefsdal.pdf">Fitting and Estimating Parameter Confidence Limits with
Sherpa</a>).</p>
<p>However, often one is interested not directly in a model parameter, but instead
in a derived quantity that depends on multiple model parameters. Typical
examples are that users want to compute errors or confidence intervals on
quantities like differential or integral flux at or above certain energies, or
location or extension of sources, from spectral and spatial model fits.</p>
<p>Here we will discuss two standard techniques to compute such uncertaintes:</p>
<ol class="arabic simple">
<li><p>Differentials (see <a class="reference external" href="https://en.wikipedia.org/wiki/Propagation_of_uncertainty">Wikipedia - Propagation of uncertainty</a> or <a class="reference external" href="http://pythonhosted.org/uncertainties/">uncertainties</a>)</p></li>
<li><p>Monte carlo (MC) samples (see <a class="reference external" href="https://pypi.org/project/mcerp/">mcerp</a> or <a class="reference external" href="https://docs.astropy.org/en/stable/uncertainty/index.html">astropy.uncertainty</a>)</p></li>
</ol>
<p>If you’re not familiar with the techniques, here’s a few references:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://arxiv.org/pdf/1009.2755.pdf">Error estimation in astronomy - A guide</a></p></li>
<li><p><a class="reference external" href="https://arxiv.org/pdf/1411.5018.pdf">Frequentism and Bayesianism - A Python-driven Primer</a></p></li>
</ul>
<p>In Gammapy we currently use the <a class="reference external" href="http://pythonhosted.org/uncertainties/">uncertainties</a> package to propagate errors to
differential fluxes <code class="docutils literal notranslate"><span class="pre">spectral_model.evaluate_error</span></code> and integral fluxes
<code class="docutils literal notranslate"><span class="pre">spectral_model.integral_error</span></code>. The <code class="docutils literal notranslate"><span class="pre">evaluate_error</span></code> method is called for
an array of energies in <code class="docutils literal notranslate"><span class="pre">plot_error</span></code>, which is used to compute and plot
spectral model error bands (see e.g. the <a class="reference external" href="https://docs.gammapy.org/0.14/notebooks/sed_fitting_gammacat_fermi.html">SED fitting tutorial</a>) It is using
autodiff to compute differentials of derived quantities wrt. model parameters,
which is accurate and fast where it works. However, <code class="docutils literal notranslate"><span class="pre">uncertainties</span></code> doesn’t
support <code class="docutils literal notranslate"><span class="pre">astropy.units.Quantity</span></code>, making the current spectral model flux
evaluation very convoluted, and it doesn’t work at all for some spectral models,
namely non-analytical models like EBL absoption or Naima cosmic ray spectral
models, which has been a frequent complaint by users (see <a class="reference external" href="https://github.com/gammapy/gammapy/issues/1046">GH 1046</a>, <a class="reference external" href="https://github.com/gammapy/gammapy/issues/2007">GH
2007</a>, <a class="reference external" href="https://github.com/gammapy/gammapy/issues/2190">GH 2190</a>).</p>
<p>The MC sample method is most commonly used for Bayesian analysis, where the
model fit directly results in a sample set that represents the parameter
posterior probability distribution. A prototype example for that kind of
analysis has been implemented in the <a class="reference external" href="https://docs.gammapy.org/0.12/notebooks/mcmc_sampling.html">MCMC Gammapy tutorial</a> notebook. However,
the MC sample error propagation technique can be applied in classical
frequentist statistical analysis as well, if one considers it a numerical
technique to avoid having to compute differentials, and instead samples a
multivariate normal according to the best-fit parameters and covariance matrix,
and then propagates the samples. One can scale the covariance matrix to only
sample near the best-fit parameters and thus should be able to reproduce the
differential method (within sampling noise).</p>
</section>
<section id="proposal">
<h2>Proposal<a class="headerlink" href="#proposal" title="Link to this heading">#</a></h2>
<p>We propose to change the <code class="docutils literal notranslate"><span class="pre">SpectralModel.evaluate_error</span></code> implementation to a
custom differential based error propagation, as shown in the  <a class="reference external" href="https://github.com/gammapy/gammapy-extra/blob/master/experiments/uncertainty_estimation_prototype.ipynb">Gammapy
uncertainty propagation prototype notebook</a>. This allows us to completely
remove the use of <a class="reference external" href="http://pythonhosted.org/uncertainties/">uncertainties</a> within Gammapy, and to simplify the spectral
model evaluation code. This will be a bit slower and less accurate than the
current method, but it is a “black box” technique that will work for any
spectral method or code that we call.</p>
<p>In the future we think that using an autodiff solution could be useful, not just
for error propagation, but also for likelihood optimisation. It’s unlikely that
we’d use <a class="reference external" href="http://pythonhosted.org/uncertainties/">uncertainties</a> though, rather we’d probably use <a class="reference external" href="https://github.com/HIPS/autograd">autograd</a> or <a class="reference external" href="https://github.com/google/jax">jax</a>
or even Tensorflow or PyTorch or Chainer or some other modern array computing
package that supports autograd. So we think removing <code class="docutils literal notranslate"><span class="pre">uncertainties</span></code> now and
cleaning up or model evaluation code is a good step, even if we want to change
to some other framework later.</p>
<p>We also propose to add a method to generate parameter samples from the best-fit
parameters and covariance, and to support MC error propagation. See  <a class="reference external" href="https://github.com/gammapy/gammapy-extra/blob/master/experiments/uncertainty_estimation_prototype.ipynb">Gammapy
uncertainty propagation prototype notebook</a>. This second part could be done
before or after the v1.0 release, it’s independent of the first proposed change.
The first step would be to add a test and improve the code of MC sampling
interface (see <a class="reference external" href="https://github.com/gammapy/gammapy/pull/2304">GH 2304</a>). Then probably we should add a <code class="docutils literal notranslate"><span class="pre">Distribution</span></code>
object from <a class="reference external" href="https://docs.astropy.org/en/stable/uncertainty/index.html">astropy.uncertainty</a> to <code class="docutils literal notranslate"><span class="pre">Parameter</span></code> or to a new <code class="docutils literal notranslate"><span class="pre">FitMC</span></code> class
to store samples from MC analysis, or multinormal samples from the covariance
matrix. And then possibly support for such objects in model evaluation and
derived quantities. Another option could be to add support for “model sets” as
in <code class="docutils literal notranslate"><span class="pre">astropy.modeling</span></code> to support arrays of parameter values within one model
object, or to directly change <code class="docutils literal notranslate"><span class="pre">gammapy.modeling</span></code> to be based on
<code class="docutils literal notranslate"><span class="pre">astropy.modeling</span></code>. As you can see, this second part of the proposal is a wish
that Gammapy support MC sample based error propagation, the implementation is
something to be prototyped and worked out in the future (could be now and for
v1.0, or any time later).</p>
</section>
<section id="alternatives">
<h2>Alternatives<a class="headerlink" href="#alternatives" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Support only sample-based uncertainty propagation (like e.g. PyMC or 3ML)</p></li>
<li><p>Support only differential uncertainty propagation (like e.g. Minuit)</p></li>
<li><p>Keep everything as-is, use <a class="reference external" href="http://pythonhosted.org/uncertainties/">uncertainties</a></p></li>
<li><p>Change to another autograd package like <code class="docutils literal notranslate"><span class="pre">autograd</span></code> or <code class="docutils literal notranslate"><span class="pre">jax</span></code></p></li>
</ul>
</section>
<section id="decision">
<h2>Decision<a class="headerlink" href="#decision" title="Link to this heading">#</a></h2>
<p>This proposal was discussed extensively on GitHub (<a class="reference external" href="https://github.com/gammapy/gammapy/pull/2255">GH 2255</a>), and also
in-person at the Gammapy coding sprint in Nov 2019. The exact mechanism and
implementation for uncertainty propagation needs to be worked out (see the
prototype notebook), this will happen at the coding sprint later this week.
There were no objections to this proposal received, so it’s accepted.</p>
</section>
</section>


                </article>
              
              
              
              
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#abstract">Abstract</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#proposal">Proposal</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#alternatives">Alternatives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decision">Decision</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../../_sources/development/pigs/pig-014.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, The Gammapy developers.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
    
     <a href="https://gammapy.org/DataPrivacy.html">Data Privacy.</a>
</div>
      
    </div>
  
  
    <div class="footer-items__center">
      
        <div class="footer-item"><p class="last-updated">
  Last updated on 15 Nov 2024.
  <br/>
</p></div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    <br/>
  </p>
</div>
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.0.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>