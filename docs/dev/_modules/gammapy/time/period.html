
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>gammapy.time.period &#8212; gammapy v0.7.dev5391</title>
    <link rel="stylesheet" href="../../../_static/gammapy.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.7.dev5391',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <link rel="shortcut icon" href="../../../_static/astropy_logo.ico"/>
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>
<script type="text/javascript" src="../../../_static/copybutton.js"></script>


  </head>
  <body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">gamma</span><span id="logotext2">py</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">gammapy v0.7.dev5391</a>
	 &#187;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for gammapy.time.period</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="k">import</span> <span class="n">LombScargle</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;lomb_scargle&#39;</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="lomb_scargle"><a class="viewcode-back" href="../../../api/gammapy.time.lomb_scargle.html#gammapy.time.lomb_scargle">[docs]</a><span class="k">def</span> <span class="nf">lomb_scargle</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">flux_err</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">max_period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">n_bootstraps</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute period and its false alarm probability of a light curve using Lomb-Scargle PSD.</span>

<span class="sd">    To compute the Lomb-Scargle power spectral density, `astropy.stats.LombScargle` is called.</span>
<span class="sd">    For eyesight inspection, the spectral window function is also returned</span>
<span class="sd">    to evaluate the impact of sampling on the periodogram.</span>
<span class="sd">    The criteria for the false alarm probability are both parametric and non-parametric.</span>

<span class="sd">    For an introduction to the Lomb-Scargle periodogram, see Lomb (1976) and Scargle (1982).</span>
<span class="sd">    For an introduction to the false alarm probability of thr Lomb-Scargle periodogram, see the astropy docs.</span>

<span class="sd">    The function returns a results dictionary with the following content:</span>

<span class="sd">    - ``pgrid`` (`~numpy.ndarray`) -- Period grid in units of ``t``</span>
<span class="sd">    - ``psd`` (`~numpy.ndarray`) -- PSD of Lomb-Scargle at frequencies of ``fgrid``</span>
<span class="sd">    - ``period`` (`float`) -- Location of the highest periodogram peak</span>
<span class="sd">    - ``fap`` (`float`) or (`~numpy.ndarray`) -- False alarm probability of ``period``</span>
<span class="sd">      under the null hypothesis of only-noise data for the specified criteria.</span>
<span class="sd">      If criteria is not defined, the false alarm probability of all criteria is returned.</span>
<span class="sd">    - ``swf`` (`~numpy.ndarray`) -- Spectral window function</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    time : `~numpy.ndarray`</span>
<span class="sd">        Time array of the light curve</span>
<span class="sd">    flux : `~numpy.ndarray`</span>
<span class="sd">        Flux array of the light curve</span>
<span class="sd">    flux_err : `~numpy.ndarray`</span>
<span class="sd">        Flux error array of the light curve</span>
<span class="sd">    dt : float</span>
<span class="sd">        Desired resolution of the periodogram and the window function</span>
<span class="sd">    max_period : float</span>
<span class="sd">        Maximum period to analyse</span>
<span class="sd">    criteria : list of str</span>
<span class="sd">        Select which significance methods you&#39;d like to run (by default all are running)</span>
<span class="sd">        Available: `{&#39;pre&#39;, &#39;cvm&#39;, &#39;nll&#39;, &#39;boot&#39;}`</span>

<span class="sd">        - ``pre`` for pre-defined beta distribution (see Schwarzenberg-Czerny (1998))</span>
<span class="sd">        - ``cvm`` for Cramer-von-Mises distance minimisation (see Thieler et at. (2016))</span>
<span class="sd">        - ``nll`` for negative logarithmic likelihood minimisation</span>
<span class="sd">        - ``boot`` for bootstrap-resampling (see Sueveges (2012)</span>
<span class="sd">           and ``astroML.time_series.lomb_scargle_bootstrap``.</span>
<span class="sd">    n_bootstraps : int</span>
<span class="sd">        Number of bootstraps resampling</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    results : `~collections.OrderedDict`</span>
<span class="sd">        Results dictionary (see description above).</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Lomb (1976), &quot;Least-squares frequency analysis of unequally spaced data&quot;,</span>
<span class="sd">       `Link &lt;https://link.springer.com/article/10.1007%2FBF00648343?LI=true&gt;`__</span>
<span class="sd">    .. [2] Scargle (1982), &quot;Studies in astronomical time series analysis. II -</span>
<span class="sd">       Statistical aspects of spectral analysis of unevenly spaced data&quot;,</span>
<span class="sd">       `Link &lt;http://articles.adsabs.harvard.edu/full/1982ApJ...263..835S&gt;`__</span>
<span class="sd">    .. [3] Schwarzenberg-Czerny (1998), &quot;The distribution of empirical periodograms: Lomb-Scargle and PDM spectra&quot;,</span>
<span class="sd">       `Link &lt;https://academic.oup.com/mnras/article/301/3/831/1038387/The-distribution-of-empirical-periodograms-Lomb&gt;`__</span>
<span class="sd">    .. [4] Thieler et at. (2016), &quot;RobPer: An R Package to Calculate Periodograms for Light Curves Based on Robust Regression&quot;,</span>
<span class="sd">       `Link &lt;https://www.jstatsoft.org/article/view/v069i09&gt;`__</span>
<span class="sd">    .. [5] Sueveges (2012), &quot;False Alarm Probability based on bootstrap and extreme-value methods for periodogram peaks&quot;,</span>
<span class="sd">       `Link &lt;http://ada7.cosmostat.org/ADA7_proceeding_MSuveges2.pdf&gt;`__</span>
<span class="sd">    .. [6] Astropy docs, Lomb-Scargle Periodograms,</span>
<span class="sd">       `Link &lt;http://docs.astropy.org/en/latest/stats/lombscargle.html&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># set up lomb-scargle-algorithm</span>
    <span class="n">freq</span><span class="p">,</span> <span class="n">periods</span> <span class="o">=</span> <span class="n">_freq_grid</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">max_period</span><span class="p">)</span>
    <span class="n">psd_data</span> <span class="o">=</span> <span class="n">LombScargle</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">flux_err</span><span class="p">)</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>

    <span class="c1"># find period with highest periodogram peak</span>
    <span class="n">psd_best_period</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">psd_data</span><span class="p">)</span>
    <span class="n">best_period</span> <span class="o">=</span> <span class="n">periods</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">psd_data</span><span class="p">)]</span>

    <span class="c1"># define significance for best period</span>
    <span class="k">if</span> <span class="n">criteria</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pre&#39;</span><span class="p">,</span> <span class="s1">&#39;cvm&#39;</span><span class="p">,</span> <span class="s1">&#39;nll&#39;</span><span class="p">,</span> <span class="s1">&#39;boot&#39;</span><span class="p">]</span>

    <span class="n">fap</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

    <span class="k">if</span> <span class="s1">&#39;pre&#39;</span> <span class="ow">in</span> <span class="n">criteria</span><span class="p">:</span>
        <span class="n">fap</span><span class="p">[</span><span class="s1">&#39;pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_fap_pre</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">psd_best_period</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;cvm&#39;</span> <span class="ow">in</span> <span class="n">criteria</span><span class="p">:</span>
        <span class="n">fap</span><span class="p">[</span><span class="s1">&#39;cvm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_fap_cvm</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">psd_data</span><span class="p">,</span> <span class="n">psd_best_period</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;nll&#39;</span> <span class="ow">in</span> <span class="n">criteria</span><span class="p">:</span>
        <span class="n">fap</span><span class="p">[</span><span class="s1">&#39;nll&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_fap_nll</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">psd_data</span><span class="p">,</span> <span class="n">psd_best_period</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;boot&#39;</span> <span class="ow">in</span> <span class="n">criteria</span><span class="p">:</span>
        <span class="n">fap</span><span class="p">[</span><span class="s1">&#39;boot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_fap_boot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">flux_err</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">psd_best_period</span><span class="p">,</span> <span class="n">n_bootstraps</span><span class="p">)</span>

    <span class="c1"># spectral window function</span>
    <span class="n">time_win</span><span class="p">,</span> <span class="n">window</span> <span class="o">=</span> <span class="n">_window_function</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">psd_win</span> <span class="o">=</span> <span class="n">LombScargle</span><span class="p">(</span><span class="n">time_win</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">&#39;pgrid&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;psd&#39;</span><span class="p">,</span> <span class="n">psd_data</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;period&#39;</span><span class="p">,</span> <span class="n">best_period</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;fap&#39;</span><span class="p">,</span> <span class="n">fap</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;swf&#39;</span><span class="p">,</span> <span class="n">psd_win</span><span class="p">),</span>
    <span class="p">])</span></div>


<span class="k">def</span> <span class="nf">_window_function</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates window function with desired resolution dt</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">time_win</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">time</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="n">t_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">time_win</span><span class="p">)</span>
    <span class="n">t_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">time_win</span><span class="p">)</span>
    <span class="n">window_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t_min</span><span class="p">,</span> <span class="n">t_max</span> <span class="o">+</span> <span class="n">dt</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">window_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">window_grid</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>  <span class="c1"># round again since np.arange is not robust</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">window_grid</span><span class="p">))</span>
    <span class="n">window</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">window_grid</span><span class="p">,</span> <span class="n">time_win</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">window_grid</span><span class="p">,</span> <span class="n">window</span>


<span class="k">def</span> <span class="nf">_freq_grid</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">max_period</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates the frequency grid for the periodogram</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">max_period</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_period</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">time</span><span class="p">))</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">max_period</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">max_period</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>

    <span class="n">min_period</span> <span class="o">=</span> <span class="n">dt</span>
    <span class="n">periods</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_period</span><span class="p">,</span> <span class="n">max_period</span> <span class="o">+</span> <span class="n">dt</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">periods</span>

    <span class="k">return</span> <span class="n">grid</span><span class="p">,</span> <span class="n">periods</span>


<span class="k">def</span> <span class="nf">_cvm</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cramer-von-Mises distance for beta distribution</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="k">import</span> <span class="n">beta</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">param</span>
    <span class="n">ordered_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">sumbeta</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="n">cdf</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">ordered_data</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">sumbeta</span> <span class="o">+=</span> <span class="p">(</span><span class="n">cdf</span> <span class="o">-</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">**</span> <span class="mf">2.0</span>

    <span class="n">cvm_dist</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">*</span> <span class="n">sumbeta</span> <span class="o">+</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">))</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cvm_dist</span><span class="p">)</span>
    <span class="n">cvm</span> <span class="o">=</span> <span class="n">cvm_dist</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">cvm</span>


<span class="k">def</span> <span class="nf">_nll</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Negative log likelihood function for beta distribution</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="k">import</span> <span class="n">beta</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">param</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">lg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lg</span><span class="p">)</span>
    <span class="n">nll</span> <span class="o">=</span> <span class="o">-</span><span class="n">lg</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">nll</span>


<span class="k">def</span> <span class="nf">_bootstrap</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">flux_error</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">n_bootstraps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns value of maximum periodogram peak for every bootstrap resampling</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">max_periods</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_bootstraps</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx_run</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_bootstraps</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">flux</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">flux</span><span class="p">))</span>
        <span class="n">psd_boot</span> <span class="o">=</span> <span class="n">LombScargle</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">flux</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">flux_error</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
        <span class="n">max_periods</span><span class="p">[</span><span class="n">idx_run</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">psd_boot</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">max_periods</span>


<span class="k">def</span> <span class="nf">_fap_pre</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">psd_best_period</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes false alarm probability for the pre-defined beta distribution</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="k">import</span> <span class="n">beta</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">fap</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">beta</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">psd_best_period</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">**</span> <span class="nb">len</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fap</span>


<span class="k">def</span> <span class="nf">_fap_cvm</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">psd</span><span class="p">,</span> <span class="n">psd_best_period</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes false alarm probability for the cvm-distance-minimised beta distribution</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">optimize</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="k">import</span> <span class="n">beta</span>
    <span class="n">clip</span> <span class="o">=</span> <span class="mf">0.00001</span>

    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">psd</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">psd</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">psd</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">psd</span><span class="p">))</span>
    <span class="n">theta_1</span> <span class="o">=</span> <span class="o">-</span> <span class="n">temp</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">psd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">theta_1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">theta_1</span> <span class="o">=</span> <span class="n">clip</span>

    <span class="n">theta_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta_1</span> <span class="o">-</span> <span class="n">theta_1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">psd</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">psd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">theta_2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">theta_2</span> <span class="o">=</span> <span class="n">clip</span>

    <span class="n">cvm_minimize</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
        <span class="n">_cvm</span><span class="p">,</span>
        <span class="p">[</span><span class="n">theta_1</span><span class="p">,</span> <span class="n">theta_2</span><span class="p">],</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">psd</span><span class="p">,),</span>
        <span class="n">bounds</span><span class="o">=</span><span class="p">((</span><span class="n">clip</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="n">clip</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
    <span class="p">)</span>
    <span class="n">fap</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">beta</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">psd_best_period</span><span class="p">,</span> <span class="n">cvm_minimize</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cvm_minimize</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="nb">len</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fap</span>


<span class="k">def</span> <span class="nf">_fap_nll</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">psd</span><span class="p">,</span> <span class="n">psd_best_period</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes false alarm probability for the negative logarithmic likelihood-minimised beta distribution</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">optimize</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="k">import</span> <span class="n">beta</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">clip</span> <span class="o">=</span> <span class="mf">0.00001</span>
    <span class="n">nll_minimize</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
        <span class="n">_nll</span><span class="p">,</span>
        <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">],</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">psd</span><span class="p">,),</span>
        <span class="n">bounds</span><span class="o">=</span><span class="p">((</span><span class="n">clip</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="n">clip</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
    <span class="p">)</span>
    <span class="n">fap</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">beta</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">psd_best_period</span><span class="p">,</span> <span class="n">nll_minimize</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nll_minimize</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="nb">len</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fap</span>


<span class="k">def</span> <span class="nf">_fap_boot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">flux_error</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">psd_best_period</span><span class="p">,</span> <span class="n">n_bootstraps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes significance for the bootstrap-resampling</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">stats</span>
    <span class="n">max_periods</span> <span class="o">=</span> <span class="n">_bootstrap</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">flux_error</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">n_bootstraps</span><span class="p">)</span>
    <span class="n">fap</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">percentileofscore</span><span class="p">(</span><span class="n">max_periods</span><span class="p">,</span> <span class="n">psd_best_period</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fap</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2018, The Gammapy developers.<br/>
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.5. &nbsp;
    Last built 08 Jan 2018. <br/>
  </p>
</footer>
  </body>
</html>