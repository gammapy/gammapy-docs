
<!DOCTYPE html>


<html lang="en" data-content_root="../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Developer How To &#8212; gammapy vX.Y.Z</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=947a6bef" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../_static/jquery.js?v=5d32c60e"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../_static/documentation_options.js?v=1f75dfce"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=30646c52"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'development/dev_howto';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.0';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://docs.gammapy.org/stable/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'dev';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = false;
        </script>
    <script src="../_static/matomo.js?v=52704cab"></script>
    <link rel="icon" href="../_static/gammapy_logo.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="PIGs" href="pigs/index.html" />
    <link rel="prev" title="Documentation How To" href="doc_howto.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="2.0.dev100+gdfd7116c9" />
    <meta name="docbuild:last-update" content="26 Nov 2024"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
    
    <img src="../_static/gammapy_logo_nav.png" class="logo__image only-light" alt="gammapy vX.Y.Z - Home"/>
    <img src="../_static/gammapy_logo_nav.png" class="logo__image only-dark pst-js-only" alt="gammapy vX.Y.Z - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../getting-started/index.html">
    Getting started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../user-guide/index.html">
    User guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api-reference/index.html">
    API reference
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    Developer guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../release-notes/index.html">
    Release notes
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/gammapy/gammapy" title="Github" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Github</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/gammapyST" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-square-x-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://gammapy.slack.com/" title="Slack" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-slack fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Slack</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../getting-started/index.html">
    Getting started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../user-guide/index.html">
    User guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api-reference/index.html">
    API reference
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    Developer guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../release-notes/index.html">
    Release notes
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/gammapy/gammapy" title="Github" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Github</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/gammapyST" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-square-x-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://gammapy.slack.com/" title="Slack" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-slack fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Slack</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="setup.html">Project setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="dependencies.html">Dependencies</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="intro.html">How to contribute to Gammapy</a></li>
<li class="toctree-l1"><a class="reference internal" href="release.html">How to make a Gammapy release</a></li>
</ul>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="doc_howto.html">Documentation How To</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Developer How To</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="pigs/index.html">PIGs</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Developer guide</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Developer How To</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="developer-how-to">
<span id="dev-howto"></span><h1>Developer How To<a class="headerlink" href="#developer-how-to" title="Link to this heading">#</a></h1>
<section id="general-conventions">
<h2>General conventions<a class="headerlink" href="#general-conventions" title="Link to this heading">#</a></h2>
<section id="python-version-support">
<h3>Python version support<a class="headerlink" href="#python-version-support" title="Link to this heading">#</a></h3>
<p>In Gammapy we currently support Python 3.8 or later.</p>
</section>
<section id="coordinate-and-axis-names">
<h3>Coordinate and axis names<a class="headerlink" href="#coordinate-and-axis-names" title="Link to this heading">#</a></h3>
<p>In Gammapy, the following coordinate and axis names should be used.</p>
<p>This applies to most of the code, ranging from IRFs to maps
to sky models, for function parameters and variable names.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">time</span></code> - time</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">energy</span></code> - energy</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">energy_true</span></code> - true energy</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ra</span></code>, <code class="docutils literal notranslate"><span class="pre">dec</span></code> - sky coordinates, <code class="docutils literal notranslate"><span class="pre">radec</span></code> frame (i.e. <code class="docutils literal notranslate"><span class="pre">icrs</span></code> to be precise)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">glon</span></code>, <code class="docutils literal notranslate"><span class="pre">glat</span></code> - sky coordinates, <code class="docutils literal notranslate"><span class="pre">galactic</span></code> frame</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">az</span></code>, <code class="docutils literal notranslate"><span class="pre">alt</span></code> - sky coordinates, <code class="docutils literal notranslate"><span class="pre">altaz</span></code> frame</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lon</span></code>, <code class="docutils literal notranslate"><span class="pre">lat</span></code> for spherical coordinates that aren’t in a specific frame.</p></li>
</ul>
<p>For angular sky separation angles:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">psf_theta</span></code> - offset wrt. PSF center position</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fov_theta</span></code> - offset wrt. field of view (FOV) center</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">theta</span></code> - when no PSF is involved, e.g. to evaluate spatial sky models</p></li>
</ul>
<p>For the general case of FOV coordinates that depend on angular orientation
of the FOV coordinate frame:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">fov_{frame}_lon</span></code>, <code class="docutils literal notranslate"><span class="pre">fov_{frame}_lat</span></code> - field of view coordinates</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fov_theta</span></code>, <code class="docutils literal notranslate"><span class="pre">fov_{frame}_phi</span></code> - field of view polar coordinates</p></li>
</ul>
<p>where <code class="docutils literal notranslate"><span class="pre">{frame}</span></code> can be one of <code class="docutils literal notranslate"><span class="pre">radec</span></code>, <code class="docutils literal notranslate"><span class="pre">galactic</span></code> or <code class="docutils literal notranslate"><span class="pre">altaz</span></code>,
depending on with which frame the FOV coordinate frame is aligned.</p>
<p>Notes:</p>
<ul class="simple">
<li><p>In cases where it’s unclear if the value is for true or reconstructed event
parameters, a postfix <code class="docutils literal notranslate"><span class="pre">_true</span></code> or <code class="docutils literal notranslate"><span class="pre">_reco</span></code> should be added.
In Gammapy, this mostly occurs for <code class="docutils literal notranslate"><span class="pre">energy_true</span></code> and <code class="docutils literal notranslate"><span class="pre">energy_reco</span></code>,
e.g. the background IRF has an axis <code class="docutils literal notranslate"><span class="pre">energy_reco</span></code>, but effective area
usually <code class="docutils literal notranslate"><span class="pre">energy_true</span></code>, and energy dispersion has both axes.
We are not pedantic about adding <code class="docutils literal notranslate"><span class="pre">_true</span></code> and <code class="docutils literal notranslate"><span class="pre">_reco</span></code> everywhere.
Note that this would quickly become annoying (e.g. source models use true
parameters, and it’s not clear why one should write <code class="docutils literal notranslate"><span class="pre">ra_true</span></code>).
E.g. the property on the event list <code class="docutils literal notranslate"><span class="pre">energy</span></code> matches the <code class="docutils literal notranslate"><span class="pre">ENERGY</span></code>
column from the event list table, which is for real data always reco energy.</p></li>
<li><p>Currently, no sky frames centered on the source, or non-radially symmetric
PSFs are in use, and thus the case of “source frames” that have to be with
a well-defined alignment, like we have for the “FOV frames” above,
doesn’t occur and thus doesn’t need to be defined yet (but it would be natural
to use the same naming convention as for FOV if it eventually does occur).</p></li>
<li><p>These definitions are mostly in agreement with the <a class="reference external" href="https://gamma-astro-data-formats.readthedocs.io/">Gamma Astro Data Formats</a> specifications.
We do not achieve 100% consistency everywhere in the spec and Gammapy code.
Achieving this seems unrealistic, because legacy formats have to be supported,
we are not starting from scratch and have time to make all formats consistent.
Our strategy is to do renames on I/O where needed, to and from the internal
Gammapy names defined here, to the names used in the formats.
Of course, where formats are not set in stone yet, we advocate and encourage
the use of the names chosen here.</p></li>
<li><p>Finally, CTAO has proposed a full data model associated to the needed quantities. And
the community is working to create a data format for very-high-energy data produced by gamma-ray
and neutrino experiments within the open initiative <a class="reference external" href="https://vodf.readthedocs.io/en/latest/index.html">Very-high-energy Open Data Format</a>. This format
aims to respect the CTAO data model, to respect the <a class="reference external" href="https://www.go-fair.org/fair-principles/">FAIR principles</a> and to follow as much as
possible the <a class="reference external" href="https://ivoa.net/">IVOA</a> recommendations. In order to handle past, current and old formats,
Gammapy should follow the <a class="reference external" href="https://www.rd-alliance.org/group_output/fair-principles-for-research-software-fair4rs-principles/">FAIR4RS principles</a> by proposing a user-friendly interface.</p></li>
</ul>
</section>
<section id="clobber-or-overwrite">
<h3>Clobber or overwrite?<a class="headerlink" href="#clobber-or-overwrite" title="Link to this heading">#</a></h3>
<p>In Gammapy we consistently use an <code class="docutils literal notranslate"><span class="pre">overwrite</span></code> bool option for <code class="xref py py-obj docutils literal notranslate"><span class="pre">gammapy.scripts</span></code> and functions that
write to files. This is in line with Astropy, which had a mix of <code class="docutils literal notranslate"><span class="pre">clobber</span></code> and <code class="docutils literal notranslate"><span class="pre">overwrite</span></code> in
the past, and has switched to uniform <code class="docutils literal notranslate"><span class="pre">overwrite</span></code> everywhere.</p>
<p>The default value should be <code class="docutils literal notranslate"><span class="pre">overwrite=False</span></code>, although we note that this decision was very
controversial, several core developers would prefer to use <code class="docutils literal notranslate"><span class="pre">overwrite=True</span></code>.
For discussion on this, see <a class="reference external" href="https://github.com/gammapy/gammapy/issues/1396">GH 1396</a>.</p>
</section>
<section id="pixel-coordinate-convention">
<h3>Pixel coordinate convention<a class="headerlink" href="#pixel-coordinate-convention" title="Link to this heading">#</a></h3>
<p>All code in Gammapy should follow the Astropy pixel coordinate convention that the center of the first pixel
has pixel coordinates <code class="docutils literal notranslate"><span class="pre">(0,</span> <span class="pre">0)</span></code> (and not <code class="docutils literal notranslate"><span class="pre">(1,</span> <span class="pre">1)</span></code> as shown e.g. in ds9).</p>
<p>You should use <code class="docutils literal notranslate"><span class="pre">origin=0</span></code> when calling any of the pixel to world or world to pixel coordinate transformations in <a class="reference external" href="https://docs.astropy.org/en/latest/wcs/reference_api.html#module-astropy.wcs" title="(in Astropy v7.1)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">astropy.wcs</span></code></a>.</p>
</section>
<section id="bsd-or-gpl-license">
<h3>BSD or GPL license?<a class="headerlink" href="#bsd-or-gpl-license" title="Link to this heading">#</a></h3>
<p>Gammapy is BSD licensed (same license as Numpy, Scipy, Matplotlib, scikit-image, Astropy, photutils, yt, …).</p>
<p>We prefer this over the GPL3 or LGPL license because it means that the packages we are most likely to
share code with have the same license, e.g. we can take a function or class and “upstream” it, i.e. contribute
it e.g. to Astropy or Scipy if it’s generally useful.</p>
<p>Some optional dependencies of Gammapy (i.e. other packages like Sherpa or Gammalib or ROOT that we import in some
places) are GPL3 or LGPL licensed.</p>
<p>Now the GPL3 and LGPL license contains clauses that other package that copy or modify it must be released under
the same license.
We take the standpoint that Gammapy is independent of these libraries, because we don’t copy or modify them.
This is a common standpoint, e.g. <code class="docutils literal notranslate"><span class="pre">astropy.wcs</span></code> is BSD licensed, but uses the LGPL-licensed WCSLib.</p>
<p>Note that if you distribute Gammapy together with one of the GPL dependencies,
the whole distribution then falls under the GPL license.</p>
</section>
</section>
<section id="how-to-write-code">
<h2>How to write code<a class="headerlink" href="#how-to-write-code" title="Link to this heading">#</a></h2>
<section id="where-should-i-import-from">
<h3>Where should I import from?<a class="headerlink" href="#where-should-i-import-from" title="Link to this heading">#</a></h3>
<p>You should import from the “end-user namespaces”, not the “implementation module”.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gammapy.data</span> <span class="kn">import</span> <span class="n">EventList</span> <span class="c1"># good</span>
<span class="kn">from</span> <span class="nn">gammapy.data.event_list</span> <span class="kn">import</span> <span class="n">EventList</span> <span class="c1"># bad</span>

<span class="kn">from</span> <span class="nn">gammapy.stats</span> <span class="kn">import</span> <span class="n">cash</span> <span class="c1"># good</span>
<span class="kn">from</span> <span class="nn">gammapy.stats.fit_statistics</span> <span class="kn">import</span> <span class="n">cash</span> <span class="c1"># bad</span>
</pre></div>
</div>
<p>The end-user namespace is the location that is shown in the API docs, i.e. you can
use the Sphinx full-text search to quickly find it.</p>
<p>To make code maintenance easier, the implementation of the functions and classes is
spread across multiple modules (<code class="docutils literal notranslate"><span class="pre">.py</span></code> files), but the user shouldn’t care about their
names, that would be too much to remember.</p>
<p>The only reason to import from a module directly is if you need to access a private
function, class or variable (something that is not listed in <code class="docutils literal notranslate"><span class="pre">__all__</span></code> and thus not
imported into the end-user namespace).</p>
<p>Note that this means that in the definition of an “end-user namespace”, e.g. in the
<code class="docutils literal notranslate"><span class="pre">gammapy/data/__init__.py</span></code> file, the imports have to be sorted in a way such that
modules in <code class="docutils literal notranslate"><span class="pre">gammapy/data</span></code> are loaded when imported from other modules in that sub-package.</p>
</section>
<section id="functions-returning-several-values">
<h3>Functions returning several values<a class="headerlink" href="#functions-returning-several-values" title="Link to this heading">#</a></h3>
<p>It is up to the developer to decide how to return multiple things from functions and methods.
For up to three things, if callers will usually want access to several things,
using a <code class="docutils literal notranslate"><span class="pre">tuple</span></code> or <code class="docutils literal notranslate"><span class="pre">collections.namedtuple</span></code> is ok.
For three or more things, using a Python <code class="docutils literal notranslate"><span class="pre">dict</span></code> instead should be preferred.</p>
</section>
<section id="what-checks-and-conversions-should-i-do-for-inputs">
<h3>What checks and conversions should I do for inputs?<a class="headerlink" href="#what-checks-and-conversions-should-i-do-for-inputs" title="Link to this heading">#</a></h3>
<p>In Gammapy we assume that
<a class="reference external" href="https://mail.python.org/pipermail/tutor/2003-October/025932.html">“we’re all consenting adults”</a>,
which means that when you write a function you should write it like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">do_something</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Do something.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : `numpy.ndarray`</span>
<span class="sd">        Data</span>
<span class="sd">    option : {&#39;this&#39;, &#39;that&#39;}</span>
<span class="sd">        Option</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;this&#39;</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">data</span>
    <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;that&#39;</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">data</span> <span class="o">**</span> <span class="mi">5</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid option: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">option</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
<ul>
<li><p><strong>Don’t always add `isinstance` checks for everything</strong> … assume the caller passes valid inputs,
… in the example above this is not needed:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p><strong>Don’t always add `numpy.asanyarray` calls for all array-like inputs</strong> … the caller can do this if
it’s really needed … in the example above document <code class="docutils literal notranslate"><span class="pre">data</span></code> as type <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v2.1)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ndarray</span></code></a>
instead of array-like and don’t put this line:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p><strong>Do always add an `else` clause to your `if`-`elif` clauses</strong> … this is boilerplate code,
but not adding it would mean users get this error if they pass an invalid option:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="ne">UnboundLocalError</span><span class="p">:</span> <span class="n">local</span> <span class="n">variable</span> <span class="s1">&#39;out&#39;</span> <span class="n">referenced</span> <span class="n">before</span> <span class="n">assignment</span>
</pre></div>
</div>
</li>
</ul>
<p>Now if you really want, you can add the <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.asanyarray.html#numpy.asanyarray" title="(in NumPy v2.1)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">numpy.asanyarray</span></code></a> and <a class="reference external" href="https://docs.python.org/3/library/functions.html#isinstance" title="(in Python v3.13)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">isinstance</span></code></a> checks
for functions that end-users might often use for interactive work to provide them with
better exception messages, but doing it everywhere would mean 1000s of lines of boilerplate
code and take the fun out of Python programming.</p>
</section>
<section id="float-data-type-32-bit-or-64-bit">
<h3>Float data type: 32 bit or 64 bit?<a class="headerlink" href="#float-data-type-32-bit-or-64-bit" title="Link to this heading">#</a></h3>
<p>Most of the time what we want is to use 32 bit to store data on disk and 64 bit to do
computations in memory.</p>
<p>Using 64 bit to store data and results (e.g. large images or cubes) on disk would mean
a factor ~2 increase in file sizes and slower I/O, but I’m not aware of any case
where we need that precision.</p>
<p>On the other hand, doing computations with millions and billions of pixels very frequently
results in inaccurate results … e.g. the likelihood is the sum over per-pixel likelihoods
and using 32-bit will usually result in erratic and hard-to-debug optimizer behaviour
and even if the fit works incorrect results.</p>
<p>Now you shouldn’t put this line at the top of every function … assume the caller
passes 64-bit data:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>But you should add explicit type conversions to 64 bit when reading float data from files
and explicit type conversions to 32 bit before writing to file.</p>
</section>
</section>
<section id="how-to-use-random-numbers">
<span id="dev-random"></span><h2>How to use random numbers<a class="headerlink" href="#how-to-use-random-numbers" title="Link to this heading">#</a></h2>
<p>All functions that need to call a random number generator should
take a <code class="docutils literal notranslate"><span class="pre">random_state</span></code> input parameter and call the
<a class="reference internal" href="../api/gammapy.utils.random.get_random_state.html#gammapy.utils.random.get_random_state" title="gammapy.utils.random.get_random_state"><code class="xref py py-obj docutils literal notranslate"><span class="pre">get_random_state</span></code></a> utility function like this
(you can copy &amp; paste the three docstring lines and the first code line
to the function you’re writing):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gammapy.utils.random</span> <span class="kn">import</span> <span class="n">get_random_state</span>

<span class="k">def</span> <span class="nf">make_random_stuff</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="s1">&#39;random-seed&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;...</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    random_state : {int, &#39;random-seed&#39;, &#39;global-rng&#39;, `~numpy.random.RandomState`}</span>
<span class="sd">        Defines random number generator initialisation.</span>
<span class="sd">        Passed to `~gammapy.utils.random.get_random_state`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">random_state</span> <span class="o">=</span> <span class="n">get_random_state</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">random_state</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
<p>This allows callers flexible control over which random number generator
(i.e. which <a class="reference external" href="https://numpy.org/doc/stable/reference/random/legacy.html#numpy.random.RandomState" title="(in NumPy v2.1)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">numpy.random.RandomState</span></code></a> instance) is used and how it’s initialised.
The default <code class="docutils literal notranslate"><span class="pre">random_state='random-seed'</span></code> means “create a new RNG, seed it randomly”,
i.e. different random numbers will be generated on every call.</p>
<p>There’s a few ways to get deterministic results from a script that call
functions that generate random numbers.</p>
<p>One option is to create a single <a class="reference external" href="https://numpy.org/doc/stable/reference/random/legacy.html#numpy.random.RandomState" title="(in NumPy v2.1)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">RandomState</span></code></a> object seeded with an integer
and then pass that <code class="docutils literal notranslate"><span class="pre">random_state</span></code> object to every function that generates random numbers:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">RandomState</span>
<span class="n">random_state</span> <span class="o">=</span> <span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">stuff1</span> <span class="o">=</span> <span class="n">make_some_random_stuff</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
<span class="n">stuff2</span> <span class="o">=</span> <span class="n">make_more_random_stuff</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
</pre></div>
</div>
<p>Another option is to pass an integer seed to every function that generates random numbers:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">stuff1</span> <span class="o">=</span> <span class="n">make_some_random_stuff</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
<span class="n">stuff2</span> <span class="o">=</span> <span class="n">make_more_random_stuff</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
</pre></div>
</div>
<p>This pattern was inspired by the way scikit-learn handles random numbers.
We have changed the <code class="docutils literal notranslate"><span class="pre">None</span></code> option of <code class="docutils literal notranslate"><span class="pre">sklearn.utils.check_random_state</span></code> to <code class="docutils literal notranslate"><span class="pre">'global-rng'</span></code>,
because we felt that this meaning for <code class="docutils literal notranslate"><span class="pre">None</span></code> was confusing given that <a class="reference external" href="https://numpy.org/doc/stable/reference/random/legacy.html#numpy.random.RandomState" title="(in NumPy v2.1)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">numpy.random.RandomState</span></code></a>
uses a different meaning (for which we use the option <code class="docutils literal notranslate"><span class="pre">'global-rng'</span></code>).</p>
</section>
<section id="how-to-use-logging">
<h2>How to use logging<a class="headerlink" href="#how-to-use-logging" title="Link to this heading">#</a></h2>
<p>Gammapy is a library. This means that it should never contain print statements, because with
print statements the library users have no easy way to configure where the print output goes
(e.g. to <code class="docutils literal notranslate"><span class="pre">stdout</span></code> or <code class="docutils literal notranslate"><span class="pre">stderr</span></code> or a log file) and what the log level (<code class="docutils literal notranslate"><span class="pre">warning</span></code>, <code class="docutils literal notranslate"><span class="pre">info</span></code>, <code class="docutils literal notranslate"><span class="pre">debug</span></code>)
and format is (e.g. include timestamp and log level?).</p>
<p>So logging is much better than printing. But also logging is only rarely needed.
Many developers use print or log statements to debug some piece of code while they write it.
Once it’s written and works, it’s rare that callers want it to be chatty and log messages all the time.
Print and log statements should mostly be contained in end-user scripts that use Gammapy,
not in Gammapy itself.</p>
<p>That said, there are cases where emitting log messages can be useful.
E.g. a long-running algorithm with many steps can log info or debug statements.
In a function that reads and writes several files it can make sense to include info log messages
for normal operation, and warning or error log messages when something goes wrong.
Also, command line tools that are included in Gammapy <strong>should</strong> contain log messages,
informing the user about what they are doing.</p>
<p>Gammapy uses the Python standard library <a class="reference external" href="https://docs.python.org/3/library/logging.html#module-logging" title="(in Python v3.13)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">logging</span></code></a> module. This module is extremely flexible,
but also quite complex. But our logging needs are very modest, so it’s actually quite simple …</p>
<p>It is worth mentioning that important logs returned to the user should be captured and tested using caplog fixture, see the section Caplog fixture above</p>
<section id="generating-log-messages">
<h3>Generating log messages<a class="headerlink" href="#generating-log-messages" title="Link to this heading">#</a></h3>
<p>To generate log messages from any file in Gammapy, include these two lines at the top:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</pre></div>
</div>
<p>This creates a module-level <a class="reference external" href="https://docs.python.org/3/library/logging.html#logging.Logger" title="(in Python v3.13)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">logging.Logger</span></code></a> object called <code class="docutils literal notranslate"><span class="pre">log</span></code>, and you can then create
log messages like this from any function or method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_lots_of_data</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">):</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting processing data ...&#39;</span><span class="p">)</span>

    <span class="c1"># do lots of work</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outfile</span><span class="p">))</span>
</pre></div>
</div>
<p>You should never log messages from the module level (i.e. on import) or configure the log
level or format in Gammapy, that should be left to callers … except from command line tools …</p>
</section>
</section>
<section id="interpolation-and-extrapolation">
<h2>Interpolation and extrapolation<a class="headerlink" href="#interpolation-and-extrapolation" title="Link to this heading">#</a></h2>
<p>In Gammapy, we use interpolation a lot, e.g. to evaluate instrument response functions (IRFs) on
data grids, or to reproject diffuse models on data grids.</p>
<p>The default interpolator we use is <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.interpolate.RegularGridInterpolator.html#scipy.interpolate.RegularGridInterpolator" title="(in SciPy v1.14.1)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">scipy.interpolate.RegularGridInterpolator</span></code></a> because it’s fast and robust
(more fancy interpolation schemes can lead to unstable response in some cases, so more careful checking
across all parameter space would be needed).</p>
<p>You should use this pattern to implement a function of method that does interpolation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">do_something</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">interp_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Do something.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    interp_kwargs : dict or None</span>
<span class="sd">        Interpolation parameter dict passed to `scipy.interpolate.RegularGridInterpolator`.</span>
<span class="sd">        If you pass ``None``, the default ``interp_params=dict(bounds_error=False)`` is used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">interp_kwargs</span><span class="p">:</span>
        <span class="n">interp_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">interpolator</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="o">**</span><span class="n">interp_kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>Since the other defaults are <code class="docutils literal notranslate"><span class="pre">method='linear'</span></code> and <code class="docutils literal notranslate"><span class="pre">fill_value=nan</span></code>, this implies that linear interpolation
is used and <a class="reference external" href="https://en.wikipedia.org/wiki/NaN">NaN</a> values are returned for points outside the interpolation domain.
This is a compromise between the alternatives:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">bounds_error=True</span></code> – Very “safe”, refuse to return results for any points if one of the points is outside the valid domain.
Can be annoying for the caller to not get any result.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bounds_error=False,</span> <span class="pre">fill_value=nan</span></code> – Medium “safe”. Always return a result, but put NaN values to make it easy
for analysers to spot that there’s an issue in their results (if pixels with NaN are used, that will usually lead
to NaN values in high level analysis results).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bounds_error=False,</span> <span class="pre">fill_value=0</span></code> – Less “safe”.
Extrapolate with zero.
Can be very convenient for the caller to avoid dealing with NaN,
but if the data values can also be zero you will lose track of invalid pixels.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bounds_error=False,</span> <span class="pre">fill_value=None</span></code> – “Unsafe”.
If fill_value is None, values outside the domain are extrapolated.
Can lead to errors where e.g. stacked high level analysis results
aren’t quite correct because IRFs or background models or … were used outside their valid range.</p></li>
</ul>
<p>Methods that use interpolation should provide an option to the caller to pass interpolation options on to
<code class="docutils literal notranslate"><span class="pre">RegularGridInterpolator</span></code> in case the default behaviour doesn’t suit the application.</p>
</section>
<section id="how-to-write-tests">
<h2>How to write tests<a class="headerlink" href="#how-to-write-tests" title="Link to this heading">#</a></h2>
<section id="assert-convention">
<h3>Assert convention<a class="headerlink" href="#assert-convention" title="Link to this heading">#</a></h3>
<p>When performing tests, the preferred numerical assert method is
<a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.testing.assert_allclose.html#numpy.testing.assert_allclose" title="(in NumPy v2.1)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">numpy.testing.assert_allclose</span></code></a>. Use</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_allclose</span>
</pre></div>
</div>
<p>at the top of the file and then just use <code class="docutils literal notranslate"><span class="pre">assert_allclose</span></code> for
the tests. This makes the lines shorter, i.e. there is more space
for the arguments.</p>
<p><code class="docutils literal notranslate"><span class="pre">assert_allclose</span></code> covers all use cases for numerical asserts, so
it should be used consistently everywhere instead of using the
dozens of other available asserts from pytest or numpy in various
places.</p>
<p>For assertions on <a class="reference external" href="https://docs.astropy.org/en/latest/api/astropy.units.Quantity.html#astropy.units.Quantity" title="(in Astropy v7.1)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Quantity</span></code></a> objects, you can do this
to assert on the unit and value separately:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_allclose</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>

<span class="n">actual</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
<span class="k">assert</span> <span class="n">actual</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s1">&#39;deg&#39;</span>
<span class="n">assert_allclose</span><span class="p">(</span><span class="n">actual</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="mf">0.33333333</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that <a class="reference external" href="https://docs.astropy.org/en/latest/api/astropy.units.Quantity.html#astropy.units.Quantity" title="(in Astropy v7.1)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Quantity</span></code></a> can be compared to unit strings directly.
Also note that the default for <code class="docutils literal notranslate"><span class="pre">assert_allclose</span></code> is <code class="docutils literal notranslate"><span class="pre">atol=0</span></code> and <code class="docutils literal notranslate"><span class="pre">rtol=1e-7</span></code>,
so when using it, you have to give the reference value with a precision of
<code class="docutils literal notranslate"><span class="pre">rtol</span> <span class="pre">~</span> <span class="pre">1e-8</span></code>, i.e. 8 digits to be on the safe side (or pass a lower <code class="docutils literal notranslate"><span class="pre">rtol</span></code> or set an <code class="docutils literal notranslate"><span class="pre">atol</span></code>).</p>
<p>The use of <a class="reference external" href="https://docs.astropy.org/en/latest/api/astropy.tests.helper.assert_quantity_allclose.html#astropy.tests.helper.assert_quantity_allclose" title="(in Astropy v7.1)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">assert_quantity_allclose</span></code></a> is discouraged,
because it only requires that the values match after unit conversions.
This is not so bad, but units in test cases should not change randomly,
so asserting on unit and value separately establishes more behaviour.</p>
<p>If you don’t like the two separate lines, you can use <a class="reference internal" href="../api/gammapy.utils.testing.assert_quantity_allclose.html#gammapy.utils.testing.assert_quantity_allclose" title="gammapy.utils.testing.assert_quantity_allclose"><code class="xref py py-obj docutils literal notranslate"><span class="pre">gammapy.utils.testing.assert_quantity_allclose</span></code></a>,
which does assert that units are equal, and calls <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.testing.assert_equal.html#numpy.testing.assert_equal" title="(in NumPy v2.1)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">numpy.testing.assert_equal</span></code></a> for the values.</p>
</section>
<section id="testing-of-plotting-functions">
<h3>Testing of plotting functions<a class="headerlink" href="#testing-of-plotting-functions" title="Link to this heading">#</a></h3>
<p>Many of the data classes in Gammapy implement <code class="docutils literal notranslate"><span class="pre">.plot()</span></code> or <code class="docutils literal notranslate"><span class="pre">.peek()</span></code> methods to
allow users a quick look in the data. Those methods should be tested using the
<code class="xref py py-obj docutils literal notranslate"><span class="pre">mpl_check_plot()</span></code> context manager. The context manager will take care of creating
a new figure to plot on and writing the plot to a byte-stream to trigger the
rendering of the plot, which can raise errors as well. Here is a short example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gammapy.utils.testing</span> <span class="kn">import</span> <span class="n">mpl_plot_check</span>

<span class="k">def</span> <span class="nf">test_plot</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">mpl_plot_check</span><span class="p">():</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">])</span>
</pre></div>
</div>
<p>With this approach we make sure that the plotting code is at least executed once
and runs completely (up to saving the plot to file) without errors. In future, we
will maybe change to something like <a class="github reference external" href="https://github.com/matplotlib/pytest-mpl">matplotlib/pytest-mpl</a>
to ensure that correct plots are produced.</p>
</section>
<section id="skip-unit-tests-for-some-astropy-versions">
<h3>Skip unit tests for some Astropy versions<a class="headerlink" href="#skip-unit-tests-for-some-astropy-versions" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">astropy</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="n">ASTROPY_VERSION</span> <span class="o">=</span> <span class="p">(</span><span class="n">astropy</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">major</span><span class="p">,</span> <span class="n">astropy</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">minor</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">xfail</span><span class="p">(</span><span class="n">ASTROPY_VERSION</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Astropy API change&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_something</span><span class="p">():</span>
   <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="caplog-fixture">
<h3>Caplog fixture<a class="headerlink" href="#caplog-fixture" title="Link to this heading">#</a></h3>
<p>Inside tests, we have the possibility to change the log level for the captured
log messages using the <code class="docutils literal notranslate"><span class="pre">caplog</span></code> fixture which allow you to access and control log capturing.
When logging is part of your function, and you want to verify the right message is logged
with the expected logging level:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>

<span class="k">def</span> <span class="nf">test_something</span><span class="p">(</span><span class="n">caplog</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test something.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    caplog : caplog fixture that give you access to the log level, the logger, etc.,</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;WARNING&quot;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">levelname</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">caplog</span><span class="o">.</span><span class="n">records</span><span class="p">]</span>
    <span class="k">assert</span> <span class="s2">&quot;warning message&quot;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">message</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">caplog</span><span class="o">.</span><span class="n">records</span><span class="p">]</span>
</pre></div>
</div>
</section>
</section>
<section id="how-to-make-a-pull-request">
<h2>How to make a pull request<a class="headerlink" href="#how-to-make-a-pull-request" title="Link to this heading">#</a></h2>
<section id="making-a-pull-request-with-new-or-modified-datasets">
<h3>Making a pull request with new or modified datasets<a class="headerlink" href="#making-a-pull-request-with-new-or-modified-datasets" title="Link to this heading">#</a></h3>
<p>Datasets used in tests are hosted in the <a class="reference external" href="https://github.com/gammapy/gammapy-data">gammapy-data</a> GitHub
repository. It is recommended that developers have <code class="xref py py-obj docutils literal notranslate"><span class="pre">$GAMMAPY_DATA</span></code> environment variable pointing to the local folder
where they have fetched the <a class="reference external" href="https://github.com/gammapy/gammapy-data">gammapy-data</a> GitHub repository,
so they can push and pull eventual modification of its content.</p>
</section>
<section id="making-a-pull-request-which-skips-github-actions">
<h3>Making a pull request which skips GitHub Actions<a class="headerlink" href="#making-a-pull-request-which-skips-github-actions" title="Link to this heading">#</a></h3>
<p>For minor PRs (eg: correcting typos in doc-strings) we can skip GitHub Actions.
Adding <code class="docutils literal notranslate"><span class="pre">[ci</span> <span class="pre">skip]</span></code> in a specific commit message will skip CI for that specific commit which can be useful for draft or incomplete PR.
For details, <a class="reference external" href="https://github.blog/changelog/2021-02-08-github-actions-skip-pull-request-and-push-workflows-with-skip-ci/">see here.</a></p>
</section>
<section id="fix-non-unix-line-endings">
<h3>Fix non-Unix line endings<a class="headerlink" href="#fix-non-unix-line-endings" title="Link to this heading">#</a></h3>
<p>In the past we had non-Unix (i.e. Mac or Windows) line endings in some files.
This can be painful, e.g. git diff and autopep8 behave strangely.
Here’s to commands to check for and fix this (see <a class="reference external" href="http://stackoverflow.com/a/22521008/498873">here</a>):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clean<span class="w"> </span>-fdx
find<span class="w"> </span>.<span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span>-print0<span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>-0<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span>-P<span class="w"> </span><span class="m">4</span><span class="w"> </span>dos2unix<span class="w"> </span>-c<span class="w"> </span>mac
find<span class="w"> </span>.<span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span>-print0<span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>-0<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span>-P<span class="w"> </span><span class="m">4</span><span class="w"> </span>dos2unix<span class="w"> </span>-c<span class="w"> </span>ascii
git<span class="w"> </span>status
<span class="nb">cd</span><span class="w"> </span>astropy_helpers<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>--<span class="w"> </span>.<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>..
</pre></div>
</div>
</section>
<section id="making-a-pull-request-that-requires-backport">
<h3>Making a pull request that requires backport<a class="headerlink" href="#making-a-pull-request-that-requires-backport" title="Link to this heading">#</a></h3>
<p>Some PRs will need to be backported to specific maintenance branches, for example
bug fixes or correcting typos in doc-strings. There are a few ways this can be done,
one of which involves the <a class="reference external" href="https://github.com/meeseeksmachine">meeseeksmachine</a>.</p>
<ol class="arabic simple">
<li><p>Add the backport label to automatically backport your PR. e.g. “<code class="docutils literal notranslate"><span class="pre">backport-v1.1.x</span></code>”</p></li>
<li><p>If you forgot, on your merged PR make the comment: “<code class="docutils literal notranslate"><span class="pre">&#64;meeseeksdev</span> <span class="pre">backport</span> <span class="pre">to</span> <span class="pre">[BRANCHNAME]</span></code>”</p></li>
<li><p>If this does not work automatically, a set of instructions will be given to you as a comment in the PR to be backported. This involves using the “<code class="docutils literal notranslate"><span class="pre">cherry-pick</span></code>” git command. See <a class="reference external" href="https://docs.astropy.org/en/latest/development/releasing.html#backporting-fixes-from-main">here</a> for information.</p></li>
</ol>
</section>
<section id="release-notes">
<h3>Release notes<a class="headerlink" href="#release-notes" title="Link to this heading">#</a></h3>
<p>In Gammapy we keep <a class="reference internal" href="../release-notes/index.html#release-notes"><span class="std std-ref">Release notes</span></a> with a list of pull requests.
We sort by release and within the release by PR number (the largest first).</p>
<p>As explained in the <a class="reference external" href="https://docs.astropy.org/en/latest/development/maintainers/maintainer_workflow.html#changelog-format" title="(in Astropy v7.1)"><span>Updating and Maintaining the Changelog</span></a> section in the Astropy docs,
there are (at least) two approaches for adding to the releases, each with pros
and cons.</p>
<p>We’ve had some pain due to merge conflicts in the releases notes and having to wait
until the contributor rebases (and having to explain git rebase to new contributors).</p>
<p>So our recommendation is that releases entries are not added in pull requests,
but that the core developer adds a releases notes entry after right after having
merged a pull request (you can add <code class="docutils literal notranslate"><span class="pre">[skip</span> <span class="pre">ci]</span></code> on this commit).</p>
</section>
</section>
<section id="how-to-handle-api-breaking-changes">
<h2>How to handle API breaking changes?<a class="headerlink" href="#how-to-handle-api-breaking-changes" title="Link to this heading">#</a></h2>
<p>As stated in PIG 23, API breaking changes can be introduced in feature and LTS releases.
This changes must be clearly identified in the release notes. To avoid abruptly changing
the API between consecutive version, forecoming API changes and deprecation must be announced
in the previous release, in particular, in the form of a deprecation warning to warn users of
future changes affecting their code.</p>
<p>The deprecation warning must be present in the next feature or LTS release after the change was
made. The feature can be removed in the following release.</p>
<p>We use a deprecation warning system based on decorators derived from the one implemented in Astropy.
Adding a decorator will raise a warning if the deprecated feature is called and it will also add a
message to its docstring.</p>
<section id="deprecating-a-function-or-a-class">
<h3>Deprecating a function or a class<a class="headerlink" href="#deprecating-a-function-or-a-class" title="Link to this heading">#</a></h3>
<p>To deprecate a function or a class, use the <code class="docutils literal notranslate"><span class="pre">&#64;deprecate</span></code> decorator, indicating the first release
following the change:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gammapy.utils.deprecation</span> <span class="kn">import</span> <span class="n">deprecated</span>

<span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;1.1&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">deprecated_function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</pre></div>
</div>
<p>If you want to indicate a new implementation to use instead, use the <code class="xref py py-obj docutils literal notranslate"><span class="pre">alternative</span></code> argument:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gammapy.utils.deprecation</span> <span class="kn">import</span> <span class="n">deprecated</span>

<span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;1.1&quot;</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s2">&quot;new_function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">deprecated_function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</pre></div>
</div>
</section>
<section id="renaming-an-argument">
<h3>Renaming an argument<a class="headerlink" href="#renaming-an-argument" title="Link to this heading">#</a></h3>
<p>If you change the name of an argument, you can use the <code class="docutils literal notranslate"><span class="pre">deprecated_renamed_argument</span></code> decorator.
It will replace the old argument with the new one in a call to the function and will raise the
<code class="docutils literal notranslate"><span class="pre">GammapyDeprecationWarning</span></code>. You can change several arguments at once.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gammapy.utils.deprecation</span> <span class="kn">import</span> <span class="n">deprecated_renamed_argument</span>

<span class="nd">@deprecated_renamed_argument</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;1.1&quot;</span><span class="p">,</span> <span class="s2">&quot;1.1&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">deprecated_argument_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="nb">print</span><span class="p">(</span><span class="n">deprecated_argument_function</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
<p>If you rename a <code class="xref py py-obj docutils literal notranslate"><span class="pre">kwarg</span></code> you simply need to set the <code class="xref py py-obj docutils literal notranslate"><span class="pre">arg_in_kwargs</span></code> argument to <a class="reference external" href="https://docs.python.org/3/library/constants.html#True" title="(in Python v3.13)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">True</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gammapy.utils.deprecation</span> <span class="kn">import</span> <span class="n">deprecated_renamed_argument</span>

<span class="nd">@deprecated_renamed_argument</span><span class="p">(</span><span class="s2">&quot;old&quot;</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">,</span> <span class="s2">&quot;1.1&quot;</span><span class="p">,</span> <span class="n">arg_in_kwargs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">deprecated_argument_function_kwarg</span><span class="p">(</span><span class="n">new</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">new</span>

<span class="nb">print</span><span class="p">(</span><span class="n">deprecated_argument_function_kwarg</span><span class="p">(</span><span class="n">old</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="removing-an-attribute">
<h3>Removing an attribute<a class="headerlink" href="#removing-an-attribute" title="Link to this heading">#</a></h3>
<p>You can also remove an attribute from a class using the <code class="docutils literal notranslate"><span class="pre">deprecated_attribute</span></code> decorator.
If you have a alternative attribute to use instead, pass its name in the <code class="xref py py-obj docutils literal notranslate"><span class="pre">alternative</span></code> argument.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gammapy.utils.deprecation</span> <span class="kn">import</span> <span class="n">deprecated_attribute</span>

<span class="k">class</span> <span class="nc">some_class</span><span class="p">:</span>
    <span class="n">old_attribute</span> <span class="o">=</span> <span class="n">deprecated_attribute</span><span class="p">(</span>
        <span class="s2">&quot;old_attribute&quot;</span><span class="p">,</span> <span class="s2">&quot;1.1&quot;</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s2">&quot;new_attribute&quot;</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_old_attribute</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_attribute</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">new_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_attribute</span>

<span class="nb">print</span><span class="p">(</span><span class="n">some_class</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">old_attribute</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="others">
<h2>Others<a class="headerlink" href="#others" title="Link to this heading">#</a></h2>
<section id="command-line-tools-using-click">
<h3>Command line tools using click<a class="headerlink" href="#command-line-tools-using-click" title="Link to this heading">#</a></h3>
<p>Command line tools that use the <a class="reference external" href="https://click.palletsprojects.com/en/8.0.x/">click</a> module should disable
the unicode literals warnings to clean up the output of the tool:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">click</span>
<span class="n">click</span><span class="o">.</span><span class="n">disable_unicode_literals_warning</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>See <a class="reference external" href="https://click.palletsprojects.com/en/5.x/python3/#unicode-literals">here</a> for further
information.</p>
</section>
<section id="bundled-gammapy-extern-code">
<h3>Bundled gammapy.extern code<a class="headerlink" href="#bundled-gammapy-extern-code" title="Link to this heading">#</a></h3>
<p>We bundle some code in <code class="docutils literal notranslate"><span class="pre">gammapy.extern</span></code>.
This is external code that we don’t maintain or modify in Gammapy.
We only bundle small pure-Python files (currently all single-file modules) purely for convenience,
because having to explain about these modules as Gammapy dependencies to end-users would be annoying.
And in some cases the file was extracted from some other project, i.e. can’t be installed
separately as a dependency.</p>
<p>For <code class="docutils literal notranslate"><span class="pre">gammapy.extern</span></code> we don’t generate Sphinx API docs.
To see what is there, check out the <code class="docutils literal notranslate"><span class="pre">gammapy/extern</span></code> directory locally or on
<a class="reference external" href="https://github.com/gammapy/gammapy/tree/master/gammapy/extern">GitHub</a>.
Notes on the bundled files are kept in the docstring of
<a class="reference external" href="https://github.com/gammapy/gammapy/blob/master/gammapy/extern/__init__.py">gammapy/extern/__init__.py</a>.</p>
</section>
<section id="locate-origin-of-warnings">
<h3>Locate origin of warnings<a class="headerlink" href="#locate-origin-of-warnings" title="Link to this heading">#</a></h3>
<p>By default, warnings appear on the console, but often it’s not clear where a given warning
originates (e.g. when building the docs or running scripts or tests) or how to fix it.</p>
<p>Sometimes putting this in <code class="docutils literal notranslate"><span class="pre">gammapy/__init__.py</span></code> can help:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Following the advice <a class="reference external" href="http://stackoverflow.com/questions/22373927/get-traceback-of-warnings/22376126#22376126">here</a>,
putting this in <code class="docutils literal notranslate"><span class="pre">docs/conf.py</span></code> can also help sometimes:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">warn_with_traceback</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">traceback</span><span class="o">.</span><span class="n">print_stack</span><span class="p">()</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">file</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;write&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">warnings</span><span class="o">.</span><span class="n">formatwarning</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">showwarning</span> <span class="o">=</span> <span class="n">warn_with_traceback</span>
</pre></div>
</div>
</section>
<section id="object-text-repr-str-and-info">
<h3>Object text repr, str and info<a class="headerlink" href="#object-text-repr-str-and-info" title="Link to this heading">#</a></h3>
<p>In Python, by default objects don’t have a good string representation. This
section explains how Python repr, str and print work, and gives guidelines for
writing <code class="docutils literal notranslate"><span class="pre">__repr__</span></code>, <code class="docutils literal notranslate"><span class="pre">__str__</span></code> and <code class="docutils literal notranslate"><span class="pre">info</span></code> methods on Gammapy classes.</p>
<p>Let’s use this as an example:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Anna&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
</pre></div>
</div>
<p>The default <code class="docutils literal notranslate"><span class="pre">repr</span></code> and <code class="docutils literal notranslate"><span class="pre">str</span></code> are this:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="p">()</span>
<span class="nb">repr</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="s1">&#39;&lt;__main__.Person object at 0x105fe3b70&gt;&#39;</span>
<span class="n">p</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
<span class="s1">&#39;&lt;__main__.Person object at 0x105fe3b70&gt;&#39;</span>
<span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="s1">&#39;&lt;__main__.Person object at 0x105fe3b70&gt;&#39;</span>
<span class="n">p</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
</pre></div>
</div>
<p>Users will see that. If they just give an object in the Python REPL, the
<code class="docutils literal notranslate"><span class="pre">repr</span></code> is shown. If they print the object, the <code class="docutils literal notranslate"><span class="pre">str</span></code> is shown. In both cases
without the quotes seen above.</p>
<blockquote>
<div><p>p
&lt;__main__.Person at 0x105fd0cf8&gt;
print(p)
&lt;__main__.Person object at 0x105fe3b70&gt;</p>
</div></blockquote>
<p>There are ways to make this better and avoid writing boilerplate code,
specifically <a class="reference external" href="http://www.attrs.org/">attrs</a> and <a class="reference external" href="https://docs.python.org/3/library/dataclasses.html">dataclasses</a>. We might use those in
the future in Gammapy, but for now, we don’t.</p>
<p>If you want a better repr or str for a given object, you have to add
<code class="docutils literal notranslate"><span class="pre">__repr__</span></code> and / or <code class="docutils literal notranslate"><span class="pre">__str__</span></code> methods when writing the class. Note that you
don’t have to do that, it’s mainly useful for objects users interact with a lot.
For classes that are mainly used internally, developers can e.g. just do this to
see the attributes printed nicely:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span><span class="o">.</span><span class="vm">__dict__</span>
<span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Anna&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>
</pre></div>
</div>
<p>Here’s an example how to write <code class="docutils literal notranslate"><span class="pre">__repr__</span></code>:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">(name=</span><span class="si">{!r}</span><span class="s1">, age=</span><span class="si">{!r}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>Note how we use <code class="docutils literal notranslate"><span class="pre">{!r}</span></code> in the format string to fill in the <code class="docutils literal notranslate"><span class="pre">repr</span></code> of the
object being formatted, and how we used <code class="docutils literal notranslate"><span class="pre">self.__class__.__name__</span></code> to avoid
duplicating the class name (easier to refactor code, and shows sub-class name if
repr is inherited).</p>
<p>This will give a nice string representation. The same one for <code class="docutils literal notranslate"><span class="pre">repr</span></code> and
<code class="docutils literal notranslate"><span class="pre">str</span></code>, you don’t have to write <code class="docutils literal notranslate"><span class="pre">__str__</span></code>:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Anna&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">p</span>
<span class="n">Person</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Anna&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">Person</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Anna&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</pre></div>
</div>
<p>The string representation is usually used for more informal or longer printout.
Here’s an example:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="s2">&quot;Hi, my name is </span><span class="si">{}</span><span class="s2"> and I&#39;m </span><span class="si">{}</span><span class="s2"> years old.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;I live in Heidelberg.&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age</span><span class="p">)</span>
</pre></div>
</div>
<p>If you need text representation that is configurable, i.e. tables arguments what
to show, you should add a method called <code class="docutils literal notranslate"><span class="pre">info</span></code>. To avoid code duplication, you
should then call <code class="docutils literal notranslate"><span class="pre">info</span></code> from <code class="docutils literal notranslate"><span class="pre">__str__</span></code>. Example:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Anna&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">(name=</span><span class="si">{!r}</span><span class="s1">, age=</span><span class="si">{!r}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">add_location</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">add_location</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Hi, my name is </span><span class="si">{}</span><span class="s2"> and I&#39;m </span><span class="si">{}</span><span class="s2"> years old.&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_location</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">I live in Heidelberg&quot;</span>
        <span class="k">return</span> <span class="n">s</span>
</pre></div>
</div>
<p>This pattern of returning a string from <code class="docutils literal notranslate"><span class="pre">info</span></code> has some pros and cons.
It’s easy to get the string, and do what you like with it, e.g. combine
it with other text, or store it in a list and write it to file later.
The main con is that users have to call <code class="docutils literal notranslate"><span class="pre">print(p.info())</span></code> to see a
nice printed version of the string instead of <code class="docutils literal notranslate"><span class="pre">\n</span></code>:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
<span class="s2">&quot;Hi, my name is Anna, and I&#39;m 8 years old.</span><span class="se">\n</span><span class="s2">I live in Heidelberg&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
<span class="n">Hi</span><span class="p">,</span> <span class="n">my</span> <span class="n">name</span> <span class="ow">is</span> <span class="n">Anna</span><span class="p">,</span> <span class="ow">and</span> <span class="n">I</span><span class="s1">&#39;m 8 years old.</span>
<span class="n">I</span> <span class="n">live</span> <span class="ow">in</span> <span class="n">Heidelberg</span>
</pre></div>
</div>
<p>To make <code class="docutils literal notranslate"><span class="pre">info</span></code> print by default, and be re-usable from <code class="docutils literal notranslate"><span class="pre">__str__</span></code> and make it
possible to get a string (without having to monkey-patch <code class="docutils literal notranslate"><span class="pre">sys.stdout</span></code>), would
require adding this <code class="docutils literal notranslate"><span class="pre">show</span></code> option and if-else at the end of every <code class="docutils literal notranslate"><span class="pre">info</span></code>
method:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">add_location</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">add_location</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Hi, my name is </span><span class="si">{}</span><span class="s2"> and I&#39;m </span><span class="si">{}</span><span class="s2"> years old.&quot;</span>
         <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">add_location</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">I live in Heidelberg&quot;</span>

    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span>
</pre></div>
</div>
<p>To summarise: start without adding and code for text representation. If there’s a
useful short text representation, you can add a <code class="docutils literal notranslate"><span class="pre">__repr__</span></code>. If really useful,
add a <code class="docutils literal notranslate"><span class="pre">__str__</span></code>. If you need it configurable, add an <code class="docutils literal notranslate"><span class="pre">info</span></code> and call
<code class="docutils literal notranslate"><span class="pre">info</span></code> from <code class="docutils literal notranslate"><span class="pre">str</span></code>. If <code class="docutils literal notranslate"><span class="pre">repr</span></code> and <code class="docutils literal notranslate"><span class="pre">str</span></code> are similar, it’s not really
useful: delete the <code class="docutils literal notranslate"><span class="pre">__str__</span></code> and only keep the <code class="docutils literal notranslate"><span class="pre">__repr__</span></code>.</p>
<p>It is common to have bugs in <code class="docutils literal notranslate"><span class="pre">__repr__</span></code>, <code class="docutils literal notranslate"><span class="pre">__str__</span></code> and <code class="docutils literal notranslate"><span class="pre">info</span></code> that are not
tested. E.g. a <code class="docutils literal notranslate"><span class="pre">NameError</span></code> or <code class="docutils literal notranslate"><span class="pre">AttributeError</span></code> because some attribute name
changed, and updating the repr / str / info was forgotten. So tests should be added
that execute these methods once. You can write the reference string in the output,
but that is not required (and actually very hard for cases where you have floats
or Numpy arrays or str, where formatting differs across Python or Numpy version).
Example what to put as a test:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_person_txt</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">repr</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Person&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Hi&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">p</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">add_location</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;Heidelberg&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="output-in-jupyter-notebook-cells">
<h3>Output in Jupyter notebook cells<a class="headerlink" href="#output-in-jupyter-notebook-cells" title="Link to this heading">#</a></h3>
<p>In addition to the standard <a class="reference external" href="https://docs.python.org/3/library/functions.html#repr" title="(in Python v3.13)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">repr</span></code></a> and <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a> outputs, Jupyter notebook
cells have the option to display nicely formatted (HTML) output, using
the IPython rich display options (other output options also exist,
such as LaTeX or SVG, but these are less used). This requires the
implementation of a <code class="xref py py-obj docutils literal notranslate"><span class="pre">_repr_html_(self)</span></code> method (note: single
underscore) in a class.</p>
<p>By default, this method can just return the string representation of
the object (which may already produce a nicely formatted output). That
is often nicer than the default, which is to return the <a class="reference external" href="https://docs.python.org/3/library/functions.html#repr" title="(in Python v3.13)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">repr</span></code></a> output,
which tends to be shorter and may miss details of the object. Thus,
the following would be a good default for a new class:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;pre&gt;html.escape(str(self))&lt;/pre&gt;&#39;</span>
</pre></div>
</div>
<p>The surrounding <code class="xref py py-obj docutils literal notranslate"><span class="pre">&lt;pre&gt;</span></code> takes care that the formatting in HTML is the
same as that for the normal <code class="xref py py-obj docutils literal notranslate"><span class="pre">__str__</span></code> method, while <a class="reference external" href="https://docs.python.org/3/library/html.html#html.escape" title="(in Python v3.13)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">html.escape</span></code></a>
handles escaping HTML special characters (&lt;, &gt;, &amp;, “ and ‘).</p>
<p>Note that if no <code class="xref py py-obj docutils literal notranslate"><span class="pre">__str__</span></code> method is implemented, <code class="xref py py-obj docutils literal notranslate"><span class="pre">__repr__</span></code> is used,
and ultimately, the Python built-in <code class="xref py py-obj docutils literal notranslate"><span class="pre">__repr__</span></code> method serves as the
final fallback (which looks like <code class="xref py py-obj docutils literal notranslate"><span class="pre">&lt;gammapy.data.event_list.EventList</span>
<span class="pre">at</span> <span class="pre">0x129602550&gt;</span></code> or similar).</p>
<p>If more specific HTML output is preferred (for example, output
formatted in a HTML table or list), it is best to create a separate
<code class="xref py py-obj docutils literal notranslate"><span class="pre">to_html(self)</span></code> method in the class, which is more explicit (and can
be documentated as part of the API), and let <code class="xref py py-obj docutils literal notranslate"><span class="pre">_repr_html_</span></code> call this
method:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
<p>Thus very similar to <code class="xref py py-obj docutils literal notranslate"><span class="pre">__str__</span></code> calling <code class="xref py py-obj docutils literal notranslate"><span class="pre">info()</span></code>, with optional
parameters if needed.</p>
<p>To allow for both options, the following default <code class="xref py py-obj docutils literal notranslate"><span class="pre">_repr_html_</span></code> can be
implemented instead:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
       <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
   <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
       <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;pre&gt;html.escape(str(self))&lt;/pre&gt;&#39;</span>
</pre></div>
</div>
<p>Nearly all base classes in Gammapy implement this default
<code class="xref py py-obj docutils literal notranslate"><span class="pre">_repr_html_</span></code>. If a new class derives from an existing Gammapy class,
a default implementation is not needed, since it will rely on its
(grand)parent. As a result, for specific HTML output, only the
<code class="xref py py-obj docutils literal notranslate"><span class="pre">to_html</span></code> method needs to be implented for the relevant class.</p>
</section>
<section id="convert-a-jupyter-notebook-to-python-script-in-the-sphinx-gallery-format">
<h3>Convert a jupyter notebook to python script in the sphinx-gallery format<a class="headerlink" href="#convert-a-jupyter-notebook-to-python-script-in-the-sphinx-gallery-format" title="Link to this heading">#</a></h3>
<p>The tutorials in Gammapy are represented by python scripts written in the sphinx-gallery format. However, since they are
displayed as jupyter notebooks in the documentation,
it is usually easier to first create a tutorial in a jupyter notebook and then convert
it into a python script. This can be done using <code class="docutils literal notranslate"><span class="pre">ipynb_to_gallery.py</span></code> script located in the <code class="docutils literal notranslate"><span class="pre">dev</span></code> folder. This
script can be used as follows:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">dev</span><span class="o">/</span><span class="n">ipynb_to_gallery</span><span class="o">.</span><span class="n">py</span> <span class="o">&lt;</span><span class="n">path_to_notebook</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">Optional</span><span class="p">)</span><span class="o">&lt;</span><span class="n">path_to_script</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>If the path of the output file is not provided, the script will be written in the same folder as the notebook and with
the same name.</p>
</section>
</section>
</section>


                </article>
              
              
              
              
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#general-conventions">General conventions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#python-version-support">Python version support</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#coordinate-and-axis-names">Coordinate and axis names</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#clobber-or-overwrite">Clobber or overwrite?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pixel-coordinate-convention">Pixel coordinate convention</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bsd-or-gpl-license">BSD or GPL license?</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-write-code">How to write code</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#where-should-i-import-from">Where should I import from?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#functions-returning-several-values">Functions returning several values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#what-checks-and-conversions-should-i-do-for-inputs">What checks and conversions should I do for inputs?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#float-data-type-32-bit-or-64-bit">Float data type: 32 bit or 64 bit?</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-use-random-numbers">How to use random numbers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-use-logging">How to use logging</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-log-messages">Generating log messages</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpolation-and-extrapolation">Interpolation and extrapolation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-write-tests">How to write tests</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assert-convention">Assert convention</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-of-plotting-functions">Testing of plotting functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#skip-unit-tests-for-some-astropy-versions">Skip unit tests for some Astropy versions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#caplog-fixture">Caplog fixture</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-make-a-pull-request">How to make a pull request</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#making-a-pull-request-with-new-or-modified-datasets">Making a pull request with new or modified datasets</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#making-a-pull-request-which-skips-github-actions">Making a pull request which skips GitHub Actions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fix-non-unix-line-endings">Fix non-Unix line endings</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#making-a-pull-request-that-requires-backport">Making a pull request that requires backport</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#release-notes">Release notes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-handle-api-breaking-changes">How to handle API breaking changes?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deprecating-a-function-or-a-class">Deprecating a function or a class</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#renaming-an-argument">Renaming an argument</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-an-attribute">Removing an attribute</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#others">Others</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#command-line-tools-using-click">Command line tools using click</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bundled-gammapy-extern-code">Bundled gammapy.extern code</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#locate-origin-of-warnings">Locate origin of warnings</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#object-text-repr-str-and-info">Object text repr, str and info</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#output-in-jupyter-notebook-cells">Output in Jupyter notebook cells</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#convert-a-jupyter-notebook-to-python-script-in-the-sphinx-gallery-format">Convert a jupyter notebook to python script in the sphinx-gallery format</a></li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/development/dev_howto.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, The Gammapy developers.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
    
     <a href="https://gammapy.org/DataPrivacy.html">Data Privacy.</a>
</div>
      
    </div>
  
  
    <div class="footer-items__center">
      
        <div class="footer-item"><p class="last-updated">
  Last updated on 26 Nov 2024.
  <br/>
</p></div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    <br/>
  </p>
</div>
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.0.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>