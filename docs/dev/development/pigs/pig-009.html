
<!DOCTYPE html>


<html lang="en" data-content_root="../../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>PIG 9 - Event sampling &#8212; gammapy vX.Y.Z</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=947a6bef" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../_static/documentation_options.js?v=1f75dfce"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=30646c52"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'development/pigs/pig-009';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.0';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://docs.gammapy.org/stable/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'dev';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = false;
        </script>
    <script src="../../_static/matomo.js?v=52704cab"></script>
    <link rel="icon" href="../../_static/gammapy_logo.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="PIG 10 - Regions" href="pig-010.html" />
    <link rel="prev" title="PIG 8 - Datasets" href="pig-008.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="2.0.dev100+gdfd7116c9" />
    <meta name="docbuild:last-update" content="26 Nov 2024"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
    
    <img src="../../_static/gammapy_logo_nav.png" class="logo__image only-light" alt="gammapy vX.Y.Z - Home"/>
    <img src="../../_static/gammapy_logo_nav.png" class="logo__image only-dark pst-js-only" alt="gammapy vX.Y.Z - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../getting-started/index.html">
    Getting started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../user-guide/index.html">
    User guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api-reference/index.html">
    API reference
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    Developer guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../release-notes/index.html">
    Release notes
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/gammapy/gammapy" title="Github" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Github</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/gammapyST" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-square-x-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://gammapy.slack.com/" title="Slack" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-slack fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Slack</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../getting-started/index.html">
    Getting started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../user-guide/index.html">
    User guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api-reference/index.html">
    API reference
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    Developer guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../release-notes/index.html">
    Release notes
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/gammapy/gammapy" title="Github" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Github</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/gammapyST" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-square-x-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://gammapy.slack.com/" title="Slack" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-slack fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Slack</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../setup.html">Project setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dependencies.html">Dependencies</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">How to contribute to Gammapy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release.html">How to make a Gammapy release</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../doc_howto.html">Documentation How To</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_howto.html">Developer How To</a></li>
</ul>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">PIGs</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="pig-001.html">PIG 1 - PIG purpose and guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-002.html">PIG 2 - Organization of low level analysis code</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-003.html">PIG 3 - Plan for dropping Python 2.7 support</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-004.html">PIG 4 - Setup for tutorial notebooks and data</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-005.html">PIG 5 - Gammapy 1.0 roadmap</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-006.html">PIG 6 - CTA observation handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-007.html">PIG 7 - Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-008.html">PIG 8 - Datasets</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">PIG 9 - Event sampling</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-010.html">PIG 10 - Regions</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-011.html">PIG 11 - Light curves</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-012.html">PIG 12 - High level interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-013.html">PIG 13 - Gammapy dependencies and distribution</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-014.html">PIG 14 - Uncertainty estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-016.html">PIG 16 - Gammapy package structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-018.html">PIG 18 - Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-019.html">PIG 19 - Gammapy package structure follow up</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-020.html">PIG 20 - Global Model API</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-021.html">PIG 21 - Models improvements</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-022.html">PIG 22 - Unified flux estimators API</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-023.html">PIG 23 - Gammapy release cycle and version numbering</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-024.html">PIG 24 - Authorship policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-025.html">PIG 25 - Metadata container for Gammapy</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-026.html">PIG 26 - Model Priors API</a></li>
</ul>
</details></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Developer guide</a></li>
    
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">PIGs</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">PIG 9 - Event sampling</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="pig-9-event-sampling">
<span id="pig-009"></span><h1>PIG 9 - Event sampling<a class="headerlink" href="#pig-9-event-sampling" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>Author: Fabio Pintore, Andrea Giuliani, Axel Donath</p></li>
<li><p>Created: May 03, 2019</p></li>
<li><p>Accepted: Aug 30, 2019</p></li>
<li><p>Status: accepted</p></li>
<li><p>Discussion: <a class="reference external" href="https://github.com/gammapy/gammapy/pull/2136">GH 2136</a></p></li>
</ul>
<section id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Link to this heading">#</a></h2>
<p>An event sampler for gamma events is an important part of the science tools of
the future Cherenkov Telescope Array (CTA) observatory. It will allow users to
simulate observations of sources with different spectral, morphological and
temporal properties and predict the performance of CTA on the simulated events
e.g. to support observation proposals or study the sensitivity of future
observations. For this reason, we propose to implement a framework for event
simulation in Gammapy.</p>
<p>The proposed framework consists of individual building blocks, represented by
classes and methods, that can be chained together to achieve a full simulation
of an event list corresponding to a given observation. This includes the
simulation of source events, background events, effects of instrument response
functions (IRF) and arrival times. As underlying method for the actual event
sampling we propose to use inverse cumulative distribution function (CDF)
sampling (<a class="reference external" href="https://en.wikipedia.org/wiki/Inverse_transform_sampling">inverseCDF</a>) with finely binned discrete source and background.
Temporal models will be also taken into account and time will be sampled
separately in a 1D analysis, assuming that the temporal dependency of the input
source models factorizes.</p>
</section>
<section id="sampling-methods">
<h2>Sampling methods<a class="headerlink" href="#sampling-methods" title="Link to this heading">#</a></h2>
<p>Inverse CDF sampling (<a class="reference external" href="https://en.wikipedia.org/wiki/Inverse_transform_sampling">inverseCDF</a>) is an established method to sample from
discrete probability mass functions. It is used by <code class="docutils literal notranslate"><span class="pre">ASTRIsim</span></code> (<a class="reference external" href="https://github.com/cento14/Astrisim">astrisim</a>), the
event simulator of the AGILE collaboration. However it is not the method of
choice for other existing event samplers such as the the Fermi-LAT Science Tools
(gtobsim) and CTOOLS (ctobssim). The latter uses a combination of analytical
sampling for models, where a solution is known (e.g. power-laws) and the
rejection sampling method (<a class="reference external" href="https://en.wikipedia.org/wiki/Rejection_sampling">rej_sampl</a>), where the sampling has to be done
numerically (see an example here <a class="reference external" href="http://cta.irap.omp.eu/gammalib-devel/">gammalib</a>).</p>
<p>As rejection sampling can directly sample from continuous probability density
functions, it is expected to yield very precise results. However an enveloping
distribution is needed, which should be adapted to the target distribution to be
efficient (see also <a class="reference external" href="https://wiseodd.github.io/techblog/2015/10/21/rejection-sampling/">rejection sampling in Python</a> for an example
implementation), otherwise a lot of computation time is spend in rejecting drawn
samples.</p>
<p>For this reason we favour the inverse CDF sampling method, as a simple to
implement and general sampling method. The precision of the inverse CDF sampling
method can be controlled by the resolution of the input probability mass
function (PMF) and is in practice only limited by the available memory. We will
study the required bin-size of the PMFs to reach sufficient precision. If we
find the inverse CDF sampling method to be not precise enough, it is still
possible to achieve better precision adopting the rejection sampling. This will
not have a strong impact on the structure of the event-sampler.</p>
</section>
<section id="proposal">
<h2>Proposal<a class="headerlink" href="#proposal" title="Link to this heading">#</a></h2>
<p>We propose to include in <code class="docutils literal notranslate"><span class="pre">gammapy.cube</span></code> an high level interface (HLI) class,
labelled as <code class="docutils literal notranslate"><span class="pre">MapDatasetEventSampler</span></code> or <code class="docutils literal notranslate"><span class="pre">MapDataset.sample</span></code> method. This
class handles the complete event sampling process, including the corrections
related to the IRF and source temporal variability, for a given GTI /
observation.</p>
<p>The dataset will be computed using the standard data reduction procedure of
Gammapy, as illustrated in the following example:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">obs</span> <span class="o">=</span> <span class="n">Observation</span><span class="p">(</span><span class="n">pointing</span><span class="p">,</span> <span class="n">gti</span><span class="p">,</span> <span class="n">aeff</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">edisp</span><span class="p">,</span> <span class="n">expomap</span><span class="p">)</span>
<span class="n">maker</span> <span class="o">=</span> <span class="n">MapDatasetMaker</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">geom_irf</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">SkyModels</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;model.yaml&quot;</span><span class="p">)</span>
<span class="n">dataset</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
<span class="n">sampler</span> <span class="o">=</span> <span class="n">MapDatasetEventSampler</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="n">events</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<span class="n">events</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
</pre></div>
</div>
<p>After data reduction, the Dataset object should contain all the needed
information, such as the pointing sky coordinates, the GTI, and the setup of all
the models (spectra, spatial morphology, temporal model) for any given source,
and it is passed as input parameter to the <code class="docutils literal notranslate"><span class="pre">MapDatasetEventSampler</span></code>. It is
important to note that the <code class="docutils literal notranslate"><span class="pre">MapDataset</span></code> object can store information for more
than one source. Then, a <code class="docutils literal notranslate"><span class="pre">.sample</span></code> method will draw the sampled events and
will provide an output <code class="docutils literal notranslate"><span class="pre">~astropy.table.Table</span></code> object. The latter will contain
the reconstructed sky positions, energies, times, and an <code class="docutils literal notranslate"><span class="pre">EVENT_ID</span></code> and
<code class="docutils literal notranslate"><span class="pre">MC_ID</span></code>. <code class="docutils literal notranslate"><span class="pre">EVENT_ID</span></code> is a unique number or a string to identify the sampled
event, while <code class="docutils literal notranslate"><span class="pre">MC_ID</span></code> is a unique ID (number or string) to identify the model
component the event was sampled from. The <code class="docutils literal notranslate"><span class="pre">MapDatasetSampler</span></code> should also fill
the mandatory header information for event list files described on <a class="reference external" href="https://gamma-astro-data-formats.readthedocs.io/">gadf</a>.</p>
<section id="mapdataseteventsampler">
<h3>MapDatasetEventSampler<a class="headerlink" href="#mapdataseteventsampler" title="Link to this heading">#</a></h3>
<p>The general design of the <code class="docutils literal notranslate"><span class="pre">sample</span></code> method is as follows:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>
<span class="w">   </span><span class="sd">&quot;&quot;&quot;Sample events from a ``MapDataset``&quot;&quot;&quot;</span>

   <span class="n">events_list</span> <span class="o">=</span> <span class="p">[]</span>

   <span class="k">for</span> <span class="n">evaluator</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">evaluators</span><span class="p">:</span>
        <span class="n">npred</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">compute_npred</span><span class="p">()</span>
        <span class="n">n_events</span> <span class="o">=</span> <span class="n">random_state</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">npred</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">npred</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n_events</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">LightCurveTableModel</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n_events</span><span class="o">=</span><span class="p">,</span> <span class="n">lc</span><span class="o">=</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="p">)</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span><span class="n">events</span><span class="p">,</span><span class="n">time</span><span class="p">)</span>
        <span class="n">events_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
        <span class="n">event_list</span><span class="p">[</span><span class="s2">&quot;MC_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span>

   <span class="n">events_src</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">(</span><span class="n">events_list</span><span class="p">)</span>
   <span class="n">events_src</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">psf</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">events_src</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>
   <span class="n">events_src</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">edisp</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">events_src</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>

   <span class="n">n_events_bkg</span> <span class="o">=</span> <span class="n">random_state</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">background_model</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
   <span class="n">events_bkg</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">background_model</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n_events</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>

   <span class="n">events_total</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">([</span><span class="n">events_src</span><span class="p">,</span> <span class="n">events_bkg</span><span class="p">])</span>
   <span class="n">events_total</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">get_events_meta_data</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">EventList</span><span class="p">(</span><span class="n">events_total</span><span class="p">)</span>
</pre></div>
</div>
<p>In more detail, <code class="docutils literal notranslate"><span class="pre">sample</span></code> starts a loop over the sources stored into the
<code class="docutils literal notranslate"><span class="pre">MapDataset</span></code> model. Then, for each source, the <code class="docutils literal notranslate"><span class="pre">src.compute_npred</span></code> method
will calculate the predicted number of source counts <code class="docutils literal notranslate"><span class="pre">npred</span></code>. In particular,
it is important to note that <code class="docutils literal notranslate"><span class="pre">npred</span> <span class="pre">=</span> <span class="pre">exposure</span> <span class="pre">*</span> <span class="pre">flux</span></code>, where <code class="docutils literal notranslate"><span class="pre">exposure</span></code> is
defined as <code class="docutils literal notranslate"><span class="pre">effective_area</span> <span class="pre">*</span> <span class="pre">exposure_time</span></code>. <code class="docutils literal notranslate"><span class="pre">npred</span></code> is therefore calculated
irrespective of the energy dispersion and of PSF. Then, <code class="docutils literal notranslate"><span class="pre">npred</span></code> will be the
input of the <code class="docutils literal notranslate"><span class="pre">npred.sample</span></code> method. The latter uses a Poisson distribution,
with mean equal to the predicted counts, to estimate the random number of
sampled events.</p>
<p>We propose to add a <code class="docutils literal notranslate"><span class="pre">Map.sample(n_events=,</span> <span class="pre">random_state=)</span></code> method in
<code class="docutils literal notranslate"><span class="pre">~gammapy.maps.Map</span></code> that will be the core of the sampling process. The
<code class="docutils literal notranslate"><span class="pre">sample</span></code> is based on the <code class="docutils literal notranslate"><span class="pre">~gammapy.utils.random.InverseCDFSampler</span></code> class
described in <a class="reference external" href="https://github.com/gammapy/gammapy/pull/2229">GH 2229</a> . The output will be an <code class="docutils literal notranslate"><span class="pre">~astropy.table.Table</span></code> with
columns: <code class="docutils literal notranslate"><span class="pre">RA_TRUE</span></code>, <code class="docutils literal notranslate"><span class="pre">DEC_TRUE</span></code> and <code class="docutils literal notranslate"><span class="pre">ENERGY_TRUE</span></code> .</p>
<p>Then, the time will be sampled independently using the temporal information
stored into the <code class="docutils literal notranslate"><span class="pre">MapDataset</span></code> model for each source of interest. This will be
done through a <code class="docutils literal notranslate"><span class="pre">.sample(n_events=,</span> <span class="pre">random_state=)</span></code> method that we propose to
add to <code class="docutils literal notranslate"><span class="pre">~gammapy.time.models.LightCurveTableModel</span></code> and
<code class="docutils literal notranslate"><span class="pre">~gammapy.time.models.PhaseCurveTableModel</span></code>. This method will take as input
the GTIs (i.e. one Tstart and Tstop) in the <code class="docutils literal notranslate"><span class="pre">MapDataset</span></code> object. Also in this
case the <code class="docutils literal notranslate"><span class="pre">InverseCDFSampler</span></code> class is the machine used to sample the time of
the events. In the case the temporal model is not provided, the time is
uniformly sampled in the time range <code class="docutils literal notranslate"><span class="pre">t_min</span></code> and <code class="docutils literal notranslate"><span class="pre">t_max</span></code>. To define a
light-curve per model component, the current <code class="docutils literal notranslate"><span class="pre">SkyModel</span></code> class will be extended
by a <code class="docutils literal notranslate"><span class="pre">SkyModel(...,</span> <span class="pre">temporal_model=)</span></code>.</p>
<p>The IRF correction can now be applied to sampled events. We propose to add a
<code class="docutils literal notranslate"><span class="pre">.sample(events=)</span></code> method in both <code class="docutils literal notranslate"><span class="pre">~gammapy.cube.PSFMap</span></code> and
<code class="docutils literal notranslate"><span class="pre">~gammapy.cube.EdispMap</span></code>. The method interpolates the “correct” IRF at the
position of a given event and applies it. In more detail, the method calculates
the psf and the energy dispersion at the events true positions and true
energies, which are given in input as an <code class="docutils literal notranslate"><span class="pre">~astropy.table.Table</span></code> object. The
IRFs are assumed to be constant and not time-dependent. The output will be an
<code class="docutils literal notranslate"><span class="pre">~astropy.table.Table</span></code> with the new columns <code class="docutils literal notranslate"><span class="pre">RA</span></code>, <code class="docutils literal notranslate"><span class="pre">DEC</span></code> and <code class="docutils literal notranslate"><span class="pre">ENERGY</span></code>,
which are the reconstructed event energies and positions.</p>
<p>Finally, the times and the energies/coordinates of the events will be merged
into a single <code class="docutils literal notranslate"><span class="pre">~astropy.table.Table</span></code> with the columns:<code class="docutils literal notranslate"><span class="pre">RA</span></code>, <code class="docutils literal notranslate"><span class="pre">DEC</span></code> and
<code class="docutils literal notranslate"><span class="pre">ENERGY</span></code> and <code class="docutils literal notranslate"><span class="pre">TIME</span></code> .</p>
<p>The <code class="docutils literal notranslate"><span class="pre">MapDatasetEventSampler</span></code> can be used to sample background events using the
<code class="docutils literal notranslate"><span class="pre">Map.sample(n_events=,</span> <span class="pre">random_state=)</span></code> as well. The time of the events is
sampled assuming a constant event rate. Finally, the IRF corrections are not
applied to background sampled events.</p>
</section>
</section>
<section id="performance-and-precision-evaluation">
<h2>Performance and precision evaluation<a class="headerlink" href="#performance-and-precision-evaluation" title="Link to this heading">#</a></h2>
<p>To evaluate the precision and performance of the described framework we propose
to implement a prototype for a simulation / fitting pipeline. Starting from a
selection of spatial, spectral and temporal models, data are simulated and
fitted multiple times to derive distributions and pull-distributions of the
reconstructed model parameters. This pipeline should also monitor the required
cpu and memory usage. This first prototype can be used to evaluate the optimal
bin-size (with the best compromise between performance and precision) for the
simulations and to verify the over-all correctness of the simulated data. This
will be valid for a set of input maps and IRFs. Later this prototype can be
developed further into a full simulation / fitting continuous integration
system.</p>
</section>
<section id="alternatives-outlook">
<h2>Alternatives / Outlook<a class="headerlink" href="#alternatives-outlook" title="Link to this heading">#</a></h2>
<p>So far Gammapy only supports binned likelihood analysis and technically most
use- cases for the event sampling could be solved with binned simulations. A
binned simulation can be basically achieved by a call to
<code class="docutils literal notranslate"><span class="pre">numpy.random.poisson()</span></code> based on the predicted number of counts map. This is
conceptionally simpler as well as computationally more efficient than a sampling
of event lists. In <code class="docutils literal notranslate"><span class="pre">Gammapy</span></code> a similar dataset simulation is already
implemented in <code class="docutils literal notranslate"><span class="pre">Dataset.fake()</span></code>, although this has a limited number of use
cases than an event sampler. However, to support the full data access and data
reduction process for simulations, event lists are required. In future Gammapy
possibly also supports event based analysis methods (unbinned likelihood, but
also e.g. clustering algorithms), that also require event lists. For this reason
binned simulations cannot present a full equivalent solution to event sampling.</p>
<p>The question of the API to simulate multiple observations from e.g. an
<code class="docutils literal notranslate"><span class="pre">ObservationTable</span></code> or a list of <code class="docutils literal notranslate"><span class="pre">GTIs</span></code> as it is needed for simulating data
for the CTA data challenge is not addressed in this PIG. For the scope of this
PIG, the fundamental class <code class="docutils literal notranslate"><span class="pre">MapDatasetEventSampler</span></code> to simulate events
corresponding to a given observation and/or single GTI is in place.</p>
<p>The proposed Event Sampler will not provide, for each event, the corresponding
<code class="docutils literal notranslate"><span class="pre">DETX</span></code> and <code class="docutils literal notranslate"><span class="pre">DETY</span></code> position. These will be added in a future development of
the simulator.</p>
</section>
<section id="task-list">
<h2>Task list<a class="headerlink" href="#task-list" title="Link to this heading">#</a></h2>
<p>This is a proposal for a list of tasks to implement the proposed changes:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Implement the <code class="docutils literal notranslate"><span class="pre">sample</span></code> method in <code class="docutils literal notranslate"><span class="pre">gammapy.maps.Map</span></code> and add tests.</p></li>
<li><p>Implement the <code class="docutils literal notranslate"><span class="pre">sample</span></code> method in <code class="docutils literal notranslate"><span class="pre">gammapy.time.models.LightCurveTableModel</span></code> and <code class="docutils literal notranslate"><span class="pre">gammapy.time.models.PhaseCurveTableModel</span></code> and add tests.</p></li>
<li><p>Implement the <code class="docutils literal notranslate"><span class="pre">sample</span></code> method in <code class="docutils literal notranslate"><span class="pre">gammapy.cube.PSFMap</span></code> and add tests.</p></li>
<li><p>Implement the <code class="docutils literal notranslate"><span class="pre">sample</span></code> method in <code class="docutils literal notranslate"><span class="pre">gammapy.cube.EdispMap</span></code> and add tests.</p></li>
<li><p>Introduce the <code class="docutils literal notranslate"><span class="pre">MapDatasetEventSampler</span></code> into <code class="docutils literal notranslate"><span class="pre">gammapy.cube.</span></code> and add tests.</p></li>
<li><p>Add tutorials for event simulations of different kinds of sources.</p></li>
</ol>
</div></blockquote>
</section>
<section id="decision">
<h2>Decision<a class="headerlink" href="#decision" title="Link to this heading">#</a></h2>
<p>The PIG was discussed extensively in <a class="reference external" href="https://github.com/gammapy/gammapy/pull/2136">GH 2136</a>, the weekly Gammapy developer
calls and coding sprint in person. After the deadline for final review expired
on August 20, all remaining comments were addressed and the PIG was accepted on
August 30, 2019.</p>
</section>
</section>


                </article>
              
              
              
              
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#abstract">Abstract</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sampling-methods">Sampling methods</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#proposal">Proposal</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mapdataseteventsampler">MapDatasetEventSampler</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#performance-and-precision-evaluation">Performance and precision evaluation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#alternatives-outlook">Alternatives / Outlook</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#task-list">Task list</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decision">Decision</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../../_sources/development/pigs/pig-009.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, The Gammapy developers.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
    
     <a href="https://gammapy.org/DataPrivacy.html">Data Privacy.</a>
</div>
      
    </div>
  
  
    <div class="footer-items__center">
      
        <div class="footer-item"><p class="last-updated">
  Last updated on 26 Nov 2024.
  <br/>
</p></div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    <br/>
  </p>
</div>
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.0.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>