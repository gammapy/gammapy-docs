
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>PIG 9 - Event sampling &#8212; gammapy vX.Y.Z</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gammapy.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../../_static/gammapy_logo.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="PIG 10 - Regions" href="pig-010.html" />
    <link rel="prev" title="PIG 8 - Datasets" href="pig-008.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../index.html">
  <img src="../../_static/gammapy_logo_nav.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../getting-started/index.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../user-guide/index.html">
  User guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../tutorials/index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../api-reference/index.html">
  API reference
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../index.html">
  Developer guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../release-notes/index.html">
  Release notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-primary btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        dev  <!-- this text may get changed later by javascript -->
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
</div>

<!-- NOTE: this JS must live here (not in our global JS file) because it relies
     on being processed by Jinja before it is run (specifically for replacing
     variables development/pigs/pig-009 and {'json_url': 'https://docs.gammapy.org/stable/switcher.json', 'version_match': 'dev'}.
-->

<script type="text/javascript">
// Check if corresponding page path exists in other version of docs
// and, if so, go there instead of the homepage of the other docs version
function checkPageExistsAndRedirect(event) {
    const currentFilePath = "development/pigs/pig-009.html",
          tryUrl = event.target.getAttribute("href");
    let otherDocsHomepage = tryUrl.replace(currentFilePath, "");
    $.ajax({
        type: 'HEAD',
        url: tryUrl,
        // if the page exists, go there
        success: function() {
            location.href = tryUrl;
        }
    }).fail(function() {
        location.href = otherDocsHomepage;
    });
    // this prevents the browser from following the href of the clicked node
    // (which is fine because this function takes care of redirecting)
    return false;
}

// Populate the version switcher from the JSON config file
(function () {
    $.getJSON("https://docs.gammapy.org/stable/switcher.json", function(data, textStatus, jqXHR) {
        const currentFilePath = "development/pigs/pig-009.html";
        // create links to the corresponding page in the other docs versions
        $.each(data, function(index, entry) {
            // if no custom name specified (e.g., "latest"), use version string
            if (!("name" in entry)) {
                entry.name = entry.version;
            }
            // create the node
            const node = document.createElement("a");
            node.setAttribute("class", "list-group-item list-group-item-action py-1");
            node.textContent = `${entry.name}`;
            node.setAttribute("href", `${entry.url}${currentFilePath}`);
            // on click, AJAX calls will check if the linked page exists before
            // trying to redirect, and if not, will redirect to the homepage
            // for that version of the docs.
            node.onclick = checkPageExistsAndRedirect;
            // Add dataset values for the version and name in case people want
            // to apply CSS styling based on this information.
            node.dataset["versionName"] = entry.name;
            node.dataset["version"] = entry.version;

            $("#version_switcher_menu").append(node);
            // replace dropdown button text with the preferred display name of
            // this version, rather than using sphinx's 1.1.dev199+gaf6187bed variable.
            // also highlight the dropdown entry for the currently-viewed
            // version's entry
            if (entry.version == "dev") {
                node.classList.add("active");
                let btn = document.getElementById("version_switcher_button");
                btn.innerText = btn.dataset["activeVersionName"] = entry.name;
                btn.dataset["activeVersion"] = entry.version;
            }
        });
    });
})();
</script>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/gammapy/gammapy" rel="noopener" target="_blank" title="Github"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">Github</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/gammapyST" rel="noopener" target="_blank" title="Twitter"><span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://gammapy.slack.com/" rel="noopener" target="_blank" title="Slack"><span><i class="fab fa-slack"></i></span>
            <label class="sr-only">Slack</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../setup.html">
   Project setup
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dependencies.html">
   Dependencies
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   How to contribute to Gammapy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../release.html">
   How to make a Gammapy release
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../doc_howto.html">
   Documentation How To
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dev_howto.html">
   Developer How To
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="index.html">
   PIGs
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="pig-001.html">
     PIG 1 - PIG purpose and guidelines
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-002.html">
     PIG 2 - Organization of low level analysis code
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-003.html">
     PIG 3 - Plan for dropping Python 2.7 support
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-004.html">
     PIG 4 - Setup for tutorial notebooks and data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-005.html">
     PIG 5 - Gammapy 1.0 roadmap
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-006.html">
     PIG 6 - CTA observation handling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-007.html">
     PIG 7 - Models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-008.html">
     PIG 8 - Datasets
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     PIG 9 - Event sampling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-010.html">
     PIG 10 - Regions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-011.html">
     PIG 11 - Light curves
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-012.html">
     PIG 12 - High level interface
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-013.html">
     PIG 13 - Gammapy dependencies and distribution
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-014.html">
     PIG 14 - Uncertainty estimation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-016.html">
     PIG 16 - Gammapy package structure
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-018.html">
     PIG 18 - Documentation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-019.html">
     PIG 19 - Gammapy package structure follow up
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-020.html">
     PIG 20 - Global Model API
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-021.html">
     PIG 21 - Models improvements
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-022.html">
     PIG 22 - Unified flux estimators API
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-023.html">
     PIG 23 - Gammapy release cycle and version numbering
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-024.html">
     PIG 24 - Authorship policy
    </a>
   </li>
  </ul>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#abstract">
   Abstract
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#sampling-methods">
   Sampling methods
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#proposal">
   Proposal
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#mapdataseteventsampler">
     MapDatasetEventSampler
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#performance-and-precision-evaluation">
   Performance and precision evaluation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#alternatives-outlook">
   Alternatives / Outlook
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#task-list">
   Task list
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#decision">
   Decision
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="pig-9-event-sampling">
<span id="pig-009"></span><h1>PIG 9 - Event sampling<a class="headerlink" href="#pig-9-event-sampling" title="Permalink to this headline">#</a></h1>
<ul class="simple">
<li><p>Author: Fabio Pintore, Andrea Giuliani, Axel Donath</p></li>
<li><p>Created: May 03, 2019</p></li>
<li><p>Accepted: Aug 30, 2019</p></li>
<li><p>Status: accepted</p></li>
<li><p>Discussion: <a class="reference external" href="https://github.com/gammapy/gammapy/pull/2136">GH 2136</a></p></li>
</ul>
<section id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">#</a></h2>
<p>An event sampler for gamma events is an important part of the science tools of
the future Cherenkov Telescope Array (CTA) observatory. It will allow users to
simulate observations of sources with different spectral, morphological and
temporal properties and predict the performance of CTA on the simulated events
e.g. to support observation proposals or study the sensitivity of future
observations. For this reason, we propose to implement a framework for event
simulation in Gammapy.</p>
<p>The proposed framework consists of individual building blocks, represented by
classes and methods, that can be chained together to achieve a full simulation
of an event list corresponding to a given observation. This includes the
simulation of source events, background events, effects of instrument response
functions (IRF) and arrival times. As underlying method for the actual event
sampling we propose to use inverse cumulative distribution function (CDF)
sampling (<a class="reference external" href="https://en.wikipedia.org/wiki/Inverse_transform_sampling">inverseCDF</a>) with finely binned discrete source and background.
Temporal models will be also taken into account and time will be sampled
separately in a 1D analysis, assuming that the temporal dependency of the input
source models factorizes.</p>
</section>
<section id="sampling-methods">
<h2>Sampling methods<a class="headerlink" href="#sampling-methods" title="Permalink to this headline">#</a></h2>
<p>Inverse CDF sampling (<a class="reference external" href="https://en.wikipedia.org/wiki/Inverse_transform_sampling">inverseCDF</a>) is an established method to sample from
discrete probability mass functions. It is used by <code class="docutils literal notranslate"><span class="pre">ASTRIsim</span></code> (<a class="reference external" href="https://github.com/cento14/Astrisim">astrisim</a>), the
event simulator of the AGILE collaboration. However it is not the method of
choice for other existing event samplers such as the the Fermi-LAT Science Tools
(gtobsim) and CTOOLS (ctobssim). The latter uses a combination of analytical
sampling for models, where a solution is known (e.g. power-laws) and the
rejection sampling method (<a class="reference external" href="https://en.wikipedia.org/wiki/Rejection_sampling">rej_sampl</a>), where the sampling has to be done
numerically (see an example here <a class="reference external" href="http://gammalib.sourceforge.net">gammalib</a>).</p>
<p>As rejection sampling can directly sample from continuous probability density
functions, it is expected to yield very precise results. However an enveloping
distribution is needed, which should be adapted to the target distribution to be
efficient (see also <a class="reference external" href="https://wiseodd.github.io/techblog/2015/10/21/rejection-sampling/">rejection sampling in Python</a> for an example
implementation), otherwise a lot of computation time is spend in rejecting drawn
samples.</p>
<p>For this reason we favour the inverse CDF sampling method, as a simple to
implement and general sampling method. The precision of the inverse CDF sampling
method can be controlled by the resolution of the input probability mass
function (PMF) and is in practice only limited by the available memory. We will
study the required bin-size of the PMFs to reach sufficient precision. If we
find the inverse CDF sampling method to be not precise enough, it is still
possible to achieve better precision adopting the rejection sampling. This will
not have a strong impact on the structure of the event-sampler.</p>
</section>
<section id="proposal">
<h2>Proposal<a class="headerlink" href="#proposal" title="Permalink to this headline">#</a></h2>
<p>We propose to include in <code class="docutils literal notranslate"><span class="pre">gammapy.cube</span></code> an high level interface (HLI) class,
labelled as <code class="docutils literal notranslate"><span class="pre">MapDatasetEventSampler</span></code> or <code class="docutils literal notranslate"><span class="pre">MapDataset.sample</span></code> method. This
class handles the complete event sampling process, including the corrections
related to the IRF and source temporal variability, for a given GTI /
observation.</p>
<p>The dataset will be computed using the standard data reduction procedure of
Gammapy, as illustrated in the following example:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">obs</span> <span class="o">=</span> <span class="n">Observation</span><span class="p">(</span><span class="n">pointing</span><span class="p">,</span> <span class="n">gti</span><span class="p">,</span> <span class="n">aeff</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">edisp</span><span class="p">,</span> <span class="n">expomap</span><span class="p">)</span>
<span class="n">maker</span> <span class="o">=</span> <span class="n">MapDatasetMaker</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">geom_irf</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">SkyModels</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;model.yaml&quot;</span><span class="p">)</span>
<span class="n">dataset</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
<span class="n">sampler</span> <span class="o">=</span> <span class="n">MapDatasetEventSampler</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="n">events</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<span class="n">events</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
</pre></div>
</div>
<p>After data reduction, the Dataset object should contain all the needed
information, such as the pointing sky coordinates, the GTI, and the setup of all
the models (spectra, spatial morphology, temporal model) for any given source,
and it is passed as input parameter to the <code class="docutils literal notranslate"><span class="pre">MapDatasetEventSampler</span></code>. It is
important to note that the <code class="docutils literal notranslate"><span class="pre">MapDataset</span></code> object can store information for more
than one source. Then, a <code class="docutils literal notranslate"><span class="pre">.sample</span></code> method will draw the sampled events and
will provide an output <code class="docutils literal notranslate"><span class="pre">~astropy.table.Table</span></code> object. The latter will contain
the reconstructed sky positions, energies, times, and an <code class="docutils literal notranslate"><span class="pre">EVENT_ID</span></code> and
<code class="docutils literal notranslate"><span class="pre">MC_ID</span></code>. <code class="docutils literal notranslate"><span class="pre">EVENT_ID</span></code> is a unique number or a string to identify the sampled
event, while <code class="docutils literal notranslate"><span class="pre">MC_ID</span></code> is a unique ID (number or string) to identify the model
component the event was sampled from. The <code class="docutils literal notranslate"><span class="pre">MapDatasetSampler</span></code> should also fill
the mandatory header information for event list files described on <a class="reference external" href="https://gamma-astro-data-formats.readthedocs.io/">gadf</a>.</p>
<section id="mapdataseteventsampler">
<h3>MapDatasetEventSampler<a class="headerlink" href="#mapdataseteventsampler" title="Permalink to this headline">#</a></h3>
<p>The general design of the <code class="docutils literal notranslate"><span class="pre">sample</span></code> method is as follows:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>
   <span class="sd">&quot;&quot;&quot;Sample events from a ``MapDataset``&quot;&quot;&quot;</span>

   <span class="n">events_list</span> <span class="o">=</span> <span class="p">[]</span>

   <span class="k">for</span> <span class="n">evaluator</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">evaluators</span><span class="p">:</span>
        <span class="n">npred</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">compute_npred</span><span class="p">()</span>
        <span class="n">n_events</span> <span class="o">=</span> <span class="n">random_state</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">npred</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">npred</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n_events</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">LightCurveTableModel</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n_events</span><span class="o">=</span><span class="p">,</span> <span class="n">lc</span><span class="o">=</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="p">)</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span><span class="n">events</span><span class="p">,</span><span class="n">time</span><span class="p">)</span>
        <span class="n">events_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
        <span class="n">event_list</span><span class="p">[</span><span class="s2">&quot;MC_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span>

   <span class="n">events_src</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">(</span><span class="n">events_list</span><span class="p">)</span>
   <span class="n">events_src</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">psf</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">events_src</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>
   <span class="n">events_src</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">edisp</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">events_src</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>

   <span class="n">n_events_bkg</span> <span class="o">=</span> <span class="n">random_state</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">background_model</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
   <span class="n">events_bkg</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">background_model</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n_events</span><span class="p">,</span> <span class="n">random_state</span><span class="p">)</span>

   <span class="n">events_total</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">([</span><span class="n">events_src</span><span class="p">,</span> <span class="n">events_bkg</span><span class="p">])</span>
   <span class="n">events_total</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">get_events_meta_data</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">EventList</span><span class="p">(</span><span class="n">events_total</span><span class="p">)</span>
</pre></div>
</div>
<p>In more detail, <code class="docutils literal notranslate"><span class="pre">sample</span></code> starts a loop over the sources stored into the
<code class="docutils literal notranslate"><span class="pre">MapDataset</span></code> model. Then, for each source, the <code class="docutils literal notranslate"><span class="pre">src.compute_npred</span></code> method
will calculate the predicted number of source counts <code class="docutils literal notranslate"><span class="pre">npred</span></code>. In particular,
it is important to note that <code class="docutils literal notranslate"><span class="pre">npred</span> <span class="pre">=</span> <span class="pre">exposure</span> <span class="pre">*</span> <span class="pre">flux</span></code>, where <code class="docutils literal notranslate"><span class="pre">exposure</span></code> is
defined as <code class="docutils literal notranslate"><span class="pre">effective_area</span> <span class="pre">*</span> <span class="pre">exposure_time</span></code>. <code class="docutils literal notranslate"><span class="pre">npred</span></code> is therefore calculated
irrespective of the energy dispersion and of PSF. Then, <code class="docutils literal notranslate"><span class="pre">npred</span></code> will be the
input of the <code class="docutils literal notranslate"><span class="pre">npred.sample</span></code> method. The latter uses a Poisson distribution,
with mean equal to the predicted counts, to estimate the random number of
sampled events.</p>
<p>We propose to add a <code class="docutils literal notranslate"><span class="pre">Map.sample(n_events=,</span> <span class="pre">random_state=)</span></code> method in
<code class="docutils literal notranslate"><span class="pre">~gammapy.maps.Map</span></code> that will be the core of the sampling process. The
<code class="docutils literal notranslate"><span class="pre">sample</span></code> is based on the <code class="docutils literal notranslate"><span class="pre">~gammapy.utils.random.InverseCDFSampler</span></code> class
described in <a class="reference external" href="https://github.com/gammapy/gammapy/pull/2229">GH 2229</a> . The output will be an <code class="docutils literal notranslate"><span class="pre">~astropy.table.Table</span></code> with
columns: <code class="docutils literal notranslate"><span class="pre">RA_TRUE</span></code>, <code class="docutils literal notranslate"><span class="pre">DEC_TRUE</span></code> and <code class="docutils literal notranslate"><span class="pre">ENERGY_TRUE</span></code> .</p>
<p>Then, the time will be sampled independently using the temporal information
stored into the <code class="docutils literal notranslate"><span class="pre">MapDataset</span></code> model for each source of interest. This will be
done through a <code class="docutils literal notranslate"><span class="pre">.sample(n_events=,</span> <span class="pre">random_state=)</span></code> method that we propose to
add to <code class="docutils literal notranslate"><span class="pre">~gammapy.time.models.LightCurveTableModel</span></code> and
<code class="docutils literal notranslate"><span class="pre">~gammapy.time.models.PhaseCurveTableModel</span></code>. This method will take as input
the GTIs (i.e. one Tstart and Tstop) in the <code class="docutils literal notranslate"><span class="pre">MapDataset</span></code> object. Also in this
case the <code class="docutils literal notranslate"><span class="pre">InverseCDFSampler</span></code> class is the machine used to sample the time of
the events. In the case the temporal model is not provided, the time is
uniformly sampled in the time range <code class="docutils literal notranslate"><span class="pre">t_min</span></code> and <code class="docutils literal notranslate"><span class="pre">t_max</span></code>. To define a
light-curve per model component, the current <code class="docutils literal notranslate"><span class="pre">SkyModel</span></code> class will be extended
by a <code class="docutils literal notranslate"><span class="pre">SkyModel(...,</span> <span class="pre">temporal_model=)</span></code>.</p>
<p>The IRF correction can now be applied to sampled events. We propose to add a
<code class="docutils literal notranslate"><span class="pre">.sample(events=)</span></code> method in both <code class="docutils literal notranslate"><span class="pre">~gammapy.cube.PSFMap</span></code> and
<code class="docutils literal notranslate"><span class="pre">~gammapy.cube.EdispMap</span></code>. The method interpolates the “correct” IRF at the
position of a given event and applies it. In more detail, the method calculates
the psf and the energy dispersion at the events true positions and true
energies, which are given in input as an <code class="docutils literal notranslate"><span class="pre">~astropy.table.Table</span></code> object. The
IRFs are assumed to be constant and not time-dependent. The output will be an
<code class="docutils literal notranslate"><span class="pre">~astropy.table.Table</span></code> with the new columns <code class="docutils literal notranslate"><span class="pre">RA</span></code>, <code class="docutils literal notranslate"><span class="pre">DEC</span></code> and <code class="docutils literal notranslate"><span class="pre">ENERGY</span></code>,
which are the reconstructed event energies and positions.</p>
<p>Finally, the times and the energies/coordinates of the events will be merged
into a single <code class="docutils literal notranslate"><span class="pre">~astropy.table.Table</span></code> with the columns:<code class="docutils literal notranslate"><span class="pre">RA</span></code>, <code class="docutils literal notranslate"><span class="pre">DEC</span></code> and
<code class="docutils literal notranslate"><span class="pre">ENERGY</span></code> and <code class="docutils literal notranslate"><span class="pre">TIME</span></code> .</p>
<p>The <code class="docutils literal notranslate"><span class="pre">MapDatasetEventSampler</span></code> can be used to sample background events using the
<code class="docutils literal notranslate"><span class="pre">Map.sample(n_events=,</span> <span class="pre">random_state=)</span></code> as well. The time of the events is
sampled assuming a constant event rate. Finally, the IRF corrections are not
applied to background sampled events.</p>
</section>
</section>
<section id="performance-and-precision-evaluation">
<h2>Performance and precision evaluation<a class="headerlink" href="#performance-and-precision-evaluation" title="Permalink to this headline">#</a></h2>
<p>To evaluate the precision and performance of the described framework we propose
to implement a prototype for a simulation / fitting pipeline. Starting from a
selection of spatial, spectral and temporal models, data are simulated and
fitted multiple times to derive distributions and pull-distributions of the
reconstructed model parameters. This pipeline should also monitor the required
cpu and memory usage. This first prototype can be used to evaluate the optimal
bin-size (with the best compromise between performance and precision) for the
simulations and to verify the over-all correctness of the simulated data. This
will be valid for a set of input maps and IRFs. Later this prototype can be
developed further into a full simulation / fitting continuous integration
system.</p>
</section>
<section id="alternatives-outlook">
<h2>Alternatives / Outlook<a class="headerlink" href="#alternatives-outlook" title="Permalink to this headline">#</a></h2>
<p>So far Gammapy only supports binned likelihood analysis and technically most
use- cases for the event sampling could be solved with binned simulations. A
binned simulation can be basically achieved by a call to
<code class="docutils literal notranslate"><span class="pre">numpy.random.poisson()</span></code> based on the predicted number of counts map. This is
conceptionally simpler as well as computationally more efficient than a sampling
of event lists. In <code class="docutils literal notranslate"><span class="pre">Gammapy</span></code> a similar dataset simulation is already
implemented in <code class="docutils literal notranslate"><span class="pre">Dataset.fake()</span></code>, although this has a limited number of use
cases than an event sampler. However, to support the full data access and data
reduction process for simulations, event lists are required. In future Gammapy
possibly also supports event based analysis methods (unbinned likelihood, but
also e.g. clustering algorithms), that also require event lists. For this reason
binned simulations cannot present a full equivalent solution to event sampling.</p>
<p>The question of the API to simulate multiple observations from e.g. an
<code class="docutils literal notranslate"><span class="pre">ObservationTable</span></code> or a list of <code class="docutils literal notranslate"><span class="pre">GTIs</span></code> as it is needed for simulating data
for the CTA data challenge is not addressed in this PIG. For the scope of this
PIG, the fundamental class <code class="docutils literal notranslate"><span class="pre">MapDatasetEventSampler</span></code> to simulate events
corresponding to a given observation and/or single GTI is in place.</p>
<p>The proposed Event Sampler will not provide, for each event, the corresponding
<code class="docutils literal notranslate"><span class="pre">DETX</span></code> and <code class="docutils literal notranslate"><span class="pre">DETY</span></code> position. These will be added in a future development of
the simulator.</p>
</section>
<section id="task-list">
<h2>Task list<a class="headerlink" href="#task-list" title="Permalink to this headline">#</a></h2>
<p>This is a proposal for a list of tasks to implement the proposed changes:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Implement the <code class="docutils literal notranslate"><span class="pre">sample</span></code> method in <code class="docutils literal notranslate"><span class="pre">gammapy.maps.Map</span></code> and add tests.</p></li>
<li><p>Implement the <code class="docutils literal notranslate"><span class="pre">sample</span></code> method in <code class="docutils literal notranslate"><span class="pre">gammapy.time.models.LightCurveTableModel</span></code> and <code class="docutils literal notranslate"><span class="pre">gammapy.time.models.PhaseCurveTableModel</span></code> and add tests.</p></li>
<li><p>Implement the <code class="docutils literal notranslate"><span class="pre">sample</span></code> method in <code class="docutils literal notranslate"><span class="pre">gammapy.cube.PSFMap</span></code> and add tests.</p></li>
<li><p>Implement the <code class="docutils literal notranslate"><span class="pre">sample</span></code> method in <code class="docutils literal notranslate"><span class="pre">gammapy.cube.EdispMap</span></code> and add tests.</p></li>
<li><p>Introduce the <code class="docutils literal notranslate"><span class="pre">MapDatasetEventSampler</span></code> into <code class="docutils literal notranslate"><span class="pre">gammapy.cube.</span></code> and add tests.</p></li>
<li><p>Add tutorials for event simulations of different kinds of sources.</p></li>
</ol>
</div></blockquote>
</section>
<section id="decision">
<h2>Decision<a class="headerlink" href="#decision" title="Permalink to this headline">#</a></h2>
<p>The PIG was discussed extensively in <a class="reference external" href="https://github.com/gammapy/gammapy/pull/2136">GH 2136</a>, the weekly Gammapy developer
calls and coding sprint in person. After the deadline for final review expired
on August 20, all remaining comments were addressed and the PIG was accepted on
August 30, 2019.</p>
</section>
</section>


              </div>
              
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, The Gammapy developers.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>