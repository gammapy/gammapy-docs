
<!DOCTYPE html>


<html lang="en" data-content_root="../../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>PIG 11 - Light curves &#8212; gammapy vX.Y.Z</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=35abb870" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=1f75dfce"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=30646c52"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'development/pigs/pig-011';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://docs.gammapy.org/stable/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'dev';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            false;
        </script>
    <script src="../../_static/matomo.js?v=52704cab"></script>
    <link rel="canonical" href="https://docs.gammapy.org/stable/development/pigs/pig-011.html" />
    <link rel="icon" href="../../_static/gammapy_logo.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="PIG 12 - High level interface" href="pig-012.html" />
    <link rel="prev" title="PIG 10 - Regions" href="pig-010.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="2.0.dev1059+g171afe4af" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
    
    <img src="../../_static/gammapy_logo.png" class="logo__image only-light" alt="gammapy vX.Y.Z - Home"/>
    <img src="../../_static/gammapy_logo.png" class="logo__image only-dark pst-js-only" alt="gammapy vX.Y.Z - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../getting-started/index.html">
    Getting started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../user-guide/index.html">
    User guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api-reference/index.html">
    API reference
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    Developer guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../release-notes/index.html">
    Release notes
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/gammapy/gammapy" title="Github" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Github</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://gammapy.slack.com/" title="Slack" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-slack fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Slack</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../getting-started/index.html">
    Getting started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../user-guide/index.html">
    User guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api-reference/index.html">
    API reference
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    Developer guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../release-notes/index.html">
    Release notes
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/gammapy/gammapy" title="Github" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Github</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://gammapy.slack.com/" title="Slack" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-slack fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Slack</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../setup.html">Project setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dependencies.html">Dependencies</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">How to contribute to Gammapy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release.html">How to make a Gammapy release</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../doc_howto.html">Documentation How To</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_howto.html">Developer How To</a></li>
</ul>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">PIGs</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="pig-001.html">PIG 1 - PIG purpose and guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-002.html">PIG 2 - Organization of low level analysis code</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-003.html">PIG 3 - Plan for dropping Python 2.7 support</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-004.html">PIG 4 - Setup for tutorial notebooks and data</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-005.html">PIG 5 - Gammapy 1.0 roadmap</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-006.html">PIG 6 - CTA observation handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-007.html">PIG 7 - Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-008.html">PIG 8 - Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-009.html">PIG 9 - Event sampling</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-010.html">PIG 10 - Regions</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">PIG 11 - Light curves</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-012.html">PIG 12 - High level interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-013.html">PIG 13 - Gammapy dependencies and distribution</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-014.html">PIG 14 - Uncertainty estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-016.html">PIG 16 - Gammapy package structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-018.html">PIG 18 - Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-019.html">PIG 19 - Gammapy package structure follow up</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-020.html">PIG 20 - Global Model API</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-021.html">PIG 21 - Models improvements</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-022.html">PIG 22 - Unified flux estimators API</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-023.html">PIG 23 - Gammapy release cycle and version numbering</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-024.html">PIG 24 - Authorship policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-025.html">PIG 25 - Metadata container for Gammapy</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-026.html">PIG 26 - Model Priors API</a></li>
<li class="toctree-l2"><a class="reference internal" href="pig-027.html">PIG 27 - Bayesian Inference using Nested Sampling</a></li>
</ul>
</details></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Developer guide</a></li>
    
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">PIGs</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">PIG 11 - Light curves</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="pig-11-light-curves">
<span id="pig-011"></span><h1>PIG 11 - Light curves<a class="headerlink" href="#pig-11-light-curves" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>Author: Régis Terrier, Axel Donath, David Fidalgo, Atreyee Sinha</p></li>
<li><p>Created: Jul 2, 2018</p></li>
<li><p>Withdrawn: Oct 29, 2019</p></li>
<li><p>Status: withdrawn</p></li>
<li><p>Discussion: <a class="reference external" href="https://github.com/gammapy/gammapy/pull/1451">GH 1451</a></p></li>
</ul>
<section id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Link to this heading">#</a></h2>
<p>In this PIG we want to discuss a restructuring of the way light curves are
computed and stored in Gammapy. Lightcurves in gamma-ray astronomy are the
result of a series of fits of the source flux in each time bin. Lightcurve
extraction covers therefore both the data reduction and the data modeling steps.
The lightcurve estimation will therefore have these two steps.</p>
<p>Here, we propose to perform the data reduction step in each of the time bins and
store the result in the form of a <code class="docutils literal notranslate"><span class="pre">Datasets</span></code> (<code class="docutils literal notranslate"><span class="pre">MapDataset</span></code> or
<code class="docutils literal notranslate"><span class="pre">SpectrumOnOffDataset</span></code> depending on the selected approach). Each individual
<code class="docutils literal notranslate"><span class="pre">Dataset</span></code> is then modeled and fitted to extract the source flux and its errors
in each time bin. The result is then stored in a <code class="docutils literal notranslate"><span class="pre">LightCurve</span></code> object which
contains a <code class="docutils literal notranslate"><span class="pre">Table</span></code> of the fit results.</p>
<p>For this purpose, we propose to introduce two new classes to perform the data
reduction first and then then the fitting. The time dependent data reduction
could be a specific case of the high level pipeline, when a list of time bins is
passed with the configuration <code class="docutils literal notranslate"><span class="pre">dict</span></code>. The data fitting should be performed by
the new <code class="docutils literal notranslate"><span class="pre">LightCurveEstimator</span></code> class, which  should essentially be a wrapper
around the <code class="docutils literal notranslate"><span class="pre">FluxPointEstimator</span></code> class that does the same thing for spectrum
and map datasets.</p>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<section id="lightcurves-in-gamma-ray-astronomy">
<h3>Lightcurves in gamma-ray astronomy<a class="headerlink" href="#lightcurves-in-gamma-ray-astronomy" title="Link to this heading">#</a></h3>
<p>In photon counting experiments, lightcurves are often simply obtained by
counting events in a given energy range in a set of time bins. In ground based
gamma-ray astronomy, things are usually more complex.</p>
<p>The response and the instrumental background of the instruments can strongly
vary over time on a night scale, e.g. because the source elevation changes or on
longer time scales given the possible changes of the atmosphere transparency or
the instrument efficiency.</p>
<p>Another complexity comes from the astrophysical background which can often
pollute a source and needs to be properly removed to extract the intrinsic
source flux at any given time.</p>
<p>For these reasons, gamma-ray lightcurve are usually the results of a fit of
model on the data performed on a number of time bins to extract the source flux
in these time bins.</p>
<p>This is more limited than e.g. time resolved spectral analysis. Although the
latter share many similarities with the lightcurve extraction, it is a more
complex task which we do not cover here.</p>
</section>
<section id="background-what-we-have-now">
<h3>Background / What we have now<a class="headerlink" href="#background-what-we-have-now" title="Link to this heading">#</a></h3>
<p>The current <code class="docutils literal notranslate"><span class="pre">gammapy.time.LightCurveEstimator</span></code> class assumes that a part of
the data reduction process has already been applied at it takes as input a
<code class="docutils literal notranslate"><span class="pre">gammapy.spectrum.SpectrumExtraction</span></code> instance for which a list of
<code class="docutils literal notranslate"><span class="pre">gammapy.background.BackgroundEstimate</span></code> is required. Apart from the time
intervals, the user also has to provide a <code class="docutils literal notranslate"><span class="pre">gammapy.spectrum.SpectralModel</span></code>
that is used to compute the expected counts in a time bin and to scale the
integral flux with respect to the excess events found in that time bin. The
parameters of the spectral model are generally obtained via a spectral fit to
the whole data sample. See <a class="reference external" href="https://docs.gammapy.org/0.14/notebooks/light_curve.html">current lightcurve tutorial</a>.</p>
<p>Drawbacks of this approach: no clear separation of the data reduction and
modeling steps, and only 1D On-Off spectral analysis is supported and lacks
supports for <code class="docutils literal notranslate"><span class="pre">MapDataset</span></code> based analysis.</p>
</section>
</section>
<section id="proposal">
<h2>Proposal<a class="headerlink" href="#proposal" title="Link to this heading">#</a></h2>
<section id="general-organization-of-the-new-approach">
<h3>General organization of the new approach<a class="headerlink" href="#general-organization-of-the-new-approach" title="Link to this heading">#</a></h3>
<p>The approach will be split into 3 main phases:
* Time bin preparation
* Data reduction in time bins to produce a list of <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>
* Light curve estimation to fit a model on the resulting <code class="docutils literal notranslate"><span class="pre">Datasets</span></code></p>
<p>The end product should contain enough information to perform some rebinning and
apply high level timing techniques without rerunning the whole data reduction
and fitting steps.</p>
</section>
<section id="time-bin-preparation">
<h3>Time bin preparation<a class="headerlink" href="#time-bin-preparation" title="Link to this heading">#</a></h3>
<p>Independently of the actual data reduction technique chosen, the user should
first provide a list/table of time intervals for which she/he wants to compute
the source flux. The computation of this list/table will be done outside of the
light curve estimation class.</p>
<p>While we could provide helper functions to prepare the time bins.
<code class="docutils literal notranslate"><span class="pre">astropy.time.Time</span></code> is relatively easy to use, so that a user would execute
code similar to the following example:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">astropy.time</span><span class="w"> </span><span class="kn">import</span> <span class="n">Time</span>
<span class="n">time_start</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="s2">&quot;2006-07-29 20:00:00.000&quot;</span><span class="p">)</span>
<span class="n">time_step</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">min</span>
<span class="n">nstep</span> <span class="o">=</span> <span class="mi">120</span>
<span class="n">times</span> <span class="o">=</span> <span class="n">time_start</span> <span class="o">+</span> <span class="n">time_step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nstep</span><span class="p">)</span>
<span class="n">time_bins</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">times</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="n">time_bins</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tmin</span><span class="p">,</span><span class="n">tmax</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="data-reduction">
<h3>Data reduction<a class="headerlink" href="#data-reduction" title="Link to this heading">#</a></h3>
<p>Once the time bins are determined, the user will have to select the relevant
<code class="docutils literal notranslate"><span class="pre">Observations</span></code> from the <code class="docutils literal notranslate"><span class="pre">Datastore</span></code>. The <code class="docutils literal notranslate"><span class="pre">Observations</span></code> are then filtered
and grouped according to the time bins using the <code class="docutils literal notranslate"><span class="pre">ObservationFilter</span></code> and
passed to the light curve extraction function or class. The latter could take a
<code class="docutils literal notranslate"><span class="pre">geom</span></code> or a <code class="docutils literal notranslate"><span class="pre">region</span></code> argument that will define the data reduction geometry
(and in particular, if the data reduction is 3D or 1D). In the absence, of a
<code class="docutils literal notranslate"><span class="pre">RegionGeom</span></code> we could simply expect a reco energy and true energy <code class="docutils literal notranslate"><span class="pre">MapAxis</span></code>.</p>
<p>We do not detail possible approaches in the current PIG. These should be
re-evaluated in the more general context of data reduction. Some examples, using
the current data reduction approach will be exposed to users in a dedicated
notebook.</p>
<p>Both approaches will result in a list of <code class="docutils literal notranslate"><span class="pre">Datasets</span></code> consisting of
<code class="docutils literal notranslate"><span class="pre">MapDataset</span></code> or <code class="docutils literal notranslate"><span class="pre">SpectrumDatasetOnOff</span></code> with identical geometries for each
time bin.</p>
<p>In order to properly assign times to any <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>, the latter must therefore
carry the time information. Minimally, this can be done with a meta information
such as <code class="docutils literal notranslate"><span class="pre">time_start</span></code> and <code class="docutils literal notranslate"><span class="pre">time_stop</span></code>. This does not give a full idea of the
coverage of time bin though. Ideally, the <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> should track the <code class="docutils literal notranslate"><span class="pre">GTI</span></code>
table of the filtered <code class="docutils literal notranslate"><span class="pre">Eventlist</span></code> that were used for its production. It can be
stored on the <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> itself and be serialized independently or be added as
an extension to the serialized <code class="docutils literal notranslate"><span class="pre">count</span></code> data container (a <code class="docutils literal notranslate"><span class="pre">CountsSpectrum</span></code> or
<code class="docutils literal notranslate"><span class="pre">Map</span></code>), as is done for OGIP spectra. In order to stack several <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>
objects it is necessary to be able to combine <code class="docutils literal notranslate"><span class="pre">GTI</span></code> tables. While a simple
stacking of tables is enough in many cases, the situation of overlapping time
intervals should be considered and a proper <code class="docutils literal notranslate"><span class="pre">GTI.union()</span></code> should be introduced
(a functionality recurrent in HEA software see e.g. ftools <code class="docutils literal notranslate"><span class="pre">mgtime</span></code>)</p>
</section>
<section id="data-fitting">
<h3>Data Fitting<a class="headerlink" href="#data-fitting" title="Link to this heading">#</a></h3>
<p>The data fitting is the step were the <code class="docutils literal notranslate"><span class="pre">Datasets</span></code> are converted into a
lightcurve based on a model of the emission. The amplitude of the source model
is fitted while other parameters are usually, but not necessarily, fixed.</p>
<p>The fitting is very similar to the extraction of <code class="docutils literal notranslate"><span class="pre">FluxPoints</span></code> in the spectral
analysis and does not strongly depend on the type of <code class="docutils literal notranslate"><span class="pre">Datasets</span></code> considered.
The new <code class="docutils literal notranslate"><span class="pre">LightCurveEstimator</span></code> class should therefore be able to take as
input both <code class="docutils literal notranslate"><span class="pre">SpectrumDatasetOnOff</span></code> and <code class="docutils literal notranslate"><span class="pre">MapDataset</span></code>, in a similar fashion as
the current <code class="docutils literal notranslate"><span class="pre">FluxPointEstimator</span></code>.</p>
<p>After creating the <code class="docutils literal notranslate"><span class="pre">Datasets</span></code>, the user would first define the model to be
used and freeze its parameters. Then we would apply it to the various
<code class="docutils literal notranslate"><span class="pre">Dataset</span></code> objects before calling the <code class="docutils literal notranslate"><span class="pre">LightCurveEstimator</span></code>:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">sky_model</span> <span class="o">=</span> <span class="n">SkyModel</span><span class="p">(</span><span class="n">spatial_model</span><span class="o">=</span><span class="n">spatial_model</span><span class="p">,</span> <span class="n">spectral_model</span><span class="o">=</span><span class="n">spectral_model</span><span class="p">)</span>
<span class="n">sky_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">frozen</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">sky_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;lon_0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">frozen</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">sky_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;lat_0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">frozen</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">sky_model</span>

<span class="n">lc_estimator</span> <span class="o">=</span> <span class="n">LightCurveEstimator</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>
<span class="n">lightcurve</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>To help, the user deal with model parameters some helper function could be
introduced to freeze all parameters of a model. Another possibility is to assume
that all parameters are fixed except the <code class="docutils literal notranslate"><span class="pre">amplitude</span></code> in the
<code class="docutils literal notranslate"><span class="pre">LightCurveEstimator.run()</span></code> method, or pass as arguments the names of the
parameters to leave free.</p>
</section>
<section id="storing-the-results-and-further-studies">
<h3>Storing the results and further studies<a class="headerlink" href="#storing-the-results-and-further-studies" title="Link to this heading">#</a></h3>
<p>The results are returned as a <code class="docutils literal notranslate"><span class="pre">gammapy.time.LightCurve</span></code> instance (the current
container class for light curves) that, so far, essentially holds the integrated
flux + errors and the time_min/time_max of each time bin. There are many other
quantities which could be stored, such as the energy range of the flux, the
number of excess events in the time bin considered, etc. The current container
class already provides some methods to study variability, such as chi-square
test, fractional variance estimation.</p>
<p>Example usage:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">lightcurve</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;amplitude&#39;</span><span class="p">)</span>

<span class="c1"># Get fractional variance</span>
<span class="nb">print</span><span class="p">(</span><span class="n">lightcurve</span><span class="o">.</span><span class="n">fvar</span><span class="p">(</span><span class="s1">&#39;amplitude&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">LightCurve</span></code> object should be able to rpovide some rebinning
functionalities. In particular, it stores the fit statistic scan, it should be
possible to perform minimal significance rebinning:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">simple_rebin_lc</span> <span class="o">=</span> <span class="n">lightcurve</span><span class="o">.</span><span class="n">rebin</span><span class="p">(</span><span class="n">factor</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># or</span>
<span class="n">min_significance_lc</span> <span class="o">=</span> <span class="n">lightcurve</span><span class="o">.</span><span class="n">rebin</span><span class="p">(</span><span class="n">min_significance</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="discussion-alternatives">
<h2>Discussion / Alternatives<a class="headerlink" href="#discussion-alternatives" title="Link to this heading">#</a></h2>
<section id="time-bins">
<h3>Time bins<a class="headerlink" href="#time-bins" title="Link to this heading">#</a></h3>
<p>To work with time bins, we could also rely on <code class="docutils literal notranslate"><span class="pre">astropy.timeseries</span></code> if we force
the dependency to astropy v&gt;3.2. This would look like:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">astropy.timeseries</span><span class="w"> </span><span class="kn">import</span> <span class="n">BinnedTimeSeries</span>
<span class="n">times</span> <span class="o">=</span> <span class="n">BinnedTimeSeries</span><span class="p">(</span><span class="n">time_bin_start</span><span class="o">=</span><span class="s2">&quot;2006-07-29 20:00:00.000&quot;</span><span class="p">,</span>
                       <span class="n">time_bin_size</span><span class="o">=</span><span class="mi">5</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">min</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">times</span><span class="o">.</span><span class="n">time_bin_start</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">times</span><span class="o">.</span><span class="n">time_bin_end</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="light-curve-fitting">
<h3>Light Curve Fitting<a class="headerlink" href="#light-curve-fitting" title="Link to this heading">#</a></h3>
<p>We could provide distinct objects specialized for <code class="docutils literal notranslate"><span class="pre">Map</span></code> and <code class="docutils literal notranslate"><span class="pre">Spectrum</span></code> datasets
instead of a single object.</p>
</section>
<section id="lightcurve">
<h3>Lightcurve<a class="headerlink" href="#lightcurve" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Lightcurve</span></code> contains  an <code class="docutils literal notranslate"><span class="pre">astropy.table.Table</span></code> object. It could be
improved by using the <code class="docutils literal notranslate"><span class="pre">astropy_timeseries.BinnedTimeSeries</span></code> object which
itself inherits from <code class="docutils literal notranslate"><span class="pre">QTable</span></code> and provides support for row selection with
time, rebinning and more complex methods for detailed timing studies such as
Lomb-Scargle periodograms.</p>
</section>
</section>
<section id="task-list">
<h2>Task list<a class="headerlink" href="#task-list" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Add <code class="docutils literal notranslate"><span class="pre">TSTART</span></code> and <code class="docutils literal notranslate"><span class="pre">TSTOP</span></code> meta info on the <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> as well as the <code class="docutils literal notranslate"><span class="pre">GTI</span></code> table.</p></li>
<li><p>Introduce <code class="docutils literal notranslate"><span class="pre">GTI.union()`</span></code> method to merge <code class="docutils literal notranslate"><span class="pre">Datasets</span></code>.</p></li>
<li><p>Refactor the <code class="docutils literal notranslate"><span class="pre">Lightcurve</span></code> class to add a number of new content in the <code class="docutils literal notranslate"><span class="pre">Table</span></code> e.g.:</p>
<ul>
<li><p>a <code class="docutils literal notranslate"><span class="pre">fit_stat_scan</span></code> column.</p></li>
<li><p>rebinning methods</p></li>
</ul>
</li>
<li><p>Implement the new <code class="docutils literal notranslate"><span class="pre">LightCurveEstimator</span></code> class</p></li>
<li><p>Provide a notebook showing data reduction  and fitting examples for both 3D and 1D cases</p></li>
</ul>
</section>
<section id="decision">
<h2>Decision<a class="headerlink" href="#decision" title="Link to this heading">#</a></h2>
<p>The authors have decided to withdraw the PIG. A significant part of the
implementation is already there. Besides, the recent additions of the high level
interface and of the new Maker scheme change the scope of the discussion.</p>
</section>
</section>


                </article>
              
              
              
              
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#abstract">Abstract</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lightcurves-in-gamma-ray-astronomy">Lightcurves in gamma-ray astronomy</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#background-what-we-have-now">Background / What we have now</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#proposal">Proposal</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#general-organization-of-the-new-approach">General organization of the new approach</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#time-bin-preparation">Time bin preparation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-reduction">Data reduction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-fitting">Data Fitting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#storing-the-results-and-further-studies">Storing the results and further studies</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#discussion-alternatives">Discussion / Alternatives</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#time-bins">Time bins</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#light-curve-fitting">Light Curve Fitting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lightcurve">Lightcurve</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#task-list">Task list</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decision">Decision</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/development/pigs/pig-011.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2025, The Gammapy developers.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
    
     <a href="https://gammapy.org/DataPrivacy.html">Data Privacy.</a>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    <br/>
  </p>
</div>
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>