
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>PIG 11 - Light curves &#8212; gammapy vX.Y.Z</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gammapy.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../../_static/gammapy_logo.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="PIG 12 - High level interface" href="pig-012.html" />
    <link rel="prev" title="PIG 10 - Regions" href="pig-010.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../index.html">
  <img src="../../_static/gammapy_logo_nav.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../getting-started/index.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../user-guide/index.html">
  User guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../tutorials/index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../api-reference/index.html">
  API reference
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../index.html">
  Developer guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../release-notes/index.html">
  Release notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-primary btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        dev  <!-- this text may get changed later by javascript -->
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
</div>

<!-- NOTE: this JS must live here (not in our global JS file) because it relies
     on being processed by Jinja before it is run (specifically for replacing
     variables development/pigs/pig-011 and {'json_url': 'https://docs.gammapy.org/stable/switcher.json', 'version_match': 'dev'}.
-->

<script type="text/javascript">
// Check if corresponding page path exists in other version of docs
// and, if so, go there instead of the homepage of the other docs version
function checkPageExistsAndRedirect(event) {
    const currentFilePath = "development/pigs/pig-011.html",
          tryUrl = event.target.getAttribute("href");
    let otherDocsHomepage = tryUrl.replace(currentFilePath, "");
    $.ajax({
        type: 'HEAD',
        url: tryUrl,
        // if the page exists, go there
        success: function() {
            location.href = tryUrl;
        }
    }).fail(function() {
        location.href = otherDocsHomepage;
    });
    // this prevents the browser from following the href of the clicked node
    // (which is fine because this function takes care of redirecting)
    return false;
}

// Populate the version switcher from the JSON config file
(function () {
    $.getJSON("https://docs.gammapy.org/stable/switcher.json", function(data, textStatus, jqXHR) {
        const currentFilePath = "development/pigs/pig-011.html";
        // create links to the corresponding page in the other docs versions
        $.each(data, function(index, entry) {
            // if no custom name specified (e.g., "latest"), use version string
            if (!("name" in entry)) {
                entry.name = entry.version;
            }
            // create the node
            const node = document.createElement("a");
            node.setAttribute("class", "list-group-item list-group-item-action py-1");
            node.textContent = `${entry.name}`;
            node.setAttribute("href", `${entry.url}${currentFilePath}`);
            // on click, AJAX calls will check if the linked page exists before
            // trying to redirect, and if not, will redirect to the homepage
            // for that version of the docs.
            node.onclick = checkPageExistsAndRedirect;
            // Add dataset values for the version and name in case people want
            // to apply CSS styling based on this information.
            node.dataset["versionName"] = entry.name;
            node.dataset["version"] = entry.version;

            $("#version_switcher_menu").append(node);
            // replace dropdown button text with the preferred display name of
            // this version, rather than using sphinx's 1.2.dev1341+gc7fa3da63 variable.
            // also highlight the dropdown entry for the currently-viewed
            // version's entry
            if (entry.version == "dev") {
                node.classList.add("active");
                let btn = document.getElementById("version_switcher_button");
                btn.innerText = btn.dataset["activeVersionName"] = entry.name;
                btn.dataset["activeVersion"] = entry.version;
            }
        });
    });
})();
</script>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/gammapy/gammapy" rel="noopener" target="_blank" title="Github"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">Github</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/gammapyST" rel="noopener" target="_blank" title="Twitter"><span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://gammapy.slack.com/" rel="noopener" target="_blank" title="Slack"><span><i class="fab fa-slack"></i></span>
            <label class="sr-only">Slack</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../setup.html">
   Project setup
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dependencies.html">
   Dependencies
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   How to contribute to Gammapy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../release.html">
   How to make a Gammapy release
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../doc_howto.html">
   Documentation How To
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dev_howto.html">
   Developer How To
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="index.html">
   PIGs
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="pig-001.html">
     PIG 1 - PIG purpose and guidelines
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-002.html">
     PIG 2 - Organization of low level analysis code
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-003.html">
     PIG 3 - Plan for dropping Python 2.7 support
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-004.html">
     PIG 4 - Setup for tutorial notebooks and data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-005.html">
     PIG 5 - Gammapy 1.0 roadmap
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-006.html">
     PIG 6 - CTA observation handling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-007.html">
     PIG 7 - Models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-008.html">
     PIG 8 - Datasets
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-009.html">
     PIG 9 - Event sampling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-010.html">
     PIG 10 - Regions
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     PIG 11 - Light curves
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-012.html">
     PIG 12 - High level interface
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-013.html">
     PIG 13 - Gammapy dependencies and distribution
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-014.html">
     PIG 14 - Uncertainty estimation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-016.html">
     PIG 16 - Gammapy package structure
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-018.html">
     PIG 18 - Documentation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-019.html">
     PIG 19 - Gammapy package structure follow up
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-020.html">
     PIG 20 - Global Model API
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-021.html">
     PIG 21 - Models improvements
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-022.html">
     PIG 22 - Unified flux estimators API
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-023.html">
     PIG 23 - Gammapy release cycle and version numbering
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-024.html">
     PIG 24 - Authorship policy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-025.html">
     PIG 25 - Metadata container for Gammapy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-026.html">
     PIG 26 - Model Priors API
    </a>
   </li>
  </ul>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#abstract">
   Abstract
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#lightcurves-in-gamma-ray-astronomy">
     Lightcurves in gamma-ray astronomy
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#background-what-we-have-now">
     Background / What we have now
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#proposal">
   Proposal
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#general-organization-of-the-new-approach">
     General organization of the new approach
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#time-bin-preparation">
     Time bin preparation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-reduction">
     Data reduction
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-fitting">
     Data Fitting
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#storing-the-results-and-further-studies">
     Storing the results and further studies
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#discussion-alternatives">
   Discussion / Alternatives
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#time-bins">
     Time bins
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#light-curve-fitting">
     Light Curve Fitting
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#lightcurve">
     Lightcurve
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#task-list">
   Task list
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#decision">
   Decision
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="pig-11-light-curves">
<span id="pig-011"></span><h1>PIG 11 - Light curves<a class="headerlink" href="#pig-11-light-curves" title="Permalink to this headline">#</a></h1>
<ul class="simple">
<li><p>Author: RÃ©gis Terrier, Axel Donath, David Fidalgo, Atreyee Sinha</p></li>
<li><p>Created: Jul 2, 2018</p></li>
<li><p>Withdrawn: Oct 29, 2019</p></li>
<li><p>Status: withdrawn</p></li>
<li><p>Discussion: <a class="reference external" href="https://github.com/gammapy/gammapy/pull/1451">GH 1451</a></p></li>
</ul>
<section id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">#</a></h2>
<p>In this PIG we want to discuss a restructuring of the way light curves are
computed and stored in Gammapy. Lightcurves in gamma-ray astronomy are the
result of a series of fits of the source flux in each time bin. Lightcurve
extraction covers therefore both the data reduction and the data modeling steps.
The lightcurve estimation will therefore have these two steps.</p>
<p>Here, we propose to perform the data reduction step in each of the time bins and
store the result in the form of a <code class="docutils literal notranslate"><span class="pre">Datasets</span></code> (<code class="docutils literal notranslate"><span class="pre">MapDataset</span></code> or
<code class="docutils literal notranslate"><span class="pre">SpectrumOnOffDataset</span></code> depending on the selected approach). Each individual
<code class="docutils literal notranslate"><span class="pre">Dataset</span></code> is then modeled and fitted to extract the source flux and its errors
in each time bin. The result is then stored in a <code class="docutils literal notranslate"><span class="pre">LightCurve</span></code> object which
contains a <code class="docutils literal notranslate"><span class="pre">Table</span></code> of the fit results.</p>
<p>For this purpose, we propose to introduce two new classes to perform the data
reduction first and then then the fitting. The time dependent data reduction
could be a specific case of the high level pipeline, when a list of time bins is
passed with the configuration <code class="docutils literal notranslate"><span class="pre">dict</span></code>. The data fitting should be performed by
the new <code class="docutils literal notranslate"><span class="pre">LightCurveEstimator</span></code> class, which  should essentially be a wrapper
around the <code class="docutils literal notranslate"><span class="pre">FluxPointEstimator</span></code> class that does the same thing for spectrum
and map datasets.</p>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">#</a></h2>
<section id="lightcurves-in-gamma-ray-astronomy">
<h3>Lightcurves in gamma-ray astronomy<a class="headerlink" href="#lightcurves-in-gamma-ray-astronomy" title="Permalink to this headline">#</a></h3>
<p>In photon counting experiments, lightcurves are often simply obtained by
counting events in a given energy range in a set of time bins. In ground based
gamma-ray astronomy, things are usually more complex.</p>
<p>The response and the instrumental background of the instruments can strongly
vary over time on a night scale, e.g. because the source elevation changes or on
longer time scales given the possible changes of the atmosphere transparency or
the instrument efficiency.</p>
<p>Another complexity comes from the astrophysical background which can often
pollute a source and needs to be properly removed to extract the intrinsic
source flux at any given time.</p>
<p>For these reasons, gamma-ray lightcurve are usually the results of a fit of
model on the data performed on a number of time bins to extract the source flux
in these time bins.</p>
<p>This is more limited than e.g. time resolved spectral analysis. Although the
latter share many similarities with the lightcurve extraction, it is a more
complex task which we do not cover here.</p>
</section>
<section id="background-what-we-have-now">
<h3>Background / What we have now<a class="headerlink" href="#background-what-we-have-now" title="Permalink to this headline">#</a></h3>
<p>The current <code class="docutils literal notranslate"><span class="pre">gammapy.time.LightCurveEstimator</span></code> class assumes that a part of
the data reduction process has already been applied at it takes as input a
<code class="docutils literal notranslate"><span class="pre">gammapy.spectrum.SpectrumExtraction</span></code> instance for which a list of
<code class="docutils literal notranslate"><span class="pre">gammapy.background.BackgroundEstimate</span></code> is required. Apart from the time
intervals, the user also has to provide a <code class="docutils literal notranslate"><span class="pre">gammapy.spectrum.SpectralModel</span></code>
that is used to compute the expected counts in a time bin and to scale the
integral flux with respect to the excess events found in that time bin. The
parameters of the spectral model are generally obtained via a spectral fit to
the whole data sample. See <a class="reference external" href="https://docs.gammapy.org/0.14/notebooks/light_curve.html">current lightcurve tutorial</a>.</p>
<p>Drawbacks of this approach: no clear separation of the data reduction and
modeling steps, and only 1D On-Off spectral analysis is supported and lacks
supports for <code class="docutils literal notranslate"><span class="pre">MapDataset</span></code> based analysis.</p>
</section>
</section>
<section id="proposal">
<h2>Proposal<a class="headerlink" href="#proposal" title="Permalink to this headline">#</a></h2>
<section id="general-organization-of-the-new-approach">
<h3>General organization of the new approach<a class="headerlink" href="#general-organization-of-the-new-approach" title="Permalink to this headline">#</a></h3>
<p>The approach will be split into 3 main phases:
* Time bin preparation
* Data reduction in time bins to produce a list of <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>
* Light curve estimation to fit a model on the resulting <code class="docutils literal notranslate"><span class="pre">Datasets</span></code></p>
<p>The end product should contain enough information to perform some rebinning and
apply high level timing techniques without rerunning the whole data reduction
and fitting steps.</p>
</section>
<section id="time-bin-preparation">
<h3>Time bin preparation<a class="headerlink" href="#time-bin-preparation" title="Permalink to this headline">#</a></h3>
<p>Independently of the actual data reduction technique chosen, the user should
first provide a list/table of time intervals for which she/he wants to compute
the source flux. The computation of this list/table will be done outside of the
light curve estimation class.</p>
<p>While we could provide helper functions to prepare the time bins.
<code class="docutils literal notranslate"><span class="pre">astropy.time.Time</span></code> is relatively easy to use, so that a user would execute
code similar to the following example:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>
<span class="n">time_start</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="s2">&quot;2006-07-29 20:00:00.000&quot;</span><span class="p">)</span>
<span class="n">time_step</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">min</span>
<span class="n">nstep</span> <span class="o">=</span> <span class="mi">120</span>
<span class="n">times</span> <span class="o">=</span> <span class="n">time_start</span> <span class="o">+</span> <span class="n">time_step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nstep</span><span class="p">)</span>
<span class="n">time_bins</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">times</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="n">time_bins</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tmin</span><span class="p">,</span><span class="n">tmax</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="data-reduction">
<h3>Data reduction<a class="headerlink" href="#data-reduction" title="Permalink to this headline">#</a></h3>
<p>Once the time bins are determined, the user will have to select the relevant
<code class="docutils literal notranslate"><span class="pre">Observations</span></code> from the <code class="docutils literal notranslate"><span class="pre">Datastore</span></code>. The <code class="docutils literal notranslate"><span class="pre">Observations</span></code> are then filtered
and grouped according to the time bins using the <code class="docutils literal notranslate"><span class="pre">ObservationFilter</span></code> and
passed to the light curve extraction function or class. The latter could take a
<code class="docutils literal notranslate"><span class="pre">geom</span></code> or a <code class="docutils literal notranslate"><span class="pre">region</span></code> argument that will define the data reduction geometry
(and in particular, if the data reduction is 3D or 1D). In the absence, of a
<code class="docutils literal notranslate"><span class="pre">RegionGeom</span></code> we could simply expect a reco energy and true energy <code class="docutils literal notranslate"><span class="pre">MapAxis</span></code>.</p>
<p>We do not detail possible approaches in the current PIG. These should be
re-evaluated in the more general context of data reduction. Some examples, using
the current data reduction approach will be exposed to users in a dedicated
notebook.</p>
<p>Both approaches will result in a list of <code class="docutils literal notranslate"><span class="pre">Datasets</span></code> consisting of
<code class="docutils literal notranslate"><span class="pre">MapDataset</span></code> or <code class="docutils literal notranslate"><span class="pre">SpectrumDatasetOnOff</span></code> with identical geometries for each
time bin.</p>
<p>In order to properly assign times to any <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>, the latter must therefore
carry the time information. Minimally, this can be done with a meta information
such as <code class="docutils literal notranslate"><span class="pre">time_start</span></code> and <code class="docutils literal notranslate"><span class="pre">time_stop</span></code>. This does not give a full idea of the
coverage of time bin though. Ideally, the <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> should track the <code class="docutils literal notranslate"><span class="pre">GTI</span></code>
table of the filtered <code class="docutils literal notranslate"><span class="pre">Eventlist</span></code> that were used for its production. It can be
stored on the <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> itself and be serialized independently or be added as
an extension to the serialized <code class="docutils literal notranslate"><span class="pre">count</span></code> data container (a <code class="docutils literal notranslate"><span class="pre">CountsSpectrum</span></code> or
<code class="docutils literal notranslate"><span class="pre">Map</span></code>), as is done for OGIP spectra. In order to stack several <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>
objects it is necessary to be able to combine <code class="docutils literal notranslate"><span class="pre">GTI</span></code> tables. While a simple
stacking of tables is enough in many cases, the situation of overlapping time
intervals should be considered and a proper <code class="docutils literal notranslate"><span class="pre">GTI.union()</span></code> should be introduced
(a functionality recurrent in HEA software see e.g. ftools <code class="docutils literal notranslate"><span class="pre">mgtime</span></code>)</p>
</section>
<section id="data-fitting">
<h3>Data Fitting<a class="headerlink" href="#data-fitting" title="Permalink to this headline">#</a></h3>
<p>The data fitting is the step were the <code class="docutils literal notranslate"><span class="pre">Datasets</span></code> are converted into a
lightcurve based on a model of the emission. The amplitude of the source model
is fitted while other parameters are usually, but not necessarily, fixed.</p>
<p>The fitting is very similar to the extraction of <code class="docutils literal notranslate"><span class="pre">FluxPoints</span></code> in the spectral
analysis and does not strongly depend on the type of <code class="docutils literal notranslate"><span class="pre">Datasets</span></code> considered.
The new <code class="docutils literal notranslate"><span class="pre">LightCurveEstimator</span></code> class should therefore be able to take as
input both <code class="docutils literal notranslate"><span class="pre">SpectrumDatasetOnOff</span></code> and <code class="docutils literal notranslate"><span class="pre">MapDataset</span></code>, in a similar fashion as
the current <code class="docutils literal notranslate"><span class="pre">FluxPointEstimator</span></code>.</p>
<p>After creating the <code class="docutils literal notranslate"><span class="pre">Datasets</span></code>, the user would first define the model to be
used and freeze its parameters. Then we would apply it to the various
<code class="docutils literal notranslate"><span class="pre">Dataset</span></code> objects before calling the <code class="docutils literal notranslate"><span class="pre">LightCurveEstimator</span></code>:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">sky_model</span> <span class="o">=</span> <span class="n">SkyModel</span><span class="p">(</span><span class="n">spatial_model</span><span class="o">=</span><span class="n">spatial_model</span><span class="p">,</span> <span class="n">spectral_model</span><span class="o">=</span><span class="n">spectral_model</span><span class="p">)</span>
<span class="n">sky_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">frozen</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">sky_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;lon_0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">frozen</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">sky_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;lat_0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">frozen</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">sky_model</span>

<span class="n">lc_estimator</span> <span class="o">=</span> <span class="n">LightCurveEstimator</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>
<span class="n">lightcurve</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>To help, the user deal with model parameters some helper function could be
introduced to freeze all parameters of a model. Another possibility is to assume
that all parameters are fixed except the <code class="docutils literal notranslate"><span class="pre">amplitude</span></code> in the
<code class="docutils literal notranslate"><span class="pre">LightCurveEstimator.run()</span></code> method, or pass as arguments the names of the
parameters to leave free.</p>
</section>
<section id="storing-the-results-and-further-studies">
<h3>Storing the results and further studies<a class="headerlink" href="#storing-the-results-and-further-studies" title="Permalink to this headline">#</a></h3>
<p>The results are returned as a <code class="docutils literal notranslate"><span class="pre">gammapy.time.LightCurve</span></code> instance (the current
container class for light curves) that, so far, essentially holds the integrated
flux + errors and the time_min/time_max of each time bin. There are many other
quantities which could be stored, such as the energy range of the flux, the
number of excess events in the time bin considered, etc. The current container
class already provides some methods to study variability, such as chi-square
test, fractional variance estimation.</p>
<p>Example usage:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">lightcurve</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;amplitude&#39;</span><span class="p">)</span>

<span class="c1"># Get fractional variance</span>
<span class="nb">print</span><span class="p">(</span><span class="n">lightcurve</span><span class="o">.</span><span class="n">fvar</span><span class="p">(</span><span class="s1">&#39;amplitude&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">LightCurve</span></code> object should be able to rpovide some rebinning
functionalities. In particular, it stores the fit statistic scan, it should be
possible to perform minimal significance rebinning:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">simple_rebin_lc</span> <span class="o">=</span> <span class="n">lightcurve</span><span class="o">.</span><span class="n">rebin</span><span class="p">(</span><span class="n">factor</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># or</span>
<span class="n">min_significance_lc</span> <span class="o">=</span> <span class="n">lightcurve</span><span class="o">.</span><span class="n">rebin</span><span class="p">(</span><span class="n">min_significance</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="discussion-alternatives">
<h2>Discussion / Alternatives<a class="headerlink" href="#discussion-alternatives" title="Permalink to this headline">#</a></h2>
<section id="time-bins">
<h3>Time bins<a class="headerlink" href="#time-bins" title="Permalink to this headline">#</a></h3>
<p>To work with time bins, we could also rely on <code class="docutils literal notranslate"><span class="pre">astropy.timeseries</span></code> if we force
the dependency to astropy v&gt;3.2. This would look like:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">astropy.timeseries</span> <span class="kn">import</span> <span class="n">BinnedTimeSeries</span>
<span class="n">times</span> <span class="o">=</span> <span class="n">BinnedTimeSeries</span><span class="p">(</span><span class="n">time_bin_start</span><span class="o">=</span><span class="s2">&quot;2006-07-29 20:00:00.000&quot;</span><span class="p">,</span>
                       <span class="n">time_bin_size</span><span class="o">=</span><span class="mi">5</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">min</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">times</span><span class="o">.</span><span class="n">time_bin_start</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">times</span><span class="o">.</span><span class="n">time_bin_end</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="light-curve-fitting">
<h3>Light Curve Fitting<a class="headerlink" href="#light-curve-fitting" title="Permalink to this headline">#</a></h3>
<p>We could provide distinct objects specialized for <code class="docutils literal notranslate"><span class="pre">Map</span></code> and <code class="docutils literal notranslate"><span class="pre">Spectrum</span></code> datasets
instead of a single object.</p>
</section>
<section id="lightcurve">
<h3>Lightcurve<a class="headerlink" href="#lightcurve" title="Permalink to this headline">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Lightcurve</span></code> contains  an <code class="docutils literal notranslate"><span class="pre">astropy.table.Table</span></code> object. It could be
improved by using the <code class="docutils literal notranslate"><span class="pre">astropy_timeseries.BinnedTimeSeries</span></code> object which
itself inherits from <code class="docutils literal notranslate"><span class="pre">QTable</span></code> and provides support for row selection with
time, rebinning and more complex methods for detailed timing studies such as
Lomb-Scargle periodograms.</p>
</section>
</section>
<section id="task-list">
<h2>Task list<a class="headerlink" href="#task-list" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Add <code class="docutils literal notranslate"><span class="pre">TSTART</span></code> and <code class="docutils literal notranslate"><span class="pre">TSTOP</span></code> meta info on the <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> as well as the <code class="docutils literal notranslate"><span class="pre">GTI</span></code> table.</p></li>
<li><p>Introduce <code class="docutils literal notranslate"><span class="pre">GTI.union()`</span></code> method to merge <code class="docutils literal notranslate"><span class="pre">Datasets</span></code>.</p></li>
<li><p>Refactor the <code class="docutils literal notranslate"><span class="pre">Lightcurve</span></code> class to add a number of new content in the <code class="docutils literal notranslate"><span class="pre">Table</span></code> e.g.:</p>
<ul>
<li><p>a <code class="docutils literal notranslate"><span class="pre">fit_stat_scan</span></code> column.</p></li>
<li><p>rebinning methods</p></li>
</ul>
</li>
<li><p>Implement the new <code class="docutils literal notranslate"><span class="pre">LightCurveEstimator</span></code> class</p></li>
<li><p>Provide a notebook showing data reduction  and fitting examples for both 3D and 1D cases</p></li>
</ul>
</section>
<section id="decision">
<h2>Decision<a class="headerlink" href="#decision" title="Permalink to this headline">#</a></h2>
<p>The authors have decided to withdraw the PIG. A significant part of the
implementation is already there. Besides, the recent additions of the high level
interface and of the new Maker scheme change the scope of the discussion.</p>
</section>
</section>


              </div>
              
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2023, The Gammapy developers.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>