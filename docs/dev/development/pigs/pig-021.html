
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>PIG 21 - Models improvements &#8212; gammapy vX.Y.Z</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gammapy.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="shortcut icon" href="../../_static/gammapy_logo.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="PIG 22 - Unified flux estimators API" href="pig-022.html" />
    <link rel="prev" title="PIG 20 - Global Model API" href="pig-020.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../index.html">
  <img src="../../_static/gammapy_logo_nav.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../getting-started/index.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../user-guide/index.html">
  User guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../tutorials/index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../api-reference/index.html">
  API reference
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../index.html">
  Developer guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../release-notes/index.html">
  Release notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-primary btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        dev  <!-- this text may get changed later by javascript -->
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
</div>

<!-- NOTE: this JS must live here (not in our global JS file) because it relies
     on being processed by Jinja before it is run (specifically for replacing
     variables development/pigs/pig-021 and {'json_url': 'https://docs.gammapy.org/stable/switcher.json', 'version_match': 'dev'}.
-->

<script type="text/javascript">
// Check if corresponding page path exists in other version of docs
// and, if so, go there instead of the homepage of the other docs version
function checkPageExistsAndRedirect(event) {
    const currentFilePath = "development/pigs/pig-021.html",
          tryUrl = event.target.getAttribute("href");
    let otherDocsHomepage = tryUrl.replace(currentFilePath, "");
    $.ajax({
        type: 'HEAD',
        url: tryUrl,
        // if the page exists, go there
        success: function() {
            location.href = tryUrl;
        }
    }).fail(function() {
        location.href = otherDocsHomepage;
    });
    // this prevents the browser from following the href of the clicked node
    // (which is fine because this function takes care of redirecting)
    return false;
}

// Populate the version switcher from the JSON config file
(function () {
    $.getJSON("https://docs.gammapy.org/stable/switcher.json", function(data, textStatus, jqXHR) {
        const currentFilePath = "development/pigs/pig-021.html";
        // create links to the corresponding page in the other docs versions
        $.each(data, function(index, entry) {
            // if no custom name specified (e.g., "latest"), use version string
            if (!("name" in entry)) {
                entry.name = entry.version;
            }
            // create the node
            const node = document.createElement("a");
            node.setAttribute("class", "list-group-item list-group-item-action py-1");
            node.textContent = `${entry.name}`;
            node.setAttribute("href", `${entry.url}${currentFilePath}`);
            // on click, AJAX calls will check if the linked page exists before
            // trying to redirect, and if not, will redirect to the homepage
            // for that version of the docs.
            node.onclick = checkPageExistsAndRedirect;
            // Add dataset values for the version and name in case people want
            // to apply CSS styling based on this information.
            node.dataset["versionName"] = entry.name;
            node.dataset["version"] = entry.version;

            $("#version_switcher_menu").append(node);
            // replace dropdown button text with the preferred display name of
            // this version, rather than using sphinx's 1.2.dev1250+g319fc82c9 variable.
            // also highlight the dropdown entry for the currently-viewed
            // version's entry
            if (entry.version == "dev") {
                node.classList.add("active");
                let btn = document.getElementById("version_switcher_button");
                btn.innerText = btn.dataset["activeVersionName"] = entry.name;
                btn.dataset["activeVersion"] = entry.version;
            }
        });
    });
})();
</script>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/gammapy/gammapy" rel="noopener" target="_blank" title="Github"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">Github</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/gammapyST" rel="noopener" target="_blank" title="Twitter"><span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://gammapy.slack.com/" rel="noopener" target="_blank" title="Slack"><span><i class="fab fa-slack"></i></span>
            <label class="sr-only">Slack</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../setup.html">
   Project setup
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dependencies.html">
   Dependencies
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   How to contribute to Gammapy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../release.html">
   How to make a Gammapy release
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../doc_howto.html">
   Documentation How To
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dev_howto.html">
   Developer How To
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="index.html">
   PIGs
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="pig-001.html">
     PIG 1 - PIG purpose and guidelines
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-002.html">
     PIG 2 - Organization of low level analysis code
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-003.html">
     PIG 3 - Plan for dropping Python 2.7 support
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-004.html">
     PIG 4 - Setup for tutorial notebooks and data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-005.html">
     PIG 5 - Gammapy 1.0 roadmap
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-006.html">
     PIG 6 - CTA observation handling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-007.html">
     PIG 7 - Models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-008.html">
     PIG 8 - Datasets
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-009.html">
     PIG 9 - Event sampling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-010.html">
     PIG 10 - Regions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-011.html">
     PIG 11 - Light curves
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-012.html">
     PIG 12 - High level interface
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-013.html">
     PIG 13 - Gammapy dependencies and distribution
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-014.html">
     PIG 14 - Uncertainty estimation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-016.html">
     PIG 16 - Gammapy package structure
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-018.html">
     PIG 18 - Documentation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-019.html">
     PIG 19 - Gammapy package structure follow up
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-020.html">
     PIG 20 - Global Model API
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     PIG 21 - Models improvements
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-022.html">
     PIG 22 - Unified flux estimators API
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-023.html">
     PIG 23 - Gammapy release cycle and version numbering
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-024.html">
     PIG 24 - Authorship policy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-025.html">
     PIG 25 - Metadata container for Gammapy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pig-026.html">
     PIG 26 - Model Priors API
    </a>
   </li>
  </ul>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#abstract">
   Abstract
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#proposal">
   Proposal
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#spectral-norm-models">
     Spectral Norm Models
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#energy-dependent-spatial-models">
     Energy Dependent Spatial Models
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#spectral-absorption-model">
     Spectral Absorption Model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#additional-models">
     Additional Models
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#simplify-yaml-representation">
     Simplify YAML Representation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#introduce-shorter-yaml-alias-tags">
       Introduce Shorter YAML Alias Tags
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#simplify-yaml-parameter-representation">
       Simplify YAML Parameter Representation
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#decision">
   Decision
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="pig-21-models-improvements">
<span id="pig-021"></span><h1>PIG 21 - Models improvements<a class="headerlink" href="#pig-21-models-improvements" title="Permalink to this headline">#</a></h1>
<ul class="simple">
<li><p>Author: Axel Donath, Régis Terrier and Quentin Remy</p></li>
<li><p>Created: Jun 10, 2020</p></li>
<li><p>Accepted: July 31, 2020</p></li>
<li><p>Status: accepted</p></li>
<li><p>Discussion: <a class="reference external" href="https://github.com/gammapy/gammapy/pull/2944">GH 2944</a></p></li>
</ul>
<section id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">#</a></h2>
<p>This PIG outlines further minor improvements to the modeling framework of Gammapy.
This includes introduction of a spectra models with norm parameters, minimal
support for energy dependent spatial models as well as simplifications of the
YAML serialisation.</p>
</section>
<section id="proposal">
<h2>Proposal<a class="headerlink" href="#proposal" title="Permalink to this headline">#</a></h2>
<section id="spectral-norm-models">
<h3>Spectral Norm Models<a class="headerlink" href="#spectral-norm-models" title="Permalink to this headline">#</a></h3>
<p>For the purpose of adjusting template based models we propose to introduce a new
class of spectral models. Those spectral models feature a norm parameter instead
of amplitude and are named using the <code class="docutils literal notranslate"><span class="pre">NormSpectralModel</span></code> suffix:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gammapy.modeling.models</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">PowerLawNormSpectralModel</span><span class="p">,</span>
    <span class="n">LogParabolaNormSpectralModel</span><span class="p">,</span>
    <span class="n">PiecewiseBrokenPowerlawNormSpectralModel</span><span class="p">,</span>
    <span class="n">ConstantNormSpectralModel</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">pwl_norm</span> <span class="o">=</span> <span class="n">PowerLawNormSpectralModel</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="p">,</span> <span class="n">tilt</span><span class="o">=</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="p">)</span>
<span class="n">log_parabola_norm</span> <span class="o">=</span> <span class="n">LogParabolaNormSpectralModel</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="p">)</span>
<span class="n">bpwl_norm</span> <span class="o">=</span> <span class="n">PiecewiseBrokenPowerlawNormSpectralModel</span><span class="p">(</span><span class="n">norms</span><span class="o">=</span><span class="p">,</span> <span class="n">energies</span><span class="o">=</span><span class="p">)</span>
<span class="n">const_norm</span> <span class="o">=</span> <span class="n">ConstantNormSpectralModel</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="p">)</span>

<span class="c1"># typically used like</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">TemplateSpectralModel</span><span class="p">()</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">template</span> <span class="o">*</span> <span class="n">pwl_norm</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">BackgroundModel</span><span class="p">(</span>
            <span class="nb">map</span><span class="o">=</span><span class="nb">map</span><span class="p">,</span>
            <span class="n">spectral_model</span><span class="o">=</span><span class="n">pwl_norm</span>
    <span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">SkyDiffuseCube</span><span class="p">(</span>
            <span class="nb">map</span><span class="o">=</span><span class="nb">map</span><span class="p">,</span>
            <span class="n">spectral_model</span><span class="o">=</span><span class="n">pwl_norm</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>This requires removing the hard-coded parameters of the <code class="xref py py-obj docutils literal notranslate"><span class="pre">TemplateSpectralModel</span></code> and <code class="xref py py-obj docutils literal notranslate"><span class="pre">BackgroundModel</span></code>.</p>
</section>
<section id="energy-dependent-spatial-models">
<h3>Energy Dependent Spatial Models<a class="headerlink" href="#energy-dependent-spatial-models" title="Permalink to this headline">#</a></h3>
<p>A very common use-case in scientific analyses is to look for energy dependent
morphology of extended sources. In the past this kind of analysis has been typically
done by splitting the data into energy bands and doing individual fits of the
morphology in these energy bands. In a combined spectral and spatial (“cube”) analysis
this can be naturally achieved by allowing for an energy dependent spatial model,
where the energy dependence is e.g. described by a parametric model expression with
energy dependent parameters.</p>
<p>In the current model scheme we use a “factorised” representation of the source model,
where the spatial, energy and time dependence are independent model components and
not correlated:</p>
<div class="math notranslate nohighlight">
\[f(l, b, E, t) = A \cdot F(l, b) \cdot G(E) \cdot H(t)\]</div>
<p>To represent energy dependent morphology we propose to introduce energy
dependent spatial models:</p>
<div class="math notranslate nohighlight">
\[f(l, b, E, t) = A \cdot F(l, b, E) \cdot G(E) \cdot H(t)\]</div>
<p>In general the energy dependence is optional. If the spatial model does not declare
an energy dependence it assumes the same morphology for all energies. This also ensures backwards
compatibility with the current behaviour.</p>
<p>To limit the implementation effort in this PIG we propose to only add an example energy dependent
custom model to our documentation. We do not propose to introduce general dependence of arbitrary
model parameters for any spatial model, such as <code class="docutils literal notranslate"><span class="pre">GaussianSpatialModel</span></code> or <code class="docutils literal notranslate"><span class="pre">DiskSpatialModel</span></code>.
An example of how this can be achieved with a custom implemented model is given below:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gammapy.modeling.models</span> <span class="kn">import</span> <span class="n">SpatialModel</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">angular_separation</span>

<span class="k">class</span> <span class="nc">MyCustomGaussianModel</span><span class="p">(</span><span class="n">SpatialModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;My custom gaussian model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lon_0, lat_0 : `~astropy.coordinates.Angle`</span>
<span class="sd">        Center position</span>
<span class="sd">    sigma_1TeV : `~astropy.coordinates.Angle`</span>
<span class="sd">        Width of the Gaussian at 1 TeV</span>
<span class="sd">    sigma_10TeV : `~astropy.coordinates.Angle`</span>
<span class="sd">        Width of the Gaussian at 10 TeV</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s2">&quot;MyCustomGaussianModel&quot;</span>
    <span class="n">lon_0</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s2">&quot;lon_0&quot;</span><span class="p">,</span> <span class="s2">&quot;0 deg&quot;</span><span class="p">)</span>
    <span class="n">lat_0</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s2">&quot;lat_0&quot;</span><span class="p">,</span> <span class="s2">&quot;0 deg&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mi">90</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

    <span class="n">sigma_1TeV</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s2">&quot;sigma_1TeV&quot;</span><span class="p">,</span> <span class="s2">&quot;1 deg&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sigma_10TeV</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s2">&quot;sigma_10TeV&quot;</span><span class="p">,</span> <span class="s2">&quot;0.5 deg&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="nd">@staticmethod</span><span class="p">:</span>
<span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">lon_0</span><span class="p">,</span> <span class="n">lat_0</span><span class="p">,</span> <span class="n">sigma_1TeV</span><span class="p">,</span> <span class="n">sigma_10TeV</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluate custom Gaussian model&quot;&quot;&quot;</span>
    <span class="n">sigmas</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">([</span><span class="n">sigma_1TeV</span><span class="p">,</span> <span class="n">sigma_10TeV</span><span class="p">])</span>
    <span class="n">energy_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">energy_nodes</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">)</span>

    <span class="n">sep</span> <span class="o">=</span> <span class="n">angular_separation</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon_0</span><span class="p">,</span> <span class="n">lat_0</span><span class="p">)</span>

    <span class="n">exponent</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sep</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">norm</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">exponent</span><span class="p">)</span>

<span class="nd">@property</span>
<span class="k">def</span> <span class="nf">evaluation_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluation radius (`~astropy.coordinates.Angle`).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_1TeV</span><span class="o">.</span><span class="n">quantity</span>
</pre></div>
</div>
</section>
<section id="spectral-absorption-model">
<h3>Spectral Absorption Model<a class="headerlink" href="#spectral-absorption-model" title="Permalink to this headline">#</a></h3>
<p>In the current handling of absorbed spectral models we have a very special
<code class="docutils literal notranslate"><span class="pre">Absorption</span></code> model, which is not a spectral model. To resolve this special
case, we propose to refactor the existing code and handle the absorbed case
using a <code class="docutils literal notranslate"><span class="pre">CompoundSpectralModel</span></code>. The new implementation is used as follows:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gammapy.modeling.models</span> <span class="kn">import</span> <span class="n">EBLAbsorptionNormSpectralModel</span><span class="p">,</span> <span class="n">PowerLawSpectralModel</span>

<span class="n">absorption</span> <span class="o">=</span> <span class="n">EBLAbsorptionNormSpectralModel</span><span class="o">.</span><span class="n">from_reference</span><span class="p">(</span>
    <span class="n">redshift</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">alpha_norm</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="s2">&quot;dominguez&quot;</span>
<span class="p">)</span>

<span class="n">pwl</span> <span class="o">=</span> <span class="n">PowerLawSpectralModel</span><span class="p">()</span>

<span class="n">spectral_model</span> <span class="o">=</span> <span class="n">absorption</span> <span class="o">*</span> <span class="n">pwl</span>

<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spectral_model</span><span class="p">,</span> <span class="n">CompoundSpectralModel</span><span class="p">)</span>
</pre></div>
</div>
<p>In addition we propose to rename <code class="docutils literal notranslate"><span class="pre">.table_model</span></code> to <code class="docutils literal notranslate"><span class="pre">.to_template_spectral_model(redshift,</span> <span class="pre">alpha_norm)</span></code>.</p>
</section>
<section id="additional-models">
<h3>Additional Models<a class="headerlink" href="#additional-models" title="Permalink to this headline">#</a></h3>
<p>In addition we propose to implement the following models in <code class="docutils literal notranslate"><span class="pre">gammapy.modeling.models</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SersicSpatialModel</span></code> following the parametrisation of the Astropy <code class="docutils literal notranslate"><span class="pre">Sersic2D</span></code> model.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BrokenPowerLaw</span></code> with the following parametrisation:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{split}\phi(E) = \phi_0 \times \left \{
    \begin{eqnarray}
            \left( \frac{E}{E_b} \right)^{\gamma_1} &amp; {\rm if\,\,} E &lt; E_b \\
            \left( \frac{E}{E_b} \right)^{\gamma_2} &amp; {\rm otherwise}
    \end{eqnarray}
    \right .\end{split}\end{split}\]</div>
<ul class="simple">
<li><p>We propose to re-introduce the <code class="docutils literal notranslate"><span class="pre">PhaseCurveModel</span></code> to compute mean fluxes over time</p></li>
</ul>
</section>
<section id="simplify-yaml-representation">
<h3>Simplify YAML Representation<a class="headerlink" href="#simplify-yaml-representation" title="Permalink to this headline">#</a></h3>
<section id="introduce-shorter-yaml-alias-tags">
<h4>Introduce Shorter YAML Alias Tags<a class="headerlink" href="#introduce-shorter-yaml-alias-tags" title="Permalink to this headline">#</a></h4>
<p>To simplify the definition of models in YAML files as well as for interactive
model creation we propose to introduce shorter YAML tags for all models in Gammapy.
For backwards compatibility we propose to support the class name as well. We
require that the short YAML tag is only unique within the model class, so that
the same tag such as “gauss” can be re-used by spectral, spatial as well as
temporal components. The uniqueness is guaranteed in the YAML file, because
of the different sections for the model types. For writing the models the
verbose class name is used by default.</p>
<p>We propose to introduce the following YAML tags:</p>
<table class="table">
<colgroup>
<col style="width: 65%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Class Name</p></th>
<th class="head"><p>YAML Tag</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ConstantSpectralModel</p></td>
<td><p>const</p></td>
</tr>
<tr class="row-odd"><td><p>ConstantNormSpectralModel</p></td>
<td><p>const-norm</p></td>
</tr>
<tr class="row-even"><td><p>CompoundSpectralModel</p></td>
<td><p>compound</p></td>
</tr>
<tr class="row-odd"><td><p>PowerLawSpectralModel</p></td>
<td><p>pl</p></td>
</tr>
<tr class="row-even"><td><p>PowerLawNormSpectralModel</p></td>
<td><p>pl-norm</p></td>
</tr>
<tr class="row-odd"><td><p>PowerLaw2SpectralModel</p></td>
<td><p>pl-2</p></td>
</tr>
<tr class="row-even"><td><p>SmoothBrokenPowerLawSpectralModel</p></td>
<td><p>sbpl</p></td>
</tr>
<tr class="row-odd"><td><p>BrokenPowerLawSpectralModel</p></td>
<td><p>bpl</p></td>
</tr>
<tr class="row-even"><td><p>PiecewiseBrokenPowerLawNormSpectraModel</p></td>
<td><p>pwbpl-norm</p></td>
</tr>
<tr class="row-odd"><td><p>ExpCutoffPowerLawSpectralModel</p></td>
<td><p>ecpl</p></td>
</tr>
<tr class="row-even"><td><p>ExpCutoffPowerLaw3FGLSpectralModel</p></td>
<td><p>ecpl-3fgl</p></td>
</tr>
<tr class="row-odd"><td><p>SuperExpCutoffPowerLaw3FGLSpectralModel</p></td>
<td><p>secpl-3fgl</p></td>
</tr>
<tr class="row-even"><td><p>SuperExpCutoffPowerLaw4FGLSpectralModel</p></td>
<td><p>secpl-4fgl</p></td>
</tr>
<tr class="row-odd"><td><p>LogParabolaSpectralModel</p></td>
<td><p>lp</p></td>
</tr>
<tr class="row-even"><td><p>LogParabolaNormSpectralModel</p></td>
<td><p>lp-norm</p></td>
</tr>
<tr class="row-odd"><td><p>TemplateSpectralModel</p></td>
<td><p>template</p></td>
</tr>
<tr class="row-even"><td><p>GaussianSpectralModel</p></td>
<td><p>gauss</p></td>
</tr>
<tr class="row-odd"><td><p>EBLAbsorbtionNormSpectralModel</p></td>
<td><p>ebl-absorbtion-norm</p></td>
</tr>
<tr class="row-even"><td><p>NaimaSpectralModel</p></td>
<td><p>naima</p></td>
</tr>
<tr class="row-odd"><td><p>ScaleSpectralModel</p></td>
<td><p>scale</p></td>
</tr>
</tbody>
</table>
<table class="table">
<colgroup>
<col style="width: 57%" />
<col style="width: 43%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Class Name</p></th>
<th class="head"><p>YAML Tag</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ConstantSpatialModel</p></td>
<td><p>const</p></td>
</tr>
<tr class="row-odd"><td><p>TemplateSpatialModel</p></td>
<td><p>template</p></td>
</tr>
<tr class="row-even"><td><p>GaussianSpatialModel</p></td>
<td><p>gauss</p></td>
</tr>
<tr class="row-odd"><td><p>DiskSpatialModel</p></td>
<td><p>disk</p></td>
</tr>
<tr class="row-even"><td><p>PointSpatialModel</p></td>
<td><p>point</p></td>
</tr>
<tr class="row-odd"><td><p>ShellSpatialModel</p></td>
<td><p>shell</p></td>
</tr>
<tr class="row-even"><td><p>SersicSpatialModel</p></td>
<td><p>sersic</p></td>
</tr>
</tbody>
</table>
<table class="table">
<colgroup>
<col style="width: 62%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Class Name</p></th>
<th class="head"><p>YAML Tag</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ConstantTemporalModel</p></td>
<td><p>const</p></td>
</tr>
<tr class="row-odd"><td><p>LightCurveTemplateTemporalModel</p></td>
<td><p>template</p></td>
</tr>
<tr class="row-even"><td><p>GaussianTemporalModel</p></td>
<td><p>gauss</p></td>
</tr>
<tr class="row-odd"><td><p>ExpDecayTemporalModel</p></td>
<td><p>exp-decay</p></td>
</tr>
</tbody>
</table>
<p>To simplify the interactive model creation we propose to introduce:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gammapy.modeling.models</span> <span class="kn">import</span> <span class="n">SkyModel</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">SkyModel</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">spectral_type</span><span class="o">=</span><span class="s2">&quot;pl&quot;</span><span class="p">,</span>
            <span class="n">spectral_pars</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
            <span class="n">spatial_type</span><span class="o">=</span><span class="s2">&quot;gauss&quot;</span><span class="p">,</span>
            <span class="n">spatial_pars</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sigma&quot;</span><span class="p">:</span> <span class="s2">&quot;0.1 deg&quot;</span><span class="p">},</span>
            <span class="n">temporal_type</span><span class="o">=</span><span class="s2">&quot;const&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>In addition the <code class="docutils literal notranslate"><span class="pre">Model.create()</span></code> factory function should be
adapted to:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gammapy.modeling.models</span> <span class="kn">import</span> <span class="n">Model</span>

<span class="n">pwl</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s2">&quot;gauss&quot;</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;spectral&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">pars</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="simplify-yaml-parameter-representation">
<h4>Simplify YAML Parameter Representation<a class="headerlink" href="#simplify-yaml-parameter-representation" title="Permalink to this headline">#</a></h4>
<p>To further simplify the structure of the YAML file we propose to remove parameter
properties if they are equivalent to the default values. The current representation
looks like:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">spectral</span><span class="p">:</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">PowerLawSpectralModel</span>
    <span class="n">parameters</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">index</span>
      <span class="n">value</span><span class="p">:</span> <span class="mf">2.0</span>
      <span class="n">unit</span><span class="p">:</span> <span class="s1">&#39;&#39;</span>
      <span class="nb">min</span><span class="p">:</span> <span class="o">.</span><span class="n">nan</span>
      <span class="nb">max</span><span class="p">:</span> <span class="o">.</span><span class="n">nan</span>
      <span class="n">frozen</span><span class="p">:</span> <span class="n">false</span>
      <span class="n">error</span><span class="p">:</span> <span class="mi">0</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">amplitude</span>
      <span class="n">value</span><span class="p">:</span> <span class="mf">1.0e-12</span>
      <span class="n">unit</span><span class="p">:</span> <span class="n">cm</span><span class="o">-</span><span class="mi">2</span> <span class="n">s</span><span class="o">-</span><span class="mi">1</span> <span class="n">TeV</span><span class="o">-</span><span class="mi">1</span>
      <span class="nb">min</span><span class="p">:</span> <span class="o">.</span><span class="n">nan</span>
      <span class="nb">max</span><span class="p">:</span> <span class="o">.</span><span class="n">nan</span>
      <span class="n">frozen</span><span class="p">:</span> <span class="n">false</span>
      <span class="n">error</span><span class="p">:</span> <span class="mi">0</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">reference</span>
      <span class="n">value</span><span class="p">:</span> <span class="mf">1.0</span>
      <span class="n">unit</span><span class="p">:</span> <span class="n">TeV</span>
      <span class="nb">min</span><span class="p">:</span> <span class="o">.</span><span class="n">nan</span>
      <span class="nb">max</span><span class="p">:</span> <span class="o">.</span><span class="n">nan</span>
      <span class="n">frozen</span><span class="p">:</span> <span class="n">true</span>
      <span class="n">error</span><span class="p">:</span> <span class="mi">0</span>
</pre></div>
</div>
<p>After the simplification:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">spectral</span><span class="p">:</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">PowerLawSpectralModel</span>
    <span class="n">parameters</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">index</span>
      <span class="n">value</span><span class="p">:</span> <span class="mf">2.0</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">amplitude</span>
      <span class="n">value</span><span class="p">:</span> <span class="mf">1.0e-12</span>
      <span class="n">unit</span><span class="p">:</span> <span class="n">cm</span><span class="o">-</span><span class="mi">2</span> <span class="n">s</span><span class="o">-</span><span class="mi">1</span> <span class="n">TeV</span><span class="o">-</span><span class="mi">1</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">reference</span>
      <span class="n">value</span><span class="p">:</span> <span class="mf">1.0</span>
      <span class="n">unit</span><span class="p">:</span> <span class="n">TeV</span>
      <span class="n">frozen</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="decision">
<h2>Decision<a class="headerlink" href="#decision" title="Permalink to this headline">#</a></h2>
<p>This PIG received feedback in form of comments to the PR <a class="reference external" href="https://github.com/gammapy/gammapy/pull/2944">GH 2944</a> and via private
Slack messages to the authors. Most concerns were raised against the introduction
of <code class="xref py py-obj docutils literal notranslate"><span class="pre">NormSpectralModels</span></code>. In a following discussion among the lead developers
it was decided to stick with the proposal, but keep the abstraction of <code class="xref py py-obj docutils literal notranslate"><span class="pre">SkyDiffuseCube</span></code>
to avoid the case, where a spatial model carries the flux information.
A final review announced on the Gammapy and CC mailing list did not yield
any additional comments. Therefore the PIG was accepted on July 31, 2020.</p>
</section>
</section>


              </div>
              
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2023, The Gammapy developers.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>