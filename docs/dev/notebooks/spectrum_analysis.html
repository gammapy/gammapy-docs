
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Spectral analysis with Gammapy &#8212; gammapy v0.7.dev5391</title>
    <link rel="stylesheet" href="../_static/gammapy.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.7.dev5391',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/sidebar.js"></script>
    <link rel="shortcut icon" href="../_static/astropy_logo.ico"/>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>
<script type="text/javascript" src="../_static/copybutton.js"></script>


  </head>
  <body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../index.html"><span id="logotext1">gamma</span><span id="logotext2">py</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../index.html">gammapy v0.7.dev5391</a>
	 &#187;
      </li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 9ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }
</style>
<script type="text/javascript" src="../_static/linksdl.js"></script><div class="admonition note">
<p class="first"><strong>This is a fixed-text formatted version of a Jupyter notebook.</strong></p>
<p>Try online on Binder</p>
<p><a class="reference external" href="https://beta.mybinder.org/v2/gh/gammapy/gammapy-extra/master?filepath=spectrum_analysis.ipynb"><img alt="Binder" src="https://mybinder.org/badge.svg" /></a></p>
<p>Alternatively you can download for each version of Gammapy a <a class="reference external" href="http://readthedocs.org/projects/gammapy/downloads/">HTMLZip
pack</a> containing
the whole HTML documentation and full collection of notebooks, so you
can execute them in your local <code class="docutils literal"><span class="pre">_static/notebooks/</span></code> folder. You can
also contribute with your own notebooks in this <a class="reference external" href="https://github.com/gammapy/gammapy-extra/tree/master/notebooks">GitHub
repository</a>.</p>
<p class="last"><strong>Source files:</strong>
<a class="reference external" href="../_static/notebooks/spectrum_analysis.ipynb">spectrum_analysis.ipynb</a>
| <a class="reference external" href="../_static/notebooks/spectrum_analysis.py">spectrum_analysis.py</a></p>
</div>
<div class="section" id="Spectral-analysis-with-Gammapy">
<h1>Spectral analysis with Gammapy<a class="headerlink" href="#Spectral-analysis-with-Gammapy" title="Permalink to this headline">¶</a></h1>
<div class="section" id="Introduction">
<h2>Introduction<a class="headerlink" href="#Introduction" title="Permalink to this headline">¶</a></h2>
<p>This notebook explains in detail how to use the classes in
<a class="reference internal" href="../spectrum/index.html"><span class="doc">gammapy.spectrum</span></a> and related ones. Note,
that there is also <a class="reference internal" href="spectrum_pipe.html"><span class="doc">spectrum_pipe.ipynb</span></a> which
explains how to do the analysis using a high-level interface. This
notebook is aimed at advanced users who want to script taylor-made
analysis pipelines and implement new methods.</p>
<p>Based on a datasets of 4 Crab observations with H.E.S.S. (simulated
events for now) we will perform a full region based spectral analysis,
i.e. extracting source and background counts from certain regions, and
fitting them using the forward-folding approach. We will use the
following classes</p>
<p>Data handling:</p>
<ul class="simple">
<li><a class="reference internal" href="../api/gammapy.data.DataStore.html"><span class="doc">gammapy.data.DataStore</span></a></li>
<li><a class="reference internal" href="../api/gammapy.data.DataStoreObservation.html"><span class="doc">gammapy.data.DataStoreObservation</span></a></li>
<li><a class="reference internal" href="../api/gammapy.data.ObservationStats.html"><span class="doc">gammapy.data.ObservationStats</span></a></li>
<li><a class="reference internal" href="../api/gammapy.data.ObservationSummary.html"><span class="doc">gammapy.data.ObservationSummary</span></a></li>
</ul>
<p>To extract the 1-dim spectral information:</p>
<ul class="simple">
<li><a class="reference internal" href="../api/gammapy.spectrum.SpectrumObservation.html"><span class="doc">gammapy.spectrum.SpectrumObservation</span></a></li>
<li><a class="reference internal" href="../api/gammapy.spectrum.SpectrumExtraction.html"><span class="doc">gammapy.spectrum.SpectrumExtraction</span></a></li>
<li><a class="reference internal" href="../api/gammapy.background.ReflectedRegionsBackgroundEstimator.html"><span class="doc">gammapy.background.ReflectedRegionsBackgroundEstimator</span></a></li>
</ul>
<p>For the global fit (using Sherpa and WSTAT in the background):</p>
<ul class="simple">
<li><a class="reference internal" href="../api/gammapy.spectrum.SpectrumFit.html"><span class="doc">gammapy.spectrum.SpectrumFit</span></a></li>
<li><a class="reference internal" href="../api/gammapy.spectrum.models.PowerLaw.html"><span class="doc">gammapy.spectrum.models.PowerLaw</span></a></li>
<li><a class="reference internal" href="../api/gammapy.spectrum.models.ExponentialCutoffPowerLaw.html"><span class="doc">gammapy.spectrum.models.ExponentialCutoffPowerLaw</span></a></li>
<li><a class="reference internal" href="../api/gammapy.spectrum.models.LogParabola.html"><span class="doc">gammapy.spectrum.models.LogParabola</span></a></li>
</ul>
<p>To compute flux points (a.k.a. “SED” = “spectral energy distribution”)</p>
<ul class="simple">
<li><a class="reference internal" href="../api/gammapy.spectrum.SpectrumResult.html"><span class="doc">gammapy.spectrum.SpectrumResult</span></a></li>
<li><a class="reference internal" href="../api/gammapy.spectrum.FluxPoints.html"><span class="doc">gammapy.spectrum.FluxPoints</span></a></li>
<li><a class="reference internal" href="../api/gammapy.spectrum.SpectrumEnergyGroupMaker.html"><span class="doc">gammapy.spectrum.SpectrumEnergyGroupMaker</span></a></li>
<li><a class="reference internal" href="../api/gammapy.spectrum.FluxPointEstimator.html"><span class="doc">gammapy.spectrum.FluxPointEstimator</span></a></li>
</ul>
<p>Feedback welcome!</p>
</div>
<div class="section" id="Setup">
<h2>Setup<a class="headerlink" href="#Setup" title="Permalink to this headline">¶</a></h2>
<p>As usual, we’ll start with some setup …</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Check package versions</span>
<span class="kn">import</span> <span class="nn">gammapy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy</span>
<span class="kn">import</span> <span class="nn">regions</span>
<span class="kn">import</span> <span class="nn">sherpa</span>

<span class="k">print</span><span class="p">(</span><span class="s1">&#39;gammapy:&#39;</span><span class="p">,</span> <span class="n">gammapy</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;numpy:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;astropy&#39;</span><span class="p">,</span> <span class="n">astropy</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;regions&#39;</span><span class="p">,</span> <span class="n">regions</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;sherpa&#39;</span><span class="p">,</span> <span class="n">sherpa</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
gammapy: 0.7.dev5129
numpy: 1.13.3
astropy 3.0.dev20290
regions 0.2
sherpa 4.9.1+12.g3626715
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">astropy.units</span> <span class="kn">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">Angle</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">vstack</span> <span class="k">as</span> <span class="n">vstack_table</span>
<span class="kn">from</span> <span class="nn">regions</span> <span class="kn">import</span> <span class="n">CircleSkyRegion</span>
<span class="kn">from</span> <span class="nn">gammapy.data</span> <span class="kn">import</span> <span class="n">DataStore</span><span class="p">,</span> <span class="n">ObservationList</span>
<span class="kn">from</span> <span class="nn">gammapy.data</span> <span class="kn">import</span> <span class="n">ObservationStats</span><span class="p">,</span> <span class="n">ObservationSummary</span>
<span class="kn">from</span> <span class="nn">gammapy.background.reflected</span> <span class="kn">import</span> <span class="n">ReflectedRegionsBackgroundEstimator</span>
<span class="kn">from</span> <span class="nn">gammapy.utils.energy</span> <span class="kn">import</span> <span class="n">EnergyBounds</span>
<span class="kn">from</span> <span class="nn">gammapy.spectrum</span> <span class="kn">import</span> <span class="n">SpectrumExtraction</span><span class="p">,</span> <span class="n">SpectrumObservation</span><span class="p">,</span> <span class="n">SpectrumFit</span><span class="p">,</span> <span class="n">SpectrumResult</span>
<span class="kn">from</span> <span class="nn">gammapy.spectrum.models</span> <span class="kn">import</span> <span class="n">PowerLaw</span><span class="p">,</span> <span class="n">ExponentialCutoffPowerLaw</span><span class="p">,</span> <span class="n">LogParabola</span>
<span class="kn">from</span> <span class="nn">gammapy.spectrum</span> <span class="kn">import</span> <span class="n">FluxPoints</span><span class="p">,</span> <span class="n">SpectrumEnergyGroupMaker</span><span class="p">,</span> <span class="n">FluxPointEstimator</span>
<span class="kn">from</span> <span class="nn">gammapy.image</span> <span class="kn">import</span> <span class="n">SkyImage</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Configure-logger">
<h2>Configure logger<a class="headerlink" href="#Configure-logger" title="Permalink to this headline">¶</a></h2>
<p>Most high level classes in gammapy have the possibility to turn on
logging or debug output. We well configure the logger in the following.
For more info see
<a class="reference external" href="https://docs.python.org/2/howto/logging.html#logging-basic-tutorial">https://docs.python.org/2/howto/logging.html#logging-basic-tutorial</a></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Setup the logger</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">()</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;gammapy.spectrum&#39;</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Load-Data">
<h2>Load Data<a class="headerlink" href="#Load-Data" title="Permalink to this headline">¶</a></h2>
<p>First, we select and load some H.E.S.S. observations of the Crab nebula
(simulated events for now).</p>
<p>We will access the events, effective area, energy dispersion, livetime
and PSF for containement correction.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">DATA_DIR</span> <span class="o">=</span> <span class="s1">&#39;$GAMMAPY_EXTRA/datasets/hess-crab4-hd-hap-prod2&#39;</span>

<span class="n">datastore</span> <span class="o">=</span> <span class="n">DataStore</span><span class="o">.</span><span class="n">from_dir</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">)</span>
<span class="n">obs_ids</span> <span class="o">=</span> <span class="p">[</span><span class="mi">23523</span><span class="p">,</span> <span class="mi">23526</span><span class="p">,</span> <span class="mi">23559</span><span class="p">,</span> <span class="mi">23592</span><span class="p">]</span>

<span class="n">obs_list</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">obs_list</span><span class="p">(</span><span class="n">obs_ids</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Define-Target-Region">
<h2>Define Target Region<a class="headerlink" href="#Define-Target-Region" title="Permalink to this headline">¶</a></h2>
<p>The next step is to define a signal extraction region, also known as on
region. In the simplest case this is just a
<a class="reference external" href="http://astropy-regions.readthedocs.io/en/latest/api/regions.CircleSkyRegion.html#regions.CircleSkyRegion">CircleSkyRegion</a>,
but here we will use the <code class="docutils literal"><span class="pre">Target</span></code> class in gammapy that is useful for
book-keeping if you run several analysis in a script.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">target_position</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="mf">83.63</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="mf">22.01</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span>
<span class="n">on_region_radius</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="s1">&#39;0.11 deg&#39;</span><span class="p">)</span>
<span class="n">on_region</span> <span class="o">=</span> <span class="n">CircleSkyRegion</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">target_position</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">on_region_radius</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Load-exclusion-mask">
<h2>Load exclusion mask<a class="headerlink" href="#Load-exclusion-mask" title="Permalink to this headline">¶</a></h2>
<p>Most analysis will require a mask to exclude regions with possible
gamma-ray signal from the background estimation procedure. For
simplicity, we will use a pre-cooked exclusion mask from gammapy-extra
which includes (or rather excludes) all source listed in the
<a class="reference external" href="http://tevcat.uchicago.edu/">TeVCat</a> and cutout only the region
around the crab.</p>
<p>TODO: Change to <a class="reference external" href="https://gammapy.github.io/gamma-cat/">gamma-cat</a></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">EXCLUSION_FILE</span> <span class="o">=</span> <span class="s1">&#39;$GAMMAPY_EXTRA/datasets/exclusion_masks/tevcat_exclusion.fits&#39;</span>

<span class="n">allsky_mask</span> <span class="o">=</span> <span class="n">SkyImage</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">EXCLUSION_FILE</span><span class="p">)</span>
<span class="n">exclusion_mask</span> <span class="o">=</span> <span class="n">allsky_mask</span><span class="o">.</span><span class="n">cutout</span><span class="p">(</span>
    <span class="n">position</span><span class="o">=</span><span class="n">on_region</span><span class="o">.</span><span class="n">center</span><span class="p">,</span>
    <span class="n">size</span><span class="o">=</span><span class="n">Angle</span><span class="p">(</span><span class="s1">&#39;6 deg&#39;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Estimate-background">
<h2>Estimate background<a class="headerlink" href="#Estimate-background" title="Permalink to this headline">¶</a></h2>
<p>Next we will manually perform a background estimate by placing
<a class="reference internal" href="../background/reflected.html"><span class="doc">reflected regions</span></a> around the pointing
position and looking at the source statistics. This will result in a
<a class="reference internal" href="../api/gammapy.background.BackgroundEstimate.html"><span class="doc">gammapy.background.BackgroundEstimate</span></a>
that serves as input for other classes in gammapy.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">background_estimator</span> <span class="o">=</span> <span class="n">ReflectedRegionsBackgroundEstimator</span><span class="p">(</span>
    <span class="n">obs_list</span><span class="o">=</span><span class="n">obs_list</span><span class="p">,</span>
    <span class="n">on_region</span><span class="o">=</span><span class="n">on_region</span><span class="p">,</span>
    <span class="n">exclusion_mask</span> <span class="o">=</span> <span class="n">exclusion_mask</span><span class="p">)</span>

<span class="n">background_estimator</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">background_estimator</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
BackgroundEstimate
 Method: Reflected Regions
 on region
 Region: CircleSkyRegion
center: &lt;SkyCoord (ICRS): (ra, dec) in deg
    ( 83.63,  22.01)&gt;
radius: 0.11 deg
 EventList info:
- Number of events: 172
- Median energy: 1.2035582065582275 TeV
- Median azimuth: 0.0
- Median altitude: 0.0

 off region
 [&lt;CircleSkyRegion(&lt;SkyCoord (Galactic): (l, b) in deg
    ( 184.52251966, -6.24161087)&gt;, radius=0.11040258105103296 deg)&gt;, &lt;CircleSkyRegion(&lt;SkyCoord (Galactic): (l, b) in deg
    ( 184.65000376, -6.42189598)&gt;, radius=0.11040258105103296 deg)&gt;, &lt;CircleSkyRegion(&lt;SkyCoord (Galactic): (l, b) in deg
    ( 184.84295448, -6.52925025)&gt;, radius=0.11040258105103296 deg)&gt;, &lt;CircleSkyRegion(&lt;SkyCoord (Galactic): (l, b) in deg
    ( 185.06336026, -6.54252475)&gt;, radius=0.11040258105103296 deg)&gt;, &lt;CircleSkyRegion(&lt;SkyCoord (Galactic): (l, b) in deg
    ( 185.26780087, -6.45910437)&gt;, radius=0.11040258105103296 deg)&gt;, &lt;CircleSkyRegion(&lt;SkyCoord (Galactic): (l, b) in deg
    ( 185.41600122, -6.29542305)&gt;, radius=0.11040258105103296 deg)&gt;, &lt;CircleSkyRegion(&lt;SkyCoord (Galactic): (l, b) in deg
    ( 185.47876565, -6.08372622)&gt;, radius=0.11040258105103296 deg)&gt;, &lt;CircleSkyRegion(&lt;SkyCoord (Galactic): (l, b) in deg
    ( 185.44372948, -5.86571845)&gt;, radius=0.11040258105103296 deg)&gt;, &lt;CircleSkyRegion(&lt;SkyCoord (Galactic): (l, b) in deg
    ( 185.31779489, -5.68434757)&gt;, radius=0.11040258105103296 deg)&gt;, &lt;CircleSkyRegion(&lt;SkyCoord (Galactic): (l, b) in deg
    ( 185.12577116, -5.57534387)&gt;, radius=0.11040258105103296 deg)&gt;, &lt;CircleSkyRegion(&lt;SkyCoord (Galactic): (l, b) in deg
    ( 184.90548722, -5.56018125)&gt;, radius=0.11040258105103296 deg)&gt;]
 EventList info:
- Number of events: 51
- Median energy: 1.2129952907562256 TeV
- Median azimuth: 0.0
- Median altitude: 0.0

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">background_estimator</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[9]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>(&lt;matplotlib.figure.Figure at 0x10b04c4e0&gt;,
 &lt;matplotlib.axes._subplots.WCSAxesSubplot at 0x10b053a90&gt;,
 None)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_spectrum_analysis_17_1.png" src="../_images/notebooks_spectrum_analysis_17_1.png" />
</div>
</div>
</div>
<div class="section" id="Source-statistic">
<h2>Source statistic<a class="headerlink" href="#Source-statistic" title="Permalink to this headline">¶</a></h2>
<p>Next we’re going to look at the overall source statistics in our signal
region. For more info about what debug plots you can create check out
the
<a class="reference internal" href="../api/gammapy.data.ObservationSummary.html#gammapy.data.ObservationSummary"><span class="std std-ref">ObservationSummary</span></a>
class.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">stats</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">obs</span><span class="p">,</span> <span class="n">bkg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obs_list</span><span class="p">,</span> <span class="n">background_estimator</span><span class="o">.</span><span class="n">result</span><span class="p">):</span>
    <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ObservationStats</span><span class="o">.</span><span class="n">from_obs</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">bkg</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">obs_summary</span> <span class="o">=</span> <span class="n">ObservationSummary</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>

<span class="n">obs_summary</span><span class="o">.</span><span class="n">plot_excess_vs_livetime</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">obs_summary</span><span class="o">.</span><span class="n">plot_significance_vs_livetime</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
*** Observation summary report ***
Observation Id: 23526
Livetime: 0.437 h
On events: 168
Off events: 58
Alpha: 0.091
Bkg events in On region: 5.27
Excess: 162.73
Excess / Background: 30.86
Gamma rate: 6.41 1 / min
Bkg rate: 0.20 1 / min
Sigma: 24.24

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[10]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x104f508d0&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_spectrum_analysis_19_2.png" src="../_images/notebooks_spectrum_analysis_19_2.png" />
</div>
</div>
</div>
<div class="section" id="Extract-spectrum">
<h2>Extract spectrum<a class="headerlink" href="#Extract-spectrum" title="Permalink to this headline">¶</a></h2>
<p>Now, we’re going to extract a spectrum using the
<a class="reference internal" href="../api/gammapy.spectrum.SpectrumExtraction.html"><span class="doc">SpectrumExtraction</span></a>
class. We provide the reconstructed energy binning we want to use. It is
expected to be a Quantity with unit energy, i.e. an array with an energy
unit. We use a utility function to create it. We also provide the true
energy binning to use.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">e_reco</span> <span class="o">=</span> <span class="n">EnergyBounds</span><span class="o">.</span><span class="n">equal_log_spacing</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;TeV&#39;</span><span class="p">)</span>
<span class="n">e_true</span> <span class="o">=</span> <span class="n">EnergyBounds</span><span class="o">.</span><span class="n">equal_log_spacing</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">100.</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;TeV&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Instantiate a
<a class="reference internal" href="../api/gammapy.spectrum.SpectrumExtraction.html"><span class="doc">SpectrumExtraction</span></a>
object that will do the extraction. The containment_correction
parameter is there to allow for PSF leakage correction if one is working
with full enclosure IRFs. We also compute a threshold energy and store
the result in OGIP compliant files (pha, rmf, arf). This last step might
be omitted though.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">ANALYSIS_DIR</span> <span class="o">=</span> <span class="s1">&#39;crab_analysis&#39;</span>

<span class="n">extraction</span> <span class="o">=</span> <span class="n">SpectrumExtraction</span><span class="p">(</span>
    <span class="n">obs_list</span><span class="o">=</span><span class="n">obs_list</span><span class="p">,</span>
    <span class="n">bkg_estimate</span><span class="o">=</span><span class="n">background_estimator</span><span class="o">.</span><span class="n">result</span><span class="p">,</span>
    <span class="n">containment_correction</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">extraction</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="c1"># Add a condition on correct energy range in case it is not set by default</span>
<span class="n">extraction</span><span class="o">.</span><span class="n">compute_energy_threshold</span><span class="p">(</span><span class="n">method_lo</span><span class="o">=</span><span class="s1">&#39;area_max&#39;</span><span class="p">,</span> <span class="n">area_percent_lo</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">extraction</span><span class="o">.</span><span class="n">observations</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="c1"># Write output in the form of OGIP files: PHA, ARF, RMF, BKG</span>
<span class="c1"># extraction.run(obs_list=obs_list, bkg_estimate=background_estimator.result, outdir=ANALYSIS_DIR)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
/Users/deil/Library/Python/3.6/lib/python/site-packages/astropy/units/quantity.py:634: RuntimeWarning: invalid value encountered in true_divide
  result = super().__array_ufunc__(function, method, *arrays, **kwargs)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
*** Observation summary report ***
Observation Id: 23523
Livetime: 0.439 h
On events: 139
Off events: 44
Alpha: 0.091
Bkg events in On region: 4.00
Excess: 135.00
Excess / Background: 33.75
Gamma rate: 0.13 1 / min
Bkg rate: 0.00 1 / min
Sigma: 22.28
energy range: 0.68 TeV - 100.00 TeV
</pre></div></div>
</div>
</div>
<div class="section" id="Look-at-observations">
<h2>Look at observations<a class="headerlink" href="#Look-at-observations" title="Permalink to this headline">¶</a></h2>
<p>Now we will look at the files we just created. We will use the
<a class="reference internal" href="../api/gammapy.spectrum.SpectrumObservation.html"><span class="doc">SpectrumObservation</span></a>
object that are still in memory from the extraction step. Note, however,
that you could also read them from disk if you have written them in the
step above . The <code class="docutils literal"><span class="pre">ANALYSIS_DIR</span></code> folder contains 4 <code class="docutils literal"><span class="pre">FITS</span></code> files for
each observation. These files are described in detail at
<a class="reference external" href="https://gamma-astro-data-formats.readthedocs.io/en/latest/ogip/index.html">https://gamma-astro-data-formats.readthedocs.io/en/latest/ogip/index.html</a>.
In short they correspond to the on vector, the off vector, the effectie
area, and the energy dispersion.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1">#filename = ANALYSIS_DIR + &#39;/ogip_data/pha_obs23523.fits&#39;</span>
<span class="c1">#obs = SpectrumObservation.read(filename)</span>

<span class="c1"># Requires IPython widgets</span>
<span class="c1">#_ = extraction.observations.peek()</span>

<span class="n">extraction</span><span class="o">.</span><span class="n">observations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
/opt/local/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/matplotlib/colors.py:1238: UserWarning: Power-law scaling on negative values is ill-defined, clamping to 0.
  warnings.warn(&#34;Power-law scaling on negative values is &#34;
/opt/local/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/matplotlib/colors.py:1199: RuntimeWarning: invalid value encountered in power
  np.power(resdat, gamma, resdat)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_spectrum_analysis_25_1.png" src="../_images/notebooks_spectrum_analysis_25_1.png" />
</div>
</div>
</div>
<div class="section" id="Fit-spectrum">
<h2>Fit spectrum<a class="headerlink" href="#Fit-spectrum" title="Permalink to this headline">¶</a></h2>
<p>Now we’ll fit a global model to the spectrum. First we do a joint
likelihood fit to all observations. If you want to stack the
observations see below. We will also produce a debug plot in order to
show how the global fit matches one of the individual observations.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">model</span> <span class="o">=</span> <span class="n">PowerLaw</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
    <span class="n">amplitude</span><span class="o">=</span><span class="mf">2e-11</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;cm-2 s-1 TeV-1&#39;</span><span class="p">),</span>
    <span class="n">reference</span><span class="o">=</span><span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">joint_fit</span> <span class="o">=</span> <span class="n">SpectrumFit</span><span class="p">(</span><span class="n">obs_list</span><span class="o">=</span><span class="n">extraction</span><span class="o">.</span><span class="n">observations</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>

<span class="n">joint_fit</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">joint_fit</span><span class="o">.</span><span class="n">est_errors</span><span class="p">()</span>
<span class="c1">#fit.run(outdir = ANALYSIS_DIR)</span>

<span class="n">joint_result</span> <span class="o">=</span> <span class="n">joint_fit</span><span class="o">.</span><span class="n">result</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
/Users/deil/code/gammapy/gammapy/stats/fit_statistics.py:161: RuntimeWarning: divide by zero encountered in log
  term2_ = - n_on * np.log(mu_sig + alpha * mu_bkg)
/Users/deil/code/gammapy/gammapy/stats/fit_statistics.py:166: RuntimeWarning: divide by zero encountered in log
  term3_ = - n_off * np.log(mu_bkg)
/Users/deil/code/gammapy/gammapy/stats/fit_statistics.py:203: RuntimeWarning: divide by zero encountered in log
  term1 = - n_on * (1 - np.log(n_on))
/Users/deil/code/gammapy/gammapy/stats/fit_statistics.py:204: RuntimeWarning: divide by zero encountered in log
  term2 = - n_off * (1 - np.log(n_off))
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">joint_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">joint_result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Fit result info
---------------
Model: PowerLaw

Parameters:

           name     value     error         unit      min max frozen
        --------- --------- --------- --------------- --- --- ------
            index 2.178e+00 4.441e-02                 nan nan  False
        amplitude 2.012e-11 1.020e-12 1 / (cm2 s TeV) nan nan  False
        reference 1.000e+00 0.000e+00             TeV nan nan   True

Covariance:

        name/name  index   amplitude
        --------- -------- ---------
            index  0.00197  2.21e-14
        amplitude 2.21e-14  1.04e-24

Statistic: 34.777 (wstat)
Fit Range: [   0.68129207  100.        ] TeV

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_spectrum_analysis_28_1.png" src="../_images/notebooks_spectrum_analysis_28_1.png" />
</div>
</div>
</div>
<div class="section" id="Compute-Flux-Points">
<h2>Compute Flux Points<a class="headerlink" href="#Compute-Flux-Points" title="Permalink to this headline">¶</a></h2>
<p>To round up out analysis we can compute flux points by fitting the norm
of the global model in energy bands. We’ll use a fixed energy binning
for now.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Define energy binning</span>
<span class="n">ebounds</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">10.1</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span>

<span class="n">stacked_obs</span> <span class="o">=</span> <span class="n">extraction</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>

<span class="n">seg</span> <span class="o">=</span> <span class="n">SpectrumEnergyGroupMaker</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="n">stacked_obs</span><span class="p">)</span>
<span class="n">seg</span><span class="o">.</span><span class="n">compute_range_safe</span><span class="p">()</span>
<span class="n">seg</span><span class="o">.</span><span class="n">compute_groups_fixed</span><span class="p">(</span><span class="n">ebounds</span><span class="o">=</span><span class="n">ebounds</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
SpectrumEnergyGroups:

Info including underflow- and overflow bins:
Number of groups: 6
Bin range: (0, 71)
Energy range: EnergyRange(min=0.01 TeV, max=100.0 TeV)

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
/Users/deil/code/gammapy/gammapy/stats/poisson.py:383: RuntimeWarning: divide by zero encountered in double_scalars
  temp = (alpha + 1) / (n_on + n_off)
/Users/deil/code/gammapy/gammapy/stats/poisson.py:385: RuntimeWarning: divide by zero encountered in log
  m = n_off * log(n_off * temp)
/Users/deil/code/gammapy/gammapy/stats/poisson.py:384: RuntimeWarning: divide by zero encountered in log
  l = n_on * log(n_on * temp / alpha)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">fpe</span> <span class="o">=</span> <span class="n">FluxPointEstimator</span><span class="p">(</span>
    <span class="n">obs</span><span class="o">=</span><span class="n">stacked_obs</span><span class="p">,</span>
    <span class="n">groups</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">groups</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="n">joint_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fpe</span><span class="o">.</span><span class="n">compute_points</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
/Users/deil/code/gammapy/gammapy/stats/fit_statistics.py:161: RuntimeWarning: divide by zero encountered in log
  term2_ = - n_on * np.log(mu_sig + alpha * mu_bkg)
/Users/deil/code/gammapy/gammapy/stats/fit_statistics.py:166: RuntimeWarning: divide by zero encountered in log
  term3_ = - n_off * np.log(mu_bkg)
/Users/deil/code/gammapy/gammapy/stats/fit_statistics.py:203: RuntimeWarning: divide by zero encountered in log
  term1 = - n_on * (1 - np.log(n_on))
/Users/deil/code/gammapy/gammapy/stats/fit_statistics.py:204: RuntimeWarning: divide by zero encountered in log
  term2 = - n_off * (1 - np.log(n_off))
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">fpe</span><span class="o">.</span><span class="n">flux_points</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">fpe</span><span class="o">.</span><span class="n">flux_points</span><span class="o">.</span><span class="n">table</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<i>Table length=4</i>
<table id="table4515172248" class="table-striped table-bordered table-condensed">
<thead><tr><th>e_ref</th><th>e_min</th><th>e_max</th><th>dnde</th><th>dnde_err</th><th>dnde_ul</th><th>is_ul</th><th>sqrt_ts</th><th>dnde_errp</th><th>dnde_errn</th></tr></thead>
<thead><tr><th>TeV</th><th>TeV</th><th>TeV</th><th>1 / (cm2 s TeV)</th><th>1 / (cm2 s TeV)</th><th>1 / (cm2 s TeV)</th><th></th><th></th><th>1 / (cm2 s TeV)</th><th>1 / (cm2 s TeV)</th></tr></thead>
<thead><tr><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>bool</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>0.681292069058</td><td>0.464158883361</td><td>1.0</td><td>3.7087890856e-11</td><td>2.98925024997e-12</td><td>4.33476015219e-11</td><td>False</td><td>24.8667543824</td><td>2.9833525432e-12</td><td>2.94494024816e-12</td></tr>
<tr><td>1.6681005372</td><td>1.0</td><td>2.78255940221</td><td>8.1570462151e-12</td><td>5.40511435651e-13</td><td>9.29533532901e-12</td><td>False</td><td>32.695252187</td><td>5.65789940379e-13</td><td>5.12020688833e-13</td></tr>
<tr><td>5.2749970637</td><td>2.78255940221</td><td>10.0</td><td>5.95234607581e-13</td><td>5.74566970764e-14</td><td>7.18471748878e-13</td><td>False</td><td>21.8282192748</td><td>5.8807378136e-14</td><td>5.52229297328e-14</td></tr>
<tr><td>16.681005372</td><td>10.0</td><td>27.8255940221</td><td>3.18839971318e-14</td><td>7.40994324674e-15</td><td>4.89510875816e-14</td><td>False</td><td>8.58047038384</td><td>7.9064762535e-15</td><td>6.85090500174e-15</td></tr>
</table></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_spectrum_analysis_32_1.png" src="../_images/notebooks_spectrum_analysis_32_1.png" />
</div>
</div>
<p>The final plot with the best fit model and the flux points can be
quickly made like this</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">spectrum_result</span> <span class="o">=</span> <span class="n">SpectrumResult</span><span class="p">(</span>
    <span class="n">points</span><span class="o">=</span><span class="n">fpe</span><span class="o">.</span><span class="n">flux_points</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="n">joint_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">spectrum_result</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">energy_range</span><span class="o">=</span><span class="n">joint_fit</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fit_range</span><span class="p">,</span>
    <span class="n">energy_power</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">flux_unit</span><span class="o">=</span><span class="s1">&#39;erg-1 cm-2 s-1&#39;</span><span class="p">,</span>
    <span class="n">fig_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">)),</span>
    <span class="n">point_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ax0</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[19]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>(0.4, 50)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_spectrum_analysis_34_1.png" src="../_images/notebooks_spectrum_analysis_34_1.png" />
</div>
</div>
</div>
<div class="section" id="Stack-observations">
<h2>Stack observations<a class="headerlink" href="#Stack-observations" title="Permalink to this headline">¶</a></h2>
<p>And alternative approach to fitting the spectrum is stacking all
observations first and the fitting a model to the stacked observation.
This works as follows. A comparison to the joint likelihood fit is also
printed.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">stacked_obs</span> <span class="o">=</span> <span class="n">extraction</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>

<span class="n">stacked_fit</span> <span class="o">=</span> <span class="n">SpectrumFit</span><span class="p">(</span><span class="n">obs_list</span><span class="o">=</span><span class="n">stacked_obs</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
<span class="n">stacked_fit</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">stacked_fit</span><span class="o">.</span><span class="n">est_errors</span><span class="p">()</span>


<span class="n">stacked_result</span> <span class="o">=</span> <span class="n">stacked_fit</span><span class="o">.</span><span class="n">result</span>
<span class="k">print</span><span class="p">(</span><span class="n">stacked_result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">stacked_table</span> <span class="o">=</span> <span class="n">stacked_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_table</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s1">&#39;.3g&#39;</span><span class="p">)</span>
<span class="n">stacked_table</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;stacked&#39;</span>
<span class="n">joint_table</span> <span class="o">=</span> <span class="n">joint_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_table</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s1">&#39;.3g&#39;</span><span class="p">)</span>
<span class="n">joint_table</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;joint&#39;</span>
<span class="n">total_table</span> <span class="o">=</span> <span class="n">vstack_table</span><span class="p">([</span><span class="n">stacked_table</span><span class="p">,</span> <span class="n">joint_table</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="n">total_table</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;index_err&#39;</span><span class="p">,</span> <span class="s1">&#39;amplitude&#39;</span><span class="p">,</span> <span class="s1">&#39;amplitude_err&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
/Users/deil/code/gammapy/gammapy/stats/fit_statistics.py:161: RuntimeWarning: divide by zero encountered in log
  term2_ = - n_on * np.log(mu_sig + alpha * mu_bkg)
/Users/deil/code/gammapy/gammapy/stats/fit_statistics.py:166: RuntimeWarning: divide by zero encountered in log
  term3_ = - n_off * np.log(mu_bkg)
/Users/deil/code/gammapy/gammapy/stats/fit_statistics.py:203: RuntimeWarning: divide by zero encountered in log
  term1 = - n_on * (1 - np.log(n_on))
/Users/deil/code/gammapy/gammapy/stats/fit_statistics.py:204: RuntimeWarning: divide by zero encountered in log
  term2 = - n_off * (1 - np.log(n_off))
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Fit result info
---------------
Model: PowerLaw

Parameters:

           name     value     error         unit      min max frozen
        --------- --------- --------- --------------- --- --- ------
            index 2.177e+00 4.432e-02                 nan nan  False
        amplitude 2.012e-11 1.020e-12 1 / (cm2 s TeV) nan nan  False
        reference 1.000e+00 0.000e+00             TeV nan nan   True

Covariance:

        name/name  index   amplitude
        --------- -------- ---------
            index  0.00196  2.21e-14
        amplitude 2.21e-14  1.04e-24

Statistic: 81.604 (wstat)
Fit Range: [   0.46415888  100.        ] TeV

 method index index_err    amplitude     amplitude_err
                        1 / (cm2 s TeV) 1 / (cm2 s TeV)
------- ----- --------- --------------- ---------------
stacked  2.18    0.0443        2.01e-11        1.02e-12
  joint  2.18    0.0444        2.01e-11        1.02e-12
</pre></div></div>
</div>
</div>
<div class="section" id="Exercises">
<h2>Exercises<a class="headerlink" href="#Exercises" title="Permalink to this headline">¶</a></h2>
<p>Some things we might do:</p>
<ul class="simple">
<li>Fit a different spectral model (ECPL or CPL or …)</li>
<li>Use different method or parameters to compute the flux points</li>
<li>Do a chi^2 fit to the flux points and compare</li>
</ul>
<p>TODO: give pointers how to do this (and maybe write a notebook with
solutions)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Start exercises here</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="What-next?">
<h2>What next?<a class="headerlink" href="#What-next?" title="Permalink to this headline">¶</a></h2>
<p>In this tutorial we learned how to extract counts spectra from an event
list and generate the corresponding IRFs. Then we fitted a model to the
observations and also computed flux points.</p>
<p>Here’s some suggestions where to go next:</p>
<ul class="simple">
<li>if you want think this is way too complicated and just want to run a
quick analysis check out <a class="reference internal" href="spectrum_pipe.html"><span class="doc">this notebook</span></a></li>
<li>if you interested in available fit statistics checkout
<a class="reference internal" href="../stats/index.html"><span class="doc">gammapy.stats</span></a></li>
<li>if you want to simulate spectral look at <a class="reference external" href="../spectrum/simulation.rst">this
tutorial</a></li>
<li>if you want to compare your spectra to e.g. Fermi spectra published
in catalogs have a look at
<a class="reference external" href="../spectrum/plotting_fermi_spectra.rst">this</a></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>
<ul>
<li><a class="reference internal" href="#">Spectral analysis with Gammapy</a><ul>
<li><a class="reference internal" href="#Introduction">Introduction</a></li>
<li><a class="reference internal" href="#Setup">Setup</a></li>
<li><a class="reference internal" href="#Configure-logger">Configure logger</a></li>
<li><a class="reference internal" href="#Load-Data">Load Data</a></li>
<li><a class="reference internal" href="#Define-Target-Region">Define Target Region</a></li>
<li><a class="reference internal" href="#Load-exclusion-mask">Load exclusion mask</a></li>
<li><a class="reference internal" href="#Estimate-background">Estimate background</a></li>
<li><a class="reference internal" href="#Source-statistic">Source statistic</a></li>
<li><a class="reference internal" href="#Extract-spectrum">Extract spectrum</a></li>
<li><a class="reference internal" href="#Look-at-observations">Look at observations</a></li>
<li><a class="reference internal" href="#Fit-spectrum">Fit spectrum</a></li>
<li><a class="reference internal" href="#Compute-Flux-Points">Compute Flux Points</a></li>
<li><a class="reference internal" href="#Stack-observations">Stack observations</a></li>
<li><a class="reference internal" href="#Exercises">Exercises</a></li>
<li><a class="reference internal" href="#What-next?">What next?</a></li>
</ul>
</li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right">
    <a href="../_sources/notebooks/spectrum_analysis.ipynb.txt"
       rel="nofollow">Page Source</a> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2018, The Gammapy developers.<br/>
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.5. &nbsp;
    Last built 08 Jan 2018. <br/>
  </p>
</footer>
  </body>
</html>